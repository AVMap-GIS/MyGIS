<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Scripts\digitizer.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.1&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.5.1&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><a href="..&#x2F;index.html"><img src="..&#x2F;assets/css/logo.png" title=""></a></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for MyGIS version 2.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/mygis.Admin.html">mygis.Admin</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.AppManager.html">mygis.Admin.AppManager</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.AppManager.Apps.html">mygis.Admin.AppManager.Apps</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.AppManager.Maps.html">mygis.Admin.AppManager.Maps</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.AppManager.Styles.html">mygis.Admin.AppManager.Styles</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.AppManager.URLs.html">mygis.Admin.AppManager.URLs</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.LayerManager.html">mygis.Admin.LayerManager</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.LogManager.html">mygis.Admin.LogManager</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.MapManager.html">mygis.Admin.MapManager</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.MapManager.Layers.html">mygis.Admin.MapManager.Layers</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.MapManager.Macros.html">mygis.Admin.MapManager.Macros</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.MapManager.Maps.html">mygis.Admin.MapManager.Maps</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.MapManager.Permissions.html">mygis.Admin.MapManager.Permissions</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.MapManager.QuickSearches.html">mygis.Admin.MapManager.QuickSearches</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.UI.html">mygis.Admin.UI</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.UserManager.html">mygis.Admin.UserManager</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Admin.Utilities.html">mygis.Admin.Utilities</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Drawing.html">mygis.Drawing</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Drawing.Editing.html">mygis.Drawing.Editing</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Drawing.Exporting.html">mygis.Drawing.Exporting</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Drawing.Importing.html">mygis.Drawing.Importing</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Drawing.Styling.html">mygis.Drawing.Styling</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Map.html">mygis.Map</a></li>
            
                <li><a href="..&#x2F;classes/mygis.OLOverrides.html">mygis.OLOverrides</a></li>
            
                <li><a href="..&#x2F;classes/mygis.OLOverrides.mygis_Control.html">mygis.OLOverrides.mygis_Control</a></li>
            
                <li><a href="..&#x2F;classes/mygis.OLOverrides.mygis_Control.mygis_GetFeature.html">mygis.OLOverrides.mygis_Control.mygis_GetFeature</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Printing.html">mygis.Printing</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Query.html">mygis.Query</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Storage.html">mygis.Storage</a></li>
            
                <li><a href="..&#x2F;classes/mygis.UI.html">mygis.UI</a></li>
            
                <li><a href="..&#x2F;classes/mygis.UI.Help.html">mygis.UI.Help</a></li>
            
                <li><a href="..&#x2F;classes/mygis.UI.Hooks.html">mygis.UI.Hooks</a></li>
            
                <li><a href="..&#x2F;classes/mygis.UI.Macros.html">mygis.UI.Macros</a></li>
            
                <li><a href="..&#x2F;classes/mygis.UI.MediaManager.html">mygis.UI.MediaManager</a></li>
            
                <li><a href="..&#x2F;classes/mygis.User.html">mygis.User</a></li>
            
                <li><a href="..&#x2F;classes/mygis.User.Hooks.html">mygis.User.Hooks</a></li>
            
                <li><a href="..&#x2F;classes/mygis.User.ProfileInfo.html">mygis.User.ProfileInfo</a></li>
            
                <li><a href="..&#x2F;classes/mygis.User.UI.html">mygis.User.UI</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Utilities.html">mygis.Utilities</a></li>
            
                <li><a href="..&#x2F;classes/mygis.Utilities.projections.html">mygis.Utilities.projections</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: Scripts\digitizer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var config={
	mapserver: &quot;&#x2F;mapserver&#x2F;&quot;,
	namespace: &quot;http:&#x2F;&#x2F;mgmapserver2.avmap.gr:8081&#x2F;geoserver&#x2F;&quot;,
	folderPath: &quot;&#x2F;DesktopModules&#x2F;AVMap.MapDigitizer_v2&#x2F;&quot;,
	mgreq: &quot;&#x2F;DesktopModules&#x2F;AVMap.MapDigitizer_v2&#x2F;mgreq.ashx&quot;		&#x2F;&#x2F;alternative: config.mgreq+&quot;&quot;
};
Object.defineProperties(config,{
	&quot;mapserver&quot;: {
		value: &quot;&#x2F;mapserver&#x2F;&quot;,
		writable: false,
		configurable: false
	},
	&quot;namespace&quot;: {
		value: &quot;http:&#x2F;&#x2F;mgmapserver2.avmap.gr:8081&#x2F;geoserver&#x2F;&quot;,
		writable: false,
		configurable: false
	},
	&quot;folderPath&quot;: {
		value: &quot;&#x2F;DesktopModules&#x2F;AVMap.MapDigitizer_v2&#x2F;&quot;,
		writable: false,
		configurable: false
	},
	&quot;mgreq&quot;: {
		value: &quot;&#x2F;DesktopModules&#x2F;AVMap.MapDigitizer_v2&#x2F;mgreq.ashx&quot;,
		writable: false,
		configurable: false
	}

});
var internalConfig={
	mapTabIndex: 1,
	layerTabIndex: 2,
	searchTabIndex: 3,
	editTabIndex: 4,
	changeDefaultMap: null,
	apiVersion: &#x27;2.0.0&#x27;,
	hotSearches: [],
	myCustomFilters: [],
	selectionToolbarIndex: 1,
	digitizingToolbarIndex: 2,
	filteringToolbarIndex: 4,
	mediaManagerSearchTimer: null,
	mmCallback:{
		fn: null,
		objectCount: -1,
		object: null
	},
	defaultBG1_index: 4,
	defaultBG2_index: 4,
	isAdminInterfaceLoaded: false,
	isUserPageLoaded: false,
	uiBlocked: false,
	mapThumbCropper: null,
	mapThumbPreviousBox: &quot;&quot;,
	macroButtons: [],
	helpTips:{
		switchBG:false,
		switchBG_animPlaying: false
	},
	moveendEvent: -1,
	zoomToFeat: -1,
	legendWidth: 20
};
var internalMemory={
	lastZoom: null,
	dialogTop: 0,
	dialogLeft: 0,
	unsavedLayerChanges: [],
	layerFields:{}
}
var backgrounds = {

};


var appPath;
var digimap;
var criteriaMap;
var digiContainer;
var drawControls;
var infoControls;
var naviControls;
var lastCritIndex;

var countMarkers, countPolygons, countPolylines;
var digiOutLoc;
var geoXml;
var postbackurl;
var extra;
var myguid;
var current;
var wmsHighlight;
var cosmeticLayer;
var selectionLayer;
var feedbackLayer;
var selectionWMSLayer;
var selectionFlasher={timer:null,count:null};
var featuresUnsaved = [];
var featuresModified = {};
var featuresDeleted = [];

var drawingManager;
var mapContainerPosition;
var panTimer;

var toolbarToggling = false;
var filledMode = 2; &#x2F;&#x2F;2 - filled polygon, 4 - filled circle, 5 - filled rectangle
var real_editMode = false;
var rightmenuOpen = false;
var infoWindows;
var autocomplete;
var saveFlasher;

var toolsEnabled = {
    allTools: false,
    toolbar: false,
    search: false,
    maps: false,
    layers: false,
    marker: false,
    filledRect: false,
    openRect: false,
    filledCircle: false,
    openCircle: false,
    openPolygon: false,
    filledPolygon: false,
    polyLine: false,
    polyLineDirections: false,
    database: false,
    undo: false
};

var cmenu;
var objcmenu;
var rightClickedObj;

window.trigger_calendar = [];		&#x2F;&#x2F;JK CHANGES	-	flag array to determine when to trigger calendar(s)
window.lines_id =[[0,false,false,false]];					&#x2F;&#x2F;JK CHANGES	-	array for naming second row&amp;calendar instances
window.current_row=[&quot;&quot;,&quot;&quot;];				&#x2F;&#x2F;JK CHANGES	-	this remembers the current row we are modifiying in order to use calendar instances

$.xhrPool = [];
$.xhrPool.abortAll = function() {
    $(this).each(function(idx, jqXHR) {
        jqXHR.abort();
    });
    $.xhrPool.length=0;
};

$.ajaxSetup({
    beforeSend: function(jqXHR) {
		if (!$.xhrPool){
			$.xhrPool = [];
		}
        $.xhrPool.push(jqXHR);
    },
    complete: function(jqXHR) {
		if ($.xhrPool){
			var index = $.xhrPool.indexOf(jqXHR);
			if (index &gt; -1) {
				$.xhrPool.splice(index, 1);
			}
		}
    }
});

&#x2F;**
Main library

@namespace mygis
**&#x2F;
window.mygis = {};&#x2F;&#x2F;namespace(&quot;AVMap.mygis&quot;);

&#x2F;**
Browser Local Storage functions
@class mygis.Storage
@static

**&#x2F;
mygis.Storage = {

	&#x2F;**
	Checks to see if browser supports local storage
	@method isStorageEnabled
	@return {Boolean} Browser supports local storage
	**&#x2F;
	isStorageEnabled: function(){
		var retvalue=false;
		if (localStorage)retvalue=false;
		return retvalue;
	},

	&#x2F;**
	Returns an item from the local storage
	@method getItem
	@param {String} key
	@return {String} The locally stored object
	**&#x2F;
	getItem: function(key){
		var retvalue;
		if (mygis.Storage.isStorageEnabled()){
			if (localStorage.length &amp;&amp; key){
				retvalue = localStorage.getItem(key);
			}
		}
		return retvalue;
	},

	&#x2F;**
	Stores an item to the local storage
	@method storeItem
	@param {String} key
	@param {String} value The value to store
	@return {Boolean} The result of the operation
	**&#x2F;
	storeItem: function(key,value){
		var retvalue=false;
		if (mygis.Storage.isStorageEnabled){
			localStorage.setItem(key,value);
			retvalue=true;
		}
		return retvalue;
	}
};

&#x2F;&#x2F;END OF mygis.Storage


&#x2F;**
Styling and Digitizing functions

@class Drawing
@static
**&#x2F;
mygis.Drawing = {

	&#x2F;**
	Editing existing features functions

	@class Drawing.Editing
	@static
	**&#x2F;
	Editing: {
	
		&#x2F;**
		  * Returns true if at least one data property is not empty
		  * @method isFilledIn
		  * @param data {Object}
		  *&#x2F;
		isFilledIn: function(data){
			var retvalue=false;
			$.each(data,function(i,v){
				if (v){
					retvalue=true;
				}
			});
			return retvalue;
		},

		editInfoFields: function(fieldInfo){
			var fields=$(&quot;.infoFieldsInnerCont .featureVCell&quot;);
			var cont = $(&quot;.infoFieldsInnerCont&quot;);
			if (!cont.hasClass(&#x27;editable&#x27;)){
				cont.addClass(&quot;editable&quot;);
			}
			$.each(fields,function(i,field){
				var key=$(field).prev().attr(&quot;data-originalName&quot;);
				var descr = $(field).prev().attr(&quot;data-description&quot;);
				var data=fieldInfo[key];
				var params={
					element: $(field).prev(),
					message: descr
				}
				singleQTip(&#x27;editField&#x27;,params);
				if (data.fieldLists.length&gt;0){
					var jsonParams=&quot;{&#x27;&#x27;:&#x27;&quot;+strings.Editing.pleaseSelect+&quot;&#x27;&quot;;
					$.each(data.fieldLists,function(i,v){
						jsonParams+=&quot;,&quot;;
						jsonParams+=&quot;&#x27;&quot;+v.value+&quot;&#x27;&quot;;
						jsonParams+=&quot;:&quot;;
						jsonParams+=&quot;&#x27;&quot;+v.name+&quot;&#x27;&quot;;
					});
					jsonParams+=&quot;}&quot;;
					$(field).editable(
						function(value,settings){
							return value;
						},
						{
							data: jsonParams,
							type   : &#x27;select&#x27;,
							onblur: &#x27;submit&#x27;,
							placeholder: &#x27;&lt;span class=&quot;placeholder&quot;&gt;&#x27;+strings.Editing.clickToEdit+&#x27;&lt;&#x2F;span&gt;&#x27;,
							onsubmit: function(settings, td) {
								var input = $(td).find(&#x27;input&#x27;);
								&#x2F;&#x2F;var name = input.attr(&quot;name&quot;);
								$(this).validate({
									rules: {
										&#x27;value&#x27;: {
											required: true
										}
									},
									messages: {
										&#x27;actionItemEntity.name&#x27;: {
											number: &#x27;Required field&#x27;

										}

									}
								});

								return ($(this).valid());
							}
						}
					);
				}else{
					switch(data.originalType){
						case &#x27;bit&#x27;:
							$(field).editable(
								function(value,settings){
									return value;
								},
								{
								data: &quot;{&#x27;&#x27;:&#x27;&quot;+strings.Editing.pleaseSelect+&quot;&#x27;,&#x27;True&#x27;:&#x27;&quot;+strings.Editing.trueValue+&quot;&#x27;,&#x27;False&#x27;:&#x27;&quot;+strings.Editing.falseValue+&quot;&#x27;}&quot;,
								type   : &#x27;select&#x27;,
								onblur: &#x27;submit&#x27;,
								placeholder: &#x27;&lt;span class=&quot;placeholder&quot;&gt;&#x27;+strings.Editing.clickToEdit+&#x27;&lt;&#x2F;span&gt;&#x27;
								&#x2F;&#x2F;,submit:&#x27;ok&#x27;
								}
							);
						case &#x27;float&#x27;:
						case &#x27;double&#x27;:
						case &#x27;int&#x27;:
						case &#x27;numeric&#x27;:
							$(field).editable(
								function(value,settings){
									return value;
								},
								{
								onsubmit: function(settings, td) {
									var input = $(td).find(&#x27;input&#x27;);
									&#x2F;&#x2F;var name = input.attr(&quot;name&quot;);
									$(this).validate({
										rules: {
											&#x27;value&#x27;: {
												number: true
											}
										},
										messages: {
											&#x27;actionItemEntity.name&#x27;: {
												number: &#x27;Only numbers are allowed&#x27;

											}

										}
									});

									return ($(this).valid());
								},
								type:&#x27;text&#x27;,
								onblur: &#x27;submit&#x27;,
								placeholder: &#x27;&lt;span class=&quot;placeholder&quot;&gt;&#x27;+strings.Editing.clickToEdit+&#x27;&lt;&#x2F;span&gt;&#x27;
								&#x2F;&#x2F;,submit:&#x27;ok&#x27;
								}
							);
							break;
						default:
							$(field).editable(
								function(value,settings){
									return value;
								},
								{
								type:&#x27;textarea&#x27;,
								onblur: &#x27;submit&#x27;,
								placeholder: &#x27;&lt;span class=&quot;placeholder&quot;&gt;&#x27;+strings.Editing.clickToEdit+&#x27;&lt;&#x2F;span&gt;&#x27;
								&#x2F;&#x2F;,submit:&#x27;ok&#x27;
								}
							);
							break;
					}
				}
				
			});
			
		},
		
		toggleEditableInfoFields: function(on){
			var mode=&quot;&quot;;
			if (on){
				mode=&quot;enable&quot;;
			}else{
				mode=&quot;disable&quot;;
			}
			try{
				mygis.Drawing.Editing.editInfoFields();
			}catch(err){}
			$(&quot;.infoFieldsInnerCont .featureVCell&quot;).editable(mode);
		},
		
		checkInfoPopupButtons: function(layername,objectID,fieldInfo){
			try{$(&quot;.infoPopupBtn&quot;).die().remove();}catch(err){}
			try{$(&quot;.infoPopup_saveChangesBtn&quot;).die().remove();}catch(err){}
			try{$(&quot;.infoPopup_editBtn&quot;).die().remove();}catch(err){}
			try{$(&quot;.infoPopup_deleteBtn&quot;).die().remove();}catch(err){}
			var records = layerSource.records;
			var fn = function(elem){
				return elem.layerTABLE==layername;
			};
			&#x2F;&#x2F;Get the layer (to get layerID):
			if (objectID==-1){	&#x2F;&#x2F;it&#x27;s a new item
				
				var btn1=$(&quot;&lt;a class=&#x27;infoPopup_addImageBtn infoPopupBtn&#x27; href=&#x27;#&#x27;&gt;&lt;&#x2F;a&gt;&quot;);
				btn1.append(strings.Editing.addImage);
				$(&quot;.infoImagesLabel&quot;).append(btn1);
				btn1.bind(&quot;click&quot;,mygis.Drawing.Editing.handlerAttachImage);
				var btn2=$(&quot;&lt;a class=&#x27;infoPopup_addFileBtn infoPopupBtn&#x27; href=&#x27;#&#x27;&gt;&lt;&#x2F;a&gt;&quot;);
				btn2.append(strings.Editing.addFile);
				$(&quot;.infoFilesLabel&quot;).append(btn2);
				btn2.bind(&quot;click&quot;,mygis.Drawing.Editing.handlerAttachFile);
				var btn3=$(&quot;&lt;a class=&#x27;infoPopup_saveChangesBtn ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only&#x27; href=&#x27;#&#x27;&gt;&lt;&#x2F;a&gt;&quot;);
				btn3.append(&#x27;&lt;span class=&quot;ui-button-icon-primary ui-icon ui-icon-disk&quot;&gt;&lt;&#x2F;span&gt;&#x27;);
				var container = $(&quot;.infoCont.ui-dialog-content&quot;).prev();
				container.append(btn3);
				btn3.bind(&quot;click&quot;,function(){setTimeout(mygis.Drawing.Editing.attachFieldsToFeature,400);});	&#x2F;&#x2F;there is a 200ms delay in jEditable&#x27;s code to actually submit...go figure.
			}else{
				var layer = records.find(fn);
				
				if (layer &amp;&amp; internalMemory.layerRights){
					if (mygis.Drawing.Exporting.checkRights(objectID,layer.layerID,&#x27;update&#x27;)){
						var btn1=$(&quot;&lt;a class=&#x27;infoPopup_addImageBtn infoPopupBtn&#x27; href=&#x27;#&#x27;&gt;&lt;&#x2F;a&gt;&quot;);
						btn1.append(strings.Editing.addImage);
						$(&quot;.infoImagesLabel&quot;).append(btn1);
						btn1.bind(&quot;click&quot;,(function(x,y){return function(){mygis.Drawing.Editing.handlerAttachImage(x,y); }})(objectID,layer.layerTABLE));
						var btn2=$(&quot;&lt;a class=&#x27;infoPopup_addFileBtn infoPopupBtn&#x27; href=&#x27;#&#x27;&gt;&lt;&#x2F;a&gt;&quot;);
						btn2.append(strings.Editing.addFile);
						$(&quot;.infoFilesLabel&quot;).append(btn2);
						btn2.bind(&quot;click&quot;,(function(x,y){return function(){mygis.Drawing.Editing.handlerAttachFile(x,y); }})(objectID,layer.layerTABLE));
						var btn3=$(&quot;&lt;a class=&#x27;infoPopup_saveChangesBtn ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only&#x27; href=&#x27;#&#x27;&gt;&lt;&#x2F;a&gt;&quot;);
						btn3.append(&#x27;&lt;span class=&quot;ui-button-icon-primary ui-icon ui-icon-disk&quot;&gt;&lt;&#x2F;span&gt;&#x27;);
						var container = $(&quot;.infoCont.ui-dialog-content&quot;).prev();
						container.append(btn3);
						btn3.bind(&quot;click&quot;,(function(objectID,layer){
							return function(event){
								var errorsFound=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;form .error&quot;).length&gt;0;
								if (errorsFound){
									showConfirmationDialog(strings.Editing.loseAllChanges,function(){	
										var dialogContent=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;.ui-dialog-content&quot;);
										try{
											dialogContent.dialog(&#x27;destroy&#x27;);
											dialogContent.remove();
										}catch(err){}
										console.log(&quot;removed 1&quot;);
										cosmeticLayer.destroyFeatures();
										digimap.layers[1].redraw(true);
										mygis.UI.activateControl(&#x27;drag&#x27;);
										
									},function(){console.log(&#x27;cancelled&#x27;);return false});
								}else{
									var previous=layerCurrentEditing;
									layerCurrentEditing=mygis.Utilities.mggetLayerIndex(layer.layerTABLE);
									mygis.Drawing.Editing.mg_updateFeature(objectID,layer.layerTABLE)
									layerCurrentEditing=previous;
									var dialogContent=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;.ui-dialog-content&quot;);
									try{
										dialogContent.dialog(&#x27;destroy&#x27;);
										dialogContent.remove();
									}catch(err){}
								}
								
								
							};
						})(objectID,layer));
						mygis.Drawing.Editing.editInfoFields(fieldInfo);
						$(&quot;.ui-dialog .ui-layout-center h3.ui-accordion-header&quot;).show();
					}
					if (mygis.Drawing.Exporting.checkRights(objectID,layer.layerID,&#x27;delete&#x27;)){
						var btn1=$(&quot;&lt;a class=&#x27;infoPopup_deleteBtn ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only&#x27; href=&#x27;#&#x27;&gt;&lt;&#x2F;a&gt;&quot;);
						btn1.append(&#x27;&lt;span class=&quot;ui-button-icon-primary ui-icon ui-icon-trash&quot;&gt;&lt;&#x2F;span&gt;&#x27;);
						container.append(btn1);
						btn1.bind(&quot;click&quot;,(function(objectID,layer){
								return function(event){
									showConfirmationDialog(strings.Editing.deleteObject,function(){
										var previous=layerCurrentEditing;
										layerCurrentEditing=mygis.Utilities.mggetLayerIndex(layer.layerTABLE);
										mygis.Drawing.Editing.mg_deleteFeature(objectID,layer.layerTABLE)
										layerCurrentEditing=previous;
										var dialogContent=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;.ui-dialog-content&quot;);
										try{
											dialogContent.dialog(&#x27;destroy&#x27;);
											dialogContent.remove();
										}catch(err){}
									}, function(){return false;});
								};
							})(objectID,layer));
							
					}
				}
			}
			
		},
	
		&#x2F;**
		 * Clears the contents of the editDigitize popup
		 * @method clearDigiPopup
		 *&#x2F;
		clearDigiPopup: function(){
			$(&quot;#appSetting_DigitizeFields&quot;).empty();
			$(&quot;#appSetting_DigitizeImages&quot;).empty();
			$(&quot;#appSetting_DigitizeFiles&quot;).empty();
			$(&quot;#appSetting_DigitizeLinks&quot;).empty();
		},

		&#x2F;**
		 *	Adds default UI to editDigitize popup. Used after clearing.
		 *	@method addDigiDefaults
		 *&#x2F;
		addDigiDefaults: function(){
			&#x2F;&#x2F;----IMAGES----&#x2F;&#x2F;
			var imageCont = $(&quot;&lt;div class=&#x27;appSetting&#x27; &#x2F;&gt;&quot;);
			var wrapper = $(&quot;&lt;div class=&#x27;imageWrapper&#x27; &#x2F;&gt;&quot;);
			var divImages = $(&quot;&lt;div id=&#x27;editImageContainer&#x27; &#x2F;&gt;&quot;);
			var btnImgAttach = $(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;defaultAction freshButton&#x27; &#x2F;&gt;&quot;);
			btnImgAttach.html(strings.Editing.btnAttachImage);
			btnImgAttach.bind(&quot;click&quot;,mygis.Drawing.Editing.handlerAttachImage);
			&#x2F;&#x2F;imageCont.append(btnImgAttach);
			wrapper.append(divImages);
			imageCont.append(wrapper);

			$(&quot;#appSetting_DigitizeImages&quot;).append(imageCont);

			&#x2F;&#x2F;----FILES----&#x2F;&#x2F;
			var fileCont = $(&quot;&lt;div class=&#x27;appSetting&#x27; &#x2F;&gt;&quot;);
			var divFiles = $(&quot;&lt;div id=&#x27;editFileContainer&#x27; &#x2F;&gt;&quot;);
			var btnFileAttach = $(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;defaultAction freshButton&#x27; &#x2F;&gt;&quot;);
			btnFileAttach.html(strings.Editing.btnAttachFile);
			btnFileAttach.bind(&quot;click&quot;,mygis.Drawing.Editing.handlerAttachFile);
			fileCont.append(divFiles);
			&#x2F;&#x2F;fileCont.append(btnFileAttach);
			$(&quot;#appSetting_DigitizeFiles&quot;).append(fileCont);
		},

		&#x2F;**
		 *	Handles the &quot;Attach Image&quot; button click
		 *	@method handlerAttachImage
		 *&#x2F;
		handlerAttachImage: function(oid,layer){
			internalConfig.mmCallback.fn = mygis.Drawing.Editing.imageAttached;
			internalConfig.mmCallback.objectCount=1;
			internalConfig.mmCallback.object=null;
			internalConfig.mmCallback.oid=oid;
			internalConfig.mmCallback.layer=layer;
			showMediaManager(true);
		},

		&#x2F;**
		 *	Handles the &quot;Attach File&quot; button click
		 *	@method handlerAttachFile
		 *&#x2F;
		handlerAttachFile: function(oid,layer){
			internalConfig.mmCallback.fn = mygis.Drawing.Editing.fileAttached;
			internalConfig.mmCallback.objectCount=1;
			internalConfig.mmCallback.object=null;
			internalConfig.mmCallback.oid=oid;
			internalConfig.mmCallback.layer=layer;
			showMediaManager();
		},

		&#x2F;**
		 *	&quot;Remembers&quot; the images attached to the feature and displays a gallery
		 *	@method imageAttached
		 *	@param {String} result
		 *&#x2F;
		imageAttached: function(result){
			if (result==&quot;ok&quot;){
				var resultObj=this;
				var lastFeature;
				var layer; 
				var fid;
				var oid;
				if (internalConfig.mmCallback.oid&gt;-1){
					layer = internalConfig.mmCallback.layer;
					oid = internalConfig.mmCallback.oid;
					mygis.Drawing.Editing.mg_featureModified(oid,layer);
					lastFeature = featuresModified[layer+&quot;.&quot;+internalConfig.mmCallback.oid];
				}else{
					lastFeature = featuresUnsaved[featuresUnsaved.length-1];
					layer = layerSource.records[layerCurrentEditing].layerTABLE;
					oid = -1;
				}
				fid = layer+&quot;.&quot;+oid;
				if (!lastFeature.attachedImages){
					lastFeature.attachedImages=[];
				}
				if (!lastFeature.attachedImagesFull){
					lastFeature.attachedImagesFull=[];
				}
				var panel=$(&quot;#detached&quot;+layer+&quot;_&quot;+oid+&quot; .popupimageContainer&quot;);
				var data=panel.data(&quot;images&quot;);
				if (data){
					$.each(data,function(i,v){
						lastFeature.attachedImages.push(v.imageID);
						lastFeature.attachedImagesFull.push(v);
					});
				}
				for (var i=0;i&lt;resultObj.length;i++){
					var resultObjItem = resultObj[i];
					
					resultObjItem.imageID=resultObjItem.fileID;	&#x2F;&#x2F;interoperability with other functions
					resultObjItem.imageTYPE = resultObjItem.fileTYPE; &#x2F;&#x2F;interoperability with other functions
					resultObjItem.imageNAME = resultObjItem.fileNAME; &#x2F;&#x2F;interoperability with other functions
					
					lastFeature.attachedImages.push(resultObjItem.fileID);
					lastFeature.attachedImagesFull.push(resultObjItem);
				}
				
				panel.empty();
				if (lastFeature.attachedImages.length&gt;0){
					panel.append(mygis.UI.getInfoImageGrid(lastFeature.attachedImagesFull,fid));
					var mainCont=$(&quot;#detached&quot;+layer+&quot;_-1&quot;).find(&quot;.mainImageCont&quot;);
					mainCont.removeClass(&quot;editable&quot;);
					mainCont.unbind(&#x27;click&#x27;);
					var src=mygis.Utilities.format(
							&quot;url(&#x27;{0}GetImage.ashx?qType=userFile&amp;qContents={1}&amp;qSize=430&#x27;)&quot;,
							config.folderPath,
							lastFeature.attachedImages[0]);
					mainCont.css(&quot;background-image&quot;,src);
				}
				
				
			}
		},

		&#x2F;**
		 *	&quot;Remembers&quot; the files attached to the feature and displays a list
		 *	@method fileAttached
		 *	@param {String} result
		 *&#x2F;
		fileAttached: function(result){
			if (result==&quot;ok&quot;){
				var resultObj=this;
				var lastFeature;
				var layer; 
				var fid;
				var oid;
				if (internalConfig.mmCallback.oid&gt;-1){
					layer = internalConfig.mmCallback.layer;
					oid = internalConfig.mmCallback.oid;
					mygis.Drawing.Editing.mg_featureModified(oid,layer);
					lastFeature = featuresModified[layer+&quot;.&quot;+internalConfig.mmCallback.oid];
				}else{
					lastFeature = featuresUnsaved[featuresUnsaved.length-1];
					layer = layerSource.records[layerCurrentEditing].layerTABLE;
					oid = -1;
				}
				fid = layer+&quot;.&quot;+oid;
				if (!lastFeature.attachedFiles){
					lastFeature.attachedFiles=[];
				}
				if (!lastFeature.attachedFilesFull){
					lastFeature.attachedFilesFull=[];
				}
				var panel=$(&quot;#detached&quot;+layer+&quot;_&quot;+oid+&quot; .popupFileContainer&quot;);
				var data=panel.data(&quot;files&quot;);
				if (data){
					$.each(data,function(i,v){
						lastFeature.attachedFiles.push(v.imageID);
						lastFeature.attachedFilesFull.push(v);
					});
				}
				for (var i=0;i&lt;resultObj.length;i++){
					var resultObjItem = resultObj[i];
					
					resultObjItem.imageID=resultObjItem.fileID;	&#x2F;&#x2F;interoperability with other functions
					resultObjItem.imageTYPE = resultObjItem.fileTYPE; &#x2F;&#x2F;interoperability with other functions
					resultObjItem.imageNAME = resultObjItem.fileNAME; &#x2F;&#x2F;interoperability with other functions
					
					lastFeature.attachedFiles.push(resultObjItem.fileID);
					lastFeature.attachedFilesFull.push(resultObjItem);
				}
				
				panel.empty();
				if (lastFeature.attachedFiles.length&gt;0){
					panel.append(mygis.UI.getInfoFileGrid(lastFeature.attachedFilesFull,fid));
				}
				
			}
		},

		&#x2F;**
		 * Used to remove an image from the &quot;to be attached&quot; array
		 * @method imageDetach
		 *&#x2F;
		imageDetach: function(){
			var grid = $(&quot;#editImageContainer&quot;);
			var lastFeature = featuresUnsaved[featuresUnsaved.length-1];
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			var newIDs=[];
			var newObjects=[];

			for (var i=0;i&lt;lastFeature.attachedImages.length;i++){
				if (selection.indexOf(i)==-1){
					newIDs.push(lastFeature.attachedImages[i]);
					newObjects.push(lastFeature.attachedImagesFull[i]);
				}
			}
			lastFeature.attachedImages=newIDs;
			lastFeature.attachedImagesFull=newObjects;
			var source = mygis.Utilities.getLocalGridSource(lastFeature.attachedImagesFull);
			grid.jqxGrid({source: source});
			&#x2F;*
			for (var i=selection.length-1;i&gt;=0;i--){
				grid.jqxGrid(&#x27;deleterow&#x27;,selection[i]);
			}
			*&#x2F;
			grid.jqxGrid(&#x27;clearselection&#x27;);
			grid.jqxGrid(&#x27;refreshdata&#x27;);
			mygis.Drawing.Editing.imageGridSelected();
		},

		&#x2F;**
		 * Used to remove a file from the &quot;to be attached&quot; array
		 * @method fileDetach
		 *&#x2F;
		fileDetach: function(){
			var grid = $(&quot;#editFileContainer&quot;);
			var lastFeature = featuresUnsaved[featuresUnsaved.length-1];
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			var newIDs=[];
			var newObjects=[];

			for (var i=0;i&lt;lastFeature.attachedFiles.length;i++){
				if (selection.indexOf(i)==-1){
					newIDs.push(lastFeature.attachedFiles[i]);
					newObjects.push(lastFeature.attachedFilesFull[i]);
				}
			}
			lastFeature.attachedFiles=newIDs;
			lastFeature.attachedFilesFull=newObjects;
			var source = mygis.Utilities.getLocalGridSource(lastFeature.attachedFilesFull);
			grid.jqxGrid({source: source});
			&#x2F;*
			for (var i=selection.length-1;i&gt;=0;i--){
				grid.jqxGrid(&#x27;deleterow&#x27;,selection[i]);
			}
			*&#x2F;
			grid.jqxGrid(&#x27;clearselection&#x27;);
			grid.jqxGrid(&#x27;refreshdata&#x27;);
			mygis.Drawing.Editing.fileGridSelected();
		},

		&#x2F;**
		 * Used to download an image
		 * @method imageDownload
		 * @param {Element} The calling element
		 *&#x2F;
		imageDownload: function(elem){
			var inp = $(elem).parent().find(&quot;.inputID&quot;)[0];
			mygis.UI.MediaManager.downloadFile(inp.value);
		},

		&#x2F;**
		 * Used to view fully an image
		 * @method imageZoom
		 * @param {Element} The calling element
		 *&#x2F;
		imageZoom: function(elem){
			var inp = $(elem).parent().find(&quot;.inputID&quot;)[0];
			var url = mygis.Utilities.format(&quot;&#x2F;DesktopModules&#x2F;AVMap.MapDigitizer_v2&#x2F;GetImage.ashx?qType=userFile&amp;qContents={0}&quot;,inp.value);
			var newImg = $(&quot;&lt;img &#x2F;&gt;&quot;);
			newImg.attr(&quot;src&quot;,url);
			newImg.attr(&quot;class&quot;,&quot;imagePreviewer&quot;);
			var newImgCont = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var popupCont = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var mywidth,myheight;
			newImgCont.attr(&quot;style&quot;,&quot;display: table-cell; text-align: center; vertical-align: middle; width: 900px; height: 360px;&quot;);
			popupCont.append(newImgCont);
			newImg.load(function(){
				mywidth = this.width;
				myheight = this.height;
				newImgCont.append(newImg);
				popupCont.dialog({
					width: 900,	&#x2F;&#x2F;mywidth,
					height: 410,&#x2F;&#x2F;myheight,
					modal: true,
					draggable: false,
					resizable: false
				});&#x2F;&#x2F;.siblings(&#x27;div.ui-dialog-titlebar&#x27;).remove();
				newImgCont.focus();
			});
		},

		&#x2F;**
		 * Used to download a file
		 * @method fileDownload
		 * @param {Element} The calling element
		 *&#x2F;
		fileDownload: function(elem){
			var inp = $(elem).parent().find(&quot;.inputID&quot;)[0];
			mygis.UI.MediaManager.downloadFile(inp.value);
		},

		&#x2F;**
		 *	Creates&#x2F;refreshes an image slider for editDigitize popup
		 *	@method refreshImageSlider
		 *	@deprecated
		 *&#x2F;
		refreshImageSlider: function(){
			var slider = $(&quot;#editImageContainer&quot;);
			slider.empty();
			var contDiv = $(&quot;$&lt;ul &#x2F;&gt;&quot;);

			var lastFeature = featuresUnsaved[featuresUnsaved.length-1];
			$.each(lastFeature.attachedImages,function(i,v){
				var item = $(&quot;&lt;li &#x2F;&gt;&quot;);
				var img = $(&quot;&lt;img &#x2F;&gt;&quot;);
				var link = $(&quot;&lt;a &#x2F;&gt;&quot;);
				var src = config.folderPath+&quot;GetImage.ashx?qtype=userFile&amp;qSize=50&amp;qContents=&quot;+v;
				img.attr(&quot;src&quot;,src);
				link.bind(&quot;click&quot;,mygis.Drawing.Editing.imageMenuClick);
				link.append(img);
				item.append(link);
				contDiv.append(item);
			});
			var wrapItem = $(&quot;&lt;div &#x2F;&gt;&quot;);
			wrapItem.append(contDiv);
			wrapItem.attr(&quot;class&quot;,&quot;es-carousel&quot;);
			slider.append(wrapItem);
			slider.elastislide({
				imageW  : 50,
				border  : 0
			});
		},

		&#x2F;**
		 * Creates&#x2F;refreshes an image grid for editDigitize popup
		 * @method refreshImageGrid
		 *&#x2F;
		refreshImageGrid: function(){
			var lastFeature = featuresUnsaved[featuresUnsaved.length-1];
			&#x2F;&#x2F;lastFeature.attachedImagesFull
			var grid = $(&quot;#editImageContainer&quot;);
			grid.removeData().empty();
			mygis.Drawing.Editing.createImageGrid(lastFeature.attachedImagesFull);
		},

		&#x2F;**
		 * Creates&#x2F;refreshes a file grid for editDigitize popup
		 * @method refreshFileGrid
		 *&#x2F;
		refreshFileGrid: function(){
			var lastFeature = featuresUnsaved[featuresUnsaved.length-1];
			&#x2F;&#x2F;lastFeature.attachedImagesFull
			var grid = $(&quot;#editFileContainer&quot;);
			grid.removeData().empty();
			mygis.Drawing.Editing.createFileGrid(lastFeature.attachedFilesFull);
		},

		&#x2F;**
		 *	Creates the image grid for editDigitize
		 *	@method createImageGrid
		 *&#x2F;
		createImageGrid: function(data){
			$.each(data,function(i,v){
				v.imageSelected=false;
			});

			var source = mygis.Utilities.getLocalGridSource(data);
			var container = $(&quot;#editImageContainer&quot;);
			var rowheight = 50;
			var columnrenderer = function(value){
				var action = &#x27;router(&quot;editPopup_imageSelectAll&quot;,this);&#x27;;
				var grid = $(&quot;#editImageContainer&quot;);
				var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
				var checked = selection.length==grid.jqxGrid(&#x27;source&#x27;).records.length ? &#x27; checked=&quot;checked&quot;&#x27; : &#x27;&#x27;;
				var customStyle=&quot;text-align: center; margin-top: 5px;position: absolute;left: 18px;z-index: 1;&quot;;
				retobject = mygis.Utilities.format(&quot;&lt;div style=&#x27;{2}&#x27;&gt;&lt;input id=&#x27;editDigitizeImageAll&#x27; type=&#x27;checkbox&#x27; onclick=&#x27;{0}&#x27;{1}&#x2F;&gt;&lt;&#x2F;div&gt;&quot;,
													action,checked,customStyle);
				return retobject;
			};
			var cellrenderer = function(row,datafield,value){
				var retobject;
				switch (datafield){
					case &quot;fileID&quot;:
						var src = config.folderPath+&quot;GetImage.ashx?qtype=userFile&amp;qSize=48&amp;qContents=&quot;+value;
						retobject = mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;height: {1}px;&#x27;&gt;&lt;img src=&#x27;{0}&#x27;&#x2F;&gt;&lt;&#x2F;div&gt;&quot;,src,rowheight);
						break;
					case &quot;fileNAME&quot;:
						retobject=mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;height: {1}px;&#x27;&gt;{0}&lt;&#x2F;div&gt;&quot;,value,rowheight);
						break;
					default:
						var buttons = &quot;&quot;;
						var fileID = this.owner.getrowdata(row).fileID;
						buttons += mygis.Utilities.format(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;freshButton&#x27; onclick=&#x27;{0}&#x27;&gt;{1}&lt;&#x2F;a&gt;&quot;,&#x27;router(&quot;editDigi_btnImageDownload&quot;,this);&#x27;,strings.Editing.btnImage_download);
						buttons += mygis.Utilities.format(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;freshButton&#x27; onclick=&#x27;{0}&#x27;&gt;{1}&lt;&#x2F;a&gt;&quot;,&#x27;router(&quot;editDigi_btnImageZoom&quot;,this);&#x27;,strings.Editing.btnImage_fullZoom);
						buttons += mygis.Utilities.format(&quot;&lt;input class=&#x27;inputID&#x27; type=&#x27;hidden&#x27; value=&#x27;{0}&#x27; &#x2F;&gt;&quot;,fileID);
						retobject=mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;height: {1}px;&#x27;&gt;{0}&lt;&#x2F;div&gt;&quot;,buttons,rowheight);
						break;
				}
				return retobject;
			};
			container.jqxGrid({
				source: source,
				width: &#x27;100%&#x27;,
				height: &#x27;300px&#x27;,
				autoheight: false,
				theme: &#x27;pk_mg_jm&#x27;,
				altrows: true,
				enabletooltips: true,
				columns: [
					{text: &quot;asdf&quot;,datafield:&quot;imageSelected&quot;,width: 45, columntype: &quot;checkbox&quot;,renderer:columnrenderer},
					{text: strings.Editing.gridFile_colThumb, datafield: &quot;fileID&quot;,width: 55,cellsrenderer: cellrenderer,editable: false},
					{text: strings.Editing.gridFile_colName, datafield: &quot;fileNAME&quot;,cellsrenderer: cellrenderer,editable: false},
					{text: strings.Editing.gridFile_colActions,datafield:&quot;&quot;,width: 200, cellsrenderer: cellrenderer,editable:false}
				],
				enableanimations: false,
				showheader: true,
				columnsmenu: false,
				editable: true,
				selectionmode: &#x27;none&#x27;,
				rowsheight: rowheight
			});
			container.bind(&quot;rowselect&quot;,mygis.Drawing.Editing.imageGridSelected);
			container.bind(&quot;rowunselect&quot;,mygis.Drawing.Editing.imageGridUnselected);
			container.bind(&quot;cellendedit&quot;,mygis.Drawing.Editing.imageGridCheckClicked);
		},

		&#x2F;**
		 *	Creates the file grid for editDigitize
		 *	@method createFileGrid
		 *&#x2F;
		createFileGrid: function(data){
			$.each(data,function(i,v){
				v.fileSelected=false;
			});
			var source = mygis.Utilities.getLocalGridSource(data);
			var container = $(&quot;#editFileContainer&quot;);
			var rowheight = 50;
			var columnrenderer = function(value){
				var action = &#x27;router(&quot;editPopup_fileSelectAll&quot;,this);&#x27;;
				var grid = $(&quot;#editFileContainer&quot;);
				var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
				var checked;
				if (selection){
					checked = selection.length==grid.jqxGrid(&#x27;source&#x27;).records.length ? &#x27; checked=&quot;checked&quot;&#x27; : &#x27;&#x27;;
				}else{
					checked = false;
				}
				var customStyle=&quot;text-align: center; margin-top: 5px;position: absolute;left: 18px;z-index: 1;&quot;;
				retobject = mygis.Utilities.format(&quot;&lt;div style=&#x27;{2}&#x27;&gt;&lt;input id=&#x27;editDigitizeFileAll&#x27; type=&#x27;checkbox&#x27; onclick=&#x27;{0}&#x27;{1}&#x2F;&gt;&lt;&#x2F;div&gt;&quot;,
													action,checked,customStyle);
				return retobject;
			};
			var cellrenderer = function(row,datafield,value){
				var retobject;
				switch (datafield){
					case &quot;fileID&quot;:
						var cname = &quot;&quot;;
						var extParts = this.owner.getrowdata(row).fileNAME.split(&quot;.&quot;);
						var ext = extParts[extParts.length-1].toLowerCase();
						switch(ext){
							case &quot;doc&quot;:
							case &quot;docx&quot;:
								cname = &quot;doc&quot;;
								break;
							case &quot;xls&quot;:
							case &quot;xlsx&quot;:
								cname = &quot;xls&quot;;
								break;
							case &quot;ppt&quot;:
							case &quot;pptx&quot;:
								cname = &quot;ppt&quot;;
								break;
							case &quot;pdf&quot;:
								cname = &quot;pdf&quot;;
								break;
							case &quot;png&quot;:
							case &quot;jpg&quot;:
							case &quot;jpeg&quot;:
							case &quot;gif&quot;:
								cname=&quot;image&quot;;
								break;
							default:
								cname = &quot;unknown&quot;;
								break;
						}
						if (cname==&quot;image&quot;){
							var src = config.folderPath+&quot;GetImage.ashx?qtype=userFile&amp;qSize=50&amp;qContents=&quot;+value;
							retobject = mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;height: {1}px;&#x27;&gt;&lt;img src=&#x27;{0}&#x27;&#x2F;&gt;&lt;&#x2F;div&gt;&quot;,src,rowheight);
						}else{
							retobject = mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;height: {1}px;width: {1}px;&#x27;&gt;&lt;div class=&#x27;MMFile2 {0}&#x27; &#x2F;&gt;&lt;&#x2F;div&gt;&quot;,cname,rowheight);
						}
						break;
					case &quot;fileNAME&quot;:
						retobject=mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;height: {1}px;&#x27;&gt;{0}&lt;&#x2F;div&gt;&quot;,value,rowheight);
						break;
					default:
						var buttons = &quot;&quot;;
						var fileID = this.owner.getrowdata(row).fileID;
						buttons += mygis.Utilities.format(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;freshButton&#x27; onclick=&#x27;{0}&#x27;&gt;{1}&lt;&#x2F;a&gt;&quot;,&#x27;router(&quot;editDigi_btnFileDownload&quot;,this);&#x27;,strings.Editing.btnImage_download);
						buttons += mygis.Utilities.format(&quot;&lt;input class=&#x27;inputID&#x27; type=&#x27;hidden&#x27; value=&#x27;{0}&#x27; &#x2F;&gt;&quot;,fileID);
						retobject=mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;height: {1}px;&#x27;&gt;{0}&lt;&#x2F;div&gt;&quot;,buttons,rowheight);
						break;
				}
				return retobject;
			};
			container.jqxGrid({
				source: source,
				width: &#x27;100%&#x27;,
				height: &#x27;300px&#x27;,
				autoheight: false,
				theme: &#x27;pk_mg_jm&#x27;,
				altrows: true,
				enabletooltips: true,
				columns: [
					{text: &quot;asdf&quot;,datafield:&quot;fileSelected&quot;,width: 45, columntype: &quot;checkbox&quot;,renderer:columnrenderer},
					{text: strings.Editing.gridFile_colThumb, datafield: &quot;fileID&quot;,width: 55,cellsrenderer: cellrenderer,editable: false},
					{text: strings.Editing.gridFile_colName, datafield: &quot;fileNAME&quot;,cellsrenderer: cellrenderer,editable: false},
					{text: strings.Editing.gridFile_colActions,datafield:&quot;&quot;,width: 200, cellsrenderer: cellrenderer,editable:false}
				],
				enableanimations: false,
				showheader: true,
				columnsmenu: false,
				editable: true,
				selectionmode: &#x27;none&#x27;,
				rowsheight: rowheight
			});
			container.bind(&quot;rowselect&quot;,mygis.Drawing.Editing.fileGridSelected);
			container.bind(&quot;rowunselect&quot;,mygis.Drawing.Editing.fileGridUnselected);
			container.bind(&quot;cellendedit&quot;,mygis.Drawing.Editing.fileGridCheckClicked);
		},


		&#x2F;**
		 * Activates&#x2F;deactivates some buttons when an image is selected in the editDigitize popup
		 * @method imageGridUnselected
		 *&#x2F;
		imageGridSelected: function(){
			var grid = $(&quot;#editImageContainer&quot;);
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (selection.length&gt;=1){
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_RemoveClassName(&quot;disabled&quot;);
			}else{
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_AddClassName(&quot;disabled&quot;);
			}
			if (selection.length==grid.jqxGrid(&#x27;source&#x27;).records.length){
				document.getElementById(&#x27;editDigitizeImageAll&#x27;).checked=true;
			}else{
				document.getElementById(&#x27;editDigitizeImageAll&#x27;).checked=false;
			}
		},

		&#x2F;**
		 * Activates&#x2F;deactivates some buttons when an image is unselected in the editDigitize popup
		 * @method imageGridUnselected
		 *&#x2F;
		imageGridUnselected: function(){
			var grid = $(&quot;#editImageContainer&quot;);
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (selection.length&gt;=1){
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_RemoveClassName(&quot;disabled&quot;);
			}else{
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_AddClassName(&quot;disabled&quot;);
			}
			if (selection.length==grid.jqxGrid(&#x27;source&#x27;).records.length){
				document.getElementById(&#x27;editDigitizeImageAll&#x27;).checked=true;
			}else{
				document.getElementById(&#x27;editDigitizeImageAll&#x27;).checked=false;
			}
		},

		&#x2F;**
		 * Handles the checking of the imageGrid row in editDigitize
		 * @method imageGridCheckClicked
		 * @param {Element} elem The firing element
		 *&#x2F;
		imageGridCheckClicked: function(elem){
			var grid=$(&quot;#editImageContainer&quot;);
			if (elem.args.value) {
				grid.jqxGrid(&#x27;selectrow&#x27;, elem.args.rowindex);
			}
			else {
				grid.jqxGrid(&#x27;unselectrow&#x27;, elem.args.rowindex);
			}
		},

		&#x2F;**
		 * Handles the check all button for the imageGrid in editDigitize
		 * @method imageGridCheckAll
		 * @param {Element} elem The firing checkbox
		 *&#x2F;
		imageGridCheckAll: function(elem){
			var grid = $(&quot;#editImageContainer&quot;);
			var records = grid.jqxGrid(&#x27;source&#x27;).records;
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (elem.checked){
				for (var i=0;i&lt;records.length;i++){
						if (selection.indexOf(i)==-1){
							records[i].imageSelected=true;
							grid.jqxGrid(&#x27;selectrow&#x27;,i)
						}
				}
				grid.jqxGrid(&#x27;refreshdata&#x27;);
			}else{
				for (var i=0;i&lt;records.length;i++){
					records[i].imageSelected=false;
					grid.jqxGrid(&#x27;unselectrow&#x27;,i)
				}
				grid.jqxGrid(&#x27;refreshdata&#x27;);
			}
		},

		&#x2F;**
		 * Activates&#x2F;deactivates some buttons when a file is selected in the editDigitize popup
		 * @method fileGridSelected
		 *&#x2F;
		fileGridSelected: function(){
			var grid = $(&quot;#editFileContainer&quot;);
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (selection.length&gt;=1){
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_RemoveClassName(&quot;disabled&quot;);
			}else{
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_AddClassName(&quot;disabled&quot;);
			}
			if (selection.length==grid.jqxGrid(&#x27;source&#x27;).records.length){
				document.getElementById(&#x27;editDigitizeFileAll&#x27;).checked=true;
			}else{
				document.getElementById(&#x27;editDigitizeFileAll&#x27;).checked=false;
			}
		},

		&#x2F;**
		 * Activates&#x2F;deactivates some buttons when a file is unselected in the editDigitize popup
		 * @method fileGridUnselected
		 *&#x2F;
		fileGridUnselected: function(){
			var grid = $(&quot;#editFileContainer&quot;);
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (selection.length&gt;=1){
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_RemoveClassName(&quot;disabled&quot;);
			}else{
				$(&quot;#editDigitizeTabActions .sectionButtons a&quot;)[1].ex_AddClassName(&quot;disabled&quot;);
			}
			if (selection.length==grid.jqxGrid(&#x27;source&#x27;).records.length){
				document.getElementById(&#x27;editDigitizeFileAll&#x27;).checked=true;
			}else{
				document.getElementById(&#x27;editDigitizeFileAll&#x27;).checked=false;
			}
		},

		&#x2F;**
		 * Handles the checking of the fileGrid row in editDigitize
		 * @method fileGridCheckClicked
		 * @param {Element} elem The firing element
		 *&#x2F;
		fileGridCheckClicked: function(elem){
			var grid=$(&quot;#editFileContainer&quot;);
			if (elem.args.value) {
				grid.jqxGrid(&#x27;selectrow&#x27;, elem.args.rowindex);
			}
			else {
				grid.jqxGrid(&#x27;unselectrow&#x27;, elem.args.rowindex);
			}
		},

		&#x2F;**
		 * Handles the check all button for the fileGrid in editDigitize
		 * @method fileGridCheckAll
		 * @param {Element} elem The firing checkbox
		 *&#x2F;
		fileGridCheckAll: function(elem){
			var grid = $(&quot;#editFileContainer&quot;);
			var records = grid.jqxGrid(&#x27;source&#x27;).records;
			var selection = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (elem.checked){
				for (var i=0;i&lt;records.length;i++){
						if (selection.indexOf(i)==-1){
							records[i].fileSelected=true;
							grid.jqxGrid(&#x27;selectrow&#x27;,i)
						}
				}
				grid.jqxGrid(&#x27;refreshdata&#x27;);
			}else{
				for (var i=0;i&lt;records.length;i++){
					records[i].fileSelected=false;
					grid.jqxGrid(&#x27;unselectrow&#x27;,i)
				}
				grid.jqxGrid(&#x27;refreshdata&#x27;);
			}
		},

		&#x2F;**
		 * Creates an input for a field of the editDigitize popup
		 * @method createFieldDiv
		 * @param {Object} field The field object
		 * @param {String} type The field type. One of text,dropdown,datetime
		 * @param {Object} Reserved for future use
		 * @returns {Element} The result element.
		 *&#x2F;
		createFieldDiv: function(field,type,params){
			var retobject;
			retobject = $(&quot;&lt;div &#x2F;&gt;&quot;); &#x2F;&#x2F;remake
			&#x2F;&#x2F;var theme = getDemoTheme();
			&#x2F;&#x2F;retobject = $(&quot;#jqxWidget&quot;).jqxDateTimeInput({width: &#x27;250px&#x27;, height: &#x27;25px&#x27;, theme: theme});

			retobject.attr(&quot;class&quot;,&quot;appSetting&quot;);
			var label = $(&quot;&lt;label &#x2F;&gt;&quot;);
			label.attr(&quot;for&quot;,&quot;inp__&quot;+field.name);
			label.html(field.name);
			var inp;
			switch (type){
				case &quot;text&quot;:
					inp = $(&quot;&lt;input type=&#x27;text&#x27; &#x2F;&gt;&quot;);
					break;
				case &quot;dropdown&quot;:
					&#x2F;*
					inp = $(&quot;&lt;div &#x2F;&gt;&quot;);

					var listSource = new $.jqx.dataAdapter({
						datatype: &quot;local&quot;,
						localdata: field.fieldLists,
						id: &quot;dadapt&quot;+field.name.replace(&#x27; &#x27;,&#x27;&#x27;)
					}
					);

					inp.jqxDropDownList({
						source: listSource,
						displayMember: &quot;name&quot;,
						valueMember: &quot;value&quot;,
						selectedIndex: 0,
						width: 300,
						height: 20
					});
					*&#x2F;
					inp = $(&quot;&lt;select &#x2F;&gt;&quot;);
					mygis.Utilities.populateSelect(inp[0],field.fieldLists,true);
					break;
				case &quot;datetime&quot;:
					inp = $(&quot;&lt;div &#x2F;&gt;&quot;);
					inp.attr(&quot;class&quot;,&quot;datetime&quot;);

					break;
			}
			inp.attr(&quot;id&quot;,&quot;inp__&quot;+field.name);
			retobject.append(label);
			retobject.append(inp);
			return retobject;
		},

		&#x2F;**
		 *	Checks if the field should be output to the UI.
		 *	Example of fields that are excluded: OID, Geometry
		 *	@method isValidOutput
		 *	@param {Object} field
		 *	@param {String} destination	One of &quot;fields&quot;,&quot;images&quot;,&quot;files&quot;,&quot;links&quot;
		 *	@returns {Boolean}
		 *&#x2F;
		isValidOutput: function(field,destination){
			var retvalue=true;
			switch(destination){
				case &quot;fields&quot;:
					retvalue=mygis.Drawing.Editing.isValidOutputIntern(field.name);
					break;
				case &quot;links&quot;:
					if (field.name.indexOf(&quot;__LNK&quot;)!=0){
						retvalue=false;
					}
					break;
				case &quot;images&quot;:
				case &quot;files&quot;:
					retvalue=false;
					break;
			}
			return retvalue;
		},
		
		isValidOutputIntern: function(name){
			var retvalue=true;
			if (name.endsWith(&quot;__&quot;)){
				retvalue=false;	&#x2F;&#x2F;RESERVED FIELDS
			}else {
				switch(name){
					case &quot;Geometry&quot;:
					case &quot;GeometryText&quot;:
					case &quot;OID&quot;:
					case &quot;Center_X&quot;:
					case &quot;Center_Y&quot;:
						retvalue=false;	&#x2F;&#x2F;INTERNAL fields
				}
			}
			return retvalue;
		},

		&#x2F;**
		 *	Returns the type of input box to create based on field type
		 *	@method getInputType
		 *	@param {Object} field
		 *	@returns {String} One of &quot;text&quot;,&quot;datetime&quot;,&quot;dropdown&quot;
		 *&#x2F;
		getInputType: function(field){
			var type;
			if (field.fieldLists.length&gt;0){
				type=&quot;dropdown&quot;;
			}else if (
				field.originalType.indexOf(&quot;char&quot;)&gt;-1 ||
				field.originalType.indexOf(&quot;nchar&quot;)&gt;-1 ||
				field.originalType.indexOf(&quot;varchar&quot;)&gt;-1 ||
				field.originalType.indexOf(&quot;nvarchar&quot;)&gt;-1 ||
				field.originalType.indexOf(&quot;Text&quot;)&gt;-1 ||
				field.originalType.indexOf(&quot;nText&quot;)&gt;-1){
				type=&quot;text&quot;;
			}else if (field.originalType.indexOf(&quot;date&quot;)&gt;-1){
				type=&quot;datetime&quot;; &#x2F;&#x2F;JK CHANGE
			}else{
				type=&quot;text&quot;;	&#x2F;&#x2F;number?
			}
			return type;
		},

		&#x2F;**
		 *	Fills in the editDigitize popup
		 *	@method fillDigiPopup
		 *	@param {Array} dataColumns
		 *	@param {String} layername
		 *&#x2F;
		fillDigiPopup: function(datacolumns,layername){
			mygis.Drawing.Editing.clearDigiPopup();
			mygis.Drawing.Editing.addDigiDefaults();
			$.each(datacolumns,function(i,v){
				if (mygis.Drawing.Editing.isValidOutput(v,&quot;fields&quot;)){
					var type = mygis.Drawing.Editing.getInputType(v);
					$(&quot;#appSetting_DigitizeFields&quot;).append(mygis.Drawing.Editing.createFieldDiv(v,type));
				}
			});
			$(&quot;#appSetting_DigitizeFields .datetime&quot;).jqxDateTimeInput({
				width: &quot;430px&quot;,
				height: &quot;20px&quot;
			});
		},

		&#x2F;**
		 *	Checks if the input in the editDigitize popup is valid
		 *	@method checkValidInfo
		 *	@returns {Boolean}
		 *&#x2F;
		checkValidInfo: function(){
			&#x2F;*
			 * 	This could be used to perform validation for &quot;not null&quot; fields etc.
			 * 	But for now...
			 *&#x2F;
			 return true;
		},

		&#x2F;**
		 *	Called when the user presses save&#x2F;cancel at the editDigitize popup
		 *	@method digiPopupResult
		 *&#x2F;
		digiPopupResult: function(result){
			if (!result || result!=&quot;ok&quot;){
				mygis.UI.cosmeticPop(featuresUnsaved[featuresUnsaved.length-1]);
			}else{
				mygis.Drawing.Editing.attachFieldsToFeature();
			}
		},

		&#x2F;**
		 * Attaches fields to last created feature
		 * @method attachFieldsToFeature
		 *&#x2F;
		attachFieldsToFeature: function(suppressNotification,whereTo){
			var f;
			if (whereTo==null){
				f = featuresUnsaved[featuresUnsaved.length-1];	&#x2F;&#x2F;last object
			}else{
				f=whereTo;
			}
			if (f){
				var fieldsToAttach = $(&quot;.infoCont.ui-dialog-content .infoFieldsInnerCont .featureVCell&quot;);&#x2F;&#x2F;$(&quot;#appSetting_DigitizeFields&quot;).find(&quot;.appSetting&quot;);
				$.each(fieldsToAttach,function(i,v){
					var data=$(v).data(&#x27;fieldInfo&#x27;);
					var col = data.name;&#x2F;&#x2F;$(v).find(&quot;label&quot;).html();
					var inp = $(v).text()==strings.Editing.clickToEdit?&quot;&quot;:$(v).text(); &#x2F;&#x2F;$(v).find(&quot;input&quot;)[0];
					&#x2F;*
					if (!inp){
						inp =$(v).find(&quot;select option:selected&quot;)[0];
					}
					*&#x2F;
					if (!f.data){f.data={}};
					f.data[col]=inp;
					

				});
				if (!suppressNotification){
					displayNotify(strings.Editing.tempNewObj+layerSource.records[layerCurrentEditing].layerNAME);
				}
			}else{
				&#x2F;&#x2F;Something went wrong: Feature should exist before save popup.
				cosmeticLayer.destroyFeatures();
				var dialogContent=$(&quot;.ui-dialog&quot;).find(&quot;.ui-dialog-content&quot;);
				try{
					dialogContent.dialog(&#x27;destroy&#x27;);
					dialogContent.remove();
				}catch(err){}
				displayError(strings.Editing.temporaryError);
			}
			
			&#x2F;&#x2F;mygis.Drawing.Exporting.saveDigitizing();
		},

		&#x2F;**
		 *	Switches the active tab to the given index.
		 *	@method switchToTab
		 *	@param {Integer} index
		 *&#x2F;
		switchToTab: function(index){
			var tabHeaders = $(&quot;#editDigitizeLinkTabsRound&quot;).find(&quot;.sectionHeader&quot;);
			for (var i=0;i&lt;tabHeaders.length;i++){
					if (i!=index){
							tabHeaders[i].ex_RemoveClassName(&quot;active&quot;);
					}else{
							tabHeaders[i].ex_AddClassName(&quot;active&quot;);
					}
			}
			var tabs = $(&quot;#editDigitizeTab&quot;).find(&quot;.appSettingFrame&quot;);
			for (var i=0;i&lt;tabs.length;i++){
					if (i!=index){
							$(tabs[i]).hide();
							tabs[i].ex_RemoveClassName(&quot;active&quot;);
					}else{
							$(tabs[i]).show();
							tabs[i].ex_AddClassName(&quot;active&quot;);
							var buttons = $(tabs[i]).find(&quot;.sectionButtons&quot;);
							$(&quot;#editDigitizeTabActions&quot;).empty();
							$(&quot;#editDigitizeTabActions&quot;).append(buttons.clone());
					}

			}
		},

		&#x2F;**
			Removes a selected feature from the map

			@method mg_removeFeature
		**&#x2F;
		mg_removeFeature: function(e){
			if (!cosmeticLayer.deletedFeatures){
				cosmeticLayer.deletedFeatures = [];
			}
			while (cosmeticLayer.selectedFeatures.length&gt;0){
				var e = cosmeticLayer.selectedFeatures[0];
				var ref = new Object();
				ref.fid = e.fid;
				cosmeticLayer.deletedFeatures.push(ref);
				featuresDeleted.push(e.fid);
				drawControls.modify.selectControl.unselect(e);
				cosmeticLayer.removeFeatures(e);
			}

			mygis.UI.notifyUnsavedLayer(layerCurrentEditing);
		},
		
		mg_deleteFeature: function(oid,layername){
			featuresDeleted.push(layername+&quot;.&quot;+oid);
			mygis.Drawing.Exporting.saveDigitizing();
		},
		
		mg_featureModified: function(oid,layername){
			var fid=layername+&quot;.&quot;+oid;
			if (!featuresModified[fid]){featuresModified[fid]={};}
			featuresModified[fid].data={};
			featuresModified[fid].data.OID=oid;
			mygis.Drawing.Editing.attachFieldsToFeature(true,featuresModified[fid]);
		},
		
		mg_updateFeature: function(oid,layername){
			mygis.Drawing.Editing.mg_featureModified(oid,layername);
			mygis.Drawing.Exporting.saveDigitizing();
		},

		&#x2F;**
			Edits the given layer. Retrieves features via WFS.

			@method editLayer
			@param {String} layername The layer name to search for
		**&#x2F;
		editLayer: function(layername){

			var options= {
				strategies: [new mygis.Map.strategies.BBOXUnique({ratio:1,resFactor:1})],
				protocol: new OpenLayers.Protocol.WFS({
					url: config.mapserver+&quot;wfs&quot;,
					version : &quot;1.1.0&quot;,
					featureType: layername,
					featureNS: config.namespace+&quot;MyGIS&quot;,	&#x2F;&#x2F;+currentAppName,
					geometryName : &quot;Geometry&quot;,
					type: &quot;Geometry&quot;
					&#x2F;&#x2F;srsName: digimap.projection.getCode()
					&#x2F;*
					,
					propertyNames: [&quot;Geometry&quot;]
					*&#x2F;
				}),
				styleMap: new OpenLayers.StyleMap(),
					preFeatureInsert: function(feature) {
					&#x2F;*
					console.log(feature.geometry.toString());
					console.log(feature.attributes.OID);
					*&#x2F;
					var y=feature.geometry.getCentroid().y;
					if (y&lt;90 &amp;&amp; y&gt;-190){
						&#x2F;&#x2F;feature.geometry.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;))
					}
			   }

			};
			digimap.removeLayer(cosmeticLayer);
			cosmeticLayer.events.unregister(&quot;afterfeaturemodified&quot;);
			cosmeticLayer = new OpenLayers.Layer.Vector(&quot;Cosmetic Layer&quot;,options);

			&#x2F;&#x2F;var style = layerStyles[layername].namedLayers[layername].userStyles[0];

			&#x2F;&#x2F;cosmeticLayer.styleMap.styles[&quot;default&quot;]=style;

			digimap.addLayer(cosmeticLayer);
			digimap.removeControl(drawControls.modify);

			var featureToUnselect;

			drawControls.modify = new OpenLayers.Control.ModifyFeature(cosmeticLayer,{

				createVertices: false,
				standalone: false

			});

			switch (featureEditMode){
				case 4:
				case 0:
					drawControls.modify.mode = OpenLayers.Control.ModifyFeature.DRAG;
					break;
				case 1:
					drawControls.modify.mode = OpenLayers.Control.ModifyFeature.ROTATE;
					break;
				case 2:
					drawControls.modify.mode = OpenLayers.Control.ModifyFeature.RESIZE;
					break;
				case 3:
					drawControls.modify.mode = OpenLayers.Control.ModifyFeature.RESHAPE;
					break;
			}
			OpenLayers.Util.extend(drawControls.modify.selectControl.callbacks,{
				over: function(feature){
					if(!(OpenLayers.Util.indexOf(this.layer.selectedFeatures, feature) &gt; -1)) {
						this.highlight(feature);
					}
				},
				out: function(feature){
					if(!(OpenLayers.Util.indexOf(this.layer.selectedFeatures, feature) &gt; -1)) {
						this.unhighlight(feature);
					}
				}
			});

			drawControls.modify.selectControl.renderIntent = &quot;select&quot;;
			drawControls.modify.selectControl.multipleKey=&#x27;shiftKey&#x27;;
			digimap.addControl(drawControls.modify);

			mygis.UI.activateOLControl(drawControls.modify);

			cosmeticLayer.events.on({
				&quot;afterfeaturemodified&quot;: mygis.UI.featureModified,
				&quot;featureselected&quot;: function(e){
					mygis.UI.editFeatureSelected(e);
					switch(layerSource.records[layerCurrentEditing].layerGeomType){
						case &quot;Point&quot;:
							document.getElementById(&quot;editModeRotate&quot;).ex_AddClassName(&quot;disabled&quot;);
							document.getElementById(&quot;editModeResize&quot;).ex_AddClassName(&quot;disabled&quot;);
							document.getElementById(&quot;editModeReshape&quot;).ex_AddClassName(&quot;disabled&quot;);
							break;
						case &quot;Line&quot;:
						case &quot;Mixed&quot;:
						case &quot;Polygon&quot;:
							document.getElementById(&quot;editModeRotate&quot;).ex_RemoveClassName(&quot;disabled&quot;);
							document.getElementById(&quot;editModeResize&quot;).ex_RemoveClassName(&quot;disabled&quot;);
							document.getElementById(&quot;editModeReshape&quot;).ex_RemoveClassName(&quot;disabled&quot;);
							break;

					}
					&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0,1,2&quot;,true);
					
					document.getElementById(&quot;selectClear&quot;).ex_RemoveClassName(&quot;disabled&quot;);
				},
				&quot;featureunselected&quot;: function(e){
					if (cosmeticLayer.selectedFeatures.length==0){
						&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0&quot;,true);
						
					}
				}
			 });


		},

		&#x2F;**
			Gathers the features to modify&#x2F;delete&#x2F;insert

			@method getFinalChanges
			@return {Object} Object with features to modify&#x2F;delete&#x2F;insert
		**&#x2F;
		getFinalChanges: function(){
			for (var i=0;i&lt;featuresDeleted.length;i++){
				var item = featuresDeleted[i];
				if (item.fid){
					mygis.Drawing.Editing.removeFeatureFromChange(item,featuresModified);	&#x2F;&#x2F;Remove deleted item from modified items
				}else{
					mygis.Drawing.Editing.removeFeatureFromChange(item,featuresUnsaved);	&#x2F;&#x2F;Remove deleted item from items to be inserted
				}
			}
			var retvalue = {};
			retvalue.featuresModified = featuresModified;
			retvalue.featuresDeleted  = featuresDeleted;
			retvalue.featuresUnsaved  = featuresUnsaved;

			return retvalue;
		},

		&#x2F;**
			Removes a given feature from the given &#x27;change&#x27; array

			@method removeFeatureFromChange
			@param feature The feature to remove
			@param featureArray The array to remove it from
		**&#x2F;
		removeFeatureFromChange: function(feature,featureArray){
			var found=false;
			var i=0;

			while (i&lt;featureArray.length &amp;&amp; !found){
				var comp = featureArray[x];
				if (comp.fid==feature.fid){
					found=true;
					featureArray.splice(i,1);
				}else{
					i++;
				}
			}

		}


	},

	&#x2F;**
	Provides various objects and methods related to styling.
	@class Drawing.Styling
	@static
	**&#x2F;
    Styling: {
		polyStyle: {
			strokeColor: &quot;#FF0000&quot;,
			fillColor: &quot;#FF0000&quot;,
			strokeOpacity: 1,
			fillOpacity: 0.5,
			strokeWidth: 3
		},

		lineStyle: {
			color: &quot;#FF0000&quot;,
			width: 3,
			opacity: 1
		},

		pointStyle: {
			icon: config.folderPath+&quot;Images&#x2F;Styles&#x2F;marker&#x2F;location.png&quot;,
			size: 32,
			defaultIcon: config.folderPath+&quot;Images&#x2F;Styles&#x2F;marker&#x2F;location.png&quot;
		},

		&#x2F;**
			Returns the default OpenLayers style, parameterized by the defaults specified in mygis.Drawing.Styling
			@method getOLStyle
			@param {String} type &#x27;point&#x27;,&#x27;line&#x27;,&#x27;polygon&#x27;,&#x27;selectpoint&#x27;,&#x27;selectline&#x27;,&#x27;selectpolygon&#x27;
			@return {Object} An object containing the appropriate style.
		**&#x2F;
		getOLStyle: function(type){

			var retvalue;
			switch(type)
			{
				case &#x27;point&#x27;:

					var defaultPointStyle = OpenLayers.Util.applyDefaults(defaultPointStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
					defaultPointStyle.externalGraphic = mygis.Drawing.Styling.pointStyle.icon;
					defaultPointStyle.graphicWidth = mygis.Drawing.Styling.pointStyle.size;
					defaultPointStyle.graphicHeight = mygis.Drawing.Styling.pointStyle.size;
					defaultPointStyle.graphicOpacity = 1;
					defaultPointStyle.graphicXOffset=-16;
					defaultPointStyle.graphicYOffset=-32;
					retvalue = defaultPointStyle;

					break;
				case &#x27;line&#x27;:
					var defaultLineStyle = OpenLayers.Util.applyDefaults(defaultLineStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
					defaultLineStyle.strokeColor = mygis.Drawing.Styling.lineStyle.color;
					defaultLineStyle.strokeOpacity = mygis.Drawing.Styling.lineStyle.opacity;
					defaultLineStyle.strokeWidth = mygis.Drawing.Styling.lineStyle.width;
					defaultLineStyle.strokeDashstyle = &quot;longdashdot&quot;;
					retvalue = defaultLineStyle;

					break;
				case &#x27;polygon&#x27;:
					var defaultPolyStyle = OpenLayers.Util.applyDefaults(defaultPolyStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
					defaultPolyStyle.fillColor = mygis.Drawing.Styling.polyStyle.fillColor;
					defaultPolyStyle.fillOpacity = mygis.Drawing.Styling.polyStyle.fillOpacity;
					defaultPolyStyle.strokeColor = mygis.Drawing.Styling.polyStyle.strokeColor;
					defaultPolyStyle.strokeOpacity = mygis.Drawing.Styling.polyStyle.strokeOpacity;
					defaultPolyStyle.strokeWidth = mygis.Drawing.Styling.polyStyle.strokeWidth;
					retvalue = defaultPolyStyle;

					break;
				case &#x27;selectPolygon&#x27;:
					var defaultPolyStyle = OpenLayers.Util.applyDefaults(defaultPolyStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
					defaultPolyStyle.strokeColor = &quot;#000000&quot;;
					defaultPolyStyle.fillColor = &quot;#FF00FF&quot;;
					defaultPolyStyle.strokeOpacity = 1;
					defaultPolyStyle.fillOpacity = 0.5;
					defaultPolyStyle.strokeWidth = 0.7;
					retvalue = defaultPolyStyle;

					break;
				case &#x27;selectLine&#x27;:
					var defaultLineStyle = OpenLayers.Util.applyDefaults(defaultLineStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
					defaultLineStyle.strokeColor = &quot;#FF0000&quot;;
					defaultLineStyle.fillColor = &quot;#FF0000&quot;;
					defaultLineStyle.strokeOpacity = 1;
					defaultLineStyle.fillOpacity = 0.7;
					defaultLineStyle.strokeWidth = 0.7;
					retvalue = defaultLineStyle;
					break;
				case &#x27;selectPoint&#x27;:
					var defaultPointStyle = OpenLayers.Util.applyDefaults(defaultPointStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
					defaultPointStyle.strokeColor = &quot;#000000&quot;;
					defaultPointStyle.fillColor = &quot;#000000&quot;;
					defaultPointStyle.fillOpacity = 0.7;
					retvalue = defaultPointStyle;
					break;
			}
			return retvalue;
		},

		&#x2F;**
			Returns an OpenLayers config object for symbolizer
			@method getSymbolizer
			@param {String} type &#x27;Point&#x27;,&#x27;Line&#x27;, or &#x27;Polygon&#x27;
			@return {Object} The config object.
		**&#x2F;
		getSymbolizer: function(type){
			var retvalue=new Object();
			var inner;
			switch (type)
			{
				case &quot;Point&quot;:
					inner = new Object();
					inner.strokeColor = &quot;&quot;;	&#x2F;&#x2F;[String] Color for line stroke.
					inner.strokeOpacity = 1;	&#x2F;&#x2F;[Number] Stroke opacity (0-1).
					inner.strokeWidth = 1;	&#x2F;&#x2F;[Number] Pixel stroke width.
					inner.strokeLinecap = &quot;square&quot;;	&#x2F;&#x2F;[String] Stroke cap type (βbuttβ, βroundβ, or βsquareβ).
					inner.fillColor = &quot;#FF0000&quot;;	&#x2F;&#x2F;[String] RGB hex fill color .
					inner.fillOpacity = 1;	&#x2F;&#x2F;[Number] Fill opacity (0-1).
					inner.pointRadius = 5;	&#x2F;&#x2F;[Number] Pixel point radius.
					inner.externalGraphic = &quot;&quot;;	&#x2F;&#x2F;[String] Url to an external graphic that will be used for rendering points.
					inner.graphicWidth = 16;	&#x2F;&#x2F;[Number] Pixel width for sizing an external graphic.
					inner.graphicHeight = 16;	&#x2F;&#x2F;[Number] Pixel height for sizing an external graphic.
					inner.graphicOpacity = 1;	&#x2F;&#x2F;[Number] Opacity (0-1) for an external graphic.
					inner.graphicXOffset = 0;	&#x2F;&#x2F;[Number] Pixel offset along the positive x axis for displacing an external graphic.
					inner.graphicYOffset = 0;	&#x2F;&#x2F;[Number] Pixel offset along the positive y axis for displacing an external graphic.
					inner.rotation = 0;	&#x2F;&#x2F;[Number] The rotation of a graphic in the clockwise direction about its center point (or any point off center as specified by graphicXOffset and graphicYOffset).
					inner.graphicName = &quot;&quot;;	&#x2F;&#x2F;[String] Named graphic to use when rendering points.
					break;
				case &quot;Line&quot;:
					inner = new Object();
					inner.strokeColor = &quot;#FF0000&quot;;	&#x2F;&#x2F;[String] Color for line stroke.
					inner.strokeOpacity = 1;	&#x2F;&#x2F;[Number] Stroke opacity (0-1).
					inner.strokeWidth = 1;	&#x2F;&#x2F;[Number] Pixel stroke width.
					inner.strokeLinecap = &quot;square&quot;;	&#x2F;&#x2F;[String] Stroke cap type (βbuttβ, βroundβ, or βsquareβ).
					break;
				case &quot;Polygon&quot;:
					inner = new Object();
					inner.strokeColor = &quot;#FF0000&quot;;	&#x2F;&#x2F;[String] Color for line stroke.
					inner.strokeOpacity = 1;	&#x2F;&#x2F;[Number] Stroke opacity (0-1).
					inner.strokeWidth = 1;	&#x2F;&#x2F;[Number] Pixel stroke width.
					inner.strokeLinecap = &quot;square&quot;;	&#x2F;&#x2F;[String] Stroke cap type (βbuttβ, βroundβ, or βsquareβ).
					inner.fillColor = &quot;#FF0000&quot;;	&#x2F;&#x2F;[String] RGB hex fill color
					inner.fillOpacity = 1;	&#x2F;&#x2F;[Number] Fill opacity (0-1).
					break;
			}
			retvalue[type]=inner;
			return retvalue;
		},

		&#x2F;**
			Returns an SLD object

			@method createSLD
			@param {String} name The named identifier.
			@param {String} geomType &#x27;Point&#x27;,&#x27;Line&#x27;, &#x27;Polygon&#x27; or &#x27;Mixed&#x27;
			@return {Object} The sld object.
		**&#x2F;
		createSLD: function(name, geomType){
			var sld ={
				version: &quot;1.0.0&quot;,
				namedLayers: new Object()
			};
			var sldString;
			var retvalue = new Object();
			retvalue.name = name;
			retvalue.userStyles = [];
			retvalue.userStyles[0]= {
				rules: []
			};
			switch(geomType){
				case &#x27;Point&#x27;:
					retvalue.userStyles[0].rules.push(new mygis.Drawing.Styling.createSLDRule(&quot;&quot;,&quot;Point&quot;,name));
					break;
				case &#x27;Line&#x27;:
					retvalue.userStyles[0].rules.push(new mygis.Drawing.Styling.createSLDRule(&quot;&quot;,&quot;Line&quot;,name));
					break;
				case &#x27;Polygon&#x27;:
					retvalue.userStyles[0].rules.push(new mygis.Drawing.Styling.createSLDRule(&quot;&quot;,&quot;Polygon&quot;,name));
					break;
				case &#x27;Mixed&#x27;:
					retvalue.userStyles[0].rules.push(new mygis.Drawing.Styling.createSLDRule(&quot;&quot;,&quot;Point&quot;,name));
					retvalue.userStyles[0].rules.push(new mygis.Drawing.Styling.createSLDRule(&quot;&quot;,&quot;Line&quot;,name));
					retvalue.userStyles[0].rules.push(new mygis.Drawing.Styling.createSLDRule(&quot;&quot;,&quot;Polygon&quot;,name));
					break;
			}

			sld.namedLayers[name] = retvalue;
			return sld;
		},

		&#x2F;**
			Creates a named sld rule.

			@method createSLDRule
			@param {String} name The named identifier.
			@param {String} geometryType &#x27;Point&#x27;,&#x27;Line&#x27;, &#x27;Polygon&#x27; or &#x27;Text&#x27;
			@param {String} layername
			@return {Object} The sld rule for the given layer.
		**&#x2F;
		createSLDRule: function(name,geometryType,layername){
			var retvalue;
			var assignedName;

			if (name){
				assignedName=name;
			}else{
				switch (geometryType){
					case &quot;Point&quot;:
						assignedName = layername+&quot; - Points&quot;;
						break;
					case &quot;Line&quot;:
						assignedName = layername+&quot; - Lines&quot;;
						break;
					case &quot;Polygon&quot;:
						assignedName = layername+&quot; - Polygons&quot;;
						break;
					case &quot;Text&quot;:
						assignedName = layername+&quot; - labels&quot;;
						break;
					default:
						assignedName = layername;
				}
			}
			if (geometryType){
				var assignedSymbolizer = new mygis.Drawing.Styling.getSymbolizer(geometryType);
				retvalue= new OpenLayers.Rule({
					name: assignedName,
					title: assignedName,
					description: &#x27;&#x27;,
					symbolizer: assignedSymbolizer,
					filter: mygis.Drawing.Styling.getSLDFilter(&quot;EQ&quot;,&quot;Geometry&quot;,geometryType)
				});
			}else{
				retvalue= new OpenLayers.Rule({
					name: assignedName,
					title: assignedName,
					description: &#x27;&#x27;
				});
			}


			return retvalue;
		},

		&#x2F;**
			Creates an sld filter.

			@method getSLDFilter
			@param {String} comparison The type of comparison. Possible values: &quot;EQ&quot;, &quot;LIKE&quot;, &quot;NEQ&quot;, &quot;GEQ&quot;, &quot;GT&quot;, &quot;LT&quot;, &quot;LEQ&quot;
			@param {String} property The property to filter
			@param {String} value The filter&#x27;s value

			@return {Object} The sld filter.
		**&#x2F;
		getSLDFilter: function(comparison,property,value){
			var retvalue;
			var comptype;
			switch (comparison)
			{
				case &quot;EQ&quot;:
					comptype = OpenLayers.Filter.Comparison.EQUAL_TO;
					break;
				case &quot;LIKE&quot;:
					comptype = OpenLayers.Filter.Comparison.LIKE;
					break;
				case &quot;NEQ&quot;:
					comptype = OpenLayers.Filter.Comparison.NOT_EQUAL_TO;
					break;
				case &quot;GEQ&quot;:
					comptype = OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO;
					break;
				case &quot;GT&quot;:
					comptype = OpenLayers.Filter.Comparison.GREATER_THAN;
					break;
				case &quot;LT&quot;:
					comptype = OpenLayers.Filter.Comparison.LESS_THAN;
					break;
				case &quot;LEQ&quot;:
					comptype = OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO;
					break;
			}
			if (property==&quot;Geometry&quot; &amp;&amp; value!=&quot;Point&quot;){
				switch (value){
					case &quot;Polygon&quot;:
						retvalue = new OpenLayers.Filter.Logical({
							type: OpenLayers.Filter.Logical.OR,
							filters: [
								new OpenLayers.Filter.Comparison({
									type: comptype,
									property: property,
									value: value
								}),
								new OpenLayers.Filter.Comparison({
									type: comptype,
									property: property,
									value: &#x27;MultiPolygon&#x27;
								})
							]
						});
						break;
					case &quot;Line&quot;:
						retvalue = new OpenLayers.Filter.Logical({
							type: OpenLayers.Filter.Logical.OR,
							filters: [
								new OpenLayers.Filter.Comparison({
									type: comptype,
									property: property,
									value: &#x27;LineString&#x27;
								}),
								new OpenLayers.Filter.Comparison({
									type: comptype,
									property: property,
									value: &#x27;MultiLineString&#x27;
								})
							]
						});
						break;
				}
			}else{
				retvalue = new OpenLayers.Filter.Comparison({
								type: comptype,
								property: property,
								value: value
							});
			}
			return retvalue;
		},

		&#x2F;**
		 * Displays the Style Manager window
		 * @method showStyleManager
		 * @param {String} layerIDThe layer tablename to edit
		 *&#x2F;
		showStyleManager:function(layerID){
			var windowTitle=&quot;Manager&quot;;
			var myconfig = &quot;&quot;;
			if (layerID){

			}else{

			}
			$(&quot;#styleManagerTitleElem&quot;).html(windowTitle);
			&#x2F;&#x2F;myconfig.checkfn = ;
			&#x2F;&#x2F;myconfig.callbackfn = ;
			&#x2F;&#x2F;myconfig.objectCount = -1;
			&#x2F;&#x2F;myconfig.windowTitle = &quot;&quot;;
			$(&quot;#styleManager&quot;).dialog({
				autoOpen: true,
				modal: true,
				resizable: false,
				width: 900,
				height: 510,
				title: &quot;&quot;,
				closeOnEscape:false
			})
		},

		&#x2F;**
		 * Handles switching of tabs in theStyle Manager window
		 * @method styleManager_switchTab
		 * @param {Integer} index The tab index
		 *&#x2F;
		styleManager_switchTab: function(index){
			var tabHeaders = $(&quot;#styleManagerLinkTabsRound&quot;).find(&quot;.sectionHeader&quot;);
			for (var i=0;i&lt;tabHeaders.length;i++){
				if (i!=index){
						tabHeaders[i].ex_RemoveClassName(&quot;active&quot;);
				}else{
						tabHeaders[i].ex_AddClassName(&quot;active&quot;);
				}
			}
			var tabs = $(&quot;#styleManagerHeaderTab&quot;).find(&quot;.appSettingFrame&quot;);
			for (var i=0;i&lt;tabs.length;i++){
				if (i!=index){
						$(tabs[i]).hide();
				}else{
						$(tabs[i]).show();

				}
			}
		}
	},

	&#x2F;**
	Provides various objects and methods related to exporting the map and&#x2F;or its objects

	@class Drawing.Exporting
	@static
	**&#x2F;
    Exporting: {


		&#x2F;**
			Exports the current map with the &quot;KTIMATOLOGIO&quot; background

			@method exportMapAs
			@param {String} filetype The format to export to. Accepts &quot;jpg&quot;, &quot;png&quot;, &quot;pdf&quot;,&quot;kml&quot;, &quot;kmz&quot;
		**&#x2F;
		exportMapAs: function(filetype){
			var format;
			var bbox = digimap.getExtent().toBBOX();
			var srs = digimap.projection.toString();
			var size = digimap.getSize();
			var layersNormal=mygis.Utilities.getVisibleLayerString(currentAppName);
			var layerBG;
			switch (digimap.baseLayer.params.LAYERS){
				case &quot;landsat5&quot;:
				case &quot;KTBASEMAP&quot;:
				case &quot;landsat&quot;:
				case &quot;openstreetmap&quot;:
				case &quot;bluemarble&quot;:
					layerBG = digimap.baseLayer.params.LAYERS;
					break;
				default:
					layerBG = &quot;openstreetmap&quot;;
					break;
			}
			&#x2F;&#x2F;layerBG= &quot;KTBASEMAP&quot;;&#x2F;&#x2F;digimap.baseLayer.params.LAYERS;	&#x2F;&#x2F;TODO proper
			var layers=layerBG+&quot;,&quot;+layersNormal;
			var url;
			switch (filetype){
				case &quot;jpg&quot;:
					format = &quot;image&#x2F;jpeg&quot;;
					break;

				case &quot;png&quot;:
					format = &quot;image&#x2F;png&quot;;
					break;
				case &quot;pdf&quot;:
					format = &quot;application&#x2F;pdf&quot;;
					break;

				case &quot;kml&quot;:
					format = &quot;application&#x2F;vnd.google-earth.kml+xml&quot;;
					break;
				case &quot;kmz&quot;:
					format = &quot;application&#x2F;vnd.google-earth.kmz+xml&quot;;
					break;

			}
			url = mygis.Utilities.format(config.mapserver+&quot;wms?service=WMS&amp;version=1.1.0&amp;request=GetMap&amp;layers={0}&amp;styles=&amp;bbox={1}&amp;width={2}&amp;height={3}&amp;srs={4}&amp;format={5}&amp;TILED=TRUE&quot;,
				layers,bbox,size.w,size.h,srs,format);
			window.open(url);
		},

		&#x2F;**
			Exports the layer&#x27;s features to GeoJSON

			@method layerToJSON
			@param {Object} layer An OpenLayers layer
		**&#x2F;
		layerToJSON: function(layer){
			var retvalue=&quot;&quot;;
			var features = layer.features;
			var writer = new OpenLayers.Format.GeoJSON();
			retvalue = writer.write(features);
			return retvalue;
		},

		&#x2F;**
			Exports the layer&#x27;s features to WKT

			@method layerToWKT
			@param {Object} layer An OpenLayers layer
		**&#x2F;
		layerToWKT: function(layer){
			var retvalue=&quot;&quot;;
			var features = layer.features;
			var writer = new OpenLayers.Format.WKT();
			for (var i=0;i&lt;features.length;i++){
				if (i&gt;0){
					retvalue+=&quot;$&quot;;
				}
				features[i].geometry.transform(new OpenLayers.Projection(&quot;EPSG:900913&quot;),new OpenLayers.Projection(&quot;EPSG:4326&quot;));
				retvalue += writer.write(features[i]);
				features[i].geometry.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;));
			}
			&#x2F;&#x2F;retvalue = writer.write(features);
			return retvalue;
		},

		&#x2F;**
			Exports the features to WKT

			@method arrayToWKT
			@param {Array} featureArray An array of OpenLayers features
		**&#x2F;
		arrayToWKT: function(featureArray){
			var retvalue=&quot;&quot;;
			var features = featureArray;
			var writer = new OpenLayers.Format.WKT();
			for (var i=0;i&lt;features.length;i++){
				features[i].geometry.transform(new OpenLayers.Projection(&quot;EPSG:900913&quot;),new OpenLayers.Projection(&quot;EPSG:4326&quot;));
				if (i&gt;0){
					retvalue+=&quot;$&quot;;
				}
				retvalue += writer.write(features[i]);
			}

			return retvalue;
		},
		
		checkDigitizing: function(event){
			mygis.Drawing.Editing.attachFieldsToFeature(true);
			var dataObj = featuresUnsaved[featuresUnsaved.length-1].data;
			if(mygis.Drawing.Editing.isFilledIn(dataObj)){
				var errorsFound=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;form .error&quot;).length&gt;0;
				if (errorsFound){
					showConfirmationDialog(strings.Editing.loseAllChanges,function(){	
						var dialogContent=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;.ui-dialog-content&quot;);
						try{
							dialogContent.dialog(&#x27;destroy&#x27;);
							dialogContent.remove();
						}catch(err){}
						console.log(&quot;removed 1&quot;);
						mygis.UI.clearUnsavedLayer(layerCurrentEditing);
						digimap.layers[1].redraw(true);
						mygis.UI.activateControl(&#x27;drag&#x27;);
						
					},function(){console.log(&#x27;cancelled&#x27;);return false});
				}else{
					showConfirmationDialog(strings.Editing.saveNewObjQuestion,function(){
						var dialogContent=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;.ui-dialog-content&quot;);
						try{
							dialogContent.dialog(&#x27;destroy&#x27;);
							dialogContent.remove();
						}catch(err){}
						console.log(&quot;removed 2&quot;);
						mygis.Drawing.Exporting.saveDigitizing();	
					},function(){console.log(&#x27;cancelled&#x27;);return false});
				}
				return false;
			}else{
				cosmeticLayer.destroyFeatures();
				var dialogContent=$(event.target).closest(&quot;.ui-dialog&quot;).find(&quot;.ui-dialog-content&quot;);
				try{
					dialogContent.dialog(&#x27;destroy&#x27;);
					dialogContent.remove();
				}catch(err){}
				console.log(&quot;removed 3&quot;);
			}
		},
		
		checkRights: function(oid,layerID,operation){
			retvalue=false;
			if (!$.isEmptyObject(internalMemory.layerRights)){
				var fn2= function(elem){
					return elem.objectID==oid;
				}
				if (internalMemory.layerRights[layerID]){
					var object = internalMemory.layerRights[layerID].find(fn2);
					if (object){
						if ((operation==&#x27;update&#x27; || operation== null) &amp;&amp; (object.hasUpdate || object.isOwner)){
							retvalue=true;
						}
						if ((operation==&#x27;delete&#x27; || operation== null) &amp;&amp; (object.hasDelete || object.isOwner)){
							retvalue=true;
						}
					}
				}
			}
			return retvalue;
		},

		&#x2F;**
			Gets all unsaved features and saves them to the DB.

			@method saveDigitizing
		**&#x2F;
		saveDigitizing: function(){
			&#x2F;&#x2F;var elem=document.getElementById(&#x27;mapAction_Save&#x27;);
			&#x2F;&#x2F;if (!elem.ex_HasClassName(&#x27;disabled&#x27;)){
				if (featuresUnsaved.length&gt;=1){
					&#x2F;&#x2F;mygis.Drawing.Exporting.attachInfoToFeature();
				}
				&#x2F;&#x2F;$(&#x27;#editableInfo&#x27;).dialog(&#x27;close&#x27;);
				var layername = layerSource.records[layerCurrentEditing].layerTABLE;
				var postObject=new Object();
				var featuresAttr=&quot;&quot;;
				var featuresImages=&quot;&quot;;
				var featuresFiles=&quot;&quot;;
				var featArray = mygis.Drawing.Editing.getFinalChanges();

				&#x2F;&#x2F;Build strings for each unsaved feature
				$.each(featArray.featuresUnsaved,function(i,v){
					if (i&gt;0){
						featuresAttr+=&quot;$&quot;;
						featuresImages+=&quot;$&quot;;
						featuresFiles+=&quot;$&quot;;
					}
					&#x2F;&#x2F;column data string:
					var counter=0;
					$.each(v.data,function(j,vv){
						if (counter&gt;0){featuresAttr+=&quot;#&quot;;}
						featuresAttr += j.toString() +&quot;%&quot;+vv.toString();
						counter++;
					});
					&#x2F;&#x2F;attached images string:
					var imagecounter=0;
					if (v.attachedImages){
						$.each(v.attachedImages,function(k,vvv){
							if (imagecounter&gt;0){featuresImages+=&quot;#&quot;;}
							featuresImages+= vvv.toString();
							imagecounter++;
						});
					}
					&#x2F;&#x2F;attached files string:
					var filecounter=0;
					if (v.attachedFiles){
						$.each(v.attachedFiles,function(l,vvvv){
							if (filecounter&gt;0){featuresFiles+=&quot;#&quot;;}
							featuresFiles+= vvvv.toString();
							filecounter++;
						});
					}
				});

				&#x2F;&#x2F;----------NEW
				postObject[&quot;layerID&quot;]=layerSource.records[layerCurrentEditing].layerID;
				postObject[&quot;layername&quot;]=layername;
				postObject[&quot;featureAttr&quot;]=featuresAttr;
				postObject[&quot;featureImages&quot;]=featuresImages;
				postObject[&quot;featureFiles&quot;]=featuresFiles;
				postObject[&quot;geometry&quot;]=mygis.Drawing.Exporting.arrayToWKT(featArray.featuresUnsaved);
				postObject[&quot;crs&quot;]=digimap.displayProjection.toString();


				&#x2F;&#x2F;----------MODIFIED
				var writer = new OpenLayers.Format.WKT();
				var output = [];
				$.each(featArray.featuresModified, function(i,v){
					var mydata = &quot;&quot;;
					counter = 0;
					var outputItem={};
					&#x2F;*
					$.each(v.data,function(j,vv){
						if (counter&gt;0){mydata+=&quot;#&quot;;}
						mydata += j.toString() +&quot;%&quot;+vv.toString();
						counter+=1;
					});
					*&#x2F;
					var mydata = &quot;&quot;;
					counter = 0;
					if (v.attachedImages){
						$.each(v.attachedImages,function(j,vv){
							if (counter&gt;0){mydata+=&quot;#&quot;;}
							mydata+= vv.toString();
							counter+=1;
						});
					}
					
					outputItem.images=mydata;
					var mydata = &quot;&quot;;
					counter = 0;
					if (v.attachedFiles){
						$.each(v.attachedFiles,function(j,vv){
							if (counter&gt;0){mydata+=&quot;#&quot;;}
							mydata+= vv.toString();
							counter+=1;
						});
					}
					
					outputItem.files=mydata;
					outputItem.data = v.data;
					
					&#x2F;&#x2F;outputItem.geometry=writer.write(v);
					output.push(outputItem);
				});
				postObject[&quot;modified&quot;]=JSON.stringify(output);
				&#x2F;&#x2F;----------TO DELETE
				var output = &quot;&quot;;
				counter = 0;
				$.each(featArray.featuresDeleted,function(i,v){
					if (counter&gt;0){output+=&quot;#&quot;;}
					output += v;
					counter+=1;
				});
				postObject[&quot;deleted&quot;]=output;

				$.ajax({
				  type: &#x27;POST&#x27;,
				  url: config.mgreq+&quot;?qtype=SaveDigitizing&quot;,
				  data: postObject,
				  success: mygis.UI.saveDigiResults
				});
			&#x2F;*}else{

			}
			*&#x2F;
		},

		&#x2F;**
			TODO: Posts back the layer style.

			@method updateStyle

		**&#x2F;
		updateStyle: function(){
			var postObject=new Object();
			postObject[&quot;layer&quot;]=layername;
			postObject[&quot;sld&quot;]=null;	&#x2F;&#x2F;TODO
			$.ajax({
			  type: &#x27;POST&#x27;,
			  url: config.mgreq+&quot;?qtype=updateStyle&quot;,
			  data: postObject,
			  success: null	&#x2F;&#x2F;TODO
			});
		},

		&#x2F;**
			Attaches all fields in the editableInfo window to the last feature digitized.

			@method attachInfoToFeature
		**&#x2F;
		attachInfoToFeature: function(){
			var f = featuresUnsaved[featuresUnsaved.length-1];	&#x2F;&#x2F;last object
			var editwindow = $(&quot;#editableInfo&quot;);
			var fieldsToAttach = editwindow.find(&quot;.infoFields span.featureHCell&quot;);
			var fieldValues = editwindow.find(&quot;.infoFields input.featureVCell&quot;);
			$.each(fieldValues,function(i,v){
				f.data[$(fieldsToAttach[i]).html()]=v.value;
				v.value=&quot;&quot;;
			});
			displayNotify(strings.Editing.tempNewObj+layerSource.records[layerCurrentEditing].layerNAME);

		}


	},

	&#x2F;**
	Provides various objects and methods related to importing things into the current map

	@class Drawing.Importing
	@static
	**&#x2F;
	Importing: {

		&#x2F;**
			Loads a KML

			@method loadKML
			@param {String} kmlstring
			@param {String} layername
			@deprecated
        *&#x2F;
        loadKML: function(kmlstring,layername) {
			var realParse = function(nodes,options){

			}
            var format = new OpenLayers.Format.KML({
				&#x27;internalProjection&#x27;: digimap.baseLayer.projection,
				&#x27;externalProjection&#x27;: new OpenLayers.Projection(&quot;EPSG:4326&quot;),
				&#x27;extractStyles&#x27;: true,
				&#x27;extractAttributes&#x27;: true
			});

			var newLayer = new OpenLayers.Layer.Vector(layername);

			setTimeout(function(){
				newLayer.addFeatures(format.read(kmlstring));
			},25);
			digimap.addLayers([newLayer]);




        }
    }

};

&#x2F;&#x2F;END of mygis.Drawing

&#x2F;**
Methods used instead of OpenLayers default ones

@class OLOverrides
@static
**&#x2F;
mygis.OLOverrides = {

	CustomDragControl: OpenLayers.Class(OpenLayers.Control, {

		defaultHandlerOptions: {
			&#x27;stopDown&#x27;: false
			&#x2F;* important, otherwise it prevent the click-drag event from 
			   triggering the normal click-drag behavior on the map to pan it *&#x2F;
		},

		initialize: function(options) {
			this.handlerOptions = OpenLayers.Util.extend(
				{}, this.defaultHandlerOptions
			);
			OpenLayers.Control.prototype.initialize.apply(
				this, arguments
			); 
			this.handler = new OpenLayers.Handler.Drag(
				this, {
					&#x27;down&#x27;: this.onDown, &#x2F;&#x2F;could be also &#x27;move&#x27;, &#x27;up&#x27; or &#x27;out&#x27;
					&#x27;move&#x27;: this.onMove,
					&#x27;up&#x27;: this.onUp
				}, this.handlerOptions
			);
		}, 

		onDown: function(evt) {
			&#x2F;&#x2F; do something when the user clic on the map (so on drag start)
			&#x2F;&#x2F;console.log(&#x27;user clicked down on the map&#x27;);
		},
		onMove: function(evt){
			&#x2F;&#x2F;console.log(&#x27;user moved the map&#x27;);
		},
		onUp: function(evt){
			&#x2F;&#x2F;console.log(&#x27;user released the map&#x27;);
			internalMemory.lastZoom=digimap.getExtent();
		}
	}),
	
	&#x2F;**
		Provides overrides for OpenLayers.Control

		@class OLOverrides.mygis_Control
		@static
	**&#x2F;
	mygis_Control: {

			&#x2F;**
				Provides ovverrides for OpenLayers.Control.GetFeature

				@class OLOverrides.mygis_Control.mygis_GetFeature
				@static
			**&#x2F;
			mygis_GetFeature: {

				&#x2F;**
					Used instead of GetFeature.request. Adds any existing cql_filters to the spatial one.

					@method mygis_request
				**&#x2F;
		
				mygis_request: function(bounds, options) {
					options = options || {};
					var filter;
					if (customFiltered){
						var format = new OpenLayers.Format.CQL();
						var filterA_cql = mygis.Map.getCustomFilter(this.protocol.featureType);
						try{
						var filterA = format.read(filterA_cql);
						&#x2F;&#x2F;JK CHANGES - add the circle functionality
						if (this.circle){
							var filterB = new OpenLayers.Filter.Spatial({
								type: OpenLayers.Filter.Spatial.INTERSECTS,
								value: bounds
							});
						}else{
							var filterB = new OpenLayers.Filter.Spatial({
								type: this.filterType,
								value: bounds
							});
						}
						&#x2F;&#x2F;JK CHANGES END
						filter = new OpenLayers.Filter.Logical({
							type: OpenLayers.Filter.Logical.AND,
							filters: [filterA,filterB]
						});
						}catch(err){
							console.log(&quot;Error in converting CQL filter: &quot;+err.message);
							&#x2F;&#x2F;JK CHANGE - add the circle functionality
							if (this.circle) {
								filter = new OpenLayers.Filter.Spatial({ 
								type: OpenLayers.Filter.Spatial.INTERSECTS, 
								value: bounds &#x2F;* bounds is the geometry representing the circle *&#x2F; 
								}); 
							} else {
								filter = new OpenLayers.Filter.Spatial({ 
									type: this.filterType,  
									value: bounds
								});
							}
							&#x2F;&#x2F;JK CHANGES END
						}
					}else{
						&#x2F;&#x2F;JK CHANGE - add the circle functionality
						&#x2F;* Default OL functionality *&#x2F;
						if (this.circle) {
							filter = new OpenLayers.Filter.Spatial({ 
							type: OpenLayers.Filter.Spatial.INTERSECTS, 
							value: bounds &#x2F;* bounds is the geometry representing the circle *&#x2F; 
							}); 
						} else {
							filter = new OpenLayers.Filter.Spatial({ 
								type: this.filterType,  
								value: bounds
							});
						}
						&#x2F;&#x2F;JK CHANGES END
					}
					&#x2F;&#x2F; Set the cursor to &quot;wait&quot; to tell the user we&#x27;re working.
					mygis.Utilities.blockUI();
					&#x2F;&#x2F;OpenLayers.Element.addClass(this.map.viewPortDiv, &quot;olCursorWait&quot;);

					var response = this.protocol.read({
						maxFeatures: options.single == true ? this.maxFeatures : undefined,
						filter: filter,
						callback: function(result) {
							mygis.Utilities.unblockUI();
							if(result.success()) {
								if(result.features.length) {
									&#x2F;&#x2F;JK CHANGE
									if (this.circle){mygis.OLOverrides.mygis_Control.mygis_GetFeature.selectBestFeature_Circle(result.features,bounds.getCentroid(), options, this);}
									else{this.selectBestFeature(result.features,bounds.getCenterLonLat(), options);}
									&#x2F;&#x2F;JK CHANGE END
								} else if(options.hover) {
									this.hoverSelect();
								} else {
									this.events.triggerEvent(&quot;clickout&quot;);
									if(this.clickout) {
										this.unselectAll();
									}
								}
							}
							&#x2F;&#x2F; Reset the cursor.
							OpenLayers.Element.removeClass(this.map.viewPortDiv, &quot;olCursorWait&quot;);
						},
						scope: this
					});
					if(options.hover == true) {
						this.hoverResponse = response;
					}
				},

				&#x2F;**
					Used instead of GetFeature.selectBeastFeature, to overcome some conditions that we didn&#x27;t want applied.

					@method mygis_selectBestFeature
					@deprecated We now use mygis_selectBestFeature_v2 instead.
				**&#x2F;
				mygis_selectBestFeature: function(features, clickPosition, options) {
				options = options || {};
				if(features.length) {

						var point = new OpenLayers.Geometry.Point(clickPosition.lon,
							clickPosition.lat);
						var feature, resultFeature, dist;
						var minDist = Number.MAX_VALUE;
						var i;
						var areas = [];
						&#x2F;&#x2F; treat (multi)polygons separately
						for(i=features.length-1; i&gt;=0; i--) {
							feature = features[i];
							if(feature.geometry instanceof OpenLayers.Geometry.Polygon ||
							   feature.geometry instanceof OpenLayers.Geometry.MultiPolygon) {
								areas.push(features.pop());
							}
						}
						var compare = function(feature) {
							if(feature.geometry) {
								dist = point.distanceTo(feature.geometry, {edge: false});
								if(dist &lt; minDist) {
									minDist = dist;
									resultFeature = feature;
								}
							}
						};
						if (features.length) {
							&#x2F;&#x2F; points or linestring take precedence to any polygon
							for(i=0; i&lt;features.length; ++i) {
								feature = features[i];
								compare(feature);
							}
						} else {
							areas.reverse();
							for(i=0; i&lt;areas.length; ++i) {
								feature = areas[i];
								compare(feature);
							}
						}

						if(options.hover == true) {
							this.hoverSelect(resultFeature);
						} else {
							this.select(resultFeature || features);
						}

				}
			},

			&#x2F;**
				Used instead of GetFeature.selectBeastFeature, to overcome some conditions that we didn&#x27;t want applied.

				@method mygis_selectBestFeature_v2
			**&#x2F;
			mygis_selectBestFeature_v2: function(features){
				if (mygis.UI.isActiveSelectMode(&quot;mode_TopSelect&quot;)){
					var newFeatures = mygis.Map.selectTopFeatures(features);
					this.select(newFeatures);
				}else{
					this.select(features);
				}
			},
			&#x2F;&#x2F;JK CHANGES 
			&#x2F;**
			 * Used instead of GetFeature.selectBeastFeature, for circles
			 * Selects the feature from an array of features that is the best match
			 * for the click position.
			 *&#x2F;
			selectBestFeature_Circle: function(features, clickPosition, options, circle) {
				options = options || {};
				if(features.length) {
					var point = new OpenLayers.Geometry.Point(clickPosition.x,clickPosition.y);					
					var feature, resultFeature, dist;
					var minDist = Number.MAX_VALUE;
					for(var i=0; i&lt;features.length; ++i) {						
						feature = features[i];
						if(feature.geometry) {
							dist = point.distanceTo(feature.geometry, {edge: false});
							if(dist &lt; minDist) {
								minDist = dist;
								resultFeature = feature;
								if(minDist == 0) {break;}
							}
						}
					}					
					if(options.hover == true) {circle.hoverSelect(resultFeature);
					} else {						
						&#x2F;&#x2F;circle.select(resultFeature || features); &#x2F;&#x2F;unuseable coz circle mode
						&#x2F;&#x2F;recreate the .select function just for the circle mode
						features = features || resultFeature
						if(!circle.multiple &amp;&amp; !circle.toggle) {circle.unselectAll();}
						if(!(OpenLayers.Util.isArray(features))) {features = [features];}						
						var cont = circle.events.triggerEvent(&quot;beforefeaturesselected&quot;, {features: features});
						if(cont !== false) {
							var selectedFeatures = [];
							var feature;
							for(var i=0, len=features.length; i&lt;len; ++i) {
								feature = features[i];
								if(circle.features[feature.fid || feature.id]) {
									if(circle.toggle) {circle.unselect(circle.features[feature.fid || feature.id]);}
								} else {
									cont = circle.events.triggerEvent(&quot;beforefeatureselected&quot;, {feature: feature});
									if(cont !== false) {
										circle.features[feature.fid || feature.id] = feature;
										selectedFeatures.push(feature);								
										circle.events.triggerEvent(&quot;featureselected&quot;,{feature: feature});
									}
								}
							}
							circle.events.triggerEvent(&quot;featuresselected&quot;, {features: selectedFeatures});
						}
					}
				}
			}
			&#x2F;&#x2F;JK CHANGES END
		}
	}
};

&#x2F;&#x2F;END of mygis.OLOverrides

&#x2F;**
	All map related functions and main functionality.

	@class Map
	@static
**&#x2F;
mygis.Map = {

	&#x2F;**
		Overrides the default map to load.

		@method overrideDefaults
	**&#x2F;
	overrideDefaults: function(params){
		internalConfig.changeDefaultMap = params;
	},

    &#x2F;**
		Initializes variables
		@method setDigiVars
		@param contID The map container&#x27;s ID
		@param tools An array of integers, specifying tools to enable
		@param misc Various application parameters
    **&#x2F;
    setDigiVars: function(contID, tools, misc) {
		backgrounds = {
			google: {
				terrain: {
					name: strings.BackgroundLayers.google_terrain,
					options: {
						type: google.maps.MapTypeId.TERRAIN,
						numZoomLevels: 20,
						sphericalMercator:true,
						maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
						attribution: &quot;Map data ©2014 Basarsoft,Google&quot;
					},
					isWMS: false
				},
				roadmap: {
					name: strings.BackgroundLayers.google_roadmap,
					options: {
						type: google.maps.MapTypeId.ROADMAP,
						numZoomLevels: 20,
						sphericalMercator:true,
						maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
						attribution: &quot;Map data ©2014 Basarsoft,Google&quot;
					},
					isWMS: false
				},
				satellite: {
					name: strings.BackgroundLayers.google_satellite,
					options: {
						type: google.maps.MapTypeId.SATELLITE,
						numZoomLevels: 20,
						sphericalMercator:true,
						maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
						attribution: &quot;Map data ©2014 Basarsoft,Google&quot;
					},
					isWMS: false
				},
				hybrid: {
					name: strings.BackgroundLayers.google_hybrid,
					options: {
						type: google.maps.MapTypeId.HYBRID,
						numZoomLevels: 20,
						sphericalMercator:true,
						maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
						attribution: &quot;Map data ©2014 Basarsoft,Google&quot;
					},
					isWMS: false
				}
			},
			ktimatologio:{
				name:strings.BackgroundLayers.ktimatologio,
				url: &quot;http:&#x2F;&#x2F;gis.ktimanet.gr&#x2F;wms&#x2F;wmsopen&#x2F;wmsserver.aspx&quot;,
				options:{
					layers: &quot;KTBASEMAP&quot;,
					TILED: &quot;true&quot;,
					format: &quot;image&#x2F;png&quot;,
					CRS: &quot;EPSG:4326&quot;
				},
				secondaryOptions:{
					tileSize: new OpenLayers.Size(256,256),
					isBaseLayer: true,
					attribution: strings.BackgroundLayers.ktimatologio_attrib,
					buffer: 0
				},
				mg_MinScale: -1,
				mg_MaxScale: 27000000,
				isWMS: true
			},
			
			opengeo_BLUEMARBLE: {
				name:strings.BackgroundLayers.opengeo_BLUEMARBLE,
				url: &quot;http:&#x2F;&#x2F;maps.opengeo.org&#x2F;geowebcache&#x2F;service&#x2F;wms&quot;,
				options:{
					layers: &quot;bluemarble&quot;,
					TILED: &quot;true&quot;,
					format: &quot;image&#x2F;jpeg&quot;,
					CRS: &quot;EPSG:4326&quot;
				},
				secondaryOptions:{
					tileSize: new OpenLayers.Size(256,256),
					isBaseLayer: true,
					attribution: strings.BackgroundLayers.opengeo_BLUEMARBLE_attrib,
					buffer: 0
				},
				mg_MinScale: 800000,
				mg_MaxScale: -1
			},
			
			opengeo_OSM:{
				name:strings.BackgroundLayers.opengeo_OSM,
				url: &quot;http:&#x2F;&#x2F;maps.opengeo.org&#x2F;geowebcache&#x2F;service&#x2F;wms&quot;,
				options:{
					layers: &quot;openstreetmap&quot;,
					TILED: &quot;true&quot;,
					format: &quot;image&#x2F;png&quot;,
					CRS: &quot;EPSG:4326&quot;
				},
				secondaryOptions:{
					tileSize: new OpenLayers.Size(256,256),
					isBaseLayer: true,
					attribution: strings.BackgroundLayers.opengeo_OSM_attrib
				},
				mg_MinScale: -1,
				mg_MaxScale: -1,
				isWMS: true
			},
			nasa_LANDSAT:{
				name:strings.BackgroundLayers.nasa_LANDSAT,
				url: &quot;http:&#x2F;&#x2F;irs.gis-lab.info&#x2F;&quot;,
				options:{
					layers: &quot;landsat&quot;,
					TILED: &quot;true&quot;,
					format: &quot;image&#x2F;jpeg&quot;,
					CRS: &quot;EPSG:4326&quot;
				},
				secondaryOptions:{
					tileSize: new OpenLayers.Size(256,256),
					isBaseLayer: true,
					attribution: strings.BackgroundLayers.nasa_LANDSAT_attrib
				},
				mg_MinScale: -1,
				mg_MaxScale: -1,
				isWMS: true
			}
			
		};
		digiContainer = document.getElementById(contID);
		if (misc) {
			try {
				if (misc[0]) {appPath = misc[0];}
				&#x2F;&#x2F;if (misc[1]) {layerlist = document.getElementById(misc[1]);}
				if (misc[2]) {postbackurl = misc[2];}
				if (misc[3]) {extra = misc[3];}
				if (misc[4]) {myguid = misc[4];}
				if (misc[5]) {postbackurl = misc[5];}
			} catch (Error) { }
		}

		if (tools) {
			for (var i = 0; i &lt; tools.length; i++) {
				switch (tools[i]) {
					case 0:
						toolsEnabled.allTools = true;
						break;
					case 1:
						toolsEnabled.toolbar = true;
						break;
					case 2:
						toolsEnabled.search = true;
						break;
					case 3:
						toolsEnabled.maps = true;
						break;
					case 4:
						toolsEnabled.layers = true;
						break;
					case 5:
						toolsEnabled.marker = true;
						break;
					case 6:
						toolsEnabled.filledRect = true;
						break;
					case 7:
						toolsEnabled.openRect = true;
						break;
					case 8:
						toolsEnabled.filledCircle = true;
						break;
					case 9:
						toolsEnabled.openCircle = true;
						break;
					case 10:
						toolsEnabled.openPolygon = true;
						break;
					case 11:
						toolsEnabled.filledPolygon = true;
						break;
					case 12:
						toolsEnabled.polyLine = true;
						break;
					case 13:
						toolsEnabled.polyLineDirections = true;
						break;
					case 14:
						toolsEnabled.database = true;
						break;
				}
			}
		}
		mygis.Map.initMap();


    },

    &#x2F;**
		Initializes the map object and services
		@method initMap
    **&#x2F;
    initMap: function() {
       $.when( loadGoogleMaps( 3, null, &#x27;el-GR&#x27; ) )
			.then(function() {
				mygis.Utilities.googleAutoComplete();
		});
	   var sphericalMercator = new OpenLayers.Projection(&quot;EPSG:900913&quot;);
		var wgs84 = new OpenLayers.Projection(&quot;EPSG:4326&quot;);
		naviControls = {
			navigation: new OpenLayers.Control.Navigation({
				handleRightClicks: false,
				autoActive:true,
				dragPanOptions: {enableKinetic: true}
			}),
			zoomBox: new OpenLayers.Control.ZoomBox()
		};
		var mapserver = new OpenLayers.Layer.WMS(&quot;OpenLayers WMS&quot;,
			&quot;http:&#x2F;&#x2F;vmap0.tiles.osgeo.org&#x2F;wms&#x2F;vmap0&quot;,
			{ layers: &#x27;basic&#x27;, gutter:0,buffer:0,isBaseLayer:true,transitionEffect:&#x27;resize&#x27;,
			
			units:&quot;dd&quot;,
			&#x2F;*maxExtent: new OpenLayers.Bounds(-180.000000,-90.000000,180.000000,90.000000),*&#x2F;
			&#x2F;&#x2F;projection: new OpenLayers.Projection(&quot;EPSG:4326&quot;.toUpperCase()),
			&#x2F;&#x2F;sphericalMercator: false,
			visibility: false,
			attribution: &#x27;Provided by &lt;a href=&quot;http:&#x2F;&#x2F;www.osgeo.org&quot; target=&quot;_blank&quot;&gt;OSGeo&lt;&#x2F;a&gt;&#x27;
			},
			{wrapDateLine: true}
		);
		
		digimap = new OpenLayers.Map(digiContainer.id, {
			units: &#x27;m&#x27;,
			projection: sphericalMercator,
			displayProjection: wgs84,
			fractionalZoom: false,
			
			maxExtent: new OpenLayers.Bounds(
                -128 * 156543.0339,
                -128 * 156543.0339,
                128 * 156543.0339,
                128 * 156543.0339),
                maxResolution: 156543.0339,
				
			controls: [

				new OpenLayers.Control.ScaleBar({
					&#x27;div&#x27;: OpenLayers.Util.getElement(&#x27;olScaleLine_wrapper&#x27;),
					geodesic: true ,
					minWidth: 150,
					abbreviateLabel:true
				}),
				new OpenLayers.Control.Permalink({
					&#x27;id&#x27;: &#x27;permalink&#x27;,
					&#x27;element&#x27;: OpenLayers.Util.getElement(&#x27;permaElem&#x27;),
					&#x27;div&#x27;: OpenLayers.Util.getElement(&#x27;permaContainer&#x27;)
				}),
				new OpenLayers.Control.Attribution({
					template: &#x27;© 2012 AVMap GIS S.A., MyGIS™ , ${layers}&#x27;,
					&#x27;div&#x27;: OpenLayers.Util.getElement(&#x27;customAttribution&#x27;)
				}),
				new OpenLayers.Control.MousePosition({&#x27;div&#x27;:OpenLayers.Util.getElement(&#x27;ll_mouse&#x27;), id: &#x27;ll_mouse&#x27;,formatOutput: mygis.Utilities.formatLonlats})
			]
                
		});
		digimap.addControl(naviControls.navigation);
		digimap.addControl(naviControls.zoomBox);
		digimap.addControl(new mygis.OLOverrides.CustomDragControl({&#x27;autoActivate&#x27;: true}));
		bg1 = new OpenLayers.Layer(&quot;No Basemap&quot;, {isBaseLayer: true});
		
		var bg1 = new OpenLayers.Layer.Google(
				&quot;Google Hybrid&quot;,
				{ type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
			); 

		digimap.addLayers([bg1]);
		

		naviControls.overview= new OpenLayers.Control.OverviewMap({
				&#x27;div&#x27;:OpenLayers.Util.getElement(&#x27;customOverview&#x27;),
				size: new OpenLayers.Size(245,104),
				layers: [mapserver.clone()],
				maximized: true,
				autoPan: true,
				mapOptions: {
					tileSize: new OpenLayers.Size(104,104),
					zoom: 5
				}
			});
		
		naviControls.overview.isSuitableOverview = function() {
			return false;
		};
		digimap.addControl(naviControls.overview);
		&#x2F;&#x2F;naviControls.overview.maxRatio=25;
		&#x2F;&#x2F;naviControls.overview.maxRatio = naviControls.overview.map.getResolution()&#x2F;digimap.getResolutionForZoom(digimap.numZoomLevels);
		&#x2F;&#x2F;naviControls.overview.minRatio = naviControls.overview.map.getResolution()&#x2F;digimap.getResolutionForZoom(0);

		digimap.events.register(&quot;zoomend&quot;,digimap,function(){
			document.getElementById(&#x27;currentScale&#x27;).innerHTML = &quot;&lt;span class=&#x27;scalepart1&#x27;&gt;1&lt;&#x2F;span&gt;&lt;span class=&#x27;scalepart2&#x27;&gt;:&lt;&#x2F;span&gt;&lt;span class=&#x27;scalepart3&#x27;&gt; &quot;+mygis.Utilities.addCommas(digimap.getScale().toFixed(0))+&quot;&lt;&#x2F;span&gt;&quot;;
			document.getElementById(&#x27;currentScale&#x27;).innerHTML = &quot;1: &quot;+mygis.Utilities.addCommas(digimap.getScale().toFixed(0));
			&#x2F;&#x2F;try{$(&quot;#olScale_wrapper&quot;).linkselect(&quot;val&quot;,&quot;1: &quot;+mygis.Utilities.addCommas(digimap.getScale().toFixed(0)));}catch(err){}
			mygis.Map.checkScaleConstraints();
		});
		
		digimap.events.register(&quot;moveend&quot;,digimap,function(){
			clearTimeout(internalConfig.moveendEvent);
			internalConfig.moveendEvent = setTimeout(mygis.Map.moveEnd,500);
		});
		
		mygis.UI.createContextMenu(&quot;map&quot;);
		var styleMap = new OpenLayers.StyleMap(OpenLayers.Util.applyDefaults({
			externalGraphic:config.folderPath+&quot;Images&#x2F;target4.png&quot;,
			graphicWidth: 24,
			graphicHeight: 24,
			graphicXOffset:-12,
			graphicYOffset:-12,
			graphicOpacity:1
		},OpenLayers.Feature.Vector.style[&quot;default&quot;]));

		cosmeticLayer = new OpenLayers.Layer.Vector(&quot;Cosmetic Layer&quot;,{
			
			preFeatureInsert: function(feature) {
				&#x2F;&#x2F;feature.geometry.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;))
		   }
		   
		});
		selectionLayer = new OpenLayers.Layer.Vector(&quot;Selection Layer&quot;,{
			styleMap:styleMap,
			
			preFeatureInsert: function(feature) {
				&#x2F;*
				console.log(feature.geometry.toString());
				console.log(feature.attributes.OID);
				*&#x2F;
				var y=feature.geometry.getCentroid().y;
				if (y&lt;90 &amp;&amp; y&gt;-190){
					feature.geometry.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;))
				}
		   }
		   
			
		});
		feedbackLayer = new OpenLayers.Layer.Vector(&quot;Feedback Layer&quot;,{
			
			preFeatureInsert: function(feature) {
				var y=feature.geometry.getCentroid().y;
				if (y&lt;90 &amp;&amp; y&gt;-190){
					feature.geometry.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;))
				}
		   }
		   
		});

		digimap.addLayers([cosmeticLayer,selectionLayer,feedbackLayer]);

		var defaultPointStyle = OpenLayers.Util.applyDefaults(defaultPointStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
		drawControls = {
			marker: new OpenLayers.Control.DrawFeature(cosmeticLayer,
				OpenLayers.Handler.Point,{
					featureAdded: function(feature){
						feature.overlaytype = &quot;marker&quot;;
						mygis.UI.increaseMarkers(feature);
					}
				}
			),
			polyline: new OpenLayers.Control.DrawFeature(cosmeticLayer,
				OpenLayers.Handler.Path,{
					featureAdded: function(feature){
						feature.overlaytype = &quot;polyline&quot;;
						mygis.UI.increasePolylines(feature);
					}
				}
			),
			polygon: new OpenLayers.Control.DrawFeature(cosmeticLayer,
				OpenLayers.Handler.Polygon,{
					featureAdded: function(feature){
						feature.overlaytype = &quot;polygon&quot;;
						mygis.UI.increasePolygons(feature);
					}
				}
			),
			rectangle: new OpenLayers.Control.DrawFeature(cosmeticLayer,
				OpenLayers.Handler.RegularPolygon, {
					featureAdded: function(feature){
						feature.overlaytype = &quot;rectangle&quot;;
						mygis.UI.increasePolygons(feature);
					}
				}
			),
			modify: new OpenLayers.Control.ModifyFeature(cosmeticLayer,{
				mode: OpenLayers.Control.ModifyFeature.RESHAPE,
				createVertices: true

			}),
			selection: new OpenLayers.Control.DrawFeature(selectionLayer,
				OpenLayers.Handler.Point,{
					handlerOptions: {
						&#x2F;&#x2F;style:mygis.Drawing.Styling.getOLStyle(&#x27;point&#x27;)
						style: mygis.Drawing.Styling.getOLStyle(&#x27;point&#x27;)
					},
					featureAdded: function(feature){
						feature.style = mygis.Drawing.Styling.getOLStyle(&#x27;point&#x27;);

						this.layer.redraw();
					}
				}
			)

		};
		for(var key in drawControls) {
			digimap.addControl(drawControls[key]);
		}


		var thelogo = mygis.Map.createLogo();
		$(&quot;#avlogo_wrapper&quot;).append(thelogo);

		mygis.UI.setProjectionTip();
		
		
		
		&#x2F;&#x2F;mygis.Utilities.googleAutoComplete();
		
		mygis.UI.createEditableInfo();
		mygis.Map.infoInit();
		$(document).bind(&#x27;keydown&#x27;,function(event){
			if (event.ctrlKey || event.metaKey) {
				switch (String.fromCharCode(event.which).toLowerCase()) {
					case &#x27;i&#x27;:
						event.preventDefault();
						router(&#x27;selectCtrl&#x27;,document.getElementById(&#x27;infoTool&#x27;));
						break;
					case &#x27;f&#x27;:
						event.preventDefault();
						router(&#x27;mapFeatureSearchOpen&#x27;);
						break;
				}
			}else{
				switch (event.which){
					case 27:
						if ($(&quot;#mapFeatureSearchBar&quot;).is(&quot;:visible&quot;)){
							event.preventDefault();
							router(&#x27;mapFeatureSearchClose&#x27;);
						}
						try{
							$.xhrPool.abortAll();
							mygis.Utilities.unblockUI();
						}catch(err){}
						break;
				}
			}
		});
		$(&quot;#mapFeatureSearch&quot;).bind(&#x27;keydown&#x27;,function(event){
			if(event.keyCode==13){
				internalMemory.searchKeyword = $(&quot;#mapFeatureSearch&quot;).val();
				if (!$(&quot;#mapFeaturesCont&quot;).is(&quot;:visible&quot;)){
					$(&quot;#mapFeaturesCont&quot;).show();
					$(&quot;#mapResultsToggleBtn&quot;).attr(&quot;class&quot;,&quot;pressed&quot;);
					mygis.Map.moveEnd();
				}else{
					mygis.Map.gotoNextFeatureResult();
				}
				
			}
		});
		
    },

	&#x2F;**
		Creates a new layer.

		@method createNewLayer
		@param {String} name
	**&#x2F;
	createNewLayer: function(name){
		var newItem = {};
		$.each(layerSource.records[0],function(key,value){
			newItem[key]=&quot;&quot;;
		});
		newItem.mapID=$(&quot;#mapsList&quot;).jqxListBox(&#x27;getSelectedItem&#x27;).originalItem.id;
		newItem.layerNAME = name;
		newItem.layerTABLE = currentAppName + &quot;_&quot;+name;
		layerSource.records.splice(0,0,newItem);
		mygis.UI.updateLayerGrid();
	},
	
	moveEnd: function(){
		&#x2F;&#x2F;if (!maplayout.state.south.isClosed){
		naviControls.overview.ovmap.setCenter(digimap.getCenter());
		if ($(&quot;#mapFeaturesCont&quot;).is(&quot;:visible&quot;)){
			var bounds = digimap.getExtent().transform(digimap.getProjection(),new OpenLayers.Projection(&quot;EPSG:4326&quot;)).toString();
			clearTimeout(internalConfig.moveendEvent);
			digimap.events.remove(&quot;moveend&quot;);	&#x2F;&#x2F;to prevent more calls while calculating
			var tablenames=[];
			$.each(layerSource.records,function(x,item){
				if (!(Boolean(item.hidden)===true) &amp;&amp; (Boolean(item.Selectable)===true)){
					tablenames.push(item.layerTABLE);
				}
			});
			var data={
				extent: bounds,
				layers: tablenames
			};
			var customUrl = config.mgreq+&quot;?qtype=GetFeatureCount&amp;qContents=&quot;+JSON.stringify(data);
			$(&quot;#mapFeaturesCont&quot;).die().empty();
			$(&quot;#mapFeaturesCont&quot;).addClass(&quot;loading&quot;);
			$.ajax({
				type:&quot;GET&quot;,
				url: customUrl,
				success: function(data){
					var results = eval(data);
					
					$(&quot;#mapFeaturesCont&quot;).data(&quot;results&quot;,results);
					
					var counter=0;
					$.each(results,function(x,result){
						var output=$(&quot;&lt;div id=&#x27;featureResult_&quot;+counter+&quot;&#x27; class=&#x27;featureResult&#x27; &#x2F;&gt;&quot;);
						var label =$(&quot;&lt;h3 class=&#x27;resultLabel&#x27;&gt;&quot;+mygis.Utilities.getFriendlyName(result.TableName)+&quot;&lt;&#x2F;h3&gt;&quot;);
						output.append(&quot;&lt;div id=&#x27;featureResultGrid_&quot;+counter+&quot;&#x27; &#x2F;&gt;&quot;);
						$(&quot;#mapFeaturesCont&quot;).append(label);
						$(&quot;#mapFeaturesCont&quot;).append(output);
						counter++;
					});
					&#x2F;&#x2F;maplayout.show(&#x27;south&#x27;);
					var counter=0;
					$.each(results,function(x,result){
						var resultArray=[];
						var mycolumns=[];
						var layerID=mygis.Utilities.mggetLayerID(result.TableName);
						$.each(result.Fields,function(x,field){
							if (mygis.Drawing.Editing.isValidOutputIntern(field.Name)){
								var col={
									text:internalMemory.layerFields[layerID][field.Name].friendlyName,
									datafield: field.Name
								};
								mycolumns.push(col);
							}
						});
						$.each(result.Rows,function(x,row){
							var item={};
							$.each(row.Cells,function(y,cell){
								if (mygis.Drawing.Editing.isValidOutputIntern(cell.ColumnName)){
									item[cell.ColumnName]=cell.Value;
								}
							});
							resultArray.push(item);
						});
						var source= {
							datatype: &#x27;array&#x27;,
							localdata: resultArray
						};
						$(&quot;#featureResultGrid_&quot;+counter).jqxGrid({
							source:source,
							width: &#x27;100%&#x27;,
							rowheight: 29,
							autoheight: true, 
							theme: &#x27;pk_mg&#x27;,
							columns:mycolumns,
							enableanimations: true,
							enabletooltips: true,
							rowdetails: false,
							sortable: true,
							groupable: false,
							showheader: true,
							showgroupsheader: false,
							editable: false,
							pageable: false,
							columnsresize: true,
							columnsmenu: false,
							columnsreorder: true,
							pageable: true,
							pagesize: 5,
							pagesizeOptions: [5,10,20,50,100,200],
							selectionmode: &#x27;singlecell&#x27;&#x2F;&#x2F;,
							&#x2F;&#x2F;scrollbarsize: 5
						});
						
						counter++;
					});
					try{
						$(&quot;#mapFeaturesCont&quot;).accordion(&#x27;destroy&#x27;);
					}catch(err){}
					$(&quot;#mapFeaturesCont&quot;).accordion({ 
						fillSpace:true,  
						heightStyle: &#x27;auto&#x27;, 
						active: 0, 
						collapsible: true,
						activate: function(event){
							var counter=0;
							var id =arguments[1].newPanel[0].id.split(&quot;_&quot;)[1];
							&#x2F;&#x2F;console.log(&#x27;id :&#x27;+id);
							$(&quot;#featureResultGrid_&quot;+id).jqxGrid(&#x27;render&#x27;);
							&#x2F;*
							$.each($(&quot;#mapFeaturesCont .featureResult&quot;),function(x,item){
								$(&quot;#featureResultGrid_&quot;+counter).jqxGrid(&#x27;render&#x27;);
								counter++;
							});
							*&#x2F;
							$(&quot;#mapFeaturesCont&quot;).scrollTo($(&quot;#mapFeaturesCont .resultLabel.ui-state-active&quot;));
						},
						create: function(event){
							internalMemory.mapFeatureResults=null;
							if (internalMemory.searchKeyword){
								
								mygis.Map.highlightMapFeatureResult(internalMemory.searchKeyword);
								&#x2F;&#x2F;internalMemory.searchKeyword = &quot;&quot;;
							}
						}
					});
					$(&quot;#mapFeaturesCont&quot;).removeClass(&quot;loading&quot;);
				}
			});
			digimap.events.register(&quot;movestart&quot;,digimap,function(){
				$(&quot;#mapFeaturesCont&quot;).die().empty();
				$(&quot;#mapFeaturesCont&quot;).addClass(&quot;loading&quot;);
			});
			digimap.events.register(&quot;moveend&quot;,digimap,function(){
				clearTimeout(internalConfig.moveendEvent);
				internalConfig.moveendEvent = setTimeout(mygis.Map.moveEnd,500);
			});
		}
	},
	
	getFieldDescriptions: function(){
		var records = layerSource.records;
		$.each(records,function(i,v){
			var id=v.layerID;
			var name=v.layerTABLE;
			$.ajax({
				type: &quot;GET&quot;,
				url: config.mgreq+&quot;?qtype=GetLayerFields&amp;qContents=&quot;+escape(name.replace(&#x2F; &#x2F;g,&quot;_&quot;)),
				success: function(data){
					var results=eval(data);
					$.each(results,function(i, result){
						if (!internalMemory.layerFields[result.layerID]){
							internalMemory.layerFields[result.layerID]={};
						}
						var store = internalMemory.layerFields[result.layerID];
						store[result.fieldNAME]=(result);
					});
				}
			});
		});
	},
	
	showSearchPanel: function(){
		mygis.UI.resetControls();
		$(&quot;#mapFeatureSearchBar&quot;).show();
		$(&quot;#mapFeatureSearch&quot;).focus();
	},
	
	hideSearchPanel: function(){
		$(&quot;#mapFeatureSearchBar&quot;).hide();
		mygis.UI.Help.shortcutStart();
		$(&quot;#mapFeatureSearch&quot;).val(&quot;&quot;);
		internalMemory.searchKeyword = &quot;&quot;;
	},
	
	highlightMapFeatureResult: function(text){
		var search = text.toUpperCase();
		var data = $(&quot;#mapFeaturesCont&quot;).data(&quot;results&quot;);
		var results=[];
		$.each(data,function(x,result){
			var tablename = result.TableName;
			$.each(result.Rows,function(y,row){
				$.each(row.Cells,function(z,cell){
					if (mygis.Drawing.Editing.isValidOutputIntern(cell.ColumnName)){
						if (cell.Value.toUpperCase().contains(search)){
							var obj={
								tableName: tablename,
								tableIndex: x,
								rowIndex: y,
								cellIndex: z,
								cellName: cell.ColumnName
							};
							results.push(obj);
						}
					}
				});
			});
		});
		internalMemory.mapFeatureResults=results;
		internalMemory.mapFeatureCurrentIndex=-1;
		mygis.Map.gotoNextFeatureResult();
	},
	
	gotoNextFeatureResult: function(){
		if (internalMemory.mapFeatureResults){
			var len = internalMemory.mapFeatureResults.length;
			var ind = internalMemory.mapFeatureCurrentIndex;
			if (ind+1&gt;=len){
				ind=0;
			}else{
				ind++;
			}
			internalMemory.mapFeatureCurrentIndex=ind;
			mygis.Map.showFeatureResult();
		}else{
			var search = $(&quot;#mapFeatureSearch&quot;).val();
			if (search){
				mygis.Map.highlightMapFeatureResult(search);
			}
		}
		
	},
	
	gotoPreviousFeatureResult: function(){
		if (internalMemory.mapFeatureResults){
			var len = internalMemory.mapFeatureResults.length;
			var ind = internalMemory.mapFeatureCurrentIndex;
			if (ind-1&lt;0){
				ind=len-1;
			}else{
				ind--;
			}
			internalMemory.mapFeatureCurrentIndex=ind;
			mygis.Map.showFeatureResult();
		}else{
			var search = $(&quot;#mapFeatureSearch&quot;).val();
			if (search){
				mygis.Map.highlightMapFeatureResult(search);
			}
		}
	},
	
	showFeatureResult:function(){
		var result = internalMemory.mapFeatureResults[internalMemory.mapFeatureCurrentIndex];
		try{
			$(&quot;#mapFeaturesCont&quot;).accordion(&#x27;option&#x27;,&#x27;active&#x27;,result.tableIndex);
			
		}catch(err){}
		$(&quot;#featureResultGrid_&quot;+result.tableIndex).jqxGrid(&#x27;ensurerowvisible&#x27;, result.rowIndex);
		$(&quot;#featureResultGrid_&quot;+result.tableIndex).jqxGrid(&#x27;selectcell&#x27;, result.rowIndex, result.cellName);
	},
	&#x2F;**
		Creates an OpenLayers.Layer.WMS object
		@method getBackgroundWMS
		@param {String} name
		@return {Object} The WMS layer
	**&#x2F;
	getBackgroundWMS: function(name){
		var queriedObj = backgrounds[name];
		var retobj;
		if (queriedObj){
			retobj = new OpenLayers.Layer.WMS(queriedObj.name, queriedObj.url,queriedObj.options,queriedObj.secondaryOptions);
		}
		retobj.mg_MinScale = queriedObj.mg_MinScale;
		retobj.mg_MaxScale = queriedObj.mg_MaxScale;
		return retobj;
	},
	
	&#x2F;**
		Creates an OpenLayers.Layer for background
		@method getBackground
		@param {String} name
		@return {Object} The OpenLayers.Layer
	**&#x2F;
	getBackground: function(name){
		var nameparts = name.split(&quot;.&quot;);
		var twopart = nameparts.length&gt;1?true:false;
		var layer;
		if (twopart){
			switch (nameparts[0]){
				case &quot;google&quot;:
					var qObj = backgrounds[nameparts[0]][nameparts[1]];
					layer = new OpenLayers.Layer.Google(qObj.name,qObj.options);
					break;
			}
		}else{
			switch (name){
				case &quot;&quot;:
				
					break;
				default: 
					layer = mygis.Map.getBackgroundWMS(name);
			}
		}
		return layer;
	},

	&#x2F;**
	 * Switches one of the available backgrounds
	 * @method switchBackground
	 * @param {String} bgname The background name as stored in the backgrounds object
	 * @param {Integer} index The index of the background to switch
	 *&#x2F;
	switchBackground: function(bgname,index){
		var newlayer = mygis.Map.getBackground(bgname);	&#x2F;&#x2F;mygis.Map.getBackgroundWMS(bgname);
		var layerToSwitch = digimap.layers[index];
		digimap.addLayer(newlayer);
		if (layerToSwitch.isBaseLayer){digimap.setBaseLayer(newlayer);}
		digimap.removeLayer(layerToSwitch);
		digimap.setLayerIndex(newlayer,index);
		mygis.UI.updateLayerGrid();
	},

	&#x2F;**
		Creates a custom filter for layers.

		@method getCustomFilter
		@param {String} specificList A comma-delimited string of layer names
		@return {String} either the combined filters (if they exist) or an &#x27;always true&#x27; filter.
	**&#x2F;
	getCustomFilter: function(specificList){
		var retvalue=&quot;&quot;;
		var recs = layerSource.records;
		var myCustomFilters = internalConfig.myCustomFilters;
		var fullLayers=[];

		if (specificList==undefined){
		&#x2F;*
		*	Get a list of all visible layers
		*&#x2F;
		for (var i=recs.length-1;i&gt;=0;i--)
		{
			if (!(Boolean(recs[i].hidden)===true)){
				var layername = recs[i].layerTABLE;
				fullLayers.push(layername);
			}
		}
		}else{
			fullLayers=specificList;
		}
		&#x2F;*
		*	For those layers, either get the combined filters (if they exist)
		*	or enter an &#x27;always true&#x27; filter.
		*&#x2F;
		for (var i=0;i&lt;fullLayers.length;i++){
			if (i&gt;0){
				retvalue+=&quot;;&quot;
			}
			if (myCustomFilters[fullLayers[i]]){
				var propCounter =0;
				for (prop in myCustomFilters[fullLayers[i]]){
					var insertValue = myCustomFilters[fullLayers[i]][prop];
					var secondItem=false;
					if (propCounter&gt;0 &amp;&amp; insertValue!=null){
						retvalue += &quot; AND (&quot;;
						secondItem=true;
					}
					if (insertValue){
						retvalue += insertValue;
						if (secondItem){
							retvalue += &quot;)&quot;;
						}
					}
					propCounter+=1;
				}
				&#x2F;&#x2F;retvalue += myCustomFilters[fullLayers[i]];
			}else{
				retvalue+=&quot;1=1&quot;;
			}
		}
		return retvalue;
	},

	&#x2F;**
		Zooms out the map by one level
		@method ZoomOut
	**&#x2F;
	ZoomOut: function(){
		digimap.zoomTo(digimap.getZoom()-1);
	},

	
	&#x2F;**
		Used to initialize selection tools (info, select rectangle etc)
		@method infoInit
	**&#x2F;
	infoInit: function(){
		infoControls = {
			click: new OpenLayers.Control.WMSGetFeatureInfo({
				url: config.mapserver+&#x27;wms&#x27;,
				title: &#x27;Identify features by clicking&#x27;,
				drillDown: true,
				infoFormat:&quot;text&#x2F;html&quot;,
				maxFeatures: 10,
				layers: [digimap.layers[1]],
				vendorParams: {
					EXCEPTIONS: &#x27;XML&#x27;
				}
			}),

			select: new OpenLayers.Control.GetFeature({
				protocol: null,	&#x2F;&#x2F;to be set on activate
				box: true,
				hover: false,
				multipleKey: &quot;&quot;,
				toggleKey: &quot;&quot;
			}),
			
			&#x2F;&#x2F;JK CHANGE - ADD the circle select tool
			select_circle: new OpenLayers.Control.GetFeature({
				protocol: null,	&#x2F;&#x2F;to be set on activate
				circle: true,
				hover: false,
				multipleKey: &quot;&quot;,
				toggleKey: &quot;&quot;
			})
			&#x2F;&#x2F;JK CHANGES END			

		};
		infoControls.click.events.register(&quot;getfeatureinfo&quot;, this, mygis.Map.showInfo2);

		for (var i in infoControls) {
			digimap.addControl(infoControls[i]);
		}

		&#x2F;&#x2F;infoControls.click.activate();

	},

    elementPosition: function(param) {
        var x = 0, y = 0;
        var obj = (typeof param == &quot;string&quot;) ? document.getElementById(param) : param;
        if (obj) {
            x = obj.offsetLeft;
            y = obj.offsetTop;
            var body = document.getElementsByTagName(&#x27;body&#x27;)[0];
            while (obj.offsetParent &amp;&amp; obj != body) {
                x += obj.offsetParent.offsetLeft;
                y += obj.offsetParent.offsetTop;
                obj = obj.offsetParent;
            }
        }
		var retobj = new Object();
		retobj.x = x;
		retobj.y = y;
        mapContainerPosition = retobj;
    },

    &#x2F;**
		Creates the AV logo inside the map
		@method createLogo
    *&#x2F;
    createLogo: function() {
        var retobj = document.createElement(&quot;DIV&quot;);
        &#x2F;&#x2F;retobj.setAttribute(&quot;class&quot;,&quot;AVLogoCont&quot;);
        var btnAVMap = document.createElement(&quot;INPUT&quot;);
        btnAVMap.id = &quot;AVLogoBtn&quot;;
        btnAVMap.type = &quot;button&quot;;
        $(btnAVMap).bind(&#x27;click&#x27;,function() { window.open(&quot;http:&#x2F;&#x2F;www.avmap.gr&#x2F;&quot;); });
        retobj.appendChild(btnAVMap);
		&#x2F;&#x2F;$(retobj).css({&quot;});
        return retobj;
    },

	&#x2F;**
		Creates the Smartest logo inside the map
		@method createLogoSmartest
		@deprecated
    *&#x2F;
	createLogoSmartest: function(){
		var retobj = document.createElement(&quot;DIV&quot;);
		var btnLogo = document.createElement(&quot;a&quot;);
		btnLogo.id = &quot;SmartestBtn&quot;;
		retobj.appendChild(btnLogo);
		$(retobj).css({&quot;position&quot;:&quot;absolute&quot;,&quot;bottom&quot;:0,&quot;z-index&quot;:999,&quot;left&quot;:10});
        return retobj;
	},

	&#x2F;**
		Creates the Cordis logo inside the map
		@method createLogoCordis
		@deprecated
    *&#x2F;
	createLogoCordis: function(){
		var retobj = document.createElement(&quot;DIV&quot;);
		var btnLogo = document.createElement(&quot;a&quot;);
		btnLogo.id = &quot;CordisBtn&quot;;
		retobj.appendChild(btnLogo);
		$(retobj).css({&quot;position&quot;:&quot;absolute&quot;,&quot;bottom&quot;:0,&quot;z-index&quot;:999,&quot;left&quot;:10});
        return retobj;
	},

	&#x2F;**
		Creates the EU logo inside the map
		@method createLogoEU
		@deprecated
    *&#x2F;
	createLogoEU: function(){
		var retobj = document.createElement(&quot;DIV&quot;);
		var btnLogo = document.createElement(&quot;a&quot;);
		btnLogo.id = &quot;EUBtn&quot;;
		retobj.appendChild(btnLogo);
		$(retobj).css({&quot;position&quot;:&quot;absolute&quot;,&quot;bottom&quot;:0,&quot;z-index&quot;:999,&quot;left&quot;:10});
        return retobj;
	},
	
	&#x2F;**
		Styles the editmode as a jquery button
		@method styleButton
		@deprecated
    *&#x2F;
    styleButton: function() {
        $(&quot;#editmodeButton&quot;).button();
    },

    &#x2F;**
		Resets the map to its initial state
		@method clearMap
    *&#x2F;
    clearMap: function() {
        try {
            mygis.Map.deleteOverlays();
			mygis.Map.clearSelection();
        } catch (Error) { }


    },

	&#x2F;**
		Clears any selection on the map

		@method clearSelection
		@param {Boolean} initialLoad If this is the initial loading of the application
    *&#x2F;
	clearSelection: function(initialLoad){
		&#x2F;&#x2F;mygis.UI.selectToolbar();
		selectionLayer.removeAllFeatures();
		drawControls.modify.selectControl.unselectAll();
		infoWindows = [];
		if (!infoWindowInitialized){
			initializeInfoWindow();
		}
		if(initialLoad){
			$(&quot;#infoLeftList&quot;).jqxListBox({source:layerSource,displayMember:&#x27;layerNAME&#x27;,valueMember:&#x27;layerID&#x27;});
		}
		&#x2F;&#x2F;$(&quot;#selectAnalysis&quot;).empty();
		document.getElementById(&quot;selectClear&quot;).ex_AddClassName(&quot;disabled&quot;);



	},
	
	setSelectableLayers: function(source,selectionLayers){
		console.log(&quot;setSelectableLayers fired&quot;);
		var getItemByValue = function(listbox,value){	&#x2F;&#x2F;we have old version of jqxwidgets, so hack it manually
			var found=false;
			var retvalue=null;
			var i=0;
			var items = listbox.jqxListBox(&#x27;getItems&#x27;);
			while (!found &amp;&amp; i&lt;items.length){
				var item = listbox.jqxListBox(&#x27;getItem&#x27;,i);
				if (item.value==value){
					found=true;
					retvalue=item;
				}else{
					i++;
				}
			}
			return retvalue;
		};
		selectionLayers.jqxListBox(&#x27;uncheckAll&#x27;); 
		$.each(source,function(x,item){
			if (item.Selectable==&quot;True&quot; || item.Selectable){
				var item=getItemByValue(selectionLayers,item.layerTABLE);
				if (item){
					selectionLayers.jqxListBox(&#x27;checkIndex&#x27;,item.index);
				}
				
			}
		});
	},
	
	determineSelectionToggleStatus: function(id){
		var status=0;
		var btnID=&quot;&quot;;
		switch (id){
			case &quot;#layerSelectionList&quot;:
				btnID=&quot;#layerSelectionToggleBtn&quot;;
				break;
			case &quot;#layerWithinSelectionList&quot;:
				btnID=&quot;#layerWithinSelectionToggleBtn&quot;;
				break;
		}
		var selectionLayers = $(id);
		var allItems = selectionLayers.jqxListBox(&#x27;getItems&#x27;);
		var checkedItems = selectionLayers.jqxListBox(&#x27;getCheckedItems&#x27;);
		if (allItems.length==checkedItems.length){
			status=2;
		}else if (allItems.length&gt;checkedItems.length &amp;&amp; checkedItems.length&gt;0){
			status=1;
		}
		$(btnID).removeClass(&quot;checked&quot;);
		$(btnID).removeClass(&quot;indeterminate&quot;);
		switch (status){
			case 2:
				$(btnID).addClass(&quot;checked&quot;);
				break;
			case 1:
				$(btnID).addClass(&quot;indeterminate&quot;);
				break;
		}
	},
	
	switchSelectionToggleBtn: function(id){
		var listID=&quot;&quot;;
		switch(id){
			case &quot;#layerSelectionToggleBtn&quot;:
				listID=&quot;#layerSelectionList&quot;;
				break;
			case &quot;#layerWithinSelectionToggleBtn&quot;:
				listID=&quot;#layerWithinSelectionList&quot;;
				break;
		}
		var btn = $(id);
		var listbox = $(listID);
		if (btn.hasClass(&quot;checked&quot;)){	
			btn.removeClass(&#x27;checked&#x27;);
			listbox.jqxListBox(&#x27;uncheckAll&#x27;);
		}else{	&#x2F;&#x2F;check all
			btn.removeClass(&#x27;indeterminate&#x27;);	&#x2F;&#x2F;just in case
			btn.addClass(&#x27;checked&#x27;);
			listbox.jqxListBox(&#x27;checkAll&#x27;);
		}
	},
	

    &#x2F;**
		Clears layers from the map
		@method deleteOverlays
    *&#x2F;
    deleteOverlays: function() {
		var layer;
		var i=0;
		var foundOne=false;
		while (i&lt;digimap.getNumLayers()){
			layer = digimap.layers[i];
			layer.events.remove(&quot;loadend&quot;);
			if (!(layer.isBaseLayer || layer.name==&quot;Cosmetic Layer&quot; || layer.name==&quot;Selection Layer&quot; || layer.name==&quot;Feedback Layer&quot;) ){
				try{
				layer.destroy(false);
				}catch(err){

				}

			}else{
				i++;
			}
		}



    },

	&#x2F;**
		Returns a combined OpenLayers WMS layer from the geoserver store.

		@method getMapServerLayer
		@param {String} layername Either one, or a comma-delimited string of layers to load
		@param {String} map Deprecated parameter
		@param mapExtent Comma-delimited string of map extents
    *&#x2F;
	getMapServerLayer: function(layername,map,mapExtent){
		var retvalue;
		var extentArray = mapExtent.split(&quot;,&quot;);
		retvalue = new OpenLayers.Layer.WMS(layername,
			config.mapserver+&quot;wms&quot;,
			{
				&#x2F;&#x2F;map: map,
				layers: customStyleApplied?null:layername,
				EXCEPTIONS:&#x27;BLANK&#x27;,
				FORMAT:&#x27;image&#x2F;png&#x27;,
				&#x2F;&#x2F;TILED: &#x27;true&#x27;,
				&quot;transparent&quot;:&quot;true&quot;,
				VERSION: &quot;1.1.1&quot;,
				CQL_FILTER: customFiltered?mygis.Map.getCustomFilter():null,
				sld_body: customStyleApplied?mygis.Map.getCustomAppliedStyle():null
			},
			{
				&#x27;isBaseLayer&#x27;: false,
				&#x27;alpha&#x27;: true,
				&#x2F;&#x2F;maxExtent : new OpenLayers.Bounds(extentArray[0],extentArray[1],extentArray[2],extentArray[3]),
				&#x2F;&#x2F;maxExtent: new OpenLayers.Bounds(-180.000000,-90.000000,180.000000,90.000000),
				singleTile:true,ratio: 2,
				transitionEffect:&#x27;null&#x27;,
				&#x2F;&#x2F;gutter: 2,
				buffer: 2,
				attribution: &#x27;&#x27;
			}
		);
		&#x2F;&#x2F;retvalue.mergeNewParams({format_options: &quot;layout:legend&quot;});
		return retvalue;
	},


	markSelectionPoint: function(point,eraseAll){

		if (eraseAll){
			feedbackLayer.removeAllFeatures();
		}

		if (point){
			var defaultPointStyle = OpenLayers.Util.applyDefaults(defaultPointStyle, OpenLayers.Feature.Vector.style[&#x27;temporary&#x27;]);
			var markerPoint = new OpenLayers.Geometry.Point(point.lon,point.lat);
			var markerFeature = new OpenLayers.Feature.Vector(markerPoint,null,defaultPointStyle);
			&#x2F;*
			defaultPointStyle.fillColor = &quot;#FF0000&quot;;
			defaultPointStyle.fillOpacity = 0.5;
			defaultPointStyle.strokeColor=&quot;#FF0000&quot;;
			defaultPointStyle.strokeOpacity = 1;
			*&#x2F;
			defaultPointStyle.externalGraphic = config.folderPath+&quot;Images&#x2F;target2.png&quot;;	&#x2F;&#x2F;target5
			defaultPointStyle.graphicWidth = 64;	&#x2F;&#x2F;12;	
			defaultPointStyle.graphicHeight = 64;	&#x2F;&#x2F;19
			&#x2F;&#x2F;defaultPointStyle.graphicYOffset= 19;
			defaultPointStyle.graphicOpacity = 1;

			feedbackLayer.addFeatures(markerFeature);
		}
	},

	markFeatures: function(features){
		selectionLayer.removeAllFeatures();
		if (features){
			clearTimeout(internalConfig.zoomToFeat);
			var fn = function(x){
				return function(){
					selectionLayer.addFeatures(x);
					digimap.zoomToExtent(selectionLayer.getDataExtent());
					&#x2F;&#x2F;console.log(&#x27;fired&#x27;);
				}
			};
			internalConfig.zoomToFeat=setTimeout(fn(features),1000);

		}
		
	},
	
	clearFeedback: function(){
		feedbackLayer.removeAllFeatures();
	},

	layerHasProperty: function(name,property){
		var retvalue=false;
		var i=0;
		var found=false;
		var checkitem;
		while (!found &amp;&amp; i&lt;layerSource.records.length){
			checkitem = layerSource.records[i];
			if (checkitem.layerTABLE==name){
				found=true;
			}else{
				i++;
			}
		}
		if (found){
			switch (property){
				case &quot;selectable&quot;:
					retvalue = checkitem.Selectable;
					break;
				case &quot;editable&quot;:
					retvalue = checkitem.Editable;
					break;
				case &quot;locked&quot;:
					retvalue = checkitem.Locked;
					break;
			}
		}
		return retvalue;
	},

	selectTopFeatures: function(features){
		var resultLayers=mygis.Utilities.categorizeFeatures(features);
		var minIndex=999999;
		var lname;
		$.each(resultLayers,function(i,v){
			var index = mygis.Utilities.mggetLayerIndex(i);
			if (index&lt;minIndex){
				lname = i;
				minIndex=index;
			}
		});
		if (resultLayers[lname].length&gt;0){
			resultLayers[lname].length=1;	&#x2F;&#x2F;	return only one;
		}
		return resultLayers[lname];
	},

	showInfo2: function(evt){
		console.log(&quot;showInfo2&quot;);
		var dump = evt.text;
		var parts = dump.split(&quot;&lt;&#x2F;table&gt;&quot;);
		&#x2F;&#x2F;var parts = $(dump).find(&#x27;table.featureInfo&#x27;);
		var lonlat = digimap.getLonLatFromPixel(evt.xy);
		mygis.Map.markSelectionPoint(lonlat,true);

		var realText;
		var layernames = [];
		infoWindows = [];
		$(&quot;#infoRightGrid&quot;).hide();
		$(&quot;#infoLeftList&quot;).hide();
		for (var i=0;i&lt;parts.length-1;i++){
			var startIndex = parts[i].indexOf(&quot;&lt;table&quot;);
				if (startIndex&gt;-1){

				var layerIDs=&quot;&quot;;
				var layername;
				var featuresFound=0;
				realText = parts[i].substring(startIndex).trim()+&quot;&lt;&#x2F;table&gt;&quot;;
				var jTable = $(realText);
				var jRows = jTable.find(&quot;tr&quot;);
				&#x2F;&#x2F;layername = jTable.find(&#x27;caption&#x27;).html().split(&quot;_&quot;).slice(1).join(&quot;_&quot;);
				layername = jTable.find(&#x27;caption&#x27;).html();
				if (mygis.Map.layerHasProperty(layername,&quot;selectable&quot;)){
					layernames.push(layername);
					jRows.each(function(i,v){
						var cells =$(v).find(&quot;td&quot;);
						if (i&gt;=1){
							if (i&gt;1){
								layerIDs+=&quot;,&quot;;
							}
							layerIDs+=$(cells[1]).html();
							featuresFound+=1;
						}
					});
					var myurl = config.mgreq+&quot;?qtype=GetFeatureList&amp;qContents=&quot;+escape(layername+&quot;$&quot;+layerIDs);
					var prevText = layernames[layernames.length-1];
					layernames[layernames.length-1] = new Object();
					layernames[layernames.length-1].text = prevText;
					layernames[layernames.length-1].dataurl = myurl;
				}
			}
		}

		&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;select&#x27;,internalConfig.layerTabIndex);
		&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;select&#x27;,0);
		if (!infoWindowInitialized){
			initializeInfoWindow();
		}

		var qItem = new Object();
		qItem.text=strings.Info.infoAt+lonlat.lon+&quot; , &quot;+lonlat.lat;
		displaySuccess(qItem.text);
		qItem.value=-1;
		qItem.isInitialized=true;
		qItem.linkedResults=layernames;
		qItem.isDBQuery=false;
		qItem.isMapSelect=false;
		qItem.centerPoint=lonlat;
		querySource.push(qItem);
		mygis.UI.updateQueryList();
		var leftList = $(&quot;#infoLeftList&quot;);
		leftList.show();
		var itemCount = leftList.jqxListBox(&#x27;getItems&#x27;).length;
		leftList.jqxListBox(&#x27;selectIndex&#x27;,itemCount-1);
		mygis.UI.queryResultsRun();

	},

	checkScaleConstraints: function(){
		&#x2F;*
		var layerlist = $(&#x27;#layersList&#x27;);
		var currentScale = digimap.getScale();
		var baselayer = digimap.baseLayer;
		var switchBackgrounds = false;
		if (currentScale&lt;baselayer.mg_MinScale || (currentScale&gt;baselayer.mg_MaxScale &amp;&amp; baselayer.mg_MaxScale!=-1)){
			 switchBackgrounds=true;
		}
		if (switchBackgrounds &amp;&amp; (!internalConfig.helpTips.switchBG)){
			internalConfig.helpTips.switchBG=true;
			displayNotify(strings.LayerControl.tip_ChangeBG,true,function(){internalConfig.helpTips.switchBG=false;});
		}
		var atLeastOne = false;
		
		for (var i=0;i&lt;layerSource.records.length;i++){
			var item=layerSource.records[i];
			if (!item.manualVisibility){
				if (item.hidden){
					if (currentScale&gt;=item.layerMinScale &amp;&amp; (currentScale&lt;item.layerMaxScale || item.layerMaxScale==-1)){
						item.hidden=false;
						atLeastOne=true;
					}
				}else{
					if(currentScale&lt;item.layerMinScale || (currentScale&gt;item.layerMaxScale &amp;&amp; item.layerMaxScale!=-1)){
						item.hidden=true;
						atLeastOne=true;
					}
				}

			}
		}
		if (atLeastOne){
			var mapItem = $(&quot;#mapsList&quot;).jqxListBox(&#x27;getSelectedItem&#x27;).originalItem;
			loadMapSequence(mapItem);
		}

		if (switchBackgrounds || atLeastOne){
			mygis.UI.updateLayerGrid();
		}
		*&#x2F;
	},

	getLayerSLD: function(name){
		var locallyStored = mygis.Storage.getItem(&#x27;layerStyle_&#x27;+name);
		if (locallyStored){
			mygis.Map.getLayerSLDComplete(eval(locallyStored),name,true);
		}else{
			OpenLayers.Request.GET({
				url: config.mapserver+&quot;styles&#x2F;&quot;+name+&quot;.sld&quot;,
				headers: {
					&quot;Content-Type&quot;: &quot;text&#x2F;xml;charset=utf-8&quot;
				},
				success: function(req){
					mygis.Storage.storeItem(&#x27;layerStyle_&#x27;+name,JSON.stringify(req.responseText));
					mygis.Map.getLayerSLDComplete(req,name);
				}
			});
		}

	},

	getLayerSLDComplete: function(req,layername,textOnly){
		var format = new OpenLayers.Format.SLD();
		if (textOnly){
			layerStyles[layername]=format.read(req);
		}else{
			layerStyles[layername]=format.read(req.responseXML || req.responseText);
		}
	},

	getCustomAppliedStyle: function(){
		var completeSLD = mygis.Map.combineLayerSLDs();
		var frmt = new OpenLayers.Format.SLD();
		var sldString = frmt.write(completeSLD);

		sldString = sldString.replace(&#x2F;&lt;ogc:PropertyName&gt;Geometry&lt;\&#x2F;ogc:PropertyName&gt;&#x2F;g,&quot;&lt;ogc:Function name=\&quot;geometryType\&quot;&gt;&lt;ogc:PropertyName&gt;Geometry&lt;&#x2F;ogc:PropertyName&gt;&lt;&#x2F;ogc:Function&gt;&quot;);
		sldString = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#x27;+sldString;
		return sldString;
	},

	getSingleAppliedStyle: function(name){
		var retvalue = new Object();
		retvalue.version = &quot;1.0.0&quot;;
		retvalue.namedLayers=new Object();
		retvalue.namedLayers[name]=layerStyles[name].namedLayers[name];
		&#x2F;&#x2F;retvalue.namedLayers[name].userStyles[0].Name=name;
		var frmt = new OpenLayers.Format.SLD();
		var sldString = frmt.write(retvalue);

		sldString = sldString.replace(&#x2F;&lt;ogc:PropertyName&gt;Geometry&lt;\&#x2F;ogc:PropertyName&gt;&#x2F;g,&quot;&lt;ogc:Function name=\&quot;geometryType\&quot;&gt;&lt;ogc:PropertyName&gt;Geometry&lt;&#x2F;ogc:PropertyName&gt;&lt;&#x2F;ogc:Function&gt;&quot;);

		sldString = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#x27;+sldString;
		return sldString;
	},

	combineLayerSLDs: function(){
		var retvalue = new Object();
		retvalue.version = &quot;1.0.0&quot;;
		retvalue.namedLayers=new Object();
		var recs = layerSource.records;
		for (var i=recs.length-1;i&gt;=0;i--)
		{
			if (!(Boolean(recs[i].hidden)===true)){
				var name = recs[i].layerTABLE;
				retvalue.namedLayers[name]=layerStyles[name].namedLayers[name];

			}

		}
		&#x2F;*
		$.each(layerStyles,function(i,v){
			if (v){
				retvalue.namedLayers[i]=v.namedLayers[i];
			}
		});
		*&#x2F;
		&#x2F;&#x2F;var frmt = new OpenLayers.Format.SLD();
		&#x2F;&#x2F;var xxx = frmt.write(retvalue);
		&#x2F;&#x2F;digimap.layers[2].mergeNewParams({sld_body:&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&quot;+xxx.replace(&#x2F;#&#x2F;g,&quot;%23&quot;)});
		return retvalue;
	},

	buildSLDArray: function(){
		var recs = layerSource.records;
		layerStyles = new Object();
		for (var i=recs.length-1;i&gt;=0;i--)
		{
			if (!(Boolean(recs[i].hidden)===true)){
				mygis.Map.getLayerSLD(recs[i].layerTABLE);

			}

		}
	},

	getUniqueGraphics: function(){
		var retvalue = [];
		var retitem;
		$.each(layerStyles,function(i,v){
			var examine = v.namedLayers[i].userStyles[0];
			for (var j=0;j&lt;examine.rules.length;j++){
				var symbolizer = examine.rules[j].symbolizer;
				for (var name in symbolizer){
					if (name.toString()==&#x27;Point&#x27;){
						if (symbolizer[name].graphic){
							retitem = new Object();
							retitem.layer=i;
							retitem.graphicUrl = symbolizer[name].externalGraphic;
							retvalue.push(retitem);
						}
					}
				}
			}
		});
		return retvalue;
	},

	strategies: {
		BBOXUnique: OpenLayers.Class(OpenLayers.Strategy, {

			&#x2F;**
			 * Property: bounds
			 * {&lt;OpenLayers.Bounds&gt;} The current data bounds (in the same projection
			 *     as the layer - not always the same projection as the map).
			 *&#x2F;
			bounds: null,

			&#x2F;**
			 * Property: resolution
			 * {Float} The current data resolution.
			 *&#x2F;
			resolution: null,

			&#x2F;**
			 * APIProperty: ratio
			 * {Float} The ratio of the data bounds to the viewport bounds (in each
			 *     dimension).  Default is 2.
			 *&#x2F;
			ratio: 2,

			&#x2F;**
			 * Property: resFactor
			 * {Float} Optional factor used to determine when previously requested
			 *     features are invalid.  If set, the resFactor will be compared to the
			 *     resolution of the previous request to the current map resolution.
			 *     If resFactor &gt; (old &#x2F; new) and 1&#x2F;resFactor &lt; (old &#x2F; new).  If you
			 *     set a resFactor of 1, data will be requested every time the
			 *     resolution changes.  If you set a resFactor of 3, data will be
			 *     requested if the old resolution is 3 times the new, or if the new is
			 *     3 times the old.  If the old bounds do not contain the new bounds
			 *     new data will always be requested (with or without considering
			 *     resFactor).
			 *&#x2F;
			resFactor: null,

			&#x2F;**
			 * Property: response
			 * {&lt;OpenLayers.Protocol.Response&gt;} The protocol response object returned
			 *      by the layer protocol.
			 *&#x2F;
			response: null,

			&#x2F;**
			 * Constructor: OpenLayers.Strategy.BBOX
			 * Create a new BBOX strategy.
			 *
			 * Parameters:
			 * options - {Object} Optional object whose properties will be set on the
			 *     instance.
			 *&#x2F;

			&#x2F;**
			 * Method: activate
			 * Set up strategy with regard to reading new batches of remote data.
			 *
			 * Returns:
			 * {Boolean} The strategy was successfully activated.
			 *&#x2F;
			activate: function() {
				var activated = OpenLayers.Strategy.prototype.activate.call(this);
				if(activated) {
					this.layer.events.on({
						&quot;moveend&quot;: this.update,
						&quot;refresh&quot;: this.update,
						&quot;visibilitychanged&quot;: this.update,
						scope: this
					});
					this.update();
				}
				return activated;
			},

			&#x2F;**
			 * Method: deactivate
			 * Tear down strategy with regard to reading new batches of remote data.
			 *
			 * Returns:
			 * {Boolean} The strategy was successfully deactivated.
			 *&#x2F;
			deactivate: function() {
				var deactivated = OpenLayers.Strategy.prototype.deactivate.call(this);
				if(deactivated) {
					this.layer.events.un({
						&quot;moveend&quot;: this.update,
						&quot;refresh&quot;: this.update,
						&quot;visibilitychanged&quot;: this.update,
						scope: this
					});
				}
				return deactivated;
			},

			&#x2F;**
			 * Method: update
			 * Callback function called on &quot;moveend&quot; or &quot;refresh&quot; layer events.
			 *
			 * Parameters:
			 * options - {Object} Optional object whose properties will determine
			 *     the behaviour of this Strategy
			 *
			 * Valid options include:
			 * force - {Boolean} if true, new data must be unconditionally read.
			 * noAbort - {Boolean} if true, do not abort previous requests.
			 *&#x2F;
			update: function(options) {
				var mapBounds = this.getMapBounds();
				if (mapBounds !== null &amp;&amp; ((options &amp;&amp; options.force) ||
				  (this.layer.visibility &amp;&amp; this.layer.calculateInRange() &amp;&amp; this.invalidBounds(mapBounds)))) {
					this.calculateBounds(mapBounds);
					this.resolution = this.layer.map.getResolution();
					this.triggerRead(options);
				}
			},

			&#x2F;**
			 * Method: getMapBounds
			 * Get the map bounds expressed in the same projection as this layer.
			 *
			 * Returns:
			 * {&lt;OpenLayers.Bounds&gt;} Map bounds in the projection of the layer.
			 *&#x2F;
			getMapBounds: function() {
				if (this.layer.map === null) {
					return null;
				}
				var bounds = this.layer.map.getExtent();
				if(bounds &amp;&amp; !this.layer.projection.equals(
						this.layer.map.getProjectionObject())) {
					bounds = bounds.clone().transform(
						this.layer.map.getProjectionObject(), this.layer.projection
					);
				}
				return bounds;
			},

			&#x2F;**
			 * Method: invalidBounds
			 * Determine whether the previously requested set of features is invalid.
			 *     This occurs when the new map bounds do not contain the previously
			 *     requested bounds.  In addition, if &lt;resFactor&gt; is set, it will be
			 *     considered.
			 *
			 * Parameters:
			 * mapBounds - {&lt;OpenLayers.Bounds&gt;} the current map extent, will be
			 *      retrieved from the map object if not provided
			 *
			 * Returns:
			 * {Boolean}
			 *&#x2F;
			invalidBounds: function(mapBounds) {
				if(!mapBounds) {
					mapBounds = this.getMapBounds();
				}
				var invalid = !this.bounds || !this.bounds.containsBounds(mapBounds);
				if(!invalid &amp;&amp; this.resFactor) {
					var ratio = this.resolution &#x2F; this.layer.map.getResolution();
					invalid = (ratio &gt;= this.resFactor || ratio &lt;= (1 &#x2F; this.resFactor));
				}
				return invalid;
			},

			&#x2F;**
			 * Method: calculateBounds
			 *
			 * Parameters:
			 * mapBounds - {&lt;OpenLayers.Bounds&gt;} the current map extent, will be
			 *      retrieved from the map object if not provided
			 *&#x2F;
			calculateBounds: function(mapBounds) {
				if(!mapBounds) {
					mapBounds = this.getMapBounds();
				}
				var center = mapBounds.getCenterLonLat();
				var dataWidth = mapBounds.getWidth() * this.ratio;
				var dataHeight = mapBounds.getHeight() * this.ratio;
				this.bounds = new OpenLayers.Bounds(
					center.lon - (dataWidth &#x2F; 2),
					center.lat - (dataHeight &#x2F; 2),
					center.lon + (dataWidth &#x2F; 2),
					center.lat + (dataHeight &#x2F; 2)
				);
			},

			&#x2F;**
			 * Method: triggerRead
			 *
			 * Parameters:
			 * options - {Object} Additional options for the protocol&#x27;s read method
			 *     (optional)
			 *
			 * Returns:
			 * {&lt;OpenLayers.Protocol.Response&gt;} The protocol response object
			 *      returned by the layer protocol.
			 *&#x2F;
			triggerRead: function(options) {
				if (this.response &amp;&amp; !(options &amp;&amp; options.noAbort === true)) {
					this.layer.protocol.abort(this.response);
					this.layer.events.triggerEvent(&quot;loadend&quot;);
				}
				this.layer.events.triggerEvent(&quot;loadstart&quot;);
				this.response = this.layer.protocol.read(
					OpenLayers.Util.applyDefaults({
						filter: this.createFilter(),
						callback: this.merge,
						scope: this
				}, options));
			},

			&#x2F;**
			 * Method: createFilter
			 * Creates a spatial BBOX filter. If the layer that this strategy belongs
			 * to has a filter property, this filter will be combined with the BBOX
			 * filter.
			 *
			 * Returns
			 * {&lt;OpenLayers.Filter&gt;} The filter object.
			 *&#x2F;
			createFilter: function() {

				var filter;
				var filterIDs = [];
				if (this.layer.features.length&gt;0){
					for (var i=0;i&lt;this.layer.features.length;i++){
						&#x2F;&#x2F;fids.push();
						if (this.layer.features[i].fid){	&#x2F;&#x2F;else is a new object
							var id = this.layer.features[i].fid.split(&quot;.&quot;)[1];
							var x = new OpenLayers.Filter.Comparison({
								type: OpenLayers.Filter.Comparison.EQUAL_TO,
								property: &#x27;OID&#x27;,
								value: id
							});
							filterIDs.push(x);
						}
					}
				}
				if (this.layer.deletedFeatures){
					if (this.layer.deletedFeatures.length&gt;0){
						for (var i=0;i&lt;this.layer.deletedFeatures.length;i++){
							&#x2F;&#x2F;fids.push();
							var id = this.layer.deletedFeatures[i].fid.split(&quot;.&quot;)[1];
							var x = new OpenLayers.Filter.Comparison({
								type: OpenLayers.Filter.Comparison.EQUAL_TO,
								property: &#x27;OID&#x27;,
								value: id
							});
							filterIDs.push(x);
						}
					}
				}
				if (filterIDs.length&gt;0){


					var filterOR = new OpenLayers.Filter.Logical({
						type: OpenLayers.Filter.Logical.OR,
						filters: filterIDs
					});
					var filterNOT = new OpenLayers.Filter.Logical({
						type: OpenLayers.Filter.Logical.NOT,
						filters: [filterOR]
					});

					var filterBBOX = new OpenLayers.Filter.Spatial({
						type: OpenLayers.Filter.Spatial.BBOX,
						value: this.bounds,
						projection: this.layer.projection
					});
					filter = new OpenLayers.Filter.Logical({
						type: OpenLayers.Filter.Logical.AND,
						filters: [filterNOT,filterBBOX]
					});
				}else{
					filter = new OpenLayers.Filter.Spatial({
						type: OpenLayers.Filter.Spatial.BBOX,
						value: this.bounds,
						projection: this.layer.projection
					});
				}
				if (this.layer.filter) {
					filter = new OpenLayers.Filter.Logical({
						type: OpenLayers.Filter.Logical.AND,
						filters: [this.layer.filter, filter]
					});
				}
				return filter;
			},

			&#x2F;**
			 * Method: merge
			 * Given a list of features, determine which ones to add to the layer.
			 *     If the layer projection differs from the map projection, features
			 *     will be transformed from the layer projection to the map projection.
			 *
			 * Parameters:
			 * resp - {&lt;OpenLayers.Protocol.Response&gt;} The response object passed
			 *      by the protocol.
			 *&#x2F;
			merge: function(resp) {
				var features = resp.features;
				if(features &amp;&amp; features.length &gt; 0) {
					var remote = this.layer.projection;
					var local = this.layer.map.getProjectionObject();
					if(!local.equals(remote)) {
						var geom;
						for(var i=0, len=features.length; i&lt;len; ++i) {
							geom = features[i].geometry;
							if(geom) {
								geom.transform(remote, local);
							}
						}
					}
					this.layer.addFeatures(features);
				}
				this.response = null;
				this.layer.events.triggerEvent(&quot;loadend&quot;);
			},

			CLASS_NAME: &quot;OpenLayers.Strategy.BBOXUnique&quot;
		})

	}
};

&#x2F;&#x2F;END of mygis.Map

&#x2F;** All printing related functions
 @class Printing
 @static
 **&#x2F;
mygis.Printing = {
	templates: {},
	templateConfig: {
		generic: &quot;&quot;,
		stats: config.folderPath+&quot;Scripts&#x2F;printing&#x2F;statResults.html?&quot;+Date.UTC(new Date())
	},
	printWindow: function(template,model){
		if (!mygis.Printing.templates[template]){
			mygis.Printing.initTemplate(template,model);
		}else{
			var path=config.folderPath+&quot;Scripts&#x2F;printing&#x2F;print.html?&quot;+Date.UTC(new Date());
			var w = window.open(path,&quot;_blank&quot;);
			w.onload=function(){
				w.document.write(mygis.Printing.templates[template](model));
				w.document.close();
				setTimeout(function(){w.print();},1000);
			};
			
		}
		
		
	},
	initTemplate: function(template,model){
		$.get(mygis.Printing.templateConfig[template]).
			then(function(src){
				mygis.Printing.templates[template]=Handlebars.compile(src);
				var w = window.open(config.folderPath+&quot;Scripts&#x2F;printing&#x2F;print.html&quot;,&quot;_blank&quot;);
				w.onload=function(){
					w.document.write(mygis.Printing.templates[template](model));
					w.document.close();
					setTimeout(function(){w.print();},1000);
				};
				&#x2F;&#x2F;w.focus();
				
			});
	},
	models: {
		printModel: function(){
			var me={
				parentDirectory:config.folderPath+&quot;Scripts&#x2F;printing&quot;,
				pageTitle: strings.Printing.statsWindowTitle,
				appLogo: $(&quot;.domainLogoWrapper2 a img&quot;).attr(&quot;src&quot;),
				appTitle: $(&quot;.domainStaticText2 div div&quot;).html().trim(),
				results: [
					&#x2F;*
					header
					subheader
					sumValue,
					minValue,
					maxValue
					avgValue
					*&#x2F;
				]
			};
			return me;
		}
	}
};

&#x2F;**
	All UI related functions. These methods either retrieve or set something to the DOM.

	@class UI
	@static
**&#x2F;
mygis.UI = {
	&#x2F;**
		Contains methods meant to be overriden by specific apps
		@class UI.Hooks
		@static
	*&#x2F;
	Hooks: {
		&#x2F;**
		*	Fired when an info window is shown
		*	@method infoWindowShown
		*&#x2F;
		infoWindowShown: function(){}
	},
	
	&#x2F;**
		Contains methods used in the interface of the Media Manager
		@class UI.MediaManager
		@static
	**&#x2F;
	MediaManager: {

		&#x2F;**
			Sorts the files displayed according to the control ID.
			Element classes:
				-No class: no sorting
				-&#x27;desc&#x27;	sorted desc
				-&#x27;asc&#x27; sorted asc
			The function cycles through the states as each button is pressed.

			@method sortBy
			@param {String} controlID The ID of the activating element. Accepts one of:
				-userFiles_nameSort
				-userFiles_typeSort
				-userFiles_dateSort
				-userFiles_inuseSort
				-userFiles_sizeSort
		**&#x2F;
		sortBy: function(controlID){
			var columnName = &quot;&quot;;
			var status=&quot;&quot;;
			var elementClasses = $(&quot;#&quot;+controlID).attr(&quot;class&quot;).split(&quot; &quot;);
			var sortClass=&quot;&quot;;
			var newSortClass = &quot;&quot;;
			if (elementClasses.length&gt;1){
				sortClass = elementClasses[1];
			}
			switch (controlID){
				case &quot;userFiles_nameSort&quot;:
					columnName=&quot;fileNAME&quot;;
					break;
				case &quot;userFiles_typeSort&quot;:
					columnName=&quot;fileTYPE&quot;;
					break;
				case &quot;userFiles_dateSort&quot;:
					columnName = &quot;fileINSERT&quot;;
					break;
				case &quot;userFiles_inuseSort&quot;:
					columnName = &quot;fileINUSE&quot;;
					break;
				case &quot;userFiles_sizeSort&quot;:
					columnName = &quot;fileSIZE&quot;
					break;
			}
			switch (sortClass){
				case &quot;desc&quot;:
					newSortClass=&quot;asc&quot;;
					break;
				case &quot;asc&quot;:
					newSortClass=&quot;&quot;;
					break;
				default:
					newSortClass=&quot;desc&quot;;
					break;

			}
			if (columnName){
				$(&quot;#userFilesList&quot;).jqxGrid(&#x27;sortby&#x27;,columnName,newSortClass);
				if (newSortClass){
					if (sortClass){
						document.getElementById(controlID).ex_RemoveClassName(sortClass);
					}
					document.getElementById(controlID).ex_AddClassName(newSortClass);
				}else{
					document.getElementById(controlID).ex_RemoveClassName(sortClass);
				}
			}
		},

		&#x2F;**
		 *	Clears the &quot;only images&quot; filter and forgets it
		 *	@method clearFilterImages
		 *&#x2F;
		clearFilterImages: function(){
			var grid=$(&#x27;#userFilesList&#x27;);
			try{
			grid.jqxGrid(&#x27;clearfilters&#x27;);
			}catch(err){}
			grid.removeData(&quot;imageFilter&quot;);
			grid.removeData(&quot;imageFilterDataField&quot;);
		},

		&#x2F;**
		 *	Adds an &quot;only images&quot; filter and remembers it
		 *	@method filterImages
		 *&#x2F;
		filterImages: function(){
			var grid=$(&#x27;#userFilesList&#x27;);
			grid.jqxGrid(&#x27;clearfilters&#x27;);
			var filtergroup = new $.jqx.filter();
			var datafield = &quot;fileTYPE&quot;;
			var filtertype = &quot;stringfilter&quot;;
			var condition= &quot;EQUAL&quot;;
			var operator= 1;
			var filter;
			for (var i=0;i&lt;4;i++){
				var filtervalue;
				switch (i){
					case 0:
						filtervalue = &quot;.PNG&quot;;
						break;
					case 1:
						filtervalue = &quot;.JPG&quot;;
						break;
					case 2:
						filtervalue = &quot;.JPEG&quot;;
						break;
					case 3:
						filtervalue = &quot;.GIF&quot;;
						break;
				}
				filter = filtergroup.createfilter(filtertype, filtervalue, condition);
				filtergroup.addfilter(operator, filter);
				filter = filtergroup.createfilter(filtertype, filtervalue.toLowerCase(), condition);
				filtergroup.addfilter(operator, filter);
			}
			grid.jqxGrid(&#x27;addfilter&#x27;, datafield, filtergroup, true);
			grid.data(&quot;imageFilter&quot;,filtergroup);
			grid.data(&quot;imageFilterDataField&quot;,datafield);
		},

		&#x2F;**
			Filters the displayed items in the file list by the input text

			@method filterBy
		**&#x2F;
		filterBy: function(){
			&#x2F;**
				@param {String} filtertype One of &#x27;numericfilter&#x27;, &#x27;stringfilter&#x27;, &#x27;datefilter&#x27; or &#x27;customfilter&#x27;
				@param {String} condition
				Possible conditions for string filter:
					&#x27;EMPTY&#x27;, &#x27;NOT_EMPTY&#x27;, &#x27;CONTAINS&#x27;, &#x27;CONTAINS_CASE_SENSITIVE&#x27;,&#x27;DOES_NOT_CONTAIN&#x27;, &#x27;DOES_NOT_CONTAIN_CASE_SENSITIVE&#x27;, &#x27;STARTS_WITH&#x27;, &#x27;STARTS_WITH_CASE_SENSITIVE&#x27;, &#x27;ENDS_WITH&#x27;, &#x27;ENDS_WITH_CASE_SENSITIVE&#x27;, &#x27;EQUAL&#x27;, &#x27;EQUAL_CASE_SENSITIVE&#x27;, &#x27;NULL&#x27;, &#x27;NOT_NULL&#x27;
				Possible conditions for numeric filter:
					&#x27;EQUAL&#x27;, &#x27;NOT_EQUAL&#x27;, &#x27;LESS_THAN&#x27;, &#x27;LESS_THAN_OR_EQUAL&#x27;, &#x27;GREATER_THAN&#x27;, &#x27;GREATER_THAN_OR_EQUAL&#x27;, &#x27;NULL&#x27;, &#x27;NOT_NULL&#x27;
				Possible conditions for date filter:
					&#x27;EQUAL&#x27;, &#x27;NOT_EQUAL&#x27;, &#x27;LESS_THAN&#x27;, &#x27;LESS_THAN_OR_EQUAL&#x27;, &#x27;GREATER_THAN&#x27;, &#x27;GREATER_THAN_OR_EQUAL&#x27;, &#x27;NULL&#x27;, &#x27;NOT_NULL&#x27;

				To create a custom filter, you need to call the createfilter function and pass a custom callback function as a fourth parameter.
				If the callback&#x27;s name is &#x27;customfilter&#x27;, the Grid will pass 3 params to this function - filter&#x27;s value, current cell value to evaluate and the condition.
				operator - 0 for &quot;AND&quot; and 1 for &quot;OR&quot;
			*&#x2F;
			&#x2F;&#x2F;clearTimeout(internalConfig.mediaManagerSearchTimer);

			var inputElem = $(&quot;#userFiles_SearchInput&quot;);
			if (inputElem.data(&quot;oldVal&quot;) != inputElem.val()){
				inputElem.data(&quot;oldVal&quot;,inputElem.val());
				var filtervalue = inputElem.val();
				var grid=$(&#x27;#userFilesList&#x27;);
				grid.jqxGrid(&#x27;clearfilters&#x27;);
				var parentElem = document.getElementById(&quot;userFiles_Search&quot;);

				if (filtervalue){

					if (!parentElem.ex_HasClassName(&quot;populated&quot;)){
						parentElem.ex_AddClassName(&quot;populated&quot;);
					}


					var filtergroup = new $.jqx.filter();
					var datafield = &quot;fileNAME&quot;;
					var filtertype = &quot;stringfilter&quot;;
					var condition= &quot;CONTAINS&quot;;
					var operator= 0;

					var filter = filtergroup.createfilter(filtertype, filtervalue, condition);


					filtergroup.addfilter(operator, filter);

					&#x2F;&#x2F; datafield is the bound field.
					&#x2F;&#x2F; adds a filter to the grid.
					&#x2F;&#x2F;$(&#x27;#userFilesList&#x27;).jqxGrid(&#x27;addfilter&#x27;, datafield, filtergroup);
					&#x2F;&#x2F; to add and apply the filter, use this:
					grid.jqxGrid(&#x27;addfilter&#x27;, datafield, filtergroup, true);


				}else{
					parentElem.ex_RemoveClassName(&quot;populated&quot;);
				}
				if (grid.data(&quot;imageFilter&quot;)){
					grid.jqxGrid(&#x27;addfilter&#x27;, grid.data(&quot;imageFilterDataField&quot;), grid.data(&quot;imageFilter&quot;), true);
				}
			}

		},

		&#x2F;**
			Adds&#x2F;removes a class when input is focused&#x2F;unfocused

			@method toggleFilterFocus
			@param {Boolean} on Whether the input is focused or not.
		**&#x2F;
		toggleFilterFocus: function(on){
			var parentElem = document.getElementById(&quot;userFiles_Search&quot;);
			if (on){
				if (!parentElem.ex_HasClassName(&quot;focused&quot;)){
					parentElem.ex_AddClassName(&quot;focused&quot;);
				}
			}else{
				if (parentElem.ex_HasClassName(&quot;focused&quot;)){
					parentElem.ex_RemoveClassName(&quot;focused&quot;);
				}
			}
		},

		&#x2F;**
			This function is called whenever a file is selected in the grid.
			@method fileSelected
			@param {Object} event The event parameters
		**&#x2F;
		fileSelected: function(event){
			$(&quot;#userFiles_SelectedActions&quot;).show();
			$(&quot;#userFiles_SortContainer&quot;).hide();
			var rowindexes = $(&quot;#userFilesList&quot;).jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (rowindexes.length&gt;1){
				document.getElementById(&quot;userFiles_replace&quot;).ex_AddClassName(&quot;disabled&quot;);
				document.getElementById(&quot;userFiles_download&quot;).ex_AddClassName(&quot;disabled&quot;);
			}
		},

		&#x2F;**
			This function is called whenever a file is unselected in the grid.
			It checks the selected rows count, to manipulate some controls
			@method fileUnselected
			@param {Object} event The event parameters
		**&#x2F;
		fileUnselected: function(event){
			var rowindexes = $(&quot;#userFilesList&quot;).jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (rowindexes.length==0){
				$(&quot;#userFiles_SelectedActions&quot;).hide();
				$(&quot;#userFiles_SortContainer&quot;).show();
			}else if(rowindexes.length==1){
				document.getElementById(&quot;userFiles_replace&quot;).ex_RemoveClassName(&quot;disabled&quot;);
				document.getElementById(&quot;userFiles_download&quot;).ex_RemoveClassName(&quot;disabled&quot;);
			}
		},

		&#x2F;**
			Creates a popup window to preview the full image

			@method fullImgPreview
			@param {Element} elem
		**&#x2F;
		fullImgPreview: function(elem){
			var imageSource = elem.src;
			var fullSource = imageSource.substring(0,imageSource.indexOf(&quot;&amp;qSize&quot;));
			var newImg = $(&quot;&lt;img &#x2F;&gt;&quot;);
			newImg.attr(&quot;src&quot;,fullSource);
			newImg.attr(&quot;class&quot;,&quot;imagePreviewer&quot;);
			var newImgCont = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var popupCont = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var mywidth,myheight;
			newImgCont.attr(&quot;style&quot;,&quot;display: table-cell; text-align: center; vertical-align: middle; width: 900px; height: 360px;&quot;);
			popupCont.append(newImgCont);
			newImg.load(function(){
				mywidth = this.width;
				myheight = this.height;
				newImgCont.append(newImg);
				popupCont.dialog({
					width: 900,	&#x2F;&#x2F;mywidth,
					height: 410,&#x2F;&#x2F;myheight,
					modal: true,
					draggable: false,
					resizable: false
				});&#x2F;&#x2F;.siblings(&#x27;div.ui-dialog-titlebar&#x27;).remove();
				newImgCont.focus();
			});


		},

		&#x2F;**
			Deletes a user&#x27;s files.
			Will only succeed if:
				-The current user is the file owner
			If a file is in use, it will only nullify the owner&#x27;s id.
			Otherwise, it will delete the record.
			@method deleteFiles
		**&#x2F;
		deleteFiles: function(){
			var grid = $(&quot;#userFilesList&quot;);
			var rowindexes = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			var fileIDs=[];
			var rowdata;
			for (var i=0;i&lt;rowindexes.length;i++){
				rowdata = grid.jqxGrid(&#x27;getrowdata&#x27;, rowindexes[i]);
				fileIDs.push(rowdata.fileID);
			}
			if (fileIDs.length&gt;0){
				var customUrl = config.mgreq+&quot;?qtype=RemoveUserFile&amp;qContents=&quot;+fileIDs.join(&quot;,&quot;);
				$.ajax({
							type:&quot;GET&quot;,
							url: customUrl,
							success: function(data){
								try{
									var realResults = eval(data);
									mygis.UI.MediaManager.refreshFileList();
									if (realResults.iotype==&quot;success&quot;){
										console.log(&quot;success&quot;);
									}else{
										console.log(realResults.iomsg);
									}
								}catch(err){
									console.log(err.message);
								}
							}
						});
			}
		},

		&#x2F;**
			Detach a file from a layer object

			@method detachFile
			@param {String} tablename
			@param {String} OID
			@param {String} fileID
		**&#x2F;
		detachFile: function(tablename,OID,fileID){
			mygis.Utilities.blockUI();
			var params = mygis.Utilities.format(&quot;{0}%23{1}%23{2}&quot;,fileID,tablename,OID);
			var customUrl = config.mgreq+&quot;?qtype=Detachfile&amp;qContents=&quot;+params;
			$.ajax({
				type:&quot;GET&quot;,
				url: customUrl,
				success: function(data){
					try{
						var realResults = eval(data);
						mygis.Utilities.unblockUI();
						propertiesVisibility(&quot;&quot;,false);	&#x2F;&#x2F;This to force user to reselect the object
						&#x2F;&#x2F;var realResults = eval(data);
						if (realResults.iotype==&quot;success&quot;){
							displaySuccess(&quot;File detached. Please reselect the object to see the new results&quot;);

						}else{
							displayError(realResults.iomsg);
						}
					}catch(err){
						console.log(err.message);
					}
				}
			});
		},

		&#x2F;**
			Replaces the file attached to the object with another.

			@method replaceFile
			@param {String} tablename
			@param {String} OID
			@param {String} fileID
			@param {String} newFileID
		**&#x2F;
		replaceFile: function(tablename,OID,fileID,newFileID){
			mygis.Utilities.blockUI();
			var params = mygis.Utilities.format(&quot;{0}%23{1}%23{2}%23{3}&quot;,fileID,tablename,OID,newFileID);
			var customUrl = config.mgreq+&quot;?qtype=ReplaceAttached&amp;qContents=&quot;+params;
			$.ajax({
				type:&quot;GET&quot;,
				url: customUrl,
				success: function(data){
					try{
						var realResults = eval(data);
						mygis.Utilities.unblockUI();
						propertiesVisibility(&quot;&quot;,false);	&#x2F;&#x2F;This to force user to reselect the object
						&#x2F;&#x2F;var realResults = eval(data);
						if (realResults.iotype==&quot;success&quot;){
							displaySuccess(&quot;File replaced. Please reselect the object to see the new results&quot;);
						}else{
							displayError(realResults.iomsg);
						}
					}catch(err){
						console.log(err.message);
					}
				}
			});
		},

		&#x2F;**
			This function is used to late-bind all handlers for the Media Manager window
			@method bindManagerHandlers
		**&#x2F;
		bindManagerHandlers: function(){
			$(&quot;#userFiles_uploadNew&quot;).bind(&#x27;click&#x27;,function(){
				if ($(&quot;#fileUploaderCont&quot;).parent().attr(&quot;id&quot;)==&quot;VariousPopUps&quot;){
					$(&quot;#userFilesSpaceCont&quot;).append($(&quot;#fileUploaderCont&quot;));
				}
				if (document.getElementById(&quot;userFiles_uploadNew&quot;).ex_HasClassName(&quot;done&quot;)){
					$(&quot;#fileUploaderCont&quot;).hide();
					mygis.UI.MediaManager.refreshFileList();
					document.getElementById(&quot;userFiles_uploadNew&quot;).ex_RemoveClassName(&quot;done&quot;);
					$(&quot;#userFiles_uploadNew&quot;).html(strings.MediaManager.btnAttachFile);
				}else{
					$(&quot;#fileUploaderCont&quot;).show();
					$(&quot;#fileUploaderCont .ruFileInput&quot;).trigger(&quot;click&quot;);
					$(&quot;#userFiles_uploadNew&quot;).trigger(&quot;click&quot;);
					
					document.getElementById(&quot;userFiles_uploadNew&quot;).ex_AddClassName(&quot;done&quot;);
					$(&quot;#userFiles_uploadNew&quot;).html(strings.MediaManager.btnAttachComplete);
				}
				return false;
			});
			$(&quot;#userFiles_nameSort&quot;).bind(&#x27;click&#x27;,function(){
				mygis.UI.MediaManager.sortBy(&quot;userFiles_nameSort&quot;);
				return false;
			});
			$(&quot;#userFiles_typeSort&quot;).bind(&#x27;click&#x27;,function(){
				mygis.UI.MediaManager.sortBy(&quot;userFiles_typeSort&quot;);
				return false;
			});
			$(&quot;#userFiles_sizeSort&quot;).bind(&#x27;click&#x27;,function(){
				mygis.UI.MediaManager.sortBy(&quot;userFiles_sizeSort&quot;);
				return false;
			});
			$(&quot;#userFiles_dateSort&quot;).bind(&#x27;click&#x27;,function(){
				mygis.UI.MediaManager.sortBy(&quot;userFiles_dateSort&quot;);
				return false;
			});
			$(&quot;#userFiles_inuseSort&quot;).bind(&#x27;click&#x27;,function(){
				mygis.UI.MediaManager.sortBy(&quot;userFiles_inuseSort&quot;);
				return false;
			});
			$(&quot;#userFiles_refreshList&quot;).bind(&quot;click&quot;,function(){
				mygis.UI.MediaManager.refreshFileList();
				return false;
			});
			var search=$(&quot;#userFiles_SearchInput&quot;);
			search.data(&quot;oldVal&quot;,&quot;&quot;);
			search.bind(&#x27;propertychange keyup input paste&#x27;,mygis.UI.MediaManager.filterBy);
			search.bind(&#x27;focus&#x27;,function(){mygis.UI.MediaManager.toggleFilterFocus(true);});
			search.bind(&#x27;blur&#x27;,function(){mygis.UI.MediaManager.toggleFilterFocus(false);});
			$(&quot;#userFiles_delete&quot;).bind(&quot;click&quot;,mygis.UI.MediaManager.deleteFiles);
			$(&quot;#userFiles_download&quot;).bind(&quot;click&quot;,function(){mygis.UI.MediaManager.downloadFile();});
			$(&quot;#userFiles_CANCEL&quot;).bind(&quot;click&quot;,mygis.UI.MediaManager.closeWindow);
			$(&quot;#userFiles_OK&quot;).bind(&quot;click&quot;,mygis.UI.MediaManager.acceptWindow);
		},

		&#x2F;**
			Refreshes the file list from server.

			@method refreshFileList
		**&#x2F;
		refreshFileList: function(){
			var fileContainer = $(&quot;#userFilesList&quot;);
			fileContainer.jqxGrid(&#x27;clearselection&#x27;);
			mygis.UI.MediaManager.fileUnselected();	&#x2F;&#x2F;to refresh the controls
			&#x2F;&#x2F;fileContainer.jqxGrid(&#x27;clear&#x27;);
			&#x2F;*
			var fileSource = createFileList();
			fileContainer.jqxGrid({
				source:fileSource
			});
			*&#x2F;
			fileContainer.jqxGrid(&#x27;updatebounddata&#x27;);
			var myurl = config.mgreq+&quot;?qtype=GetUserSpace&quot;;
			$.ajax({
				url: myurl,
				type: &#x27;GET&#x27;,
				success: function(data){
					mygis.UI.MediaManager.setupGaugeValue(parseFloat(data));
				}
			});
		},

		&#x2F;**
			Sets up the &quot;gauge&quot; feedback about used space.
			@method setupGaugeFeedback
		**&#x2F;
		setupGaugeFeedback: function(){
			var maxValue = 10;	&#x2F;&#x2F;TODO PROPER
			var greenEnd = Math.floor(maxValue&#x2F;2);
			var yellowStart = greenEnd;
			var yellowEnd = Math.floor(maxValue*0.7);
			var orangeStart = yellowEnd;
			var orangeEnd = Math.floor(maxValue*0.9);
			var redStart = orangeEnd;
			var redEnd = maxValue;
			$(&quot;#userFilesSpace&quot;).jqxGauge({
					ranges: [{ startValue: 0, endValue: greenEnd, style: { fill: &#x27;#4bb648&#x27;, stroke: &#x27;#4bb648&#x27; }, endWidth: 5, startWidth: 1 },
							 { startValue: yellowStart, endValue: yellowEnd, style: { fill: &#x27;#fbd109&#x27;, stroke: &#x27;#fbd109&#x27; }, endWidth: 10, startWidth: 5 },
							 { startValue: orangeStart, endValue: orangeEnd, style: { fill: &#x27;#ff8000&#x27;, stroke: &#x27;#ff8000&#x27; }, endWidth: 13, startWidth: 10 },
							 { startValue: redStart, endValue: redEnd, style: { fill: &#x27;#e02629&#x27;, stroke: &#x27;#e02629&#x27; }, endWidth: 16, startWidth: 13 }],
					ticksMinor: { interval: 0.5, size: &#x27;5%&#x27; },
					ticksMajor: { interval: 1, size: &#x27;9%&#x27; },
					value: 0,
					colorScheme: &#x27;scheme09&#x27;,
					animationDuration: 1200,
					width: 80,
					height: 80,
					max: maxValue,
					caption: {
						value: &#x27;0 MB&#x27;,
						position: &#x27;bottom&#x27;,
						offset: [0, 0],
						visible: true
					} ,
					labels: {
						visible: false
					}
				});
		},

		&#x2F;**
			Updates the &quot;used space&quot; gauge value
			@method setupGaugeValue
			@param {Number} value The value to set
		**&#x2F;
		setupGaugeValue: function(value){
			$(&quot;#userFilesSpace&quot;).jqxGauge({
				caption:{
					value:value+&quot; MB&quot;
				}
			});
			$(&quot;#userFilesSpace&quot;).jqxGauge({&quot;value&quot;: value});
			var maxSpace = 10;	&#x2F;&#x2F;TODO
			var usedSpace = mygis.Utilities.format(&quot; {0} MB {1} {2} MB&quot;,value,&quot;out of&quot;,maxSpace);
			$(&quot;#currentUsedSpaceSpan&quot;).html(usedSpace);
		},

		&#x2F;**
			This methods handles the pressing of &quot;OK&quot; button in the MediaManager.
			Checks if a function is waiting for input from the MediaManager and if true, forwards the input.
			@method acceptWindow
		**&#x2F;
		acceptWindow: function(){
			var grid = $(&quot;#userFilesList&quot;);
			var selections = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
			if (internalConfig.mmCallback.fn!=null){
				var selectedCount = selections.length;
				var expectedCount = internalConfig.mmCallback.objectCount;
				if (selectedCount&lt;expectedCount &amp;&amp; expectedCount&gt;-1){
					alert(mygis.Utilities.format(strings.MediaManager.mm_err_notEnoughSelected,expectedCount));
				}else{
					var retobject;
					retobject = [];
					for (var i =0;i&lt;selections.length;i++){
						retobject.push(grid.jqxGrid(&#x27;getrowdata&#x27;,selections[i]));
					}
					$(&quot;#userFiles&quot;).dialog(&#x27;close&#x27;);
					internalConfig.mmCallback.fn.call(retobject,&quot;ok&quot;);
					mygis.UI.MediaManager.resetConfig();
				}
			}
		},

		&#x2F;**
			This method handles the pressing of &quot;Cancel&quot; button in the MediaManager.
			@method closeWindow
		**&#x2F;
		closeWindow: function(){
			if (internalConfig.mmCallback.fn!=null){
				internalConfig.mmCallback.fn.call(null,null);
				mygis.UI.MediaManager.resetConfig();
			}
			$(&quot;#userFiles&quot;).dialog(&#x27;close&#x27;);

		},

		&#x2F;**
			This method resets the inter-function communication vars.
			@method resetConfig
		**&#x2F;
		resetConfig: function(){
			internalConfig.mmCallback.fn=null;
			internalConfig.mmCallback.objectCount=-1;
			internalConfig.mmCallback.object=null;
			internalConfig.mmCallback.oid=null;
			internalConfig.mmCallback.layer=null;
			$(&quot;#fileUploaderCont&quot;).hide();
		},

		&#x2F;**
			This is used to trigger a &quot;save as&quot; dialog for the given file id.
			@method downloadFile
			@param {String} fileID
		**&#x2F;
		downloadFile: function(fileID){
			if (!fileID){
				var grid = $(&quot;#userFilesList&quot;);
				var rowindexes = grid.jqxGrid(&#x27;getselectedrowindexes&#x27;);
				if (rowindexes.length&gt;0){
					var rowdata;
					rowdata = grid.jqxGrid(&#x27;getrowdata&#x27;, rowindexes[0]);
					fileID=rowdata.fileID;
				}
			}
			var url = mygis.Utilities.format(config.mgreq+&quot;?qtype=DownloadFile&amp;qContents={0}&quot;,fileID);
			window.open(url);
		},

		&#x2F;**
			Toggles selection of MediaManager files.
			If all items are selected, it unselects everything. Otherwise it selects everything.
			@method toggleSelection
			@param {Element} elem The calling element
		**&#x2F;
		toggleSelection: function(elem){
			var grid = $(&quot;#userFilesList&quot;);
			var alreadySelected = grid.jqxGrid(&#x27;selectedrowindexes&#x27;);
			var gridLength = grid.jqxGrid(&#x27;source&#x27;).records.length;
			var on = alreadySelected.length&lt;gridLength;
			if (on){
				for (var i=0;i&lt;gridLength;i++){
					if (alreadySelected.indexOf(i)==-1)
						grid.jqxGrid(&#x27;selectrow&#x27;,i);
				}
				$(elem).html(strings.MediaManager.btnUnselectAll);
			}else{
				grid.jqxGrid(&#x27;clearselection&#x27;);
				mygis.UI.MediaManager.fileUnselected();
				$(elem).html(strings.MediaManager.btnSelectAll);
			}
		}
	},

	&#x2F;**
	 * Macro creation functions
	 * @class UI.Macros
	 * @static
	 *&#x2F;
	Macros:{

		&#x2F;**
		 * Creates a new Macro
		 * @method createNew
		 * @param {Integer} id The macro id
		 * @param {String} name The macro name. This is used for the button text if isButton=true
		 * @param {Boolean} isButton whether this macro should be attached to a button
		 * @param {String} commands The various commands to execute
		 * @param {Object} options Any additional options to pass
		 *&#x2F;
		createNew: function(id,name,isButton,commands,parentSelector,cont_css,btn_css,options,contClass,btnClass){
			&#x2F;*
			 * example
			 * command 1: mygis.UI.toggleLayerEditable(0);
			 * command 2: router(&#x27;markerButton&#x27;,document.getElementById(&quot;markerButton&quot;));
			 *&#x2F;
			if (isButton){
				var parent = $(parentSelector);
				var btn = $(&quot;&lt;a &#x2F;&gt;&quot;);
				var btnLink = $(&quot;&lt;span class=&#x27;&quot;+btnClass+&quot;&#x27; &#x2F;&gt;&quot;);
				btn.attr(&quot;id&quot;,&quot;macro_&quot;+id+&quot;_cont&quot;);
				btn.attr(&quot;class&quot;,contClass);
				
				&#x2F;&#x2F;console.log(&quot;btnClass: &quot;+btnClass);
				btnLink.attr(&quot;id&quot;,&quot;macro_&quot;+id);
				btnLink.append(name);
				btn.bind(&quot;click&quot;,new Function(commands));
				btn.append(btnLink);
				&#x2F;&#x2F;btnLink.attr(&quot;class&quot;,btnClass);
				btn.attr(&quot;style&quot;,cont_css);
				btnLink.attr(&quot;style&quot;,btn_css);
				parent.append(btn);
				internalConfig.macroButtons.push(&quot;macro_&quot;+id);
			}else{
				if (!mygis.Macros){
					mygis.Macros = {};
				}
				mygis.Macros[name]=new Function(commands);
				mygis.Macros[name]();	&#x2F;&#x2F;and execute it
			}
		},

		&#x2F;**
		 *	Clears any previously placed macro buttons
		 *	@method clearButtons
		 *&#x2F;
		clearButtons: function(){
			$.each(internalConfig.macroButtons,function(i,v){
				var item = $(&quot;#&quot;+v);
				var cont = $(&quot;#&quot;+v+&quot;_cont&quot;);
				item.remove();
				cont.remove();
			});
			internalConfig.macroButtons.length=0;
		},

		&#x2F;**
		 *	Retrieves a list of macros
		 *	@method getList
		 *&#x2F;
		getList: function(){
			var retvalue;
			var myurl = config.folderPath+&quot;mgreq.ashx?qtype=getMacros&amp;qContents=&quot;+currentMapID;
			var source =
			{
				datatype: &quot;json&quot;,
				datafields: [
					{ name: &quot;macroID&quot; },
					{ name: &quot;mapID&quot;},
					{ name: &quot;appID&quot; },
					{ name: &quot;name&quot; },
					{ name: &quot;commands&quot; },
					{ name: &quot;parentSelector&quot;},
					{ name: &quot;cont_css&quot;},
					{ name: &quot;btn_css&quot;},
					{ name: &quot;options&quot;},
					{ name: &quot;contClass&quot;},
					{ name: &quot;btnClass&quot;}, 
					{ name: &quot;isButton&quot;}
				],
				id: &#x27;macroIDSource&#x27;,
				url: myurl
			};
			retvalue = new $.jqx.dataAdapter(source,{async:false});
			retvalue.dataBind();
			return retvalue;
		},

		&#x2F;**
		 *	Initializes the macros
		 *	@method init
		 *&#x2F;
		init: function(){
			try{
			mygis.UI.Macros.clearButtons();
			var source = mygis.UI.Macros.getList();
			for (var i=0;i&lt;source.records.length;i++){
				var rec = source.records[i];
				mygis.UI.Macros.createNew(rec.macroID,rec.name,mygis.Utilities.stringToBoolean(rec.isButton),rec.commands,rec.parentSelector,rec.cont_css,rec.btn_css,rec.options,rec.contClass, rec.btnClass);
			}
			}catch(err){console.log(err.message);}
		}
	},

	&#x2F;**
	 * Functions related to providing user help, like help baloons, tips etc
	 * @class UI.Help
	 * @static
	 *&#x2F;
	Help: {

		&#x2F;**
		 * Creates a popup containing help text
		 * @method createPopup
		 * @param {String} id The popup&#x27;s container id
		 * @param {String} html The popup&#x27;s contents. Any valid html string
		 * @param {String} headerText The popup&#x27;s title
		 * @param {Boolean} displayHeader Whether to display the popup&#x27;s header or not
		 * @param {Boolean} displayClose Whether to display the close button or not
		 * @param {Boolean} movable Whether the popup is movable or not
		 * @param {String,Array} position The starting position
		 * @param {Array} size width,height of the dialog
		 *&#x2F;
		createPopup: function(id,html,headerText,displayHeader,displayClose,movable,position,size){
			var cont = $(&quot;&lt;div &#x2F;&gt;&quot;);
			cont.attr(&quot;id&quot;,id);
			var txt = $(&quot;&lt;div &#x2F;&gt;&quot;);
			txt.html(html);
			cont.append(txt);
			if (!displayClose){
				cont.dialog({
					autoOpen: true,
					modal: true,
					resizable: false,
					width: size[0],
					height: size[1],
					title: headerText,
					closeOnEscape: false,
					draggable: movable,
					close: function(event, ui){
						$(this).dialog(&#x27;destroy&#x27;).remove();
					},
					position: position||&quot;center&quot;
				}).siblings(&#x27;div.ui-dialog-titlebar&#x27;).remove()
			}else{
				cont.dialog({
					autoOpen: true,
					modal: true,
					resizable: false,
					width: size[0],
					height: size[1],
					title: headerText,
					closeOnEscape: false,
					draggable: movable,
					close: function(event, ui){
						$(this).dialog(&#x27;destroy&#x27;).remove();
					},
					position: position||&quot;center&quot;
				});
			}
		},

		showManual: function(override){
			var show=false;
			var src=&quot;&quot;;
			switch(currentAppName){
				case &quot;ToBeParks&quot;:
					show=true;
					src=&quot;&#x2F;mgManual.pdf&quot;;
					break;
				case &quot;psyhat&quot;:
					show=true;
					src=&quot;&#x2F;psyhatManual.pdf&quot;;
					break;
			}
			if (show){
				if ($(&quot;#mygis_manual&quot;).children().length&gt;0){
					$(&quot;#mygis_manual&quot;).dialog(&#x27;show&#x27;);
				}else{
					var superCont = $(&quot;&lt;div &#x2F;&gt;&quot;);

					var cont = $(&quot;&lt;iframe &#x2F;&gt;&quot;);
					cont.attr(&quot;id&quot;,&quot;mygis_manual&quot;);
					cont.attr(&quot;src&quot;,src);
					cont.css({
						&quot;width&quot;:&quot;100%&quot;,
						&quot;height&quot;: &quot;100%&quot;
					});
					superCont.append(cont);
					superCont.dialog({
						modal: true,
						autoOpen: false,
						width: 900,
						height: 500,
						title: strings.HelpSystem.manual,
						resizable: true
					});

					superCont.dialog(&#x27;open&#x27;);
				}
			}else{
				displayNotify(msg_errFeatureNotImplemented);
			}
		},
		
		shortcutsReset: function(){
			$(&quot;#pageHelpActions a[id^=&#x27;pageHelp&#x27;]&quot;).attr(&quot;class&quot;,&quot;&quot;);
			QuerySettingsVisibility(false);
		},
		
		shortcutStart: function(){
			mygis.UI.Help.shortcutsReset();
			mygis.UI.toggleActiveList(internalConfig.layerTabIndex);
			$(&quot;#pageHelpStartHere&quot;).attr(&quot;class&quot;,&quot;active&quot;);
		},

		shortcutMaps: function(){
			&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&quot;select&quot;,internalConfig.mapTabIndex);
			&#x2F;*
			mygis.UI.Help.shortcutsReset();
			mygis.UI.toggleActiveList(internalConfig.mapTabIndex);
			$(&quot;#pageHelpChangeMap&quot;).attr(&quot;class&quot;,&quot;active&quot;);
			*&#x2F;
			if ($(&quot;#mapsPanel&quot;).is(&quot;:visible&quot;)){
				$(&quot;#mapsPanel&quot;).slideUp(&#x27;fast&#x27;);
				$(&quot;#mapsPanelOverlay&quot;).hide().unbind(&#x27;click&#x27;);
			}else{
				$(&quot;#mapsPanelOverlay&quot;).show().click(function(){
					mygis.UI.Help.shortcutMaps();
				});
				$(&quot;#mapsPanel&quot;).slideDown({
					duration: &#x27;slow&#x27;,
					complete: function(){
						$(&quot;#mapsAnalysis&quot;)[0].ex_AddClassName(&quot;active&quot;);
						$(&quot;#mapsList&quot;).jqxListBox(&#x27;width&#x27;,243);
						$(&quot;#mapsList&quot;).jqxListBox(&#x27;width&#x27;,244);
						
					}
				});
				$(&quot;#mapsPanel&quot;).css(&quot;left&quot;,$(&quot;#mapDescription&quot;).offset().left-7);
			}
			
			
		},

		shortcutSearch: function(){
			&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&quot;select&quot;,internalConfig.searchTabIndex);
			mygis.UI.Help.shortcutsReset();
			mygis.UI.toggleActiveList(internalConfig.searchTabIndex);
			$(&quot;#pageHelpSearchMap&quot;).attr(&quot;class&quot;,&quot;active&quot;);
			&#x2F;&#x2F;$(&quot;#searchSettings&quot;).show();
			&#x2F;&#x2F;$(&quot;#btnSearchSettings&quot;).attr(&quot;class&quot;,&quot;active&quot;);
			&#x2F;&#x2F;showQueryDialog();
		},

		tutorial:function(action,caller){
			var targetElem;
			var actionX=0;
			var actionY=0;
			var cbFunction;
			var initialized=false;
			switch(action){
				case &quot;changeBG&quot;:
					if (!internalConfig.helpTips.switchBG_animPlaying){
						&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;select&#x27;,internalConfig.layerTabIndex);
						internalConfig.helpTips.switchBG_animPlaying=true;
						var grid = $(&quot;#layersList&quot;);
						var rowid = grid.jqxGrid(&#x27;getrowid&#x27;,grid.jqxGrid(&#x27;source&#x27;).localdata.length-1);
						var colnumber = 1;
						if (Sys.Services.AuthenticationService.get_isLoggedIn()){
							colnumber = 7;
						}else{
							colnumber = 5;
						}
						targetElem = $(mygis.Utilities.format(&quot;#row{0}layersList div:nth-child({1})&quot;,rowid,colnumber));
						actionY=10;
						initialized=true;
						cbFunction= function(){
							singleQTip(&quot;switchBG&quot;,[targetElem]);
							internalConfig.helpTips.switchBG_animPlaying=false;
						};
					}
					break;
			}
			if(initialized){
				var source_offset = $(caller).offset();
				var source_top = source_offset.top;
				var source_left = source_offset.left;
				var target_offset = targetElem.offset();
				var target_top = target_offset.top+actionY;
				var target_left = target_offset.left+actionX;

				mygis.UI.Help.animateCursor([source_top,source_left],[target_top,target_left],cbFunction);
			}
		},

		animateCursor: function(from,to,callback){
			var div = $(&quot;&lt;div class=&#x27;tutorialCursor&#x27; &#x2F;&gt;&quot;);
			$(&quot;body&quot;).append(div);
			div.css({&quot;top&quot;: from[0]+&quot;px&quot;,&quot;left&quot;: from[1]+&quot;px&quot;});
			div.animate({
				&quot;top&quot;: to[0]+&quot;px&quot;,
				&quot;left&quot;: to[1]+&quot;px&quot;
			},{
				duration: 4000,
				complete: function(){
					div.remove();
					callback();
				}
			});
		}
	},

	&#x2F;**

		@method attachFileToRecord
		@param {String} fid The object identifier (Tablename.OID)
	**&#x2F;
	attachFileToRecord: function (fid){
		internalConfig.mmCallback.fn=mygis.UI.attachFileToRecordResult;
		internalConfig.mmCallback.objectCount=1;
		internalConfig.mmCallback.object=fid;
		showMediaManager();
	},
	
	layerCloneInit: function(event){
		var originalList = $(&quot;#layersList&quot;);
		var clonedList = $(&quot;#layerlistClone&quot;);
		var outerRenderer = function(row,datafield,value){
			var class1=&quot;&quot;;
			var class2=&quot;&quot;;
			var class3=&quot;&quot;;
			var title=&quot;&quot;;
			var action=&quot;&quot;;
			var retvalue = &quot;&quot;;
			var retvalue = &quot;&quot;;
			switch (datafield){
				case &quot;Visible&quot;:
					class1 = &quot;layer_visible&quot;;
					class2 = mygis.Utilities.stringToBoolean(value)?&quot;pressed&quot;:&quot;&quot;;
					&#x2F;&#x2F;class3 = Boolean(this.owner.getrowdata(row).Locked)?&quot;disabled&quot;:&quot;&quot;;
					title = strings.LayerControl.columnVisible;
					action = &quot;router(&#x27;tlvm&#x27;,&quot;+row+&quot;);&quot;;	&#x2F;&#x2F;&quot;mygis.UI.toggleLayerSelectable(&quot;+(row)+&quot;);&quot;;
				break;
			}
			retvalue = &#x27;&lt;a href=&quot;#&quot; onclick=&quot;&#x27;+action+&#x27;return false;&quot; class=&quot;&#x27;+class1+&#x27; &#x27;+class3+&#x27; &#x27;+class2+&#x27;&quot; title=&quot;&#x27;+title+&#x27;&quot;&gt;&lt;&#x2F;a&gt;&#x27;;;	&#x2F;&#x2F;temp
			return retvalue;
		}
		var outerColumns = [
			{text: &#x27;&#x27;,datafield:&#x27;Visible&#x27;, width: 20,cellsrenderer: outerRenderer},
			{text: &#x27;Folder&#x27;, datafield:&#x27;Name&#x27;, editable:false}
		];
		var outerSource = layerSource.getrecords();
		var folders={
			&quot;Unknown&quot;: []
		};
		$.each(outerSource,function(x,y){
			if (y.folderName){
				if (!folders[y.folderName]){
					folders[y.folderName]=[];
				}
				folders[y.folderName].push(y);
			}else{
				folders[&quot;Unknown&quot;].push(y);
					
			}
		});
		var maxCount=0;
		var minCount=1;
		&#x2F;&#x2F;outerSource=[];
		var innerSource =[];
		$.each(folders,function(x,y){
			if (folders[x].length&gt;0){
				if (folders[x].length&gt;maxCount){maxCount=folders[x].length;}
				if (folders[x].length&lt;minCount){minCount=folders[x].length;}
				innerSource.push({
					&quot;Visible&quot;: true, 
					&quot;Name&quot;: x
				});
			}
		});
		 var source = { datafields: [
			{ name: &#x27;Visible&#x27;},
			{ name: &#x27;Name&#x27;, type: &#x27;string&#x27; }
			],
			id: &#x27;asdf2&#x27;,
			localdata: innerSource
		};
		var nestedGrids = new Array();
		
		var adapter = new $.jqx.dataAdapter(source, { autoBind: true });
		clonedList.jqxGrid({
			width: 241,
			height: &#x27;100%&#x27;,
			source: adapter,
			rowdetails: true,
			autorowheight: true,
			autoheight: true, 
			initrowdetails: mygis.UI.layerNestedCloneInit(nestedGrids,folders),
			rowdetailstemplate: { rowdetails: &quot;&lt;div id=&#x27;layerClonedGrid&#x27; style=&#x27;margin: 10px;&#x27;&gt;&lt;&#x2F;div&gt;&quot;,rowdetailsheight:(maxCount*29)+10, rowdetailshidden: true },
			columns: outerColumns,
			showheader: false,
			showgroupsheader: false,
			theme: &#x27;pk_mg&#x27;
		});
		
	},
	
	layerNestedCloneInit: function(nestedGrids,outerSource){
		var groupsrenderer = function (text, group, expanded,properties) {
			return &quot;&quot; + group + &quot; (&quot;+properties.rows.length+&quot;)&quot;;
		}
		return function(index, parentElement, gridElement, record){
			var id = record.Name;
			var grid = $($(parentElement).children()[0]);
			nestedGrids[index] = grid;
			var layersByFolder = [];
			for(var i=0;i&lt;outerSource[id].length;i++){
				layersByFolder.push(outerSource[id][i]);
			}
			var layerInnerSource = { datafields: [
					{ name: &quot;mapID&quot; },
					{ name: &quot;layerID&quot; },
					{ name: &quot;layerNAME&quot; },
					{ name: &quot;layerDESCRIPTION&quot; },
					{ name: &quot;layerTABLE&quot; },
					{ name: &quot;layerORDER&quot; },
					{ name: &quot;layerEXTENTS&quot;}, 
					{ name: &quot;hidden&quot;},
					{ name: &quot;Editable&quot;},
					{ name: &quot;Selectable&quot;},
					{ name: &quot;layerMinScale&quot; },
					{ name: &quot;layerMaxScale&quot; },
					{ name: &quot;manualVisibility&quot; },
					{ name: &quot;layerGeomType&quot; },
					{ name: &quot;folderName&quot;}
				],
				id: &#x27;asdf3&#x27;,
				localdata: layersByFolder
			}
			var nestedGridAdapter = new $.jqx.dataAdapter(layerInnerSource);
			nestedGridAdapter.dataBind();
			layergridSource = {
				localdata: mygis.UI.buildGridSource(nestedGridAdapter,&#x27;layers&#x27;,false),
				datatype: &#x27;array&#x27;
			};
			if (grid != null) {
				grid.jqxGrid({
					source: layergridSource, 
					width: 200, 

					columns: [
						&#x2F;&#x2F;{text: &#x27;&#x27;, datafield: &#x27;Locked&#x27;, width: 26, cellsrenderer: mygis.UI.layerInnerCellRenderer(), editable:false},
						{text: &#x27;&#x27;,datafield:&#x27;Visible&#x27;, width: 13,cellsrenderer: mygis.UI.layerInnerCellRenderer()},
						{text: &#x27;&#x27;,datafield:&#x27;Image&#x27;, width: 26, cellsrenderer: mygis.UI.layerGraphicCellRenderer(),editable:false},
						{text: strings.LayerControl.columnName, datafield:&#x27;Name&#x27;, cellsrenderer: mygis.UI.layerInnerCellRenderer(), editable:false},
						{text: &#x27;&#x27;, datafield: &#x27;Selectable&#x27;, width: 16, cellsrenderer: mygis.UI.layerInnerCellRenderer(), editable:false}
					],
					autorowheight: true,
					&#x2F;&#x2F;autoheight: true, 
					height:&#x27;90%&#x27;,
					theme: &#x27;pk_mg&#x27;,
					rowdetails: false,
					sortable: true,
					groupable: true,
					showheader: false,
					showgroupsheader: false,
					editable: false,
					selectionmode: &#x27;none&#x27;,
					groupsrenderer: groupsrenderer,
					scrollbarsize: 5,
					rendered: layerGridRendered
				});
				grid.find(&#x27;.layerLegendGraphic&#x27;).live({
					mouseenter: layerStyleFullZoom,
					mouseleave: layerStyleFullZoomOff
				});
			}
		};
	},
	
	layerGraphicCellRenderer: function(){
		return function (row, datafield, value) {
			&#x2F;&#x2F;return &#x27;&lt;img style=&quot;margin-left: 5px;&quot; height=&quot;60&quot; width=&quot;50&quot; src=&quot;&#x27; + value + &#x27;&quot;&#x2F;&gt;&#x27;;
			&#x2F;&#x2F;console.log(&#x27;IR1 - datafield: &#x27;+datafield + &#x27;\r\n&#x27;+&#x27;value: &#x27;+value);
			if (value==&quot;none&quot; || value==99999){console.log(&quot;gotcha1&quot;);}
			if (value){
				&#x2F;&#x2F;return &#x27;&lt;div class=&quot;layerLegendGraphic&quot; style=&quot;background-image:url(&#x27;+value+&#x27;);&quot;&gt;&lt;&#x2F;div&gt;&#x27;;
				return &#x27;&lt;div class=&quot;layerLegendGraphic normalLayer&quot; style=&quot;background-image:url(&#x27;+value+&#x27;);&quot;&gt;&lt;img style=&quot;pointer-events: none;&quot; src=&quot;&#x27; + value + &#x27;&quot;&#x2F;&gt;&lt;&#x2F;div&gt;&#x27;;
			}else{
				&#x2F;&#x2F;console.log(&quot;gotcha2&quot;);
				var value2=config.folderPath+&#x27;Images&#x2F;layerList&#x2F;tilecache-layer.png&#x27;;
				return &#x27;&lt;div class=&quot;layerLegendGraphic background&quot; style=&quot;background-image: url(&#x27;+value2+&#x27;);&quot;&gt;&lt;img style=&quot;pointer-events: none;&quot; src=&quot;&#x27; + value2 + &#x27;&quot;&#x2F;&gt;&lt;&#x2F;div&gt;&#x27;;
			}
		}
	},
	
	buildSelectionListSource: function(dataAdapter){
		var data=dataAdapter.records;
		var records=[];
		$.each(data,function(i,v){
			if (!(Boolean(v.hidden)===true)){
				&#x2F;&#x2F;v.label=v.layerNAME;
				&#x2F;&#x2F;v.value=v.layerTABLE;
				records.push(v);
			}
		});
		var retvalue={
			localdata: records,
			datatype: &#x27;array&#x27;
		};
		var dataAdapter = new $.jqx.dataAdapter(retvalue);
		dataAdapter.dataBind();
		return dataAdapter;
	},
	
	&#x2F;**
	  *Gets a layer&#x27;s checkbox status in the &quot;legend&quot; panel
	  *That checkbox might actually reflect the current visibility status of the layer, 
	  *or the user has unsaved changes. 
	  *Used because the panel refreshes often, and the user might not have applied changes yet.
	  * @method getLayerCheckStatus
	  * @param item {Object}
	  *&#x2F;
	getLayerCheckStatus: function(item){
		var status=false;
		var found=false;
		if (internalMemory.unsavedLayerChanges.length&gt;0){
			var i=0;
			var items=internalMemory.unsavedLayerChanges;
			while (!found &amp;&amp; i &lt; items.length){
				var check = items[i];
				if (item.layerID==check.layerID){
					found=true;
					status=!mygis.Utilities.stringToBoolean(check.hidden);
				}
				i++;
			}
		}
		if (!found){
			status=!mygis.Utilities.stringToBoolean(item.hidden);
		}
		
		return status;
	},
	
	applyLayerChanges: function(){
		$(&quot;#applyLayersCont&quot;).hide(&#x27;slide&#x27;,{direction: &#x27;down&#x27;},300);
		mygis.Utilities.blockUI();
		$.each(internalMemory.unsavedLayerChanges,function(i,v){
			var i=0;
			var found=false;
			var items = layerSource.records
			while (!found &amp;&amp; i &lt; items.length){
				var check=items[i];
				if (v.layerID==check.layerID){
					found=true;
					check.hidden=v.hidden;
					check.manualVisibility=true;
				}
				i++;
			}
		});
		internalMemory.unsavedLayerChanges.length=0;
		var mapItem = $(&quot;#mapsList&quot;).jqxListBox(&#x27;getSelectedItem&#x27;).originalItem;
		loadMapSequence(mapItem);
		mygis.UI.updateLayerGrid();
	},
	
	cancelLayerChanges: function(){
		$(&quot;#applyLayersCont&quot;).hide(&#x27;slide&#x27;,{direction: &#x27;down&#x27;},300);
		internalMemory.unsavedLayerChanges.length=0;
		mygis.UI.updateLayerGrid(true);
	},
	
	buildGridSource: function(dataAdapter,mode,includeBG){
		var data = dataAdapter.records;
		switch (mode)
		{
			case &quot;layers&quot;:
				var source = new Array();
				for (var i = 0; i &lt; data.length; i++) {
					var item = data[i];
					var label = item.layerNAME;
					var row = {};
					row[&quot;#&quot;]=i+1;
					row[&quot;Name&quot;]=label;
					row[&quot;Visible&quot;]=mygis.UI.getLayerCheckStatus(item);	&#x2F;&#x2F;!mygis.Utilities.stringToBoolean(item.hidden);
					&#x2F;&#x2F;console.log(item.layerNAME+&quot; visible: &quot;+row[&quot;Visible&quot;]);
					if (item.mygisImageSrc){
						row[&quot;Image&quot;]=item.mygisImageSrc;
					}else{
						var img = mygis.UI.getSingleLegend(item.layerTABLE,item.layerGeomType);
						row[&quot;Image&quot;]=img.src;
					}
					row[&quot;Type&quot;]=strings.LayerControl.typeData;
					row[&quot;Savable&quot;]=item.Savable;
					row[&quot;Editable&quot;]=item.Editable;
					row[&quot;Selectable&quot;]=item.Selectable;
					&#x2F;&#x2F;row[&quot;Locked&quot;]=item.Locked;
					row[&quot;manualVisibility&quot;]=item.manualVisibility;
					row[&quot;folderName&quot;]=item.folderName?item.folderName:strings.LayerControl.noFolderName;
					source.push(row);
				}
				&#x2F;&#x2F;if (includeBG){
					for (var i=0;i&lt;digimap.layers.length;i++){
						var layer = digimap.layers[i];
						&#x2F;*
						if (layer.isBaseLayer){
							var newObj = {};
							if (newObj.Visible){
								newObj[&quot;#&quot;]=data.length+1;
							}else{
								newObj[&quot;#&quot;]=99999;
							}
							newObj[&quot;Name&quot;]=layer.name;
							newObj[&quot;Visible&quot;]= layer.visibility;
							newObj[&quot;Image&quot;]=&quot;&quot;;
							newObj[&quot;Type&quot;]=strings.LayerControl.typeBackground;
							newObj[&quot;Savable&quot;]=false;
							newObj[&quot;Editable&quot;]=false;
							newObj[&quot;Selectable&quot;]=false;
							&#x2F;&#x2F;newObj[&quot;Locked&quot;]=true;
							newObj[&quot;manualVisibility&quot;]=layer.manualVisibility;
							newObj[&quot;folderName&quot;]=&quot;Background&quot;;
							source.push(newObj);
						}
						*&#x2F;
						if (layer.isBaseLayer){
							for (var bg in backgrounds){
								if (backgrounds[bg].hasOwnProperty(&quot;name&quot;)){
									var newObj = {};
									newObj[&quot;#&quot;]=99999;
									newObj[&quot;Name&quot;]=backgrounds[bg].name;
									newObj[&quot;Visible&quot;]= layer.visibility &amp;&amp; (layer.name==backgrounds[bg].name);
									newObj[&quot;Image&quot;]=&quot;&quot;;
									newObj[&quot;Type&quot;]=strings.LayerControl.typeBackground;
									newObj[&quot;Savable&quot;]=false;
									newObj[&quot;Editable&quot;]=false;
									newObj[&quot;Selectable&quot;]=false;
									newObj[&quot;manualVisibility&quot;]=layer.manualVisibility;
									newObj[&quot;folderName&quot;]=&quot;Background&quot;;
									source.push(newObj);
								}else{
									for (var sub in backgrounds[bg]){
										var newObj = {};
										newObj[&quot;#&quot;]=99999;
										newObj[&quot;Name&quot;]=backgrounds[bg][sub].name;
										newObj[&quot;Visible&quot;]= layer.visibility&amp;&amp; (layer.name==backgrounds[bg][sub].name);
										newObj[&quot;Image&quot;]=&quot;&quot;;
										newObj[&quot;Type&quot;]=strings.LayerControl.typeBackground;
										newObj[&quot;Savable&quot;]=false;
										newObj[&quot;Editable&quot;]=false;
										newObj[&quot;Selectable&quot;]=false;
										newObj[&quot;manualVisibility&quot;]=layer.manualVisibility;
										newObj[&quot;folderName&quot;]=&quot;Background&quot;;
										source.push(newObj);
									}
								}
								
							}
						}
					}
				&#x2F;&#x2F;}
				return source;
		}
	},
	
	layerInnerCellRenderer: function(){
		return function(row,datafield,value){
			var class1=&quot;&quot;;
			var class2=&quot;&quot;;
			var class3=&quot;&quot;;
			var title=&quot;&quot;;
			var action=&quot;&quot;;
			var retvalue = &quot;&quot;;
			switch (datafield){
				case &quot;#&quot;:
					class1=&quot;layer_options&quot;;
					if (value!=99999){
						action=&quot;router(&#x27;codingTLD&#x27;,&quot;+(value-1)+&quot;);&quot;; &#x2F;&#x2F;&quot;toggleLayerDetails(&quot;+(value-1)+&quot;,this);&quot;;
						title = strings.LayerControl.columnProperties;
					}else{
						action=&quot;router(&#x27;cycleBG&#x27;,[&#x27;&quot;+this.owner.getrowdata(row).Name+&quot;&#x27;,&quot;+row+&quot;]);&quot;;
						title = strings.LayerControl.columnCycle;
					}
					
					break;
				case &quot;Name&quot;:
					var layerID = this.owner.getrowdata(row)[&quot;#&quot;];
					var rowheight = 21;
					var rowindex = row - layerSource.records.length;
					var action = mygis.Utilities.format(&quot;switchBG_{0}&quot;,rowindex);
					if (layerID==99999){
						retvalue=mygis.Utilities.format(&quot;&lt;div title=&#x27;{0}&#x27; class=&#x27;imageVerticalContainer2&#x27; style=&#x27;font-size: 11px;height: {1}px;text-align:left;&#x27;&gt;{0}&lt;&#x2F;div&gt;&quot;,value,rowheight);
					}else{
						retvalue=mygis.Utilities.format(&quot;&lt;div title=&#x27;{0}&#x27; class=&#x27;imageVerticalContainer2&#x27; style=&#x27;font-size: 11px;height: {1}px;&#x27;&gt;{0}&lt;&#x2F;div&gt;&quot;,value,rowheight);
					}
					break;
				case &quot;Visible&quot;:
					var layerID = this.owner.getrowdata(row)[&quot;#&quot;];
					if (layerID==99999){
						class1 = &quot;layer_visible background&quot;;
					}else{
						class1 = &quot;layer_visible&quot;;
					}
					class2 = value?&quot;pressed&quot;:&quot;&quot;;
					if (value){
						class3 = &quot;jqx-checkbox-default jqx-checkbox-default-pk_mg jqx-rc-all jqx-rc-all-pk_mg jqx-checkbox-check-checked&quot;;
					}else{
						class3 = &quot;jqx-checkbox-default jqx-checkbox-default-pk_mg jqx-fill-state-normal jqx-fill-state-normal-pk_mg jqx-rc-all jqx-rc-all-pk_mg&quot;;
					}
					title = strings.LayerControl.columnVisible;
					action = &quot;router(&#x27;tlvm&#x27;,&quot;+row+&quot;);return true;&quot;;	
					break;
				case &quot;Savable&quot;:
					class1= &quot;layer_savable&quot;;
					class2 = Boolean(value)?&quot;pressed&quot;:&quot;&quot;;
					action=&quot;router(&#x27;codingSaveLayer&#x27;,&quot;+(value-1)+&quot;);&quot;;
					title = strings.LayerControl.saveChanges;
					break;
				case &quot;Editable&quot;:
					class1 = &quot;layer_editable&quot;;
					class2 = mygis.Utilities.stringToBoolean(value)?&quot;pressed&quot;:&quot;&quot;;
					class3 = mygis.Utilities.stringToBoolean(this.owner.getrowdata(row).Locked)?&quot;disabled&quot;:&quot;&quot;;
					title = strings.LayerControl.columnEditable;
					action = &quot;router(&#x27;codingTLE&#x27;,&quot;+row+&quot;);&quot;;	&#x2F;&#x2F;&quot;mygis.UI.toggleLayerEditable(&quot;+(row)+&quot;);&quot;;
					break;
				case &quot;Selectable&quot;:
					class1 = &quot;layer_selectable&quot;;
					class2 = mygis.Utilities.stringToBoolean(value)?&quot;pressed&quot;:&quot;&quot;;
					&#x2F;&#x2F;class3 = Boolean(this.owner.getrowdata(row).Locked)?&quot;disabled&quot;:&quot;&quot;;
					title = strings.LayerControl.columnSelectable;
					action = &quot;router(&#x27;codingTLS&#x27;,&quot;+row+&quot;);&quot;;	&#x2F;&#x2F;&quot;mygis.UI.toggleLayerSelectable(&quot;+(row)+&quot;);&quot;;
					break;
				case &quot;Locked&quot;:
					class1 = &quot;layer_locked&quot;;
					class2 = mygis.Utilities.stringToBoolean(value)?&quot;pressed&quot;:&quot;&quot;;
					title = strings.LayerControl.columnLocked;
					break;
				case &quot;Type&quot;:
					class1 = &quot;layer_type&quot;;
					class2 = value==strings.LayerControl.typeData?&quot;layer_type_data&quot;:&quot;layer_type_bg&quot;;
					title = value==strings.LayerControl.typeData?strings.LayerControl.typeData:strings.LayerControl.typeBackground;
					break;
				case &quot;folderName&quot;:
					console.log(&quot;value: &quot;+value);
					retvalue=mygis.Utilities.format(&quot;&lt;div class=&#x27;imageVerticalContainer2&#x27; style=&#x27;font-size: 11px;height: {1}px;&#x27;&gt;{0}&lt;&#x2F;div&gt;&quot;,value,20);
					break;
			}
			if (datafield!=&quot;Name&quot; &amp;&amp; datafield!=&quot;folderName&quot;){
				if (datafield==&quot;#&quot; &amp;&amp; value==99999){
					return &quot;&quot;;
				}else{
					return &#x27;&lt;a href=&quot;#&quot; onclick=&quot;&#x27;+action+&#x27;return false;&quot; class=&quot;&#x27;+class1+&#x27; &#x27;+class3+&#x27; &#x27;+class2+&#x27;&quot; title=&quot;&#x27;+title+&#x27;&quot;&gt;&lt;&#x2F;a&gt;&#x27;;
				}
			}else{
				return retvalue;			
			}
		}
	},

	&#x2F;**

		@method replaceFileInRecord
		@param {String} tablename
		@param {String} OID
		@param {String} fileID
	**&#x2F;
	replaceFileInRecord: function(tablename,OID,fileID){
		internalConfig.mmCallback.fn=mygis.UI.replaceFileInRecordResult;
		internalConfig.mmCallback.objectCount=1;
		internalConfig.mmCallback.object={
			called_table: tablename,
			called_oid: OID,
			called_fileID: fileID
		};
		showMediaManager();
	},

	&#x2F;**
		This method is called after the user closes the Media Manager to attach a file.

		@method attachFileToRecordResult
		@param {String} result The operation&#x27;s result
	**&#x2F;
	attachFileToRecordResult: function(result){
		var resultObj=this;
		resultObj = resultObj[0];
		if (!result || result!=&quot;ok&quot;){
			if (result){
				displayError(result);
			}
		}else{
			mygis.Utilities.blockUI();
			var customurl = config.mgreq+&quot;?qtype=AttachFileToFeature&amp;qContents=&quot;+resultObj.fileID+&quot;%23&quot;+internalConfig.mmCallback.object;
			$.ajax({
				type:&quot;GET&quot;,
				url: customurl,
				success: function(data){
					try{
						mygis.Utilities.unblockUI();
						propertiesVisibility(&quot;&quot;,false);	&#x2F;&#x2F;This to force user to reselect the object
						var realResults = eval(data);
						if (realResults.iotype==&quot;success&quot;){
							displaySuccess(&quot;File attached. Please reselect the object to see the new results&quot;);
						}else{
							displayError(realResults.iomsg);
						}
					}
					catch(err){
						displayError(err.message);
					}
				}
			});

		}
	},

	&#x2F;**
		This method is called after the user closes the Media Manager to replace an attached file.

		@method replaceFileInRecordResult
		@param {String} result The operation&#x27;s result
	**&#x2F;
	replaceFileInRecordResult: function(result){
		var resultObj=this;

		resultObj = resultObj[0];
		if (!result || result!=&quot;ok&quot;){
			if (result){
				displayError(result);
			}
		}else{
			var config = internalConfig.mmCallback.object;
			var tablename=config.called_table;
			var oid=config.called_oid;
			var fid=config.called_fileID;
			var newFid=resultObj.fileID;
			mygis.UI.MediaManager.replaceFile(tablename,oid,fid,newFid);
		}
	},

	&#x2F;**
		This method builds an &quot;available images&quot; grid for use in object info.
		@method objectImageGrid
		@param {String} OID Object ID
		@param {String} tablename The layer.tableNAME
		@param {String} type The generic type: &#x27;Images&#x27; or &#x27;Files&#x27;
	**&#x2F;
	objectImageGrid: function(OID,tablename,type){
		var fid = tablename+&quot;.&quot;+OID;
		var imageSource=mygis.UI.getObjectGridSource(type,fid);
		var suffix = type==&quot;Images&quot;?&quot;image&quot;:&quot;file&quot;;
		var className = imageSource.records.length?&quot;imagegrid&quot;:&quot;imagegrid norecords&quot;;
		var grid = $(&quot;&lt;div id=&#x27;&quot;+fid.replace(&quot;.&quot;,&quot;_&quot;)+mygis.Utilities.format(&quot;__{0}grid&quot;,suffix)+&quot;&#x27; class=&#x27;&quot;+className+&quot;&#x27; &#x2F;&gt;&quot;);
		

		$.each(imageSource.records,function(i,v){
			var panel = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var panelTitle = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var panelContents = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var panelActions = $(&quot;&lt;div &#x2F;&gt;&quot;);
			panel.attr(&quot;class&quot;,&quot;objectFilePanel&quot;);
			panelTitle.attr(&quot;class&quot;,&quot;objectFileTitle&quot;);
			panelContents.attr(&quot;class&quot;,&quot;objectFileContents&quot;);
			panelActions.attr(&quot;class&quot;,&quot;objectFileActions&quot;);
			
			panel.append(panelContents);
			panel.append(panelActions);
			panel.append(panelTitle);

			if (!v.imageFRIENDLY || v.imageFRIENDLY==&quot;&quot;){
				panelTitle.append(v.imageNAME);
			}else{
				panelTitle.append(v.imageFRIENDLY);
			}
			if (type==&quot;Images&quot;){
				var action = &quot;router(&#x27;infopopup_previewImg&#x27;,this);&quot;;
				retobject = mygis.Utilities.format(&#x27;&lt;div style=&quot;&quot; title=&quot;{3}&quot;&gt;&lt;img onclick=&quot;{0}&quot; style=&quot;margin: 4px;&quot; src=&quot;{1}GetImage.ashx?qType=userFile&amp;qContents={2}&amp;qSize=45&quot; &#x2F;&gt;&lt;&#x2F;div&gt;&#x27;,
							action,
							config.folderPath,
							v.imageID,
							v.imageNAME);
			}else{
				var cname = &quot;&quot;;
				var extParts = v.imageNAME.split(&quot;.&quot;);
				var ext = extParts[extParts.length-1].toLowerCase();
				switch(ext){
					case &quot;doc&quot;:
					case &quot;docx&quot;:
						cname = &quot;doc&quot;;
						break;
					case &quot;xls&quot;:
					case &quot;xlsx&quot;:
						cname = &quot;xls&quot;;
						break;
					case &quot;ppt&quot;:
					case &quot;pptx&quot;:
						cname = &quot;ppt&quot;;
						break;
					case &quot;pdf&quot;:
						cname = &quot;pdf&quot;;
						break;
					default:
						cname = &quot;unknown&quot;;
						break;
				}
				retobject = mygis.Utilities.format(&#x27;&lt;div title=&quot;{0}&quot;&gt;&lt;div class=&quot;MMLargeFile {1}&quot; &#x2F;&gt;&lt;&#x2F;div&gt;&#x27;,
						v.imageNAME,
						cname);
			}

			panelContents.html(retobject);

			var imageButtons = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var imgBtnDownload = $(&quot;&lt;a &#x2F;&gt;&quot;);
			var imgBtnReplace = $(&quot;&lt;a &#x2F;&gt;&quot;);
			var imgBtnDelete = $(&quot;&lt;a &#x2F;&gt;&quot;);
			var disabledClass = !Sys.Services.AuthenticationService.get_isLoggedIn()?&quot; disabled&quot;:&quot;&quot;;
			imageButtons.attr(&quot;class&quot;,&quot;objectFileActionCont&quot;);
			imgBtnDownload.attr(&quot;class&quot;,&quot;btnTool imageDownload&quot;);
			imgBtnDelete.attr(&quot;class&quot;,&quot;btnTool imageDelete&quot;+disabledClass);
			imgBtnReplace.attr(&quot;class&quot;,&quot;btnTool imageReplace&quot;+disabledClass);

			imageButtons.append(imgBtnDownload);
			imageButtons.append(imgBtnReplace);
			imageButtons.append(imgBtnDelete);
			imgBtnDownload.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_download&#x27;,{0});&quot;,v.imageID));
			imgBtnDelete.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_detach&#x27;,[&#x27;{0}&#x27;,&#x27;{1}&#x27;,{2}]);&quot;,tablename,OID,v.imageID));
			imgBtnReplace.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_replace&#x27;,[&#x27;{0}&#x27;,&#x27;{1}&#x27;,{2}]);&quot;,tablename,OID,v.imageID));
			panelActions.append(imageButtons);

			grid.append(panel);
		});
		return grid;
	},

	&#x2F;**
		Builds a jqxDataAdapter source for the given grid type.
		This is used in object info (images and file tab accordingly)
		@method getObjectGridSource
		@param {String} type &#x27;Images&#x27; or &#x27;Files&quot;
		@param {String} key The object primary key
		@return {Object} jqxDataAdapter
	**&#x2F;
	getObjectGridSource: function(type,key){
		var myurl = mygis.Utilities.format(config.mgreq+&quot;?qtype=GetObject{0}&amp;qContents={1}&quot;,type,key);
		var retSource;
		var source;
		switch(type){
			case &quot;Images&quot;:
				source = {
					datatype: &quot;json&quot;,
					datafields:[
						{ name: &quot;imageID&quot; },
						{ name: &quot;imageNAME&quot; },
						{ name: &quot;imageFRIENDLY&quot; }
					],
					id: &#x27;ImagesSource&#x27;,
					url: myurl
				};
				break;
			case &quot;Files&quot;:
				source = {
					datatype: &quot;json&quot;,
					datafields:[
						{ name: &quot;imageID&quot; },
						{ name: &quot;imageNAME&quot; },
						{ name: &quot;imageFRIENDLY&quot; }
					],
					id: &#x27;FilesSource&#x27;,
					url: myurl
				};
				break;
		}
		mygis.Utilities.blockUI();
		retSource = new $.jqx.dataAdapter(source,{async:false});
		retSource.dataBind();
		mygis.Utilities.unblockUI();
		return retSource;
	},
	
	&#x2F;**
		Builds the layout for images inside info popup
		@method getInfoImageGrid
		@param (Array) data The image records
		@param (String) id A unique identifier to attach to the returned object. Expects a tablename{dot}featureID form.
	*&#x2F;
	getInfoImageGrid: function(data,id){
		var grid = $(&quot;&lt;div id=&#x27;&quot;+id.replace(&quot;.&quot;,&quot;_&quot;)+mygis.Utilities.format(&quot;__{0}grid&quot;,&quot;image&quot;)+&quot;&#x27; class=&#x27;imagegrid&#x27; &#x2F;&gt;&quot;);
		var tablename=id.split(&quot;.&quot;)[0];
		var OID=id.split(&quot;.&quot;)[1];
		$.each(data,function(i,v){
			grid.append(mygis.UI.buildImageCell(v,id));
		});
		return grid;
	},
	
	&#x2F;**
		Builds the layout for files inside info popup
		@method getInfoFileGrid
		@param (Array) data The image records
		@param (String) id A unique identifier to attach to the returned object. Expects a tablename{dot}featureID form.
	*&#x2F;
	getInfoFileGrid: function(data,id){
		var grid = $(&quot;&lt;div id=&#x27;&quot;+id.replace(&quot;.&quot;,&quot;_&quot;)+mygis.Utilities.format(&quot;__{0}grid&quot;,&quot;image&quot;)+&quot;&#x27; class=&#x27;imagegrid&#x27; &#x2F;&gt;&quot;);
		var tablename=id.split(&quot;.&quot;)[0];
		var OID=id.split(&quot;.&quot;)[1];
		$.each(data,function(i,v){
			grid.append(mygis.UI.buildFileCell(v,id));
		});
		return grid;
	},

	&#x2F;**
	* Creates html for a single image block
	* @method buildImageCell
	* @param v {Object} Image data
	* @param id (String) tablename.OID
	*&#x2F;
	buildImageCell: function(v,id){
		var tablename=id.split(&quot;.&quot;)[0];
		var OID=id.split(&quot;.&quot;)[1];
		var panel = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var panelTitle = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var panelContents = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var panelActions = $(&quot;&lt;div &#x2F;&gt;&quot;);
		panel.attr(&quot;class&quot;,&quot;objectFilePanel&quot;);
		panelTitle.attr(&quot;class&quot;,&quot;objectFileTitle&quot;);
		panelContents.attr(&quot;class&quot;,&quot;objectFileContents&quot;);
		panelActions.attr(&quot;class&quot;,&quot;objectFileActions&quot;);
		
		panel.append(panelTitle);
		panel.append(panelContents);
		panel.append(panelActions);
		

		if (!v.imageFRIENDLY || v.imageFRIENDLY==&quot;&quot;){
			panelTitle.append(v.imageNAME);
		}else{
			panelTitle.append(v.imageFRIENDLY);
		}
		var action = &quot;router(&#x27;infopopup_previewImg&#x27;,this);&quot;;
		retobject = mygis.Utilities.format(&#x27;&lt;div style=&quot;&quot; title=&quot;{3}&quot;&gt;&lt;img onclick=&quot;{0}&quot; style=&quot;margin: 4px;&quot; src=&quot;{1}GetImage.ashx?qType=userFile&amp;qContents={2}&amp;qSize=45&quot; &#x2F;&gt;&lt;&#x2F;div&gt;&#x27;,
					action,
					config.folderPath,
					v.imageID,
					v.imageNAME);
		panelContents.html(retobject);

		var imageButtons = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var imgBtnDownload = $(&quot;&lt;a &#x2F;&gt;&quot;);
		var imgBtnReplace = $(&quot;&lt;a &#x2F;&gt;&quot;);
		var imgBtnDelete = $(&quot;&lt;a &#x2F;&gt;&quot;);
		var disabledClass = !Sys.Services.AuthenticationService.get_isLoggedIn()?&quot; disabled&quot;:&quot;&quot;;
		imageButtons.attr(&quot;class&quot;,&quot;objectFileActionCont&quot;);
		imgBtnDownload.attr(&quot;class&quot;,&quot;btnTool imageDownload&quot;);
		imgBtnDelete.attr(&quot;class&quot;,&quot;btnTool imageDelete&quot;+disabledClass);
		imgBtnReplace.attr(&quot;class&quot;,&quot;btnTool imageReplace&quot;+disabledClass);

		imageButtons.append(imgBtnDownload);
		imageButtons.append(imgBtnReplace);
		imageButtons.append(imgBtnDelete);
		imgBtnDownload.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_download&#x27;,{0});&quot;,v.imageID));
		imgBtnDelete.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_detach&#x27;,[&#x27;{0}&#x27;,&#x27;{1}&#x27;,{2}]);&quot;,tablename,OID,v.imageID));
		imgBtnReplace.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_replace&#x27;,[&#x27;{0}&#x27;,&#x27;{1}&#x27;,{2}]);&quot;,tablename,OID,v.imageID));
		panelActions.append(imageButtons);
		return panel;
	},
	
	&#x2F;**
	* Creates html for a single file block
	* @method buildFileCell
	* @param v {Object} File data
	* @param id (String) tablename.OID
	*&#x2F;
	buildFileCell: function(v,id){
		var tablename=id.split(&quot;.&quot;)[0];
		var OID=id.split(&quot;.&quot;)[1];
		var panel = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var panelTitle = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var panelContents = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var panelActions = $(&quot;&lt;div &#x2F;&gt;&quot;);
		panel.attr(&quot;class&quot;,&quot;objectFilePanel&quot;);
		panelTitle.attr(&quot;class&quot;,&quot;objectFileTitle&quot;);
		panelContents.attr(&quot;class&quot;,&quot;objectFileContents&quot;);
		panelActions.attr(&quot;class&quot;,&quot;objectFileActions&quot;);
		
		panel.append(panelTitle);
		panel.append(panelContents);
		panel.append(panelActions);
		

		if (!v.imageFRIENDLY || v.imageFRIENDLY==&quot;&quot;){
			panelTitle.append(v.imageNAME);
		}else{
			panelTitle.append(v.imageFRIENDLY);
		}
		var cname = &quot;&quot;;
		var extParts = v.imageNAME.split(&quot;.&quot;);
		var ext = extParts[extParts.length-1].toLowerCase();
		switch(ext){
			case &quot;doc&quot;:
			case &quot;docx&quot;:
				cname = &quot;doc&quot;;
				break;
			case &quot;xls&quot;:
			case &quot;xlsx&quot;:
				cname = &quot;xls&quot;;
				break;
			case &quot;ppt&quot;:
			case &quot;pptx&quot;:
				cname = &quot;ppt&quot;;
				break;
			case &quot;pdf&quot;:
				cname = &quot;pdf&quot;;
				break;
			default:
				cname = &quot;unknown&quot;;
				break;
		}
		var action=&quot;router(&#x27;infopopup_previewFile&#x27;,{elem:this,id:&quot;+v.imageID+&quot;});&quot;;
		retobject = mygis.Utilities.format(&#x27;&lt;div title=&quot;{1}&quot; onclick=&quot;{0}&quot;&gt;&lt;div class=&quot;MMLargeFile {2}&quot; &#x2F;&gt;&lt;&#x2F;div&gt;&#x27;,
				action,
				v.imageNAME,
				cname);
		panelContents.html(retobject);
		var imageButtons = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var imgBtnDownload = $(&quot;&lt;a &#x2F;&gt;&quot;);
		var imgBtnReplace = $(&quot;&lt;a &#x2F;&gt;&quot;);
		var imgBtnDelete = $(&quot;&lt;a &#x2F;&gt;&quot;);
		var disabledClass = !Sys.Services.AuthenticationService.get_isLoggedIn()?&quot; disabled&quot;:&quot;&quot;;
		imageButtons.attr(&quot;class&quot;,&quot;objectFileActionCont&quot;);
		imgBtnDownload.attr(&quot;class&quot;,&quot;btnTool imageDownload&quot;);
		imgBtnDelete.attr(&quot;class&quot;,&quot;btnTool imageDelete&quot;+disabledClass);
		imgBtnReplace.attr(&quot;class&quot;,&quot;btnTool imageReplace&quot;+disabledClass);

		imageButtons.append(imgBtnDownload);
		imageButtons.append(imgBtnReplace);
		imageButtons.append(imgBtnDelete);
		imgBtnDownload.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_download&#x27;,{0});&quot;,v.imageID));
		imgBtnDelete.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_detach&#x27;,[&#x27;{0}&#x27;,&#x27;{1}&#x27;,{2}]);&quot;,tablename,OID,v.imageID));
		imgBtnReplace.attr(&quot;onclick&quot;,mygis.Utilities.format(&quot;router(&#x27;infoPopup_replace&#x27;,[&#x27;{0}&#x27;,&#x27;{1}&#x27;,{2}]);&quot;,tablename,OID,v.imageID));
		panelActions.append(imageButtons);
		return panel;
	},
	&#x2F;**
		Retrieves the user input from the &quot;editFieldBox&quot; dialog and appends it to the correct feature.

		@method updateObjectField
		@for UI
	**&#x2F;
	updateObjectField: function(){
		var newValue = $(&quot;#fieldEditor&quot;).attr(&quot;value&quot;);
		var recordOID = $(&quot;#editRecordNo&quot;).html().split(&quot;#&quot;)[1];
		var recordLayer = $(&quot;#editLayerName&quot;).html();
		var recordField = $(&quot;#fieldColumnName&quot;).html();
		var feature = cosmeticLayer.getFeatureByFid(recordLayer+&quot;.&quot;+recordOID);
		if (feature){
			feature.data[recordField]=newValue;
			feature.modified=true;
			feature.layer.events.triggerEvent(&quot;afterfeaturemodified&quot;,{
				feature: feature,
				modified: feature.modified
			});
			$(&quot;#editFieldBox&quot;).dialog(&#x27;close&#x27;);
		}else{
			displayError(&quot;Feature &quot;+recordLayer+&quot;.&quot;+recordOID+&quot; not found!&quot;);
		}
	},

	&#x2F;**
		Clear the current field value in the &quot;editFieldBox&quot; dialog.

		@method clearObjectField
	**&#x2F;
	clearObjectField: function(){
		$(&quot;#fieldEditor&quot;).attr(&quot;value&quot;,&quot;&quot;);
	},


	&#x2F;**
		Closes the &quot;editFieldBox&quot; dialog

		@method cancelObjectEditing
	**&#x2F;
	cancelObjectEditing: function(){
		$(&quot;#editFieldBox&quot;).dialog(&#x27;close&#x27;);
	},
	
	createCustomHotSearch: function(queryname,querylabel,params){
		var myurl=config.mgreq+&quot;?qtype=&quot;+queryname+&quot;&amp;qContents=&quot;+(params);
		$(document).bind(&#x27;finishedLoading&#x27;,function(){
			$.ajax({
				type:&quot;GET&quot;,
				url: myurl,
				success: function(data){
					var response = eval(data);
					if (typeof response==&quot;object&quot;){
						var qItem = new Object();
						qItem.text=querylabel;
						qItem.value=-1;
						qItem.isInitialized=true;
						qItem.linkedResults=response;
						qItem.isDBQuery=true;
						qItem.isMapSelect=false;
						querySource.push(qItem);
						mygis.UI.updateQueryList();		
					}
				}
			});
		});
	},
	
	&#x2F;**
	*	Creates a predefined quick search window

	*	@method createHotSearch
	*	@param {String} layername The layer to search
	*	@param {String} fieldname The field that participates in the filter
	*	@param {String} searchType Has one of two possible values:
			distinct: Distinct values
			input: User input
	*	@param {String} searchOperator The type of comparison:
			EQ: equal
			LIKE: approximately equal
			NEQ: not equal
			GEQ: greater or equal
			GT: greater than
			LT: less than
			LEQ: less or equal
	*	@param {String} searchLayout Only applies if searchType is distinct. One of the following:
			checkbox: lists distinct values as checkboxes
			dropdown: lists distinct values as dropdown list
	*	@param {String} searchMode Has one of two possible values:
			auto: performs search on change
			buttons: creates two buttons for search
	*	@param {String} windowTitle The title displayed in the window
	*	@param {String} [windowIcon] The url of an image to display in the windowTitle
	**&#x2F;
	createHotSearch: function(layername,fieldname,searchType,searchOperator,searchLayout,searchMode,windowTitle,windowIcon){
		&#x2F;*
		*	Create the basic structure, a div with 2 containing divs
		*&#x2F;
		var result = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var titleCont = $(&quot;&lt;div class=&#x27;divTitle&#x27; &#x2F;&gt;&quot;);
		var contentsCont = $(&quot;&lt;div class=&#x27;divContents&#x27; &#x2F;&gt;&quot;);

		var resultObj = $(&quot;&lt;div &#x2F;&gt;&quot;);
		&#x2F;*
		*	Encapsulate some get_from_db functions
		*&#x2F;
		var getFieldType = function(layername,search_field){
			var customUrl = config.mgreq+&quot;?qtype=GetLayerFields&amp;qContents=&quot;+escape(layername.replace(&#x2F; &#x2F;g,&quot;_&quot;));
			var retvalue;
			$.ajax({
					type:&quot;GET&quot;,
					url: customUrl,
					async: false,
					success: function(data){
						var realResults = eval(data);
						$.each(realResults,function(index,value){
							if (value.fieldNAME==search_field){
								retvalue = value.fieldTYPE;
							}
						});
					}
			});
			return retvalue;
		};
		var getDistinctValues = function(layername,search_field){
			var retvalue = [];
			var customUrl = mygis.Utilities.format(config.mgreq+&quot;?qtype=GetLayerDistinct&amp;qContents={0}${1}&quot;,escape(layername.replace(&#x2F; &#x2F;g,&quot;_&quot;)),search_field);
			$.ajax({
					type:&quot;GET&quot;,
					url: customUrl,
					async: false,
					success: function(data){
						var realResults = eval(data);
						$.each(realResults,function(index,value){
								row=new Object();
								row[&quot;name&quot;]=(value&amp;&amp;(value!=&quot;&quot;))?value:&quot;-&quot;;;
								row[&quot;value&quot;]=(value&amp;&amp;(value!=&quot;&quot;))?value:&quot;{NULL}&quot;;
								retvalue.push(row);
							});
					}
			});
			return retvalue;
		};
		switch(searchType){
			case &quot;distinct&quot;:
				var fieldValues = getDistinctValues(layername,fieldname);
				switch(searchLayout){
					case &quot;checkbox&quot;:
						var source = {
							datatype: &quot;local&quot;,
							localdata: fieldValues
						};
						var listSource = new $.jqx.dataAdapter(source,{
							async: false
						});
						listSource.dataBind();
						var hiddenValues = $(&quot;&lt;input class=&#x27;lname&#x27; type=&#x27;hidden&#x27; &#x2F;&gt;&quot;);
						hiddenValues[0].value=layername+&quot;#&quot;+fieldname;
						resultObj.append(hiddenValues);
						$.each(listSource.records,function(i,v){
							var row = $(&quot;&lt;div class=&#x27;qsListItem&#x27; &#x2F;&gt;&quot;);
							var check = $(&quot;&lt;input type=&#x27;checkbox&#x27; onchange=&#x27;router(\&quot;tHotSearch\&quot;,this);&#x27; &#x2F;&gt;&quot;);
							var checkTitle = $(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;qsListLink&#x27; &#x2F;&gt;&quot;);
							checkTitle.append(v.name);
							row.append(check);
							row.append(checkTitle);
							row.appendTo(resultObj);
						});
						break;
					case &quot;dropdown&quot;:

						break;
				}
				break;
			case &quot;input&quot;:

				var fieldType = getFieldType(layername,fieldname);
				switch(fieldType){

					default:
						var fieldTitle = $(&quot;&lt;span &#x2F;&gt;&quot;);
						fieldTitle.append(&quot;test caption&quot;);

						var fieldInput = $(&quot;&lt;input type=&#x27;text&#x27; class=&#x27;userInput&#x27; &#x2F;&gt;&quot;);

						resultObj.append(fieldInput);
						if (searchOperator==&quot;BETWEEN&quot;){
							resultObj.append(fieldInput.clone());
						}
						break;
				}
				break;

		}

		contentsCont.append(resultObj);
		var winTitle = $(&quot;&lt;span &#x2F;&gt;&quot;);
		winTitle.append(windowTitle);

		var winImg = $(&quot;&lt;img &#x2F;&gt;&quot;);
		if (windowIcon){
			winImg[0].src=windowIcon;
			titleCont.append(winImg);
		}
		titleCont.append(winTitle);

		&#x2F;*
		*	Append the final structure
		*&#x2F;
		result.append(titleCont);
		result.append(contentsCont);
		internalConfig.hotSearches.push(result);
		var finalResult = $(&quot;&lt;div &#x2F;&gt;&quot;);
		$.each(internalConfig.hotSearches,function(i,v){
			finalResult.append(v.html());
		});

		var numOfItems = finalResult.find(&quot;&gt;div&quot;).length&#x2F;2;
		$(&quot;#filterContents&quot;).empty();
		$(&quot;#filterContents&quot;).append(finalResult);
	},

	&#x2F;**
		Used to apply the HotSearch item to the display map objects as cql filter.

		@method toggleHotSearchItem
		@param {Element} elem The toggling element
	**&#x2F;
	toggleHotSearchItem: function(elem){
		var row = $(elem).parent();

		var hidden = row.parent().find(&quot;.lname&quot;)[0];
		var values = hidden.value.split(&quot;#&quot;);
		var layername = values[0];
		var fieldname = values[1];
		var op = &quot;IN&quot;; &#x2F;&#x2F;TODO
		var op = &quot;=&quot;;
		var qValues=[];

		&#x2F;**
		*	Get the checked elements, and then find the anchor links in those rows to get the text
		*&#x2F;
		var qValueLinks = row.parent().find(&#x27;input:checked&#x27;);
		for (var i=0;i&lt;qValueLinks.length;i++){
			var link = $(qValueLinks[i]).parent().find(&quot;.qsListLink&quot;);

			qValues.push(&quot;&#x27;&quot;+link.html()+&quot;&#x27;&quot;);
		}


		if (qValues.length==0){
			internalConfig.myCustomFilters[layername].fieldname=null;
		}else{
			if (internalConfig.myCustomFilters[layername]==null){
				internalConfig.myCustomFilters[layername]={};
			}
			var resultFilter = &quot;&quot;;
			$.each(qValues,function(i,v){
				if (resultFilter!=&quot;&quot;){
					resultFilter += &quot; OR &quot;;
				}
				resultFilter += mygis.Utilities.format(&quot;{0} {1} {2}&quot;,fieldname,op,v);
			});
			if (resultFilter!=&quot;&quot;){
					internalConfig.myCustomFilters[layername][fieldname]=resultFilter;
			}

		}
		if ($(&quot;#filterContents .qsListItem input:checked&quot;).length){
			customFiltered=true;	&#x2F;&#x2F;TODO
		}else{
			customFiltered=false;	&#x2F;&#x2F;TODO
		}

		loadMapSequence();
	},

	&#x2F;**
	 * Initializes the window for the Hot Searches
	 * @method initHotSearches
	 *&#x2F;
	initHotSearches: function(){
		&#x2F;&#x2F;console.log(&#x27;initHotSearches&#x27;);
		if (QSSource){
			if (QSSource.records.length!=0){
				var atLeastOne=false;
				if ($(&quot;#filterContents&quot;).children().length==0){
					$.each(QSSource.records,function(qsourceIndex,qsValue){
						if (qsValue.searchType==&#x27;customSQL&#x27;){
							&#x2F;&#x2F;(&quot;pong&quot;);
							mygis.UI.createCustomHotSearch(qsValue.customFn,qsValue.windowTitle,qsValue.fieldFill);
						}else{
							atLeastOne=true;
							mygis.UI.createHotSearch(qsValue.layername,qsValue.fieldname,qsValue.searchType,qsValue.searchOperator,qsValue.searchLayout,qsValue.searchMode,qsValue.windowTitle,qsValue.windowIcon);
						}
					});
				}
				if (atLeastOne){
					document.getElementById(&quot;panel3Out&quot;).ex_RemoveClassName(&quot;collapsed&quot;);
					document.getElementById(&quot;rpanelCollapseBtn&quot;).ex_AddClassName(&quot;active&quot;)
					propertiesVisibility(&quot;filterContents&quot;,true);
					$(&quot;#filterTabButton&quot;).show();
					$(&quot;#filterTabButton&quot;).bind(&#x27;click&#x27;,function(){propertiesVisibility(&quot;filterAnalysis&quot;,!document.getElementById(&quot;filterTabButton&quot;).ex_HasClassName(&quot;active&quot;));});
				}
			}
		}else{
			document.getElementById(&quot;panel3Out&quot;).ex_AddClassName(&quot;collapsed&quot;);
		}

	},
	&#x2F;**
		Checks to see if there are unsaved features and calls mygis.Drawing.Exporting.saveDigitizing if true.

		@method gatherUnsaved
	**&#x2F;
	gatherUnsaved: function(){
		if (featuresUnsaved.length&gt;0 || featuresDeleted.length&gt;0 || !mygis.Utilities.isEmptyObject(featuresModified)){
			mygis.Drawing.Exporting.saveDigitizing();
		}
	},

	&#x2F;**
		Checks to see if there are unsaved features and calls mygis.Utilities.checkAuthorization if true.

		@method startSaving
	**&#x2F;
	startSaving: function(params){
		if (featuresUnsaved.length&gt;0 || featuresDeleted.length&gt;0 || !mygis.Utilities.isEmptyObject(featuresModified)){
			mygis.Utilities.checkAuthorization(&#x27;digitize&#x27;,layerSource.records[layerCurrentEditing].layerID);
		}
	},

	&#x2F;**
		Resets the &quot;select&quot;, navigation and digitizing controls to their initial, unpressed state.

		@method resetControls
	**&#x2F;
	resetControls: function(){
		mygis.Map.clearFeedback();
		$(&quot;#mapContainer&quot;).attr(&quot;class&quot;,&quot;olMap&quot;);	&#x2F;&#x2F;reset
		mygis.UI.clearInfoButtons();
		&#x2F;&#x2F;----Disable select controls:-----
		for (var i in infoControls){
			infoControls[i].deactivate();
		}
		$(&quot;#layerSelectionListCont&quot;).hide();

		&#x2F;&#x2F;----Disable navigation controls:-----
		for (var i in naviControls){
			if (i!=&quot;navigation&quot;){
			naviControls[i].deactivate();
			}
		}
		for (var i=0;i&lt;4;i++){
			switch(i)
			{
				case 0:
					cname = &quot;#dragPanBtn&quot;;
					break;
				case 1:
					cname = &quot;#zoomBoxBtn&quot;;
					break;
				case 2:
					cname = &quot;#zoomOutBtn&quot;;
					break;
				case 3:
					cname = &quot;#toggleInfoBtn&quot;;
					break;
			}
			$(cname)[0].ex_RemoveClassName(&quot;selected&quot;);
		}

		&#x2F;&#x2F;----Disable digitizing controls:-----
		mygis.UI.stopDigitize();
		
		mygis.Map.hideSearchPanel();

	},

	&#x2F;**
		Activates the given OpenLayers Control, after resetting the interface.

		@method activateOLControl
		@param {Object} control An OpenLayers Control
		@param {Element} object the activated dom object
	**&#x2F;
	activateOLControl: function(control,object){
		mygis.UI.resetControls();
		control.activate();
		if (object){
			if (!object.ex_HasClassName(&quot;btnTool_selected&quot;)){
				object.ex_AddClassName(&quot;btnTool_selected&quot;);
			}
			
		}

	},

	&#x2F;**
		Toggles the given &quot;selectModeTools_XXX&quot; toolbar

		@method selectToolbar
		@param {String} name
		@param {Boolean} on Ignores the current state and turns it on
	**&#x2F;
	selectToolbar: function(name,on){
		var toolbar;
		var splitList = name?name.split(&quot;,&quot;):[];

		for (var i=0;i&lt;3;i++){
			toolbar = &quot;selectModeTools_&quot;+i.toString();
			if (splitList.indexOf(i.toString())==-1 || !on){
				document.getElementById(toolbar).ex_RemoveClassName(&quot;on&quot;);
				$(&quot;#&quot;+toolbar).parent().hide();
			}else{
				document.getElementById(toolbar).ex_AddClassName(&quot;on&quot;);
				$(&quot;#&quot;+toolbar).parent().show();

			}

		}

	},
	&#x2F;&#x2F;JK CHANGES - also activates circle btn
	&#x2F;**
		Handles activation of:
			-selectObject
			-selectRect
			-selectCircle
			-selectClear

		@method activateSelectCtrl
		@param {Element} elem The toggling element
	**&#x2F;
	activateSelectCtrl: function(elem){
		var showTip=false;
		mygis.UI.stopDigitize();
		document.getElementById(&quot;mode_TopSelect&quot;).ex_RemoveClassName(&quot;drawer&quot;);
		if (!elem.ex_HasClassName(&quot;disabled&quot;)){
			&#x2F;&#x2F;mygis.UI.Help.shortcutSearch();
			switch(elem.id){
				case &quot;infoTool&quot;:
					document.getElementById(&quot;mode_TopSelect&quot;).ex_AddClassName(&quot;drawer&quot;);
					mygis.UI.toggleSelectBtn(&#x27;info&#x27;);
					elem.ex_AddClassName(&quot;selected&quot;);
					$(&quot;#layerSelectionListCont&quot;).attr(&quot;class&quot;,&quot;&quot;);
					$(&quot;#layerSelectionHeaderLabel&quot;).html(strings.MapTools.infoToolExplain);
					showTip=false;
					document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;selectMode&quot;);
					break;
				case &quot;selectObject&quot;:
					if (layerCurrentEditing&gt;-1){
						mygis.UI.activateOLControl(drawControls.modify);
						if (selectionLayer.features.length==0){
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0&quot;,true);
						}else{
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0,1&quot;,true);
						}

					}else{
						mygis.UI.toggleSelectBtn(&#x27;point&#x27;);
						if (selectionLayer.features.length==0){
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0&quot;,true);
						}else{
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0,1&quot;,true);
						}

					}
					elem.ex_AddClassName(&quot;selected&quot;);
					document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;selectMode&quot;);
					$(&quot;#layerSelectionListCont&quot;).attr(&quot;class&quot;,&quot;pointSelect&quot;);
					$(&quot;#layerSelectionHeaderLabel&quot;).html(strings.MapTools.otherToolExplain);
					showTip=true;
					break;
				case &quot;selectRect&quot;:
					if (layerCurrentEditing&gt;-1){
						&#x2F;&#x2F;We have to re-init, re-add the control as box mode...
						mygis.UI.activateOLControl(drawControls.modify);
						if (selectionLayer.features.length==0){
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0&quot;,true);
						}else{
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0,1&quot;,true);
						}

					}else{
						mygis.UI.toggleSelectBtn(&#x27;rectangle&#x27;);
						if (selectionLayer.features.length==0){
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0&quot;,true);
						}else{
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0,1&quot;,true);
						}

					}
					elem.ex_AddClassName(&quot;selected&quot;);
					$(&quot;#layerSelectionListCont&quot;).attr(&quot;class&quot;,&quot;rectSelect&quot;);
					$(&quot;#layerSelectionHeaderLabel&quot;).html(strings.MapTools.otherToolExplain);
					document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;selectMode&quot;);
					showTip=true;
					break;
									
				case &quot;selectCircle&quot;:
					if (layerCurrentEditing&gt;-1){
						&#x2F;&#x2F;We have to re-init, re-add the control as circle mode...
						mygis.UI.activateOLControl(drawControls.modify);
						if (selectionLayer.features.length==0){
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0&quot;,true);
						}else{
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0,1&quot;,true);
						}

					}else{
						mygis.UI.toggleSelectBtn(&#x27;circle&#x27;);
						if (selectionLayer.features.length==0){
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0&quot;,true);
						}else{
							&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;0,1&quot;,true);
						}
					}
					$(&quot;#layerSelectionListCont&quot;).attr(&quot;class&quot;,&quot;circleSelect&quot;);
					elem.ex_AddClassName(&quot;selected&quot;);
					$(&quot;#layerSelectionHeaderLabel&quot;).html(strings.MapTools.otherToolExplain);
					showTip=true;
					break;
					&#x2F;&#x2F;JK CHANGES END
				case &quot;selectClear&quot;:
					mygis.Map.clearSelection();
					var containerDiv = $(&quot;#infoAnalysisContents&quot;);
					containerDiv.empty();
					$(&quot;#queryExpanders&quot;).die().empty();
					$(&quot;#layerSelectionHeaderLabel&quot;).html(strings.MapTools.otherToolExplain);
					break;
			}
			if (showTip){
				displayNotify(strings.Info.selectDeselect);
			}
		}
	},

	&#x2F;**
		Adds a modified feature to the proper array and notifies the UI.

		@method featureModified
	**&#x2F;
	featureModified: function(event){
		if (event.modified){
			var f = event.feature;
			if (f.fid){
				featuresModified[f.fid]=f;
			}

			mygis.UI.notifyUnsavedLayer(layerCurrentEditing);
		}
	},

	&#x2F;**
		Applies the local style and updates the layer grid

		@method applyLocalStyle
	**&#x2F;
	applyLocalStyle: function(){
		customStyleApplied=true;
		&#x2F;&#x2F;collapseLayerDetails();
		mygis.UI.updateLayerGrid();
	},

	&#x2F;**
		Cancel the applied local style for a given layer
		@method cancelApplyLocalStyle
	**&#x2F;
	cancelApplyLocalStyle: function(){
		customStyleApplied=false;
		digimap.layers[1].mergeNewParams({
			sld_body: null,
			layers: mygis.Utilities.getVisibleLayerString(currentAppName)
		});
		mygis.UI.updateLayerGrid();
		&#x2F;&#x2F;collapseLayerDetails();
	},

	&#x2F;**
		@TODO TODO

		@method resetLocalStyle
	**&#x2F;
	resetLocalStyle: function(){

	},

	&#x2F;**
		Toggles point mode in Layer Properties - Change style
		@method togglePointMode
	**&#x2F;
	togglePointMode: function(elem){
		var checked;
		if (elem){
			checked = $(elem);
		}else{
			checked = $(&#x27;input[name=PointMode]:checked&#x27;,&#x27;#pointModeContainer&#x27;);
		}
		var checkMode=checked.val();
		if (checkMode==0){
			$(&quot;#modeOptions_0&quot;).css(&quot;display&quot;,&quot;block&quot;);
			$(&quot;#modeOptions_1&quot;).css(&quot;display&quot;,&quot;none&quot;);

			var fontSelect = document.getElementById(&quot;pointFontFamily&quot;);
			var font = fontSelect.options[fontSelect.selectedIndex].value;

			mygis.UI.populatePointIcons(&#x27;font&#x27;,font);
		}else{
			$(&quot;#modeOptions_0&quot;).css(&quot;display&quot;,&quot;none&quot;);
			$(&quot;#modeOptions_1&quot;).css(&quot;display&quot;,&quot;block&quot;);
			mygis.UI.populatePointIcons(&#x27;library&#x27;);
			&#x2F;&#x2F;setMarkerStyleTree();
		}
	},

	&#x2F;**
		Initializes the styler properties for the given layer
		@method initializeStyler
		@param {String} layername The given layer
		@param {Object} The original data source item
	**&#x2F;
	initializeStyler: function(layername,layerRecord){

		var style = layerStyles[layername].namedLayers[layername].userStyles[0];
		var markerStyle,lineStyle,polyStyle;
		var rules = style.rules.length;
		switch (rules){
			case 3:	&#x2F;&#x2F;typical;
				markerStyle = style.rules[0].symbolizer.Point;
				lineStyle = style.rules[1].symbolizer.Line;
				polyStyle = style.rules[2].symbolizer.Polygon;
				break;
			case 1:	&#x2F;&#x2F;default
				var symbolizer = style.rules[0].symbolizer;
				for (var name in symbolizer){
					switch (name.toString()){
						case &quot;Point&quot;:
							markerStyle = symbolizer[name];
							break;
						case &quot;Line&quot;:
							lineStyle = symbolizer[name];
							break;
						case &quot;Polygon&quot;:
							polyStyle = symbolizer[name];
							break;
					}
				}
				break;
			default:	&#x2F;&#x2F;thematic?

				break;
		}
		$(&quot;#markerChooseStyle&quot;).hide();
		$(&quot;#polylineChooseStyle&quot;).hide();
		$(&quot;#polygonChooseStyle&quot;).hide();
		switch (layerRecord.layerGeomType){
			case &quot;Point&quot;:
				&#x2F;&#x2F;$(&quot;#pointStyleButton&quot;).show();
				&#x2F;&#x2F;$(&quot;#lineStyleButton&quot;).hide();
				&#x2F;&#x2F;$(&quot;#polygonStyleButton&quot;).hide();
				toggleStylerButton(&#x27;Point&#x27;);
				break;
			case &quot;Line&quot;:
				&#x2F;&#x2F;$(&quot;#pointStyleButton&quot;).hide();
				&#x2F;&#x2F;$(&quot;#lineStyleButton&quot;).show();
				&#x2F;&#x2F;$(&quot;#polygonStyleButton&quot;).hide();
				toggleStylerButton(&#x27;Line&#x27;);
				break;
			case &quot;Polygon&quot;:
				&#x2F;&#x2F;$(&quot;#pointStyleButton&quot;).hide();
				&#x2F;&#x2F;$(&quot;#lineStyleButton&quot;).hide();
				&#x2F;&#x2F;$(&quot;#polygonStyleButton&quot;).show();
				toggleStylerButton(&#x27;Polygon&#x27;);
				break;
			case &quot;Mixed&quot;:
				&#x2F;&#x2F;$(&quot;#pointStyleButton&quot;).show();
				&#x2F;&#x2F;$(&quot;#lineStyleButton&quot;).show();
				&#x2F;&#x2F;$(&quot;#polygonStyleButton&quot;).show();

				break;

		}
		&#x2F;*----Point Initializing----*&#x2F;
		var ms = markerStyle;
		var actual;
		if (ms){
			$(&quot;#markerPreview&quot;).attr(&quot;class&quot;,&quot;&quot;);
			$(&quot;#markerPreview&quot;).html(&quot;&lt;img style=&#x27;width: 100%; height: 100%;&#x27; src=&#x27;&quot;+ms.externalGraphic+&quot;&#x27; &#x2F;&gt;&quot;);
			document.getElementById(&quot;pointGraphicUrl&quot;).value = ms.externalGraphic;
			if (ms.pointRadius){
				actual=parseFloat(ms.pointRadius)*2;
			}else{
				actual=8;
			}
			$(&#x27;#markerSizeSlider&#x27;).slider(&#x27;value&#x27;,actual);
			markerSizeText.set_value(actual.toString());
		}
		&#x2F;*----End of Point----*&#x2F;

		&#x2F;*----Line Initializing----*&#x2F;
		var ls = lineStyle;
		if (ls){
			var actual;
			if (ls.strokeOpacity){
				actual=parseFloat(ls.strokeOpacity);
			}else{
				actual=1.0;
			}
			$(&#x27;#lineStrokeOpacitySlider&#x27;).slider(&#x27;value&#x27;,actual);
			lineOpacityText.set_value(actual.toString());
			if (ls.strokeWidth){
				actual=parseFloat(ls.strokeWidth);
			}else{
				actual = 1.0;
			}
			$(&#x27;#lineStrokeWeightSlider&#x27;).slider(&#x27;value&#x27;,actual);
			lineWeightText.set_value(actual.toString());

			$(&#x27;#polylineStrokeColor&#x27;).mSetInputColor(ls.strokeColor);
			mygis.UI.updateLinePreview(true);
		&#x2F;*----End of Line----*&#x2F;
		}

		&#x2F;*----Polygon Initializing----*&#x2F;
		var ps = polyStyle;
		var actual;
		if (ps){
			if (ps.strokeOpacity){
				actual = parseFloat(ps.strokeOpacity);
				$(&#x27;#polygonStrokeOpacitySlider&#x27;).slider(&#x27;value&#x27;,actual);
				polygonStrokeOpacityText.set_value(actual.toString());
			}
			if (ps.fillOpacity){
				actual = parseFloat(ps.fillOpacity);
				$(&#x27;#polygonFillOpacitySlider&#x27;).slider(&#x27;value&#x27;,actual);
				polygonFillOpacityText.set_value(actual.toString());
			}
			if (ps.strokeWidth){
				actual=parseFloat(ps.strokeWidth);
			}else{
				actual=1.0;
			}
			$(&#x27;#polygonStrokeWeightSlider&#x27;).slider(&#x27;value&#x27;,actual);
			polygonStrokeWeightText.set_value(actual.toString());
			$(&quot;#polygonStrokeColor&quot;).mSetInputColor(ps.strokeColor);
			$(&quot;#polygonFillColor&quot;).mSetInputColor(ps.fillColor);
			mygis.UI.updatePolyPreview(true);
			&#x2F;*----End of Polygon----*&#x2F;
		}
	},

	&#x2F;**
	 *	Applies the style changes to the selected layer
	 * @method getStyleChanges
	 *&#x2F;
	getStyleChanges: function(){
		if (finishApplicationLoad){
			var rowIndex = $(&#x27;#layersList&#x27;).jqxGrid(&#x27;getselectedrowindex&#x27;);
			var layername = layerSource.records[rowIndex].layerTABLE;
			var geomType = layerSource.records[rowIndex].layerGeomType;
			var styleToApply = mygis.Drawing.Styling.createSLD(layername,geomType);
			var pointRule,lineRule,polygonRule;
			&#x2F;&#x2F;styleToApply.namedLayers[layername].userStyles[0].isDefault=1;

			switch(geomType){
				case &#x27;Point&#x27;:
					pointRule = styleToApply.namedLayers[layername].userStyles[0].rules[0].symbolizer;
					break;
				case &#x27;Line&#x27;:
					lineRule = styleToApply.namedLayers[layername].userStyles[0].rules[0].symbolizer;
					break;
				case &#x27;Polygon&#x27;:
					polygonRule = styleToApply.namedLayers[layername].userStyles[0].rules[0].symbolizer;
					break;
				case &#x27;Mixed&#x27;:
					pointRule = styleToApply.namedLayers[layername].userStyles[0].rules[0].symbolizer;
					lineRule = styleToApply.namedLayers[layername].userStyles[0].rules[1].symbolizer;
					polygonRule = styleToApply.namedLayers[layername].userStyles[0].rules[2].symbolizer;
					break;
			}
			if (pointRule){
			&#x2F;*-----POINTS-----*&#x2F;
				var selectedItem = document.getElementById(&quot;pointGraphicUrl&quot;).value; &#x2F;&#x2F;markerStyleList.get_selectedItem();
				var newValue;
				var newSize;
				if (selectedItem){
					newValue = selectedItem;
					newSize = markerSizeText.get_value();
					if (newValue){
						switch(newValue.substring(0,4)){
							case &quot;ttf:&quot;:
								&#x2F;&#x2F;
								pointRule.Point.graphicName=newValue;
								pointRule.Point.externalGraphic = null;
								break;
							case &quot;http&quot;:
								pointRule.Point.externalGraphic = newValue;
								break;
							default:
								pointRule.Point.externalGraphic = &quot;http:&#x2F;&#x2F;&quot;+window.location.host+newValue;
								break;
						}
						&#x2F;&#x2F;pointRule.Point.externalGraphic = newValue.indexOf(&quot;http&quot;)==0?newValue:&quot;http:&#x2F;&#x2F;&quot;+window.location.host+newValue;
						pointRule.Point.graphicWidth = newSize;	&#x2F;&#x2F;
						pointRule.Point.graphicHeight = newSize;	&#x2F;&#x2F;
						pointRule.Point.pointRadius = newSize &#x2F; 2;
						pointRule.Point.fillColor = document.getElementById(&quot;pointColor&quot;).value;
						pointRule.Point.strokeColor = document.getElementById(&quot;pointBorderColor&quot;).value;
						pointRule.Point.strokeWidth = pointBorderText.get_value();
					}
				}
				&#x2F;*--END OF POINTS---*&#x2F;
			}

			if (lineRule){
				&#x2F;*----LINES-----*&#x2F;
				var color=document.getElementById(&quot;polylineStrokeColor&quot;).value;
				var lineOpacity = lineOpacityText.get_value();
				var lineWeight = lineWeightText.get_value();

				lineRule.Line.strokeWidth = lineWeight;
				lineRule.Line.strokeOpacity = lineOpacity;
				lineRule.Line.strokeColor = color;
				&#x2F;*---END OF LINES----*&#x2F;
			}

			if (polygonRule){
				&#x2F;*----POLYGONS----*&#x2F;
				var strokeColor = document.getElementById(&quot;polygonStrokeColor&quot;).value;
				var fillColor = document.getElementById(&quot;polygonFillColor&quot;).value;
				var strokeOpacity = polygonStrokeOpacityText.get_value();
				var fillOpacity = polygonFillOpacityText.get_value();
				var strokeWidth = polygonStrokeWeightText.get_value();

				polygonRule.Polygon.fillColor = fillColor;
				polygonRule.Polygon.fillOpacity= fillOpacity;
				polygonRule.Polygon.strokeColor = strokeColor;
				polygonRule.Polygon.strokeOpacity = strokeOpacity;
				polygonRule.Polygon.strokeWidth = strokeWidth;
				&#x2F;*----END OF POLYGONS----*&#x2F;
			}
			&#x2F;&#x2F;var xxx = styleToApply.namedLayers[layername].userStyles[0];
			&#x2F;&#x2F;styleToApply.namedLayers[layername].userStyles[layername]=xxx;
			return [styleToApply,layername];
		}else{
			return null;
		}
	},

	&#x2F;**

		@method saveLayerStyle
		@param {String} layername The layer&#x27;s table name
	**&#x2F;
	saveLayerStyle: function(layername){
		if (!layername){
			var rowIndex = $(&#x27;#layersList&#x27;).jqxGrid(&#x27;getselectedrowindex&#x27;);
            layername = layerSource.records[rowIndex].layerTABLE;
		}
		var xmlstyle = mygis.Map.getSingleAppliedStyle(layername);
		var postObject=new Object();
		var injectIndex = xmlstyle.indexOf(&quot;&lt;sld:FeatureTypeStyle&quot;);
		xmlstyle = xmlstyle.substring(0,injectIndex)+&quot;&lt;sld:Name&gt;&quot;+layername+&quot;&lt;&#x2F;sld:Name&gt;&quot;+xmlstyle.substring(injectIndex);
		postObject[&quot;layer&quot;]=layername;
		postObject[&quot;sld&quot;]=xmlstyle;
		postObject[&quot;layerID&quot;]=mygis.Utilities.mggetLayerID(layername);
		mygis.Utilities.blockUI();
		$.ajax({
			type: &#x27;POST&#x27;,
			url: config.mgreq+&quot;?qtype=updateStyle&quot;,
			data: postObject,
			success: function(data){
				mygis.Utilities.unblockUI();
				try{
					var realResults = eval(data);
					if (realResults.iotype==&quot;success&quot;){
						displaySuccess(&quot;Style updated&quot;);
					}else{
						displayError(realResults.iomsg);
					}
				}catch(err){
					displayError(err.message);
				}
			}
		});
	},

	&#x2F;**
		Applies the style change to the map
		@method previewLayerStyle
	**&#x2F;
	previewLayerStyle: function(){
		if (finishApplicationLoad){
			var changeTo = mygis.UI.getStyleChanges();
			var styleToApply=changeTo[0];
			var layername=changeTo[1];
			layerStyles[layername]=styleToApply;
			var sldString = mygis.Map.getCustomAppliedStyle();

			&#x2F;&#x2F;sldString = sldString.replace(&#x2F;\%23&#x2F;g,&quot;#&quot;);
			&#x2F;&#x2F;sldString = unescape( encodeURIComponent( sldString ));
			&#x2F;&#x2F;sldString =escape(sldString);
			&#x2F;&#x2F;mygis.Query.highlightSelection(null,sldString);


			digimap.layers[1].mergeNewParams({
				sld_body: sldString,
				layers: null
			});

			&#x2F;&#x2F;digimap.layers[2].setVisibility(false);
		}
	},

	&#x2F;**
		Cancels the style change from the map
		@method clearPreviewLayer
	**&#x2F;
	clearPreviewLayer: function(){
		if (selectionWMSLayer){
			selectionWMSLayer.mergeNewParams({
					sld_body: null
				});

			digimap.layers[1].setVisibility(true);
		}
	},

	&#x2F;**
		Applies the given scale constraint to a layer

		@method toggleLayerConstraint
		@param {String} mode Accepted values: From&#x2F;To
	**&#x2F;
	toggleLayerConstraint: function(mode){
		var row= $(&quot;#visible&quot;+mode);
		var btn= row.find(&quot;.visible&quot;+mode+&quot;Btn&quot;)[0];
		var input = row.find(&quot;.layerVisibleInput&quot;)[0];
		var layer = layerSource.records[$(&#x27;#layersList&#x27;).jqxGrid(&#x27;getselectedrowindex&#x27;)];
		var actualValue = input.value.replace(&#x2F;\.&#x2F;g,&quot;&quot;);
		if (btn.ex_HasClassName(&quot;pressed&quot;)){
			btn.ex_RemoveClassName(&quot;pressed&quot;);
			layer.manualVisibility=true;
		}else{
			if (actualValue){
				btn.ex_AddClassName(&quot;pressed&quot;);
				layer.manualVisibility=false;
				if (mode==&quot;From&quot;){
					layer.layerMinScale=parseFloat(actualValue);
				}else{
					layer.layerMaxScale=parseFloat(actualValue);
				}
			}else{
				displayError(strings.LayerControl.visibleRangeNotFilled);
			}
		}
		mygis.Map.checkScaleConstraints();
		expandLayerDetails(null,true);
	},

	&#x2F;**
		Creates the &quot;editableInfo&quot; window for new digitized objects
		@method createEditableInfo
	**&#x2F;
	createEditableInfo: function(){
		&#x2F;&#x2F;console.log(&#x27;createEditableInfo&#x27;);
		if ($(&quot;#editDigitize&quot;).children().length==0){
			loadFragment(&quot;editDigitize&quot;,function(){
				$(&quot;#editDigitize&quot;).dialog({
						autoOpen: false,
						modal: true,
						resizable: false,
						width: 900,
						height: 510,
						title: &quot;New object&quot;,
						closeOnEscape: false
				});
				var titleBar = $(&quot;#ui-dialog-title-editDigitize&quot;).parent();
				titleBar.css({
					&quot;background&quot;:&quot;url(&#x27;&quot;+config.folderPath+&quot;Images&#x2F;Administration&#x2F;header&#x2F;icon-48-cpanel.png&#x27;) #F6A828 no-repeat 14px 5px&quot;,
					&quot;background-size&quot;:&quot;auto 18px&quot;
				});
			});
		}
	},

	&#x2F;**
		Creates or hides the &quot;editableInfo&quot; window
		@method toggleEditableInfo
	**&#x2F;
	toggleEditableInfo: function(){
		mygis.UI.createEditableInfo();
		var btn = $(&quot;#mapFinalToolbar&quot;).find(&#x27;.showInfoOnEdit&#x27;)[0];
		showInfoOnEdit=!showInfoOnEdit;
		if (!showInfoOnEdit){
			&#x2F;&#x2F;$(&quot;#editableInfo&quot;).dialog(&#x27;close&#x27;);
			$(&quot;#editDigitize&quot;).dialog(&#x27;close&#x27;);

			btn.ex_RemoveClassName(&#x27;btnTool_selected&#x27;);
		}else{
			btn.ex_AddClassName(&#x27;btnTool_selected&#x27;);
		}
	},

	&#x2F;**
		Shows the &quot;editableInfo&quot; window
		@method showEditableInfo
	**&#x2F;
	showEditableInfo: function(){
		if (showInfoOnEdit) {
			&#x2F;&#x2F;$(&quot;#editableInfo&quot;).dialog(&#x27;open&#x27;);
			console.log(&#x27;showEditableInfo&#x27;);
			mygis.Admin.UI.dialogConfig.checkfn=mygis.Drawing.Editing.checkValidInfo;
			mygis.Admin.UI.dialogConfig.callbackfn=mygis.Drawing.Editing.digiPopupResult;
			mygis.Admin.UI.dialogConfig.windowTitle=&quot;#editDigitize&quot;;
			mygis.Admin.UI.dialogConfig.objectCount=1;
			$(&quot;#editDigitize&quot;).dialog(&#x27;open&#x27;);
		}

	},

	&#x2F;**
		Used to fix bugs in &quot;editableInfo&quot; window in the UI (namely tabs)
		@method fixEditableInfo
	**&#x2F;
	fixEditableInfo: function(){
		var infoWin = $(&quot;#editableInfo&quot;);
		if (infoWin){
			var detachCont = infoWin.find(&quot;.infoDetachCont&quot;)[0];

			if ($(detachCont).is(&quot;:empty&quot;)){
				&#x2F;&#x2F;console.log($(detachCont).is(&quot;:empty&quot;));
				setTimeout(mygis.UI.fixEditableInfo,500);
			}else{
				$(detachCont).removeData();
				var titleBar = $(&quot;#ui-dialog-title-editableInfo&quot;).parent();
				titleBar.css({
					&quot;background&quot;:&quot;url(&#x27;&quot;+config.folderPath+&quot;Images&#x2F;file_edit.png&#x27;) #F6A828 no-repeat 12px 2px&quot;,
					&quot;background-size&quot;:&quot;auto 25px&quot;
				});
				titleBar.find(&quot;.ui-dialog-titlebar-close&quot;).css({&quot;visibility&quot;:&quot;hidden&quot;});	&#x2F;&#x2F;when ready from code
				var dialogWindow = titleBar.parent();
				var dialogContent=$(dialogWindow.find(&quot;#editableInfo&quot;)[0]);
				
				dialogContent.css({&quot;padding&quot;:&quot;0&quot;,&quot;margin-left&quot;:&quot;-5px&quot;,&quot;overflow&quot;:&quot;hidden&quot;});
				
				var mapCont = $(&quot;#mapContainer&quot;);
				
				var dialogX = 935;
				var dialogY = 120;
				var dialogHeight =
				infoWin.dialog(&quot;option&quot;,&quot;position&quot;,[dialogX,dialogY]);

			}
		}else{
			setTimeout(mygis.UI.fixEditableInfo,500);
		}
	},

	&#x2F;**
		Activates naviControls.navigation or naviControls.zoomBox

		@method activateControl
		@param {String} name Keyword for the control to activate.
	**&#x2F;
	activateControl: function(name){
		var cname;
		mygis.UI.stopDigitize();
		$(&quot;#mapContainer&quot;).attr(&quot;class&quot;,&quot;olMap&quot;);	&#x2F;&#x2F;reset
		&#x2F;&#x2F;document.getElementById(&quot;mapContainer&quot;).(&quot;selectMode&quot;);
		switch(name)
		{
			case &quot;drag&quot;:
				mygis.UI.activateOLControl(naviControls.navigation);

				$(&quot;#dragPanBtn&quot;)[0].ex_AddClassName(&quot;selected&quot;);
				break;
			case &quot;zoomBox&quot;:
				&#x2F;&#x2F;digimap.controls[6].activate();
				mygis.UI.activateOLControl(naviControls.zoomBox);
				document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;zoomMode&quot;);
				$(&quot;#zoomBoxBtn&quot;)[0].ex_AddClassName(&quot;selected&quot;);
				break;
			case &quot;zoomOut&quot;:
				document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;zoomModeOff&quot;);
				break;
		}
		

		
	},

	&#x2F;**
		Toggles the map overview visibility
		@method toggleOverview
	**&#x2F;
	toggleOverview: function(){
		var overview = $(&quot;#customOverview&quot;);
		if (overview.is(&quot;:visible&quot;)){
			overview.hide();
			$(&quot;#toggleOverviewBtn&quot;)[0].ex_RemoveClassName(&quot;selected&quot;);
		}else{
			overview.show();
			$(&quot;#toggleOverviewBtn&quot;)[0].ex_AddClassName(&quot;selected&quot;);
		}
	},

	&#x2F;**
		Toggles the WMSGetFeatureInfo tool.

		@method toggleInfoBtn
		@deprecated We now use toggleInfoBtn_V2 instead
	**&#x2F;
	toggleInfoBtn: function(){

		var isInfoActive=false;
		if (infoControls){
			if (infoControls.click.active){
				isInfoActive=true;
			}
		}
		mygis.UI.clearInfoButtons();
		if (!isInfoActive){
			infoControls.click.events.unregister(&quot;getfeatureinfo&quot;,this, mygis.Map.showInfo2);
			digimap.removeControl(infoControls.click);
			infoControls.click=new OpenLayers.Control.WMSGetFeatureInfo({
				url: config.mapserver+&#x27;wms&#x27;,
				title: &#x27;Identify features by clicking&#x27;,
				drillDown: true,
				infoFormat:&quot;text&#x2F;html&quot;,
				maxFeatures: 10,
				layers: [digimap.layers[1]],
				vendorParams: {
					EXCEPTIONS: &#x27;XML&#x27;
				}
			});
			infoControls.click.events.register(&quot;getfeatureinfo&quot;, this, mygis.Map.showInfo2);
			digimap.addControl(infoControls.click);
			mygis.UI.activateOLControl(infoControls.click);
			document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;selectMode&quot;);
			$(&quot;#toggleInfoBtn&quot;)[0].ex_AddClassName(&quot;selected&quot;);
			mygis.UI.stopDigitize();
		}else{
			infoControls.click.deactivate();
			mygis.Map.clearSelection();
			$(&quot;#toggleInfoBtn&quot;)[0].ex_RemoveClassName(&quot;selected&quot;);
		}
	},

	&#x2F;**
		Toggles the &quot;select feature&quot; tool, according to some parameters.

		@method toggleInfoBtn_V2
		@param {Boolean} topLayer If true, switches the appropriate controls on&#x2F;off to act as info tool
	**&#x2F;
	toggleInfoBtn_V2: function(topLayer){
		mygis.UI.resetControls();
		infoControls.select.activate();	&#x2F;&#x2F;just to prevent clearing
		if (topLayer){
			document.getElementById(&quot;mode_TopSelect&quot;).ex_AddClassName(&quot;drawer&quot;);
		}else{
			document.getElementById(&quot;mode_TopSelect&quot;).ex_RemoveClassName(&quot;drawer&quot;);
		}
		document.getElementById(&quot;mode_InfoSelect&quot;).ex_AddClassName(&quot;drawer&quot;);
		document.getElementById(&quot;mode_InfoStore&quot;).ex_AddClassName(&quot;drawer&quot;);

		document.getElementById(&quot;mode_AddSelect&quot;).ex_RemoveClassName(&quot;drawer&quot;);
		document.getElementById(&quot;mode_SubtractSelect&quot;).ex_RemoveClassName(&quot;drawer&quot;);
		if (topLayer){
			&#x2F;&#x2F;document.getElementById(&quot;toggleDrillInfoBtn&quot;).ex_AddClassName(&quot;selected&quot;);
		}else{
			document.getElementById(&quot;toggleInfoBtn&quot;).ex_AddClassName(&quot;selected&quot;);
		}
		document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;selectMode&quot;);
		mygis.UI.toggleSelectBtn(&#x27;point&#x27;);
	},
	
	&#x2F;**
		Recreates the appropriates GetFeature control and reattaches it to the map.

		@method addSelectBtn
		@param {Boolean} boxmode
	**&#x2F;
	addSelectBtn: function(boxmode,singleMode){
		var layerToSelect = [];
		var namespaces = [];
		var previouslyActive;
		var previouslyBox;
		for (var i=0;i&lt;layerSource.records.length;i++){
			var checkname = layerSource.records[i].layerTABLE;
			if (mygis.Map.layerHasProperty(checkname,&#x27;selectable&#x27;)&amp;&amp;!(Boolean(layerSource.records[i].hidden)===true)){
				layerToSelect.push(checkname);
				namespaces.push(config.namespace+checkname.split(&quot;_&quot;)[0]);
			}
		}
		previouslyActive = infoControls.select.active;
		previouslyBox = infoControls.select.box;
		digimap.removeControl(infoControls.select);
		infoControls.select.destroy();
		infoControls.select = new OpenLayers.Control.GetFeature({
			protocol: new OpenLayers.Protocol.WFS({
				version: &quot;1.0.0&quot;,
				url:  config.mapserver+&quot;wms&quot;,
				featureType: layerToSelect,
				featureNS: config.namespace+&quot;MyGIS&quot;,
				geometryName: &quot;Geometry&quot;,
				srsName: digimap.projection.getCode()
			}),
			box: boxmode,
			hover: false,
			click: !boxmode,
			single: singleMode,
			multipleKey: &quot;ctrlKey&quot;,
			toggleKey: &quot;ctrlKey&quot;,
			clickTolerance: 10
		});
		infoControls.select.request = mygis.OLOverrides.mygis_Control.mygis_GetFeature.mygis_request;
		infoControls.select.selectBestFeature = mygis.OLOverrides.mygis_Control.mygis_GetFeature.mygis_selectBestFeature_v2;
		digimap.addControl(infoControls.select);
		infoControls.select.events.register(&quot;featuresselected&quot;,this,mygis.UI.selectionMultipleFeaturesSelected);
		infoControls.select.events.register(&quot;featureselected&quot;, this, mygis.UI.selectionFeatureSelected);
		infoControls.select.events.register(&quot;featureunselected&quot;, this, mygis.UI.selectionFeatureUnselected);
		if (previouslyActive){
			if (boxmode){
				document.getElementById(&quot;selectRect&quot;).ex_AddClassName(&quot;selected&quot;);
			}else if (!singleMode){
				document.getElementById(&quot;selectObject&quot;).ex_AddClassName(&quot;selected&quot;);
			}
			infoControls.select.activate();
		}else{
			mygis.UI.activateOLControl(infoControls.select);
		}
		&#x2F;&#x2F;mygis.Map.setSelectableLayers(layerSource.records,$(&quot;#layerSelectionList&quot;));	&#x2F;&#x2F;shouldn&#x27;t be needed: somewhere after map load it resets.
		$(&quot;#layerSelectionListCont&quot;).show();
	},
	
	&#x2F;&#x2F;JK CHANGE - ADD CIRCLE tool
	&#x2F;**
		Recreates the appropriates GetFeature control and reattaches it to the map.

		@method addSelectCircleBtn
		@param {Boolean} circlemode
	**&#x2F;
	addSelectCircleBtn: function(circlemode){
		var layerToSelect = [];
		var namespaces = [];
		var previouslyActive;
		var previouslyCircle;
		for (var i=0;i&lt;layerSource.records.length;i++){
			var checkname = layerSource.records[i].layerTABLE;
			if (mygis.Map.layerHasProperty(checkname,&#x27;selectable&#x27;)){
				layerToSelect.push(checkname);
				namespaces.push(config.namespace+checkname.split(&quot;_&quot;)[0]);
			}
		}
		previouslyActive = infoControls.select.active;
		previouslyBox = infoControls.select.circle;
		digimap.removeControl(infoControls.select);
		infoControls.select.destroy();
		infoControls.select = new OpenLayers.Control.GetFeature({
			protocol: new OpenLayers.Protocol.WFS({
				version: &quot;1.1.0&quot;,
				url:  config.mapserver+&quot;wms&quot;,
				featureType: layerToSelect,
				featureNS: config.namespace+&quot;MyGIS&quot;,
				geometryName: &quot;Geometry&quot;,
				srsName: digimap.projection.getCode()
			}),
			circle: circlemode,
			hover: false,
			click: true,
			single: false,
			multipleKey: &quot;ctrlKey&quot;,
			toggleKey: &quot;ctrlKey&quot;,
			clickTolerance: 10
		});
		infoControls.select.request = mygis.OLOverrides.mygis_Control.mygis_GetFeature.mygis_request;
		infoControls.select.selectBestFeature = mygis.OLOverrides.mygis_Control.mygis_GetFeature.mygis_selectBestFeature_v2;
		digimap.addControl(infoControls.select);
		infoControls.select.events.register(&quot;featuresselected&quot;,this,mygis.UI.selectionMultipleFeaturesSelected);
		infoControls.select.events.register(&quot;featureselected&quot;, this, mygis.UI.selectionFeatureSelected);
		infoControls.select.events.register(&quot;featureunselected&quot;, this, mygis.UI.selectionFeatureUnselected);
		if (previouslyActive){
			if (circlemode){
				document.getElementById(&quot;selectCircle&quot;).ex_AddClassName(&quot;selected&quot;);
			}else{
				document.getElementById(&quot;selectObject&quot;).ex_AddClassName(&quot;selected&quot;);
			}
			infoControls.select.activate();
		}else{
			mygis.UI.activateOLControl(infoControls.select);
		}
	},
	&#x2F;&#x2F;JK CHANGES END
	
	&#x2F;**
		Should be called when multiple features are selected (server-side).
		Shows the appropriate info results and toggles some UI elements.

		@method selectionMultipleFeaturesSelected
		@param (Object} e An object containing the selected features.
	**&#x2F;
	selectionMultipleFeaturesSelected: function(e){
		&#x2F;&#x2F;console.log(&quot;Multiple: &quot;+e.object.modifiers.multiple);
		var multiple = e.object.modifiers.multiple;
		var toggle = e.object.modifiers.toggle;
		document.getElementById(&quot;selectClear&quot;).ex_RemoveClassName(&quot;disabled&quot;);
		$(&quot;#layerSelectionListCont&quot;).hide();
		&#x2F;&#x2F;if (!mygis.UI.isActiveSelectMode(&quot;mode_AddSelect&quot;)&amp;&amp; !mygis.UI.isActiveSelectMode(&quot;mode_SubtractSelect&quot;)){
		if (!multiple &amp;&amp; !toggle){
			selectionLayer.removeAllFeatures();
			selectionLayer.addFeatures(e.features);
		}
		var layersTotal = [];
		for (var i=0;i&lt;selectionLayer.features.length;i++){
			layersTotal.push(selectionLayer.features[i].type);
		}
		var layerUnique = mygis.Utilities.arrayUnique(layersTotal);
		if (mygis.UI.isActiveSelectMode(&quot;mode_TopSelect&quot;)){
			&#x2F;&#x2F;router(&#x27;expandSelect&#x27;,{layername: layerUnique[0],results: selectionLayer.features, isMapSelect: true,fid: selectionLayer.features[0].fid});
			var featData = selectionLayer.features[0].data;
			mygis.Query.popupInfo(featData,layerUnique[0]);
		}else{
			mygis.UI.setupSelectResults(layerUnique,selectionLayer.features);
		}
		if (layerCurrentEditing&gt;-1){
			&#x2F;&#x2F;mygis.UI.selectToolbar(&quot;2&quot;,true);
		}
	},

	&#x2F;**
		Should be called when a single feature is selected (server-side).


		@method selectionFeatureSelected
		@param (Object} e An object containing the selected features.
	**&#x2F;
	selectionFeatureSelected: function(e){
		$(&quot;#layerSelectionListCont&quot;).hide();
		if (mygis.UI.isActiveSelectMode(&quot;mode_SubtractSelect&quot;)){
			selectionLayer.removeFeatures([selectionLayer.getFeatureByFid(e.feature.fid)]);
		}else{
			if(e.object.modifiers.multiple){
				selectionLayer.addFeatures([e.feature]);
			}
		}
	},

	&#x2F;**
		Should be called when a single feature is unselected (server-side)

		@method selectionFeatureUnselected
	**&#x2F;
	selectionFeatureUnselected: function(e){
		try{
		mygis.UI.queryResultsReset();
		var multiple = e.object.modifiers.multiple;
		if (!mygis.UI.isActiveSelectMode(&quot;mode_AddSelect&quot;) &amp;&amp; !mygis.UI.isActiveSelectMode(&quot;mode_SubtractSelect&quot;)){
			selectionLayer.removeFeatures([selectionLayer.getFeatureByFid(e.feature.fid)]);
			var containerDiv = $(&quot;#infoAnalysisContents&quot;);
			containerDiv.empty();
			$(&quot;#queryExpanders&quot;).die().empty();
		}
		}catch(err){
			&#x2F;&#x2F;console.log(err)
		}
	},

	&#x2F;**
		Should be called when a single feature is edited.
		Updates the UI to reflect the new info.

		@method editFeatureSelected
	**&#x2F;
	editFeatureSelected: function(e){
		var layerUnique = [layerSource.records[layerCurrentEditing].layerTABLE];
		e.feature.type = layerUnique;
		mygis.UI.setupSelectResults(layerUnique,[e.feature]);
	},

	&#x2F;**
		Activates the proper &quot;select&quot; tool

		@method toggleSelectBtn
		@param {String} mode Accepted values: point,rectangle
	**&#x2F;
	toggleSelectBtn: function(mode){
		var boxmode;
		var singleMode=false;
		switch (mode){
			&#x2F;&#x2F; JK CHANGES - support circle button
			case &quot;info&quot;:
				circlemode=false;
				boxmode=false;
				singleMode=true;
				break;
			case &quot;point&quot;:
				circlemode=false
				boxmode=false;
				break;
			case &quot;rectangle&quot;:
				circlemode=false
				boxmode=true;
				break;
			case &quot;circle&quot;:
				circlemode=true;
				boxmode=false;
			break;
			
		}
		var alreadyActive = infoControls.select.active;
		if (!document.getElementById(&quot;mapContainer&quot;).ex_HasClassName(&quot;selectMode&quot;)){
			document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;selectMode&quot;);
		}
		if (alreadyActive){
			document.getElementById(&quot;infoTool&quot;).ex_RemoveClassName(&quot;selected&quot;);

			document.getElementById(&quot;selectObject&quot;).ex_RemoveClassName(&quot;selected&quot;);
			document.getElementById(&quot;selectRect&quot;).ex_RemoveClassName(&quot;selected&quot;);
			document.getElementById(&quot;selectCircle&quot;).ex_RemoveClassName(&quot;selected&quot;);
		}
		if (circlemode==true){
			mygis.UI.addSelectCircleBtn(circlemode);
		}else{
			mygis.UI.addSelectBtn(boxmode,singleMode);
		}
		
		&#x2F;&#x2F;JK CHANGES END
	},

	&#x2F;**
		Pushes the select result into the &quot;infoLeftList&quot; list

		@method setupSelectResults
		@param {Object} layers The resulting layers
		@param {Object} features The uncategorized features
	**&#x2F;
	setupSelectResults: function(layers,features){
		var qItem = new Object();
		qItem.text=strings.Info.mapSelectionDefaultQText;

		qItem.value=mygis.UI.isActiveSelectMode(&quot;mode_InfoStore&quot;)?-1:-999;	&#x2F;&#x2F;defaultSelectMap
		qItem.isInitialized=true;
		qItem.linkedResults={&quot;layers&quot;:layers,&quot;features&quot;:features};
		qItem.isDBQuery=false;
		qItem.isMapSelect=true;

		mygis.UI.pushSelectInQueries(qItem,mygis.UI.isActiveSelectMode(&quot;mode_InfoStore&quot;));

		var leftList = $(&quot;#infoLeftList&quot;);
		var itemCount = leftList.jqxListBox(&#x27;getItems&#x27;).length;
		var lastSelection = leftList.jqxListBox(&#x27;getItemByValue&#x27;,-999);
		leftList.jqxListBox(&#x27;selectIndex&#x27;,lastSelection.index);
		&#x2F;&#x2F;var defaultIndex = mygis.Utilities.getQueryByValue(999,true);

		&#x2F;&#x2F;leftList.jqxListBox(&#x27;selectIndex&#x27;,mygis.UI.isActiveSelectMode(&quot;mode_InfoSelect&quot;)?itemCount-1:defaultIndex);
		mygis.UI.queryResultsRun();
	},

	&#x2F;**
		Updates the &quot;last searched&quot; item in the &quot;infoLeftList&quot; list

		@method pushSelectInQueries
		@param {Object} qItem The item to insert
		@param {Boolean} If true, creates a new item in the list instead
	**&#x2F;
	pushSelectInQueries: function(qItem,createNew){
		var index = mygis.Utilities.getQueryByValue(qItem.value,true);
		if (createNew || index==-1){
			if (createNew){
				&#x2F;&#x2F;qItem.text = new Date().toString(Date.CultureInfo.formatPatterns.sortableDateTime) +&quot;: &quot; + strings.Info.mapSelectionQText;
				qItem.text = strings.Info.mapSelectionQText+new Date().toString(&quot;hh:mm:ss&quot;);
			}
			querySource.push(qItem);
		}else{
			querySource[index].linkedResults=qItem.linkedResults;
		}
		mygis.UI.updateQueryList();
	},

	&#x2F;**
	 *	Removes a query from the search list
	 *	@method removeSavedQuery
	 *&#x2F;
	removeSavedQuery: function(){
		var qIndex = $(&quot;#infoLeftList&quot;).jqxListBox(&#x27;getSelectedIndex&#x27;);
		if (qIndex&gt;-1){
			querySource.splice(qIndex,1);
			mygis.UI.updateQueryList();

		}
	},
	
	&#x2F;**
		* Resets the results pane
		* @method queryResultsReset
	*&#x2F;
	queryResultsReset: function(){
		$(&quot;#totalResultsCount&quot;).html(&quot;(&quot;+0+&quot;)&quot;);
		$(&quot;#queryExpanders&quot;).die().empty();
		$(&quot;#showWithinBtn&quot;).hide();
		$(&quot;#showQueryStatsBtn&quot;).hide();
	},

	&#x2F;**
	 * Draws the selected query&#x27;s results
	 * @method queryResultsRun
	 *&#x2F;
	queryResultsRun: function(){
		mygis.UI.queryResultsReset();
		var originalSource = $(&quot;#infoLeftList&quot;).jqxListBox(&#x27;source&#x27;);	&#x2F;&#x2F;$(&quot;#infoLeftList&quot;).jqxListBox(&#x27;source&#x27;)._source.localdata;
		var item = $(&quot;#infoLeftList&quot;).jqxListBox(&#x27;getSelectedItem&#x27;);
		if(!item){
			item=$(&quot;#infoLeftList&quot;).jqxListBox(&#x27;getItem&#x27;,0);
		}
		var mode= 0; &#x2F;&#x2F;mygis.UI.isActiveSelectMode(&quot;mode_ResultsList&quot;)?0:1;		&#x2F;&#x2F;0: jqxNavigation, 1: jqxTabs 
		if (resultGridButtons.is(&quot;:empty&quot;)){
			loadFragment(&quot;resultGridButtons&quot;,null,resultGridButtons);
		}
		expandResultDetails();
		if (originalSource[item.index].isDBQuery){
			var containerDiv = $(&quot;#infoAnalysisContents&quot;);
			var results = originalSource[item.index].linkedResults;
			containerDiv.empty();
			$(&quot;#queryExpanders&quot;).die().empty();
			var struct = mygis.UI.buildQueryExpanders(originalSource[item.index].linkedResults);
			struct.appendTo(containerDiv);
			var numOfItems = struct.find(&quot;&gt;div&quot;).length&#x2F;2;
			var calcHeight = $(&quot;#layerPropertiesWrapper&quot;).height()-30;
			$(&quot;#queryExpanders&quot;).accordion({ fillSpace:true,  heightStyle: &#x27;auto&#x27;, active: false, collapsible: true });		
			$(&quot;#queryExpanders&quot;).data(&quot;querySource&quot;,item);
			document.getElementById(&quot;selectClear&quot;).ex_RemoveClassName(&quot;disabled&quot;);
		}else if(originalSource[item.index].isMapSelect){
			var containerDiv = $(&quot;#infoAnalysisContents&quot;);
			var results = originalSource[item.index].linkedResults;
			containerDiv.empty();
			$(&quot;#queryExpanders&quot;).die().empty();
			var struct = mygis.UI.buildSelectExpanders(results.layers,results.features,results);
			struct.appendTo(containerDiv);
			var numOfItems = struct.find(&quot;&gt;div&quot;).length&#x2F;2;
			var calcHeight = $(&quot;#layerPropertiesWrapper&quot;).height()-30;
			$(&quot;#queryExpanders&quot;).accordion({ fillSpace:true, heightStyle: &#x27;auto&#x27;, active: false, collapsible: true });
			$(&quot;#queryExpanders&quot;).data(&quot;querySource&quot;,item);
		}else{
			alert(&quot;Error!&quot;);
			console.log(&quot;Not mapselect, not db query. wtf is it?&quot;);
		}
		$(&quot;#totalResultsCount&quot;).html(&quot;(&quot;+$(&quot;#queryExpanders .featureTab&quot;).length+&quot;)&quot;);
		if($(&quot;#queryExpanders .featureTab&quot;).length&gt;0){
			$(&quot;#showWithinBtn&quot;).show();
			$(&quot;#showQueryStatsBtn&quot;).show();
		}
	},
	
	
	&#x2F;**
	 *	Filters search results
	 *	@method filterSearchResults
	 *&#x2F;
	filterSearchResults: function(){
		var inputElem = $(&quot;#infoAnalysis_SearchInput&quot;);
		var mode=mygis.UI.isActiveSelectMode(&quot;mode_ResultsList&quot;)?0:1;		&#x2F;&#x2F;0: jqxNavigation, 1: jqxTabs
		if (inputElem.data(&quot;oldVal&quot;) != inputElem.val()){
			inputElem.data(&quot;oldVal&quot;,inputElem.val());
			var filtervalue = inputElem.val();
			var parentElem = document.getElementById(&quot;infoAnalysisHeader&quot;);
			if (filtervalue){
				parentElem.ex_AddClassName(&quot;populated&quot;);
				if (mode==0){
					mygis.UI.filterListResults(filtervalue);
				}
			}else{
				parentElem.ex_RemoveClassName(&quot;populated&quot;);
				if (mode==0){
					mygis.UI.clearFilterListResults();
				}
			}
		}
	},

	&#x2F;**
	 *	Makes input element for search results focused
	 *	@method toggleSearchFilterFocus
	 *&#x2F;
	toggleSearchFilterFocus: function(on){
		var parentElem = document.getElementById(&quot;infoAnalysisHeader&quot;);
		if (on){
			if (!parentElem.ex_HasClassName(&quot;focused&quot;)){
				parentElem.ex_AddClassName(&quot;focused&quot;);
			}
		}else{
			if (parentElem.ex_HasClassName(&quot;focused&quot;)){
				parentElem.ex_RemoveClassName(&quot;focused&quot;);
			}
		}
	},

	&#x2F;**
	 *	Filter search results when display mode = list
	 *	@method filterListResults
	 *	@param {String} filter The filter to apply
	 *&#x2F;
	filterListResults: function(filter){
		&#x2F;&#x2F;var filter = &quot;&quot;;	&#x2F;&#x2F;todo
		filter = filter.toUpperCase();
		var tabs = $(&quot;#infoAnalysisContents .featureTabCont&quot;);
		$.each(tabs,function(ind,elem){
			var headerElem = $(elem).parent().parent().parent().find(&quot;.jqx-widget-header .jqx-expander-header-content&quot;);
			var headerText = headerElem.html();
			headerText = headerText.substring(0,headerText.indexOf(&quot;(&quot;));
			var results = $(elem).find(&quot;.featureTab&quot;);
			var counter = 0;
			$.each(results,function(resIndex,result){
				var compare = $(result).find(&quot;.featureTabTitle&quot;).html().toUpperCase();
				if (compare.indexOf(filter)!=-1){
					counter++;

					result.ex_RemoveClassName(&quot;collapsed&quot;);	&#x2F;&#x2F;if previously collapsed
				}else{
					result.ex_AddClassName(&quot;collapsed&quot;);
				}
			});
			headerElem.html(mygis.Utilities.format(&quot;{0} ({1})&quot;,headerText,counter));
		});
	},

	&#x2F;**
	 * Clears search results when display mode = list
	 * @method clearFilterListResults
	 *&#x2F;
	clearFilterListResults: function(){
		var tabs = $(&quot;#infoAnalysisContents .featureTabCont&quot;);
		$.each(tabs,function(ind,elem){
			var headerElem = $(elem).parent().parent().parent().find(&quot;.jqx-widget-header .jqx-expander-header-content&quot;);
			var headerText = headerElem.html();
			headerText = headerText.substring(0,headerText.indexOf(&quot;(&quot;));
			var results = $(elem).find(&quot;.featureTab&quot;);
			var filtered = $(elem).find(&quot;.featureTab.collapsed&quot;);
			$.each(filtered,function(resIndex,result){
				result.ex_RemoveClassName(&quot;collapsed&quot;);
			});
			headerElem.html(mygis.Utilities.format(&quot;{0} ({1})&quot;,headerText,results.length));
		});
	},

	&#x2F;**
		Creates a tabbed (jqxTabs) array of grids (jqxGrids) to display the selected info.
		The info was gathered by a map tool.

		@method buildSelectTabs
		@param {Object} resultItem The object containing the specific results.
	**&#x2F;
	buildSelectTabs: function(resultItem){
		expandResultDetails();
		var qText = resultItem.text;
		var layers=resultItem.linkedResults.layers;
		var features=resultItem.linkedResults.features;
		var newdata = {};
		var rightList = $(&quot;#infoRightCol&quot;);
		var rightTabs = $(&quot;&lt;ul &#x2F;&gt;&quot;);
		rightTabs.attr(&quot;id&quot;,&quot;infoRightTabsQ&quot;);
		rightList.removeData().empty();
		rightList.die();
		rightList.append(rightTabs);

		if (rightList.children().length&gt;1){
			rightList.children().slice(1).remove();
		}

		for (var i =0;i&lt;layers.length;i++){
			var gSource = [];
			var lname = layers[i];
			for (var j=0;j&lt;features.length;j++){
				var f=features[j];
				if (f.type==lname){
					gSource.push(f);
				}
			}

			var newdiv = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var newdivHeader = $(&quot;&lt;li &#x2F;&gt;&quot;);
			var newdivContent = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var windowTitle;
			newdivContent.attr(&quot;class&quot;,&quot;resultGridButtons&quot;);
			newdivContent.html(resultGridButtons.html());
			rightTabs.append(newdivHeader);
			newdiv.attr(&quot;id&quot;,&quot;queryTab_&quot;+i);
			newdiv.append(newdivContent);
			windowTitle = lname;
			newdivHeader.html(windowTitle);
			newdiv.data(&#x27;result&#x27;,gSource);

			newdiv.data(&#x27;windowTitle&#x27;,windowTitle);

			rightList.append(newdiv);
		}

		rightList.jqxTabs({
			width: &#x27;100%&#x27;,
			height: &#x27;100%&#x27;,
			theme: &#x27;pk_mg_white&#x27;,
			scrollable: true,
			scrollPosition:&#x27;right&#x27;,
			selectionTracker: true
		});
		rightList.live(&#x27;selected&#x27;, infoTabClickedM);
		&#x2F;&#x2F;console.log(&quot;binding infoTabClicked&quot;);
		infoTabClickedM(null,0,false,true);
	},

	&#x2F;**
		Creates a jqxNavigation menu of expanders (jqxExpander) to display the selected info.
		The info was gathered by a map tool.

		@method buildSelectExpanders
		@param {Array} layers Array of strings containing the layer names
		@param {Array} features Array of feature objects
	**&#x2F;
	buildSelectExpanders: function(layers,features,results){
		var struct = $(&quot;&lt;div id=&#x27;queryExpanders&#x27; &#x2F;&gt;&quot;);

		for (var i =0;i&lt;layers.length;i++){
			var layerTitle = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var layerContents = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var featureGrid = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var lname = layers[i];
			featureGrid.attr(&quot;class&quot;,&quot;featureTabCont&quot;);
			layerTitle.html(mygis.Utilities.getFriendlyName(lname));
			var gSource = [];
			for (var j=0;j&lt;features.length;j++){
				var f=features[j];

				if (f.type==lname){
					var classes=&quot;featureTab&quot;;
					if (layerCurrentEditing&gt;-1){
						if (layerSource.records[layerCurrentEditing].layerTABLE==lname){
							classes += &quot; editMode&quot;;
						}
					}
					var featureTab = $(&quot;&lt;div &#x2F;&gt;&quot;);
					featureTab.attr(&quot;class&quot;,classes);
					gSource.push(f.data);
					var counter = 0;
					var firstLine = $(&quot;&lt;a class=&#x27;firstLine featureTabExpand&#x27; &#x2F;&gt;&quot;);
					var secondLine = $(&quot;&lt;div class=&#x27;secondLine&#x27; &#x2F;&gt;&quot;);
					var restContent = $(&quot;&lt;div class=&#x27;restContent&#x27; &#x2F;&gt;&quot;)
					$.each(f.data,function(prop,value){
						if (counter==0){

							var title = $(&quot;&lt;span class=&#x27;featureTabTitle&#x27; &#x2F;&gt;&quot;);
							
							firstLine.click(
								function(layer,results,fid){
									return function(){
										
										router(&#x27;expandSelect&#x27;,{layername: layer,results: results, isMapSelect: true,fid: fid});
										return false;
									}
								}(lname,results,f.fid));
							firstLine.mouseover(
								function(feat){
									return function(){
										router(&#x27;markHoverResult&#x27;,{feature: feat});
									}
								}(f));
							firstLine.mouseleave(
								function(){
									return function(){
										mygis.Map.markFeatures();
										clearTimeout(internalConfig.zoomToFeat);
										internalConfig.zoomToFeat=setTimeout(function(){
											digimap.zoomToExtent(internalMemory.lastZoom);
										},1000);
									}
								}());
							title.append(value);
							firstLine.append(title);
						}
						counter+=1;
					});
					featureTab.append(firstLine);
					featureGrid.append(featureTab);
				}
			}
			featureGrid.data(&quot;gridSource&quot;,gSource);
			layerTitle.html(layerTitle.html()+&quot;   (&quot;+gSource.length+&quot;)&quot;);
			layerContents.append(featureGrid);
			struct.append(layerTitle);
			struct.append(layerContents);
			
			
		}
		return struct;
	},

	&#x2F;**
		Creates a jqxNavigation menu of expanders (jqxExpander) to display the selected info.
		The info was gathered by a database search.
		@method buildQueryExpanders
		@param {Array} linkedResults
		* linkedResult[X].Fields: the field names
		* linkedResult[X].TableName: the layer name
		* linkedResult[X].Rows: the records
		* linkedResult[X].Rows[Y].Cells[Z]: cellobjects
	**&#x2F;
	buildQueryExpanders: function(linkedResults){
		var struct = $(&quot;&lt;div id=&#x27;queryExpanders&#x27; &#x2F;&gt;&quot;);
		$.each(linkedResults,function(i,result){
			var layerTitle = $(&quot;&lt;h3 &#x2F;&gt;&quot;);
			var layerContents = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var featureGrid = $(&quot;&lt;div &#x2F;&gt;&quot;);
			var lname = result.TableName;
			featureGrid.attr(&quot;class&quot;,&quot;featureTabCont&quot;);
			layerTitle.html(mygis.Utilities.getFriendlyName(lname));
			var gSource = [];
			$.each(result.Rows,function(rowIndex,rowObject){
				var featureTab = $(&quot;&lt;div class=&#x27;featureTab&#x27; &#x2F;&gt;&quot;);


				var firstLine = $(&quot;&lt;a class=&#x27;firstLine featureTabExpand&#x27; &#x2F;&gt;&quot;);
				var secondLine = $(&quot;&lt;div class=&#x27;secondLine&#x27; &#x2F;&gt;&quot;);
				var restContent = $(&quot;&lt;div class=&#x27;restContent&#x27; &#x2F;&gt;&quot;)
				gSource.push(rowObject);
				var counter = 0;
				var feature = null;
				$.each(rowObject.Cells, function(cellIndex,cellObject){
					if (counter==0){
						var title = $(&quot;&lt;span class=&#x27;featureTabTitle&#x27; &#x2F;&gt;&quot;);
						
						firstLine.click(
								function(layer,results,fid){
									return function(){
										router(&#x27;expandSelect&#x27;,{layername: layer,results: results, isMapSelect: false,fid: fid});
										return false;
									}
								}(lname,rowObject.Cells,rowObject.Cells[0].ColumnName==&quot;OID&quot;?rowObject.Cells[0].Value:rowObject.Cells[1].Value));	&#x2F;&#x2F;look up in the first 2 fields for id field
						title.append(cellObject.Value);
						firstLine.append(title);
					}
					var currentCell=rowObject.Cells[counter];
					if (currentCell.ColumnName==&quot;GeometryText&quot;){
						var wkt= new OpenLayers.Format.WKT();
						feature = wkt.read(currentCell.Value);
						if (feature){
							feature.geometry = feature.geometry.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),selectionLayer.projection);
						}
					}
					counter+=1;
				});
				if (feature){
					firstLine.mouseover(
						function(feat){
							return function(){
								router(&#x27;markHoverResult&#x27;,{feature: feat});
							}
						}(feature));
					firstLine.mouseleave(
								function(){
									return function(){
										mygis.Map.markFeatures();
										clearTimeout(internalConfig.zoomToFeat);
										internalConfig.zoomToFeat=setTimeout(function(){
											digimap.zoomToExtent(internalMemory.lastZoom);
										},1000);
									}
								}());
				}
				featureTab.append(firstLine);
				featureGrid.append(featureTab);
			});

			featureGrid.data(&quot;gridSource&quot;,gSource);
			layerTitle.html(layerTitle.html()+&quot;   (&quot;+gSource.length+&quot;)&quot;);
			layerContents.append(featureGrid);
			struct.append(layerTitle);
			struct.append(layerContents);
		});
		return struct;
	},

	&#x2F;**
		Router function used for the toggling of all &quot;drawer&quot; style buttons.
		@method toggleDrawerButton
		@param {Element} elem The toggling element
	**&#x2F;
	toggleDrawerButton: function(elem){
		var btnCont = $(elem).parent();
		btnCont.toggleClass(&quot;drawer&quot;);
		switch (btnCont.attr(&quot;id&quot;))
		{
			case &quot;mode_TopSelect&quot;:
				mygis.UI.addSelectBtn(infoControls.select.box);
				break;

			case &quot;mode_AddSelect&quot;:
				if (mygis.UI.isActiveSelectMode(&quot;mode_AddSelect&quot;)){
					document.getElementById(&quot;mode_SubtractSelect&quot;).ex_RemoveClassName(&quot;drawer&quot;);
				}
				break;
			case &quot;mode_SubtractSelect&quot;:
				if (mygis.UI.isActiveSelectMode(&quot;mode_SubtractSelect&quot;)){
					document.getElementById(&quot;mode_AddSelect&quot;).ex_RemoveClassName(&quot;drawer&quot;);
				}
				break;
			case &quot;mode_ResultsList&quot;:
				var resultList =$(&quot;#infoLeftList&quot;);
				var item = resultList.jqxListBox(&#x27;getSelectedIndex&#x27;);
				if (item&gt;-1){
					resultList.jqxListBox(&#x27;clearSelection&#x27;);
					resultList.jqxListBox(&#x27;selectIndex&#x27;,item);
				}

				break;
			case &quot;mode_NewLayerDB&quot;:
			case &quot;mode_NewLayerStyle&quot;:
			case &quot;mode_NewLayerAdvanced&quot;:
				var parent = btnCont.parent()[0];
				if (parent.ex_HasClassName(&quot;expanded&quot;)){
					parent.ex_RemoveClassName(&quot;expanded&quot;);
				}else{
					parent.ex_AddClassName(&quot;expanded&quot;);
				}
				break;

		}

	},

	&#x2F;**
		Checks if an element with the given id has the class &#x27;drawer&#x27;.
		If true, it&#x27;s considered active.
		Used for the &#x27;drawer&#x27; style buttons.
		@method isActiveSelectMode
		@param {String} name The id of the element to check.
		@return {Boolean} The active status for the selected control
	**&#x2F;
	isActiveSelectMode: function(name){
		var retvalue=false;
		var elem = document.getElementById(name);
		if (elem){
			retvalue = elem.ex_HasClassName(&quot;drawer&quot;);
		}else{
			console.log(name);
		}
		return retvalue;
	},

	&#x2F;**
		This is used to toggle expand status for the select result tabs.
		@method toggleSelectTab
		@param {Element} elem The toggling element.
	**&#x2F;
	toggleSelectTab: function(elem){
		&#x2F;&#x2F;var tab = $(elem).parent().parent();
		var tab = $(elem).parent();
		if (tab[0].ex_HasClassName(&quot;expanded&quot;)){
			tab[0].ex_RemoveClassName(&quot;expanded&quot;);
		}else{
			tab[0].ex_AddClassName(&quot;expanded&quot;);
		}
		&#x2F;*
		var hiddenDiv = tab.find(&quot;.restContent&quot;);
		if (hiddenDiv.is(&quot;:visible&quot;)){
			hiddenDiv.hide(1000);
		}else{
			hiddenDiv.show(1000);
		}
		*&#x2F;
	},
	&#x2F;&#x2F;JK CHANGES - also reset circle btn
	&#x2F;**
		Resets status for &quot;select&quot; buttons, namely:
		toggleInfoBtn
		selectObject
		selectRect
		selectCircle
		selectClear
		@method clearInfoButtons
	**&#x2F;
	clearInfoButtons: function(){
		for (var i in infoControls){
			infoControls[i].deactivate();
		}
		&#x2F;&#x2F;document.getElementById(&quot;infoPoint&quot;).ex_RemoveClassName(&quot;btnTool_selected&quot;);
		&#x2F;&#x2F;document.getElementById(&quot;infoRect&quot;).ex_RemoveClassName(&quot;btnTool_selected&quot;);
		document.getElementById(&quot;infoTool&quot;).ex_RemoveClassName(&quot;selected&quot;);
		document.getElementById(&quot;toggleInfoBtn&quot;).ex_RemoveClassName(&quot;selected&quot;);
		document.getElementById(&quot;selectObject&quot;).ex_RemoveClassName(&quot;selected&quot;);
		document.getElementById(&quot;selectRect&quot;).ex_RemoveClassName(&quot;selected&quot;);
		document.getElementById(&quot;selectCircle&quot;).ex_RemoveClassName(&quot;selected&quot;);
		&#x2F;&#x2F;JK CHANGES END
		document.getElementById(&quot;selectClear&quot;).ex_RemoveClassName(&quot;selected&quot;);
		mygis.Map.clearSelection();
	},

	&#x2F;**
		This should return an image containing the legend for all visible elements.
		TODO.
		@method ToggleFullLegend
		@deprecated
	**&#x2F;
	ToggleFullLegend: function(){
		var layers = mygis.Utilities.getVisibleLayerString(currentAppName,true);
		document.getElementById(&quot;testLegend&quot;).src=config.mapserver+&quot;wms&quot;+
		&quot;?layer=&quot;+layers+
		&quot;&amp;REQUEST=GetLegendGraphic&amp;VERSION=1.0.0&amp;FORMAT=image&#x2F;png&amp;WIDTH=&quot;+internalConfig.legendWidth+&quot;&amp;HEIGHT=&quot;+internalConfig.legendWidth;
		$(&quot;#testLegend&quot;).dialog();

	},

	&#x2F;**
		Creates an image element with the layer&#x27;s style as the image source.
		The image created SHOULD be 20 x 20 pixels wide.
		@method getSingleLegend
		@param {String} layername The layer TABLE name.
		@return {Element} The image element.
	**&#x2F;
	getSingleLegend: function(layername,geomType){
		var img = document.createElement(&quot;img&quot;);
		layername = mygis.Utilities.nameToUnderscore(layername);
		var specificRule;
		switch (geomType){
			case &quot;Point&quot;:
				specificRule= mygis.Utilities.format(&quot;&amp;RULE={0} - Points&quot;,layername);
				break;
			case &quot;Line&quot;:
				specificRule= mygis.Utilities.format(&quot;&amp;RULE={0} - Lines&quot;,layername);
				break;
			case &quot;Polygon&quot;:
			case &quot;Mixed&quot;:
				specificRule= mygis.Utilities.format(&quot;&amp;RULE={0} - Polygons&quot;,layername);
				break;
			default:
				specificRule=&quot;&quot;;
				break;
		}



		img.src = config.mapserver+&quot;wms&quot;+
		&quot;?layer=&quot;+layername+
		&quot;&amp;REQUEST=GetLegendGraphic&amp;transparent=true&amp;VERSION=1.0.0&amp;FORMAT=image&#x2F;png&amp;WIDTH=&quot;+internalConfig.legendWidth+&quot;&amp;HEIGHT=&quot;+internalConfig.legendWidth;
		if (customStyleApplied){
			img.src+=&quot;&amp;SLD_BODY=&quot;+escape(mygis.Map.getSingleAppliedStyle(layername));
		}
		var testSrc=mygis.Utilities.format(&quot;{0}wms?layer={1}{2}&amp;REQUEST=GetLegendGraphic&amp;transparent=true&amp;VERSION=1.0.0&amp;FORMAT=image&#x2F;png&amp;WIDTH=&quot;+internalConfig.legendWidth+&quot;&amp;HEIGHT=&quot;+internalConfig.legendWidth,
										   config.mapserver,layername,specificRule
										   );
		if (customStyleApplied){
			testSrc+=&quot;&amp;SLD_BODY=&quot;+escape(mygis.Map.getSingleAppliedStyle(layername));
		}
		var xxx = function(layername){
			return function(newImg){
				mygis.Utilities.updateLayerSource(&quot;layerTABLE&quot;,layername,&quot;mygisImageSrc&quot;,newImg.src);
			}
		};
		checkImage(testSrc,xxx(layername));

		return img;
	},

	&#x2F;**
		Toggles the selected layer&#x27;s &quot;visible&quot; property.
		@method toggleLayerVisibleProperty
		@param {Element} elem The activating element. Does not affect the layer grid&#x27;s selected item.
	**&#x2F;
	toggleLayerVisibleProperty: function(elem){
		var rowindex = $(&#x27;#layersList&#x27;).jqxGrid(&#x27;getselectedrowindex&#x27;);
		mygis.UI.toggleLayerVisible(null,rowindex);
		if (elem.ex_HasClassName(&#x27;pressed&#x27;)){
			elem.ex_RemoveClassName(&#x27;pressed&#x27;);
		}else{
			elem.ex_AddClassName(&#x27;pressed&#x27;);
		}
	},
	
	toggleInfoGroup: function(){
		var container=$(&quot;#dialog-extend-fixed-container&quot;);
		if (container.hasClass(&quot;collapsed&quot;)){
			container.removeClass(&quot;collapsed&quot;);
		}else{
			container.addClass(&quot;collapsed&quot;);
		}
	},
	
	toggleLayerGroup: function(groupName){
		var layerlist=$(&#x27;#layersList&#x27;);
		var groupCount=layerlist.jqxGrid(&#x27;getrootgroupscount&#x27;);
		var i=0;
		var found=false;
		while (!found &amp;&amp; i&lt;groupCount){
			var group = layerlist.jqxGrid(&#x27;getgroup&#x27;,i);
			if (group.group==groupName){
				found=true;
				var items = group.subrows;
				var countVisible=0;
				$.each(items,function(j,v){
					if (v.Visible){
						countVisible++;
					}
				});
				var visibility=true;
				if (countVisible==items.length){	&#x2F;&#x2F;hide
					visibility=false;
				}
				$.each(items,function(j,v){
					var rowIndex = v[&quot;#&quot;]-1;
					mygis.UI.preToggleLayerVisible(null,rowIndex,visibility,true);
				});
			}
			i++;
		}
		mygis.UI.updateLayerGrid(true);
	},
	
	preToggleLayerVisible: function(layername,rowIndex,visible,pauseUpdate){
		var layerlist = $(&#x27;#layersList&#x27;);
		if (layername){
			var layerID;
			layerSource.records.forEach(function(element,index,array){
				if (array[index].layerNAME==layername){
					if (index){
						layerID=index;
					}
				}
			});

		}else{
			var layerID =rowIndex;
		}
		var found=false;
		var item = $.extend({},layerSource.records[layerID]);
		if (layerID&gt;layerSource.records.length-1){	&#x2F;&#x2F;it&#x27;s a bg layer. toggle it instantly, too much hassle to do otherwise.
			mygis.UI.toggleLayerVisible(layername,rowIndex,visible);
			found=true;
		}else if (internalMemory.unsavedLayerChanges.length&gt;0){	&#x2F;&#x2F;if we have unsaved changes, check if it&#x27;s there...
			var i=0;
			var items=internalMemory.unsavedLayerChanges;
			while (!found &amp;&amp; i &lt; items.length){
				var check = items[i];
				if (item.layerID==check.layerID){
					found=true;
					if (undefined != visible){
						check.hidden = !visible;
					}else{
						check.hidden=!Boolean(check.hidden);
					}
					if(!pauseUpdate){
						mygis.UI.updateLayerGrid(true);
					}
					$(&quot;#applyLayersCont&quot;).show(&#x27;slide&#x27;,{direction: &#x27;down&#x27;},300);
				}
				i++;
			}
		}
		if (!found){
			item.manualVisibility=true;
			if (undefined != visible){
				item.hidden=!visible;
			}else{
				item.hidden=!Boolean(item.hidden);
			}
			internalMemory.unsavedLayerChanges.push(item);
			if (!pauseUpdate){
				mygis.UI.updateLayerGrid(true);
			}
			$(&quot;#applyLayersCont&quot;).show(&#x27;slide&#x27;,{direction: &#x27;down&#x27;},300);
		}
	},

	&#x2F;**
		Toggles a given layer&#x27;s visibility
		@method toggleLayerVisible
		@param {String} [layername] If defined, takes precedence over rowIndex
		@param {Integer} rowIndex The layer&#x27;s index
		@param {Boolean} visible The visible status to set.
	**&#x2F;
	toggleLayerVisible: function(layername,rowIndex, visible){
		$(&#x27;#initialLoad&#x27;).find(&quot;.mygis_logo&quot;).hide();
		$(&#x27;#initialLoad&#x27;).find(&quot;.mygis_loader&quot;).attr({&quot;style&quot;:&quot;margin-top:140px;&quot;});
		&#x2F;&#x2F;mygis.Utilities.blockUI();
		&#x2F;&#x2F;$(&#x27;#initialLoad&#x27;).find(&quot;.mygis_loader&quot;).attr({&quot;style&quot;:&quot;display: block;margin-top:140px;&quot;});
		&#x2F;&#x2F;$(&quot;#initialLoad&quot;).show();
		var mapItem = $(&quot;#mapsList&quot;).jqxListBox(&#x27;getSelectedItem&#x27;).originalItem;
		var layerlist = $(&#x27;#layersList&#x27;);
		if (layername){
			var layerID;
			layerSource.records.forEach(function(element,index,array){
				if (array[index].layerNAME==layername){
					if (index){
						layerID=index;
					}
				}
			});
		}else{
			var layerID =rowIndex;
		}
		if (layerID&gt;layerSource.records.length-1){
			var name = layergridSource.localdata[layerID].Name;
			if (name==digimap.layers[0].name){
				var layerToChange = digimap.getLayersByName(name)[0];
				layerToChange.manualVisibility= true;
				if (digimap.baseLayer==layerToChange){
					layerToChange.setVisibility(!layerToChange.visibility);

				}else{
					digimap.baseLayer.setVisibility(false);
					digimap.setBaseLayer(layerToChange);

				}
			}else{
				mygis.Map.switchBackground(mygis.Utilities.getBGIdentifier(name),0);
			}
			
			&#x2F;&#x2F;mygis.Utilities.unblockUI();
		}else{
			if (undefined != visible){
				layerSource.records[layerID].hidden=!visible;
			}else{
				layerSource.records[layerID].hidden=!Boolean(layerSource.records[layerID].hidden);
			}
			layerSource.records[layerID].manualVisibility=true;
			loadMapSequence(mapItem);

		}

		mygis.UI.updateLayerGrid();



		&#x2F;&#x2F;layerlist.jqxGrid(&#x27;showrowdetails&#x27;,layerID);

	},

	&#x2F;**
		Toggles a layer &quot;selectable&quot; property.

		@method toggleLayerSelectable
		@param {Integer} index The layer index to toggle
	**&#x2F;
	toggleLayerSelectable: function(index,preventUpdate){
		var rowIndex = index!=null?index:$(&#x27;#layersList&#x27;).jqxGrid(&#x27;getselectedrowindex&#x27;);
		if (rowIndex&lt;layerSource.records.length){
			layerSource.records[rowIndex].Selectable = !layerSource.records[rowIndex].Selectable;
			var previouslyActive = infoControls.select.active;
			var previouslyBox = infoControls.select.box;
			if (previouslyActive &amp;&amp; !preventUpdate){
				mygis.UI.addSelectBtn(previouslyBox);
				&#x2F;*
				if (boxmode){
					document.getElementById(&quot;selectRect&quot;).ex_AddClassName(&quot;selected&quot;);
				}else{
					document.getElementById(&quot;selectObject&quot;).ex_AddClassName(&quot;selected&quot;);
				}
				infoControls.select.activate();
				*&#x2F;
			}
			mygis.UI.updateLayerGrid(preventUpdate);
			&#x2F;*
			if (!preventUpdate){
				mygis.UI.updateLayerGrid();
			}
			*&#x2F;

		}
	},

	&#x2F;**
		Toggles a layer as editable.
		@method toggleLayerEditable
		@param {Integer} index The layer index to toggle
	**&#x2F;
	toggleLayerEditable: function(index){
		var rowIndex = index!=null?index:$(&#x27;#layersList&#x27;).jqxGrid(&#x27;getselectedrowindex&#x27;);
		if (rowIndex&lt;layerSource.records.length){
			var item = layerSource.records[rowIndex];
			var isEditable = item.Editable;
			if (unsavedChanges){
				showConfirmationDialog(strings.Editing.loseChanges,function(){
					mygis.UI.clearUnsavedLayer(layerCurrentEditing);
					mygis.UI.toggleLayerEditable(index);
				});
				return false;
			}else{

				mygis.UI.clearEditable();	&#x2F;&#x2F;this is to have only one editable at a time
				if (!isEditable){

					item.Editable = true;
					layerCurrentEditing=rowIndex;
					for (var i=0;i&lt;layerSource.records.length;i++){

						if (layerSource.records[i].Selectable &amp;&amp; i!=rowIndex){
							memory.LayerControl.selectableBeforeEdit.push(i);
							layerSource.records[i].Selectable=false;
						}
					}
					mygis.Drawing.Editing.editLayer(item.layerTABLE);
					if (!layerSource.records[index].hidden){
						mygis.UI.toggleLayerVisible(null,index,false);
						layerToReset=index;
					}
					mygis.UI.switchEditMode(document.getElementById(&quot;editModeDrag&quot;));	&#x2F;&#x2F;reset it
					&#x2F;&#x2F;$(&quot;#fDock1&quot;).jqxNavigationBar(&#x27;expandAt&#x27;,internalConfig.selectionToolbarIndex);
					&#x2F;&#x2F;$(&quot;#fDock1&quot;).jqxNavigationBar(&#x27;expandAt&#x27;,internalConfig.digitizingToolbarIndex);
					mygis.UI.activateSelectCtrl(document.getElementById(&quot;selectObject&quot;));
					$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;enableAt&#x27;,internalConfig.editTabIndex);
					&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;select&#x27;,internalConfig.editTabIndex);
				}else{
					item.Editable = false;
					&#x2F;&#x2F;layerCurrentEditing = -1;
					&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;select&#x27;,internalConfig.layerTabIndex);
					$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;disableAt&#x27;,internalConfig.editTabIndex);
					mygis.UI.activateControl(&#x27;drag&#x27;);
					cosmeticLayer.destroyFeatures();
					window.location.reload();	&#x2F;&#x2F;&quot;fix&quot;
					cosmeticLayer = new OpenLayers.Layer.Vector(&quot;Cosmetic Layer&quot;,{
						preFeatureInsert: function(feature) {
							&#x2F;*
							console.log(feature.geometry.toString());
							console.log(feature.attributes.OID);
							*&#x2F;
							var y=feature.geometry.getCentroid().y;
							if (y&lt;90 &amp;&amp; y&gt;-190){
								&#x2F;&#x2F;feature.geometry.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;))
							}
					   }
					});
					mygis.Utilities.nudgeMap();

				}


				mygis.UI.updateLayerGrid();
			}

		}
	},

	&#x2F;**
		Activates the proper ModifyFeature control based on the selected edit mode,
		or deletes the feature if delete is active.
		@method switchEditMode
		@param {Element} elem The toggling element
	**&#x2F;
	switchEditMode: function(elem){
		if (!elem.ex_HasClassName(&quot;disabled&quot;)){
			if (elem.id==&quot;editModeDelete&quot;){
				var positiveConfirm=function(){

					mygis.Drawing.Editing.mg_removeFeature();
				};
				showConfirmationDialog(strings.Editing.deleteObject,positiveConfirm);
			}else{


				var parent = $(elem).parent();
				var children = parent.find(&quot;a&quot;);
				for (var i=0;i&lt;children.length;i++){
					children[i].ex_RemoveClassName(&quot;pressed&quot;);
				}
				switch (elem.id){
					case &quot;editModeDrag&quot;:
						featureEditMode=0;
						drawControls.modify.mode = OpenLayers.Control.ModifyFeature.DRAG;
						break;
					case &quot;editModeRotate&quot;:
						featureEditMode=1;
						drawControls.modify.mode = OpenLayers.Control.ModifyFeature.ROTATE;
						break;
					case &quot;editModeResize&quot;:
						featureEditMode=2;
						drawControls.modify.mode = OpenLayers.Control.ModifyFeature.RESIZE;
						break;
					case &quot;editModeReshape&quot;:
						featureEditMode=3;
						drawControls.modify.mode = OpenLayers.Control.ModifyFeature.RESHAPE;
						break;
				}

				elem.ex_AddClassName(&quot;pressed&quot;);
				if (cosmeticLayer.selectedFeatures.length&gt;0){
					&#x2F;&#x2F;var clone = mygis.Utilities.arrayUnique(cosmeticLayer.selectedFeatures);
					var clone = [];
					while(cosmeticLayer.selectedFeatures.length&gt;0){
						clone.push(cosmeticLayer.selectedFeatures[0]);
						drawControls.modify.selectControl.unselect(cosmeticLayer.selectedFeatures[0]);
					}

					for (var k=0;k&lt;clone.length;k++){
						drawControls.modify.selectControl.select(clone[k]);
					}

				}
			}
		}
	},

	&#x2F;**
		Goes through the layer list and clears any previous &quot;editable&quot; status
		@method clearEditable
	**&#x2F;
	clearEditable: function(){

		&#x2F;&#x2F;mygis.UI.clearCosmetic();
		for (var i=0;i&lt;layerSource.records.length;i++){
			layerSource.records[i].Editable = false;
		}
		if (layerToReset&gt;-1){
			mygis.UI.toggleLayerVisible(null,layerToReset,true);
			layerToReset = -1;
		}
		var previouslySelected = memory.LayerControl.selectableBeforeEdit;
		for (var i=0;i&lt;previouslySelected.length;i++){
			layerSource.records[previouslySelected[i]].Selectable=true;
		}
		memory.LayerControl.selectableBeforeEdit=[];
		&#x2F;&#x2F;document.getElementById(&quot;selectObject&quot;).ex_AddClassName(&quot;disabled&quot;);
		document.getElementById(&quot;selectClear&quot;).ex_AddClassName(&quot;disabled&quot;);
	},

	&#x2F;**
		Updates the layer list source
		@method updateLayerGrid
	**&#x2F;
	updateLayerGrid: function(ignoreSecondLevel){
		var layerlist=$(&#x27;#layersList&#x27;);
		layergridSource = {
			localdata: mygis.UI.buildGridSource(layerSource,&#x27;layers&#x27;),
			datatype: &#x27;array&#x27;
		};
		layerlist.jqxGrid({
				source: layergridSource
			});
		layerlist.jqxGrid(&#x27;refreshdata&#x27;);
		fixLayerList();
		
		if (!ignoreSecondLevel){
			mygis.UI.initLayerSelectionList(false);
			mygis.UI.initLayerWithinSelectionList(false);
			router(&#x27;dragPanBtn&#x27;);	&#x2F;&#x2F;shortest way to reset.
			mygis.Map.moveEnd();
		}
		console.log(&#x27;updateLayerGrid fired&#x27;);
	},

	
	initLayerSelectionList: function(initial){
		var layerSelectionList=$(&quot;#layerSelectionList&quot;);
		if (initial){
			layerSelectionList.jqxListBox({
				width: 239,
				source: mygis.UI.buildSelectionListSource(layerSource),
				checkboxes: true, 
				height: 128,
				theme: &#x27;pk_mg&#x27;,
				displayMember: &#x27;layerNAME&#x27;,
				valueMember: &#x27;layerTABLE&#x27;,
				autoItemsHeight: true,
				renderer: function(index,label,value){
					var data = $(&quot;#layerSelectionList&quot;).jqxListBox(&#x27;source&#x27;).records;
					var datarecord = data[index];
					if(datarecord){
						var tip;
						switch(datarecord.layerGeomType){
							case &quot;Point&quot;:
								tip = strings.LayerControl.layergrid_colPoints;
								break;
							case &quot;Line&quot;:
								tip = strings.LayerControl.layergrid_colLines;
								break;
							case &quot;Polygon&quot;:
								tip = strings.LayerControl.layergrid_colPolygons;
								break;
						}
						return &quot;&lt;span class=&#x27;&quot;+datarecord.layerGeomType+&quot;&#x27; title=&#x27;&quot;+tip+&quot;&#x27;&gt;&lt;&#x2F;span&gt;&lt;span class=&#x27;label&#x27; title=&#x27;&quot;+label+&quot;&#x27;&gt;&quot;+label+&quot;&lt;&#x2F;span&gt;&quot;;
					}
				}
			});
			layerSelectionList.bind(&quot;rendered&quot;,function(){
				var horizontalScrollBarId = &#x27;#horizontalScrollBar&#x27; + &#x27;layerSelectionList&#x27;;
				var horizontalScrollBar = $(&#x27;#layerSelectionList&#x27;).find(horizontalScrollBarId);
				var bottomRightId = &#x27;#bottomRight&#x27;+ &#x27;layerSelectionList&#x27;;
				var bottomRight = $(&#x27;#layerSelectionList&#x27;).find(bottomRightId);
				&#x2F;&#x2F; Horizontal scrollbar is visible
				if (horizontalScrollBar.css(&#x27;visibility&#x27;) === &#x27;visible&#x27;) {
					horizontalScrollBar.css(&#x27;visibility&#x27;, &#x27;hidden&#x27;);
					bottomRight.css(&#x27;visibility&#x27;, &#x27;hidden&#x27;);
					$(&#x27;#layerSelectionList&#x27;).css(&#x27;height&#x27;, $(&#x27;#layerSelectionList&#x27;).height() - 17);
				}
			});
			try{selectionLayers.unbind(&#x27;checkChange&#x27;);}catch(err){}
			
		}else{
			layerSelectionList.unbind(&#x27;checkChange&#x27;);
			layerSelectionList.jqxListBox({
					source: mygis.UI.buildSelectionListSource(layerSource)
			});
		}
		layerSelectionList.unbind(&#x27;checkChange&#x27;);
		mygis.Map.setSelectableLayers(layerSource.records,layerSelectionList);
		mygis.Map.determineSelectionToggleStatus(&quot;#layerSelectionList&quot;);
		layerSelectionList.bind(&#x27;checkChange&#x27;,function(event){
			var args = event.args;
			var checked = args.checked;
			var item = args.item;
			var index = mygis.Utilities.mggetLayerIndex(item.originalItem.layerTABLE);
			mygis.UI.toggleLayerSelectable(index,true);
			var previouslyActive = infoControls.select.active;
			var previouslyBox = infoControls.select.box;
			if (previouslyActive){
				mygis.UI.addSelectBtn(previouslyBox);
			}
			if (internalConfig.updateLayerList){
				clearTimeout(internalConfig.updateLayerList);
			}
			internalConfig.updateLayerList=setTimeout(function(){
				mygis.UI.updateLayerGrid(true);
			},1000);
			
			mygis.Map.determineSelectionToggleStatus(&quot;#layerSelectionList&quot;);
			
		});
	},
	
	initLayerWithinSelectionList: function(initial){
		var selectionWithinLayers = $(&quot;#layerWithinSelectionList&quot;);
		if (initial){
			selectionWithinLayers.jqxListBox({
				width: 310,
				source: mygis.UI.buildSelectionListSource(layerSource),
				checkboxes: true, 
				height: 282,
				theme: &#x27;pk_mg&#x27;,
				displayMember: &#x27;layerNAME&#x27;,
				valueMember: &#x27;layerTABLE&#x27;,
				renderer: function(index,label,value){
					var data = $(&quot;#layerWithinSelectionList&quot;).jqxListBox(&#x27;source&#x27;).records;
					var datarecord = data[index];
					var tip;
					switch(datarecord.layerGeomType){
						case &quot;Point&quot;:
							tip = strings.LayerControl.layergrid_colPoints;
							break;
						case &quot;Line&quot;:
							tip = strings.LayerControl.layergrid_colLines;
							break;
						case &quot;Polygon&quot;:
							tip = strings.LayerControl.layergrid_colPolygons;
							break;
					}
					return &quot;&lt;span class=&#x27;&quot;+datarecord.layerGeomType+&quot;&#x27; title=&#x27;&quot;+tip+&quot;&#x27;&gt;&lt;&#x2F;span&gt;&lt;span class=&#x27;label&#x27; title=&#x27;&quot;+label+&quot;&#x27;&gt;&quot;+label+&quot;&lt;&#x2F;span&gt;&quot;;
				}
			});
			try{selectionWithinLayers.unbind(&#x27;checkChange&#x27;);}catch(err){}
		}else{
			selectionWithinLayers.unbind(&#x27;checkChange&#x27;);
			selectionWithinLayers.jqxListBox({
					source: mygis.UI.buildSelectionListSource(layerSource)
			});
		}
		mygis.Map.setSelectableLayers(layerSource.records,selectionWithinLayers);
		mygis.Map.determineSelectionToggleStatus(&quot;#layerWithinSelectionList&quot;);
		selectionWithinLayers.bind(&#x27;checkChange&#x27;,function(event){
			var args = event.args;
			var checked = args.checked;
			var item = args.item;
			mygis.Map.determineSelectionToggleStatus(&quot;#layerWithinSelectionList&quot;);
		});
		
		
	},
	&#x2F;**
		Updates the query list source(&quot;#infoLeftList&quot;)
		@method updateQueryList
	**&#x2F;
	updateQueryList: function(){
		var leftList = $(&quot;#infoLeftList&quot;);
		leftList.die();
		var itemRenderer = function(index, label, value){
			retobject = mygis.Utilities.format(
				&quot;&lt;div class=&#x27;queryListItem&#x27;&gt;&lt;a class=&#x27;queryDeleteBtn&#x27; href=&#x27;#&#x27; title=&#x27;{1}&#x27;&gt;&lt;&#x2F;a&gt;&lt;a class=&#x27;queryRunBtn&#x27; href=&#x27;#&#x27; title=&#x27;{2}&#x27;&gt;&lt;&#x2F;a&gt;&lt;span title=&#x27;{0}&#x27;&gt;{0}&lt;&#x2F;span&gt;&lt;&#x2F;div&gt;&quot;,label,strings.QBuilder.deleteQuery,strings.QBuilder.runQuery);
			return retobject;
		};
		
		leftList.jqxListBox({
			width: 244,
			height: &#x27;100%&#x27;,
			theme: &#x27;pk_mg&#x27;,
			source: jQuery.extend(true, {}, querySource),	&#x2F;&#x2F;clone source
			displayMember: &quot;text&quot;,
			renderer: itemRenderer,
			valueMember: &quot;value&quot;
		});

		leftList.live(&#x27;select&#x27;, queryResultsSelect);
		leftList.live(&#x27;click&#x27;,queryResultsClick);
		&#x2F;&#x2F;leftList.bind(&#x27;mouseover&#x27;,queryResultsMouseOver);
		&#x2F;&#x2F;leftList.bind(&#x27;mouseout&#x27;,queryResultsMouseOut);
		$(&quot;.queryRunBtn&quot;).live(&#x27;click&#x27;,function(){
			showConfirmationDialog(strings.QBuilder.runQueryConfirm ,function(){
				mygis.UI.queryResultsRun();
			});
			return false;
		});
		$(&quot;.queryDeleteBtn&quot;).live(&#x27;click&#x27;,function(){
			router(&#x27;searchDelete&#x27;);
			return false;
		});
	},

	&#x2F;**
		Zooms to layer extents
		Layer extents is a database property that must be set for its layer record.
		@method zoomToLayer
		@param {Integer} index The layer index in the layerSource
	**&#x2F;
	zoomToLayer: function(index){
		var index2 = $(&#x27;#layersList&#x27;).jqxGrid(&#x27;getselectedrowindex&#x27;);
		var lay= layerSource.records[index2].layerEXTENTS.split(&quot;$&quot;);
		var x,y,mx,my;

		x = parseFloat(lay[0].replace(&quot;,&quot;,&quot;.&quot;));
		y = parseFloat(lay[1].replace(&quot;,&quot;,&quot;.&quot;));
		mx = parseFloat(lay[2].replace(&quot;,&quot;,&quot;.&quot;));
		my = parseFloat(lay[3].replace(&quot;,&quot;,&quot;.&quot;));
		digimap.zoomToExtent([x,y,mx,my],false);
	},

	&#x2F;**
		Moves a layer custom X places
		@method moveLayerCustom
		@param {Integer} oldindex The layer old position
		@param {Integer} newindex The layer new position
	*&#x2F;
	moveLayerCustom: function(oldindex,newindex){
		if (newindex&gt;=0 &amp;&amp; newindex&lt;=layerSource.records.length-1){
			var layerlist=$(&#x27;#layersList&#x27;);
			layerlist.jqxGrid(&#x27;hiderowdetails&#x27;,oldindex);
			var params=[];
			params.push(oldindex);
			params.push(newindex);
			MakeTimeout(function(cl_params){
				layerSource.records = mygis.Utilities.arrayMove(layerSource.records,cl_params[0],cl_params[1]);
				mygis.UI.updateLayerGrid();
				loadMapSequence();
				layerlist.jqxGrid(&#x27;refreshdata&#x27;);

			},params,0);
		}
	},

	&#x2F;**
		Moves a layer up according to the value in #moveLayerStep
		@method moveLayerUp
		@param {Integer} index The layer index
	*&#x2F;
	moveLayerUp: function(index){
		var layerlist=$(&#x27;#layersList&#x27;);
		&#x2F;&#x2F;layerlist.jqxGrid(&#x27;hiderowdetails&#x27;,index);
		&#x2F;&#x2F;var step_value=document.getElementById(&quot;moveLayerStep&quot;+index).value;
		var index2 = layerlist.jqxGrid(&#x27;getselectedrowindex&#x27;);
		var step_value=document.getElementById(&quot;moveLayerStep&quot;).value;
		MakeTimeout(function(i){
			layerSource.records = mygis.Utilities.arrayMove(layerSource.records,i,i-step_value);
			mygis.UI.updateLayerGrid();
			loadMapSequence();

			&#x2F;&#x2F;expandLayerDetails();
		},index2,0);

	},

	&#x2F;**
		Moves a layer down according to the value in #moveLayerStep
		@method moveLayerDown
		@param {Integer} index The layer index
	*&#x2F;
	moveLayerDown: function(index){
		var layerlist=$(&#x27;#layersList&#x27;);
		&#x2F;&#x2F;layerlist.jqxGrid(&#x27;hiderowdetails&#x27;,index);
		&#x2F;&#x2F;var step_value=document.getElementById(&quot;moveLayerStep&quot;+index).value;
		var index2 = layerlist.jqxGrid(&#x27;getselectedrowindex&#x27;);
		var step_value=document.getElementById(&quot;moveLayerStep&quot;).value;
		MakeTimeout(function(i){
			layerSource.records = mygis.Utilities.arrayMove(layerSource.records,i,i+step_value);
			mygis.UI.updateLayerGrid();
			loadMapSequence();
			&#x2F;&#x2F;expandLayerDetails();
		},index2,0);
	},

	&#x2F;**
		Removes a layer from the map
		::TODO:: - display a save notification

		@method mg_removeLayer
		@param {Integer} index The layer index
	*&#x2F;
	mg_removeLayer: function(index){
		var positiveConfirm=function(){
			var layerlist=$(&#x27;#layersList&#x27;);
			&#x2F;&#x2F;layerlist.jqxGrid(&#x27;hiderowdetails&#x27;,index);
			var index2 = layerlist.jqxGrid(&#x27;getselectedrowindex&#x27;);
			layerlist.jqxGrid(&#x27;clearSelection&#x27;);

			MakeTimeout(function(i){
				layerRemovedSource.push(layerSource.records.splice(i,1));
				mygis.UI.resetLayerAvailableActions();
				mygis.UI.updateLayerGrid();
				loadMapSequence();
				&#x2F;&#x2F;expandLayerDetails();
			},index2,0);
		};
		showConfirmationDialog(strings.ConfirmBox.msg_lc_removemap,positiveConfirm);
	},

	&#x2F;**
		Handles the layer grid grouping. Still needs work ::TODO::
		@method layerGrouping
	*&#x2F;
	layerGrouping: function(element){
		var value=element.value;
		if (value==&quot;Name&quot;){
			$(&#x27;#layersList&#x27;).jqxGrid(&#x27;removegroup&#x27;, &#x27;Type&#x27;);
		}else{
			$(&#x27;#layersList&#x27;).jqxGrid(&#x27;addgroup&#x27;, &#x27;Type&#x27;);
		}
	},

	&#x2F;**
		Creates the projection tooltip

		@method setProjectionTip
	*&#x2F;
	setProjectionTip: function(){
		var proj = digimap.getProjection()
		$(&quot;#map_projection_node&quot;).html(proj);
		params = [];
		var msg;
		switch (proj){
			case mygis.Utilities.projections.wgs84:
				msg = mygis.Utilities.format(&quot;Projection: {0}&lt;br&#x2F;&gt;Ellipsoid: {1}&lt;br&#x2F;&gt;Datum: {2}&quot;,&quot;longlat&quot;,&quot;WGS 1984&quot;,&quot;WGS 1984&quot;);

				break;
			case mygis.Utilities.projections.google:
				msg = mygis.Utilities.format(&quot;Projection: {0}&lt;br&#x2F;&gt;Spheroid: {1}&lt;br&#x2F;&gt;Datum: {2}&quot;,&quot;simple mercator&quot;,&quot;WGS 1984&quot;,&quot;WGS 1984&quot;);
				break;
		}
		params.push(msg);
		singleQTip(&#x27;projection&#x27;,params);
	},

	&#x2F;**
	* Stops digitizing, unselecting the related tools and performing various clean-up code.
		@method stopDigitize
	 *&#x2F;
	stopDigitize: function(){

		mygis.UI.clearmygis();
        mygis.UI.clearDrawingMode();
		if (layerCurrentEditing&gt;-1){
			mygis.UI.clearUnsavedLayer();
		}
	},

	&#x2F;**
	* The handler for the right click of an object
	* @param event the right click event
	@method objRClickHandler
	 *&#x2F;
	objRClickHandler: function(event){
		cmenu.close();
		rightClickedObj=this;
		event.pixel=mygis.Utilities.latlngToPoint(digimap, event.latLng,digimap.getZoom());
		current=event;

		&#x2F;&#x2F;inp.value = this.title;

		objcmenu.open(event,&quot;hackMe&quot;);


	},

	&#x2F;**
	* 	Creates a map context menu
	* 	@param caller The caller for the menu (map, map object, etc)
		@method createContextMenu
	 *&#x2F;
	 createContextMenu: function(caller){
		switch(caller){
			case &quot;map&quot;:
				cmenu = new contextMenu($(digiContainer));
				cmenu.add(strings.MapRMenu.zoomin, &#x27;zoomIn&#x27;,
					function(){
						var center = digimap.getLonLatFromLayerPx(new OpenLayers.Pixel(current.layerX,current.layerY));
						digimap.setCenter(center,digimap.getZoom() + 1);
						internalMemory.lastZoom=digimap.getExtent();
						cmenu.close();
				});
				cmenu.add(strings.MapRMenu.zoomout, &#x27;zoomOut&#x27;,
					function(){
						var center = digimap.getLonLatFromLayerPx(new OpenLayers.Pixel(current.layerX,current.layerY));
						digimap.setCenter(center,digimap.getZoom() - 1);
						internalMemory.lastZoom=digimap.getExtent();
						cmenu.close();
				});
				cmenu.add(strings.MapRMenu.center, &#x27;centerHere&#x27;,
					function(){
						var center = digimap.getLonLatFromLayerPx(new OpenLayers.Pixel(current.layerX,current.layerY));
						digimap.setCenter(center);
						internalMemory.lastZoom=digimap.getExtent();
						cmenu.close();
				});
				digimap.div.oncontextmenu = function(event){
					current = event;
					cmenu.open(event);
					return false;
				}
				break;
			case &quot;mapObject&quot;:
				objcmenu = new contextMenu($(digiContainer));

				objcmenu.add(&#x27;&#x27;,&#x27;objectTitleRMenu&#x27;,
					function(){
						if(rightClickedObj.overlaytype==&quot;marker&quot;){
							rightClickedObj.setDraggable(!rightClickedObj.getDraggable());
						}else{
							rightClickedObj.setOptions({editable: !rightClickedObj.getEditable()});
						}
				});

				objcmenu.add(strings.ObjRMenu.edit,&#x27;objR_edit&#x27;,
					function(){
						if(rightClickedObj.overlaytype==&quot;marker&quot;){
							rightClickedObj.setDraggable(!rightClickedObj.getDraggable());
						}else{
							rightClickedObj.setOptions({editable: !rightClickedObj.getEditable()});
						}
				});
				objcmenu.add(strings.ObjRMenu.deleteMe,&#x27;objR_deleteMe&#x27;,
					function(){
						mygis.UI.deleteObject(rightClickedObj);
				});
				objcmenu.add(strings.ObjRMenu.styleMe,&#x27;objR_styleMe&#x27;,
					function(){
						mygis.UI.editObjectStyle(rightClickedObj.overlaytype);
				});
				objcmenu.add(strings.ObjRMenu.zoomin,&#x27;objR_zoomIn&#x27;,
					function(){
						digimap.setCenter(current.latLng);
						digimap.setZoom(digimap.getZoom() + 1);
						objcmenu.close();
				});
				objcmenu.add(strings.ObjRMenu.zoomout,&#x27;objR_zoomOut&#x27;,
					function(){
						digimap.setCenter(current.latLng);
						digimap.setZoom(digimap.getZoom() - 1);
						objcmenu.close();
				});
				objcmenu.add(strings.ObjRMenu.fitBounds,&#x27;objR_fitBounds&#x27;,
					function(){
						digimap.fitBounds(rightClickedObj.bounds);
						objcmenu.close();
				});
				break;
		}
	 },

	&#x2F;**
	@method editObjectStyle
	@deprecated
	*&#x2F;
	editObjectStyle: function(type){
		switch (type){
			case &quot;marker&quot;:
				$(&quot;#markerChooseStyle&quot;).dialog({ modal: true,resizable: false, title: strings.ObjRMenu.styleMe,width: 380}).show();
				break;
			case &quot;polyline&quot;:
				$(&quot;#polylineChooseStyle&quot;).dialog({ modal: true,resizable: false, title: strings.ObjRMenu.styleMe }).show();
				break;
			case &quot;rectangle&quot;:
			case &quot;polygon&quot;:
				$(&quot;#polygonChooseStyle&quot;).dialog({ modal: true,resizable: false, title: strings.ObjRMenu.styleMe }).show();
				break;
		}
	},

	&#x2F;**
		Updates a small preview box to show the new style
		@method selectMarkerStyle
		@param {Boolean} disablePreview If true, does not apply style to map
	*&#x2F;
	selectMarkerStyle: function(disablePreview){
		var sItem = markerStyleList.get_selectedItem();
		var sItemUrl = sItem.get_value();
		if (sItemUrl){
			$(&quot;#markerPreview&quot;).html(&quot;&lt;img style=&#x27;width: 100%; height: 100%;&#x27; src=&#x27;&quot;+sItemUrl+&quot;&#x27; &#x2F;&gt;&quot;);
		}
		if (!disablePreview){
			mygis.UI.previewLayerStyle();
		}
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changeLayerOpacity
	*&#x2F;
	changeLayerOpacity: function(event,ui){
		var curr=ui.value;
		curr = curr*100;
		layerOpacityText.set_value(curr+&quot;%&quot;);
		mygis.UI.previewLayerStyle();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changePointBorder
	*&#x2F;
	changePointBorder: function(event,ui){
		var curr=ui.value;
		pointBorderText.set_value(curr);
		mygis.UI.previewLayerStyle();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changePointOpacity
	*&#x2F;
	changePointOpacity: function(event,ui){
		var curr=ui.value;
		curr = curr*100;
		pointOpacityText.set_value(curr+&quot;%&quot;);
		mygis.UI.previewLayerStyle();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changeMarkerSize
	*&#x2F;
	changeMarkerSize: function(event,ui){
		var curr=ui.value;
		markerSizeText.set_value(curr);
		mygis.UI.previewLayerStyle();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changeLineOpacity
	*&#x2F;
	changeLineOpacity: function(event,ui){
		var curr=ui.value;
		lineOpacityText.set_value(curr);
		mygis.UI.updateLinePreview();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changeLineWeight
	*&#x2F;
	changeLineWeight: function(event,ui){
		var curr=ui.value;
		lineWeightText.set_value(curr);
		mygis.UI.updateLinePreview();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changePolyStrokeOpacity
	*&#x2F;
	changePolyStrokeOpacity: function(event,ui){
		var curr=ui.value;
		polygonStrokeOpacityText.set_value(curr);
		mygis.UI.updatePolyPreview();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changePolyFillOpacity
	*&#x2F;
	changePolyFillOpacity: function(event,ui){
		var curr=ui.value;
		polygonFillOpacityText.set_value(curr);
		mygis.UI.updatePolyPreview();
	},

	&#x2F;**
		Updates the corresponding input box based on the UI slider
		@method changePolyWeight
	*&#x2F;
	changePolyWeight: function(event,ui){
		var curr=ui.value;
		polygonStrokeWeightText.set_value(curr);
		mygis.UI.updatePolyPreview();
	},

	&#x2F;**
		Updates a small preview box to show the new style
		@method updateLinePreview
		@param {Boolean} disablePreview If true, does not apply style to map
	*&#x2F;
	updateLinePreview: function(disablePreview){
		var color=document.getElementById(&quot;polylineStrokeColor&quot;).value;
		var lineOpacity = lineOpacityText.get_value();
		var lineWeight = lineWeightText.get_value();
		$(&quot;#polylinePreview&quot;).css({
			&quot;background-color&quot;:color,
			&quot;opacity&quot;:lineOpacity,
			&#x2F;&#x2F;&quot;height&quot;:lineWeight+&quot;px&quot;,
			&quot;height&quot;:2+&quot;px&quot;,
			&quot;margin-top&quot;:((38-2)&#x2F;2)+&quot;px&quot;,
			&quot;margin-bottom&quot;:((38-2)&#x2F;2)+&quot;px&quot;
		});
		if (!disablePreview){
			mygis.UI.previewLayerStyle();
		}
	},

	&#x2F;**
		Updates a small preview box to show the new style
		@method updatePolyPreview
		@param {Boolean} disablePreview If true, does not apply style to map
	*&#x2F;
	updatePolyPreview: function(disablePreview){
		var strokeColor = document.getElementById(&quot;polygonStrokeColor&quot;).value;
		var fillColor = document.getElementById(&quot;polygonFillColor&quot;).value;
		var strokeOpacity = polygonStrokeOpacityText.get_value();
		var fillOpacity = polygonFillOpacityText.get_value();
		var strokeWidth = polygonStrokeWeightText.get_value();
		var borderColor = mygis.Utilities.hexToRGB(strokeColor);
		fillColor = mygis.Utilities.hexToRGB(fillColor);
		var rgbaString = &quot;rgba(&quot;
							+borderColor[0]+&quot;,&quot;
							+borderColor[1]+&quot;,&quot;
							+borderColor[2]+&quot;,&quot;
							+strokeOpacity+&quot;)&quot;;
		var rgbaString2 = &quot;rgba(&quot;
							+fillColor[0]+&quot;,&quot;
							+fillColor[1]+&quot;,&quot;
							+fillColor[2]+&quot;,&quot;
							+fillOpacity+&quot;)&quot;;
		$(&quot;#polygonPreview&quot;).css({
			&quot;background-color&quot;:rgbaString2,
			&quot;border-color&quot;: rgbaString,
			&#x2F;&#x2F;&quot;border-width&quot;: strokeWidth+&quot;px&quot;
			&quot;border-width&quot;: 5+&quot;px&quot;
		});
		if (!disablePreview){
			mygis.UI.previewLayerStyle();
		}
	},

	&#x2F;**
	@method populateMarkerIcons
	@deprecated
	*&#x2F;
	populateMarkerIcons: function(level,sublevel){
		var listItem;
		var items;
		var err=false;
		markerStyleList.trackChanges();
		$(&quot;#markerPreview&quot;).empty();
		items = markerStyleList.get_items();
		items.clear();
		switch (level)
		{
			case &quot;Default&quot;:

				listItem= new Telerik.Web.UI.RadListBoxItem();
				listItem.set_text(&quot;Default&quot;);
				listItem.set_value(mygis.Drawing.Styling.pointStyle.defaultIcon);
				listItem.set_imageUrl(mygis.Drawing.Styling.pointStyle.defaultIcon);
				items.add(listItem);
				break;
			case &quot;Google&quot;:
				var gurl = &quot;http:&#x2F;&#x2F;maps.google.com&#x2F;mapfiles&#x2F;kml&#x2F;&quot;;
				var folder, filename,finalurl;
				switch (sublevel)
				{
					case &quot;Palette 2&quot;:
						folder = &quot;pal2&#x2F;&quot;;
						break;
					case &quot;Palette 3&quot;:
						folder = &quot;pal3&#x2F;&quot;;
						break;
					case &quot;Palette 4&quot;:
						folder = &quot;pal4&#x2F;&quot;;
						break;
					case &quot;Palette 5&quot;:
						folder = &quot;pal5&#x2F;&quot;;
						break;
				}
				for (var i=0;i&lt;64;i++){
					filename=&quot;icon&quot;+i.toString();
					finalurl = gurl+folder+filename+&quot;.png&quot;;
					listItem= new Telerik.Web.UI.RadListBoxItem();
					listItem.set_text(filename);
					listItem.set_value(finalurl);
					listItem.set_imageUrl(finalurl);
					items.add(listItem);
				}
				break;
			case &quot;My uploads&quot;:
			case &quot;My maps&quot;:
				listItem= new Telerik.Web.UI.RadListBoxItem();
				listItem.set_text(strings.Login.notLoggedIn);
				items.add(listItem);
				err=true;
				break;

		}
		if (items.get_count()&gt;=1 &amp;&amp; !err){
			items.getItem(0).select();
			items.getItem(0).scrollIntoView();
		}
		markerStyleList.commitChanges();
	},

	&#x2F;**
	Updates the UI to use the new point style.
	Called when the point style is based on a font.
	@method setPointFont
	@param {String} charcode A formatted string containing the image coordinates for the selected font.
	@param {Element} elem The element to modify
	*&#x2F;
	setPointFont: function(charcode,elem){
		var coords = charcode.split(&quot;_&quot;);
		var cellvalue = $(&quot;#pointIcons&quot;).jqxGrid(&#x27;getcellvalue&#x27;,coords[0],&quot;_&quot;+coords[1]);
		var fontSelect = document.getElementById(&quot;pointFontFamily&quot;);
		var font = fontSelect.options[fontSelect.selectedIndex].value;
		var pointPreview = $(&quot;#markerPreview&quot;);
		var bgposition = $(elem).css(&#x27;background-position&#x27;);
		pointPreview.empty();
		pointPreview.attr(&quot;class&quot;,font);
		pointPreview.css(&quot;background-position&quot;,bgposition);
		&#x2F;&#x2F;displaySuccess(&quot;code: &quot;+cellvalue);
		document.getElementById(&quot;pointGraphicUrl&quot;).value = &quot;ttf:&#x2F;&#x2F;&quot;+font+&quot;#&quot;+cellvalue;
		mygis.UI.previewLayerStyle();
	},

	&#x2F;**
	Updates the UI to use the new point style.
	Called when the point style is based on existing url.

	@method setPointImg
	@param {String} params A #-separated string containing the layername and the url
	@param {Element} elem
	*&#x2F;
	setPointImg: function(params,elem){
		var parts = params.split(&quot;#&quot;);
		var layername = parts[0];
		var url = parts[1];
		var img = $(&quot;&lt;img &#x2F;&gt;&quot;);
		img.attr(&quot;src&quot;,url);
		img.attr(&quot;class&quot;,&quot;geolink&quot;);
		var pointPreview = $(&quot;#markerPreview&quot;);
		pointPreview.attr(&quot;class&quot;,&quot;&quot;);
		pointPreview.empty();
		pointPreview.append(img);
		document.getElementById(&quot;pointGraphicUrl&quot;).value = url;
		mygis.UI.previewLayerStyle();
	},

	&#x2F;**
	Populates the &quot;choose icon style&quot; grid according to the callingMode
	@method populatePointIcons
	@param {String} callingMode one of &#x27;primitive&#x27;, &#x27;font&#x27;, &#x27;library&#x27;
		-Primitive: Point icon is one of &#x27;circle&#x27;,&#x27;square&#x27; etc
		-Library: Point icon is taken from the MyGIS library ::TODO::
		-Font: Point icon is taken from a system font. Currently only Wingdings supported
	@param {String} params Additional params for the callingMode
	*&#x2F;
	populatePointIcons: function(callingMode,params){
		var mode;
		var colNumber = $(&#x27;#pointColumns&#x27;).jqxNumberInput(&#x27;getDecimal&#x27;);	&#x2F;&#x2F;SET THIS TO SOMETHING ELSE FOR LARGER GRID
		var thegrid = $(&quot;#pointIcons&quot;);
		var pointSource=[];
		var fontSelect = document.getElementById(&quot;pointFontFamily&quot;);
		var font = fontSelect.options[fontSelect.selectedIndex].value;
		var librarySelect = document.getElementById(&quot;pointMyIconFolders&quot;);
		var library = librarySelect.options[librarySelect.selectedIndex].value;
		var renderer;
		switch (callingMode){
			case &quot;primitive&quot;:
				mode=&#x27;image&#x27;;
				break;
			case &quot;font&quot;:
				mode=&#x27;image&#x27;;
				pointSource = buildFontSource(font,colNumber);
				break;
			case &quot;library&quot;:
				mode=&#x27;image&#x27;;
				pointSource = buildLibrarySource(library,colNumber);
				break;
		}
		var imagerenderer=function(row,datafield,value){
			var class1=&quot;&quot;;
			var class2=&quot;&quot;;
			var action=&quot;&quot;;
			var posX,posY;
			var extraStyle=&quot;&quot;;
			switch (callingMode){
				case &quot;primitive&quot;:

					break;
				case &quot;font&quot;:
					class1=&#x27;fontlink&#x27;;
					class2=params;
					action=&quot;mygis.UI.setPointFont(&#x27;&quot;+row.toString()+datafield+&quot;&#x27;,this);return false;&quot;;	&#x2F;&#x2F;setPointFont(&#x27;2_4&#x27;);
					switch(params){
						case &quot;Wingdings&quot;:
							var col=parseInt(datafield.split(&quot;_&quot;)[1]);
							var picrow = parseInt((((row)*colNumber)+col) &#x2F; 16);
							var piccol = (((row)*colNumber)+col)%16;

							posX=(5+(47*piccol))*-1;
							posY=0 +(34*(picrow)*-1);

							break;
					}
					break;
				case &quot;library&quot;:
					class1=&#x27;geolink&#x27;;
					posX=0;
					posY=0;
					if (value){
						var imgsrc=value.split(&quot;#&quot;)[1];
						extraStyle=mygis.Utilities.format(&quot;background-image: url(&#x27;{0}&#x27;);&quot;,imgsrc);
					}
					action=&quot;mygis.UI.setPointImg(&#x27;&quot;+value+&quot;&#x27;,this);return false;&quot;;
					break;
			}
			var returnString = mygis.Utilities.format(
				&#x27;&lt;a href=&quot;#&quot; onclick=&quot;{0}return false;&quot; class=&quot;{1} {2}&quot; style=&quot;background-position: {3}px {4}px;{5}&quot;&gt;&lt;&#x2F;a&gt;&#x27;,
				action,class1,class2,posX,posY,extraStyle
			);
			return returnString;
		};
		renderer = mode==&#x27;image&#x27;?imagerenderer:null;
		var pointgridSource = {
			localdata: pointSource,
			datatype: &#x27;array&#x27;
		};
		var columnArray=[];
		for (var i=1;i&lt;=colNumber;i++){
			var colItem = new Object();
			colItem.text=&quot;&quot;;
			colItem.datafield=&quot;_&quot;+i.toString();
			colItem.width=40;
			colItem.cellsrenderer = renderer;
			columnArray.push(colItem);
		}
		thegrid.jqxGrid({
			source: pointgridSource,
			width: (40*colNumber)+20,
			height: 200,
			autoheight: false,
			theme: &#x27;pk_mg&#x27;,
			enableanimations: true,
			rowdetails: false,
			sortable: true,
			groupable: false,
			showheader: false,
			showgroupsheader: false,
			&#x2F;&#x2F;initrowdetails: initrowdetails,
			editable: false,
			selectionmode: &#x27;singlecell&#x27;,
			columns:columnArray,
			rowsheight: 34
		});
	},

    &#x2F;**
     Toggles editing for map objects
	 @method toggleEditMode
	 @param {Boolean} force_off Ignores the previous state and toggles it off.
     *&#x2F;
    toggleEditMode: function(force_off,params){

		var continueDigi=true;
		var positiveConfirm = function(){
			mygis.Map.createNewLayer(&quot;test&quot;);
			displayNotify(msg_errFeatureNotImplemented);
			continueDigi=false;
			mygis.UI.continueEditMode(continueDigi,params);};

		if (!(layerCurrentEditing&gt;-1)){
			&#x2F;&#x2F;showConfirmationDialog(strings.Editing.noEditingForDigi,positiveConfirm); &#x2F;&#x2F;TODO
			displayError(strings.Editing.noEditingForce);
		}else{
			mygis.UI.continueEditMode(continueDigi,params);
		}

    },

	&#x2F;**
		Continues after toggleEditMode (confirmation window)

		@method continueEditMode
		@param {Boolean} continueDigi True if we want the digitizing to continue. False code (error handling?) is still TODO
		@param {Array} Array of strings. Only 1st object is used, to mark the activated tool.
	**&#x2F;
	continueEditMode: function(continueDigi,params){
		if (continueDigi){
			var valid=false;
			var insertType=layerSource.records[layerCurrentEditing].layerGeomType;
			var activateType=params[0];
			if (insertType==&quot;Mixed&quot; || !insertType){
				valid=true;
			}else{
				switch(true){
					case (insertType==&#x27;Point&#x27; &amp;&amp; activateType==&#x27;marker&#x27;): valid=true; break;
					case (insertType==&#x27;Line&#x27; &amp;&amp; activateType==&#x27;polyline&#x27;): valid=true; break;
					case (insertType==&#x27;Polygon&#x27; &amp;&amp; (activateType==&#x27;polygon&#x27; || activateType==&#x27;rectangle&#x27;)): valid=true;break;
				}
			}
			if (!valid){
				displayError(strings.Editing.wrongLayerType+insertType);
			}else{
				mygis.UI.activateTool(params);
			}
		}
	},

	&#x2F;**
		Pushes a feature from the cosmetic layer to featuresUnsaved and attaches any user-input data to that feature.

		@method cosmeticPush
		@param {Object} feature
	*&#x2F;
    cosmeticPush: function(feature){
		if (featuresUnsaved.length&gt;=1){

			&#x2F;&#x2F;mygis.Drawing.Exporting.attachInfoToFeature();
		}
		featuresUnsaved.push(feature);
		&#x2F;&#x2F;mygis.UI.showEditableInfo();
		mygis.UI.notifyUnsavedLayer(layerCurrentEditing);
	},

	&#x2F;**
	 *	Pops a feature from the cosmetic layer
	 *	@method cosmeticPop
	 *	@param {Object}	feature
	 *&#x2F;
	cosmeticPop: function(feature){
		featuresUnsaved.pop();
		cosmeticLayer.removeFeatures([feature]);
	},

	&#x2F;**
		Flashes a generic save icon, to notify the user that he needs to save
		@method notifyUnsaved
		@deprecated
	*&#x2F;
	notifyUnsaved: function(){
		var elem=document.getElementById(&#x27;mapAction_Save&#x27;);
		elem.ex_RemoveClassName(&#x27;disabled&#x27;);
		clearInterval(saveFlasher);
		saveFlasher = setInterval(function(){
			var elem=document.getElementById(&#x27;mapAction_Save&#x27;);
			if (elem.ex_HasClassName(&#x27;flash&#x27;)){
				elem.ex_RemoveClassName(&#x27;flash&#x27;);
			}else{
				elem.ex_AddClassName(&#x27;flash&#x27;);
			}
		},500);
	},

	&#x2F;**
		Updates the layer grid to show that the layer needs to be saved
		@method notifyUnsavedLayer
		@param {Integer} index The layer index to notify about.
	*&#x2F;
	notifyUnsavedLayer: function(index){
		layerSource.records[index].Savable=true;
		unsavedChanges=true;
		&#x2F;&#x2F;mygis.UI.updateLayerGrid();
	},

	&#x2F;**
		Clears all unsaved objects for the given layer index
		@method clearUnsavedLayer
		@param {Integer} index The layer index to clear
	*&#x2F;
	clearUnsavedLayer: function(index){
		&#x2F;&#x2F;layerSource.records[index].Savable=null;
		unsavedChanges=false;
		featuresUnsaved=[];
		featuresModified = {};
		featuresDeleted = [];

		cosmeticLayer.destroyFeatures();
		layerCurrentEditing=-1;
		&#x2F;&#x2F;mygis.UI.updateLayerGrid();
	},

	&#x2F;**
		Stops the flashing &quot;save&quot; button next to the layer
		@method disableNotifyUnsaved
		@deprecated
	*&#x2F;
	disableNotifyUnsaved: function(){
		var elem=document.getElementById(&#x27;mapAction_Save&#x27;);

		clearInterval(saveFlasher);
		if (elem.ex_HasClassName(&#x27;flash&#x27;)){
			elem.ex_RemoveClassName(&#x27;flash&#x27;);
		}
		elem.ex_AddClassName(&quot;disabled&quot;);
	},

    &#x2F;**
		Resets digitizing tools to &quot;unpressed&quot; state.
		@param exceptme The tool to except from this process
		@method clearmygis
     *&#x2F;
    clearmygis: function(exceptme){
        var object;
        var myname;
        for (var i=0; i&lt;6; i++)
        {
            switch (i)
            {
                case 0:
                    myname = &quot;marker&quot;;
                    break;
                case 1:
                    myname = &quot;polyline&quot;;
                    break;
                case 2:
                    myname = &quot;polygon&quot;;
                    break;
                case 3:
                    myname = &quot;circle&quot;;
                    break;
                case 4:
                    myname = &quot;rectangle&quot;;
                    break;
                case 5:
                    myname = &quot;drive&quot;;
                    break;

            }
            if (myname !=exceptme)
            {
                object = document.getElementById(myname+&quot;Button&quot;);
                if (object){
                    if (object.ex_HasClassName(&quot;btnTool_selected&quot;)){
                    object.ex_RemoveClassName(&quot;btnTool_selected&quot;);
                }
                }
            }
        }
    },

	&#x2F;**
		Deactivates all digitizing controls
		@method clearDrawingMode
	**&#x2F;
    clearDrawingMode: function(){

		for(key in drawControls) {
			var control = drawControls[key];
			control.deactivate();

		}
		&#x2F;&#x2F;mygis.UI.clearUnsavedLayer(layerCurrentEditing);
    },

    &#x2F;**
     * Handles toggling of a map tool
		@param toolname The tool&#x27;s name
		@param object The actual DOM object containing the tool
		@method setTool
     *&#x2F;
    setTool: function(toolname,object){
		var params = [];
		params.push(toolname);
		params.push(object);
        &#x2F;&#x2F;drawingManager.setDrawingMode(null);
        if (object.ex_HasClassName(&quot;btnTool_selected&quot;)){
            object.ex_RemoveClassName(&quot;btnTool_selected&quot;);
            mygis.UI.clearDrawingMode();
        }else{
			mygis.UI.toggleEditMode(true,params);	&#x2F;&#x2F;toggle off editing
        }
    },

	&#x2F;**
	Activates a digitizing tool
	@method activateTool
	@param {String} params The tool to activate
	*&#x2F;
	activateTool: function(params){

		var toolname = params[0];
		var object = params[1];
		
		digimap.removeControl(drawControls[toolname]);
		switch(toolname){
			case &quot;marker&quot;:
				drawControls.marker = new OpenLayers.Control.DrawFeature(cosmeticLayer,
					OpenLayers.Handler.Point,{
						featureAdded: function(feature){
							feature.overlaytype = &quot;marker&quot;;
							mygis.UI.increaseMarkers(feature);
							mygis.Utilities.blockUI();
							var layername = layerSource.records[layerCurrentEditing].layerTABLE;
							$.ajax({
								type: &quot;GET&quot;,
								url: config.mgreq+&quot;?qtype=GetLayerFields&amp;qContents=&quot;+escape(layername.replace(&#x2F; &#x2F;g,&quot;_&quot;)),
								success: function(data){
									
									var datacolumns = mygis.Query.resultLayerDetails(data);
									var newWindow=true;
									mygis.Utilities.unblockUI();
									mygis.Query.popupInfo(datacolumns,layername,newWindow);
								}
							});
						},
						handlerOptions:{
							stopDown:false,
							stopUp: false
						}
					});
				break;
			case &quot;polyline&quot;:
				drawControls.polyline = new OpenLayers.Control.DrawFeature(cosmeticLayer,
					OpenLayers.Handler.Path,{
						featureAdded: function(feature){
							feature.overlaytype = &quot;polyline&quot;;
							mygis.UI.increasePolylines(feature);
						},
						handlerOptions:{
							stopDown:false,
							stopUp: false
						}
					});
				break;
			case &quot;polygon&quot;:
				drawControls.polygon = new OpenLayers.Control.DrawFeature(cosmeticLayer,
					OpenLayers.Handler.Polygon,{
						featureAdded: function(feature){
							feature.overlaytype = &quot;polygon&quot;;
							mygis.UI.increasePolygons(feature);
						},
						handlerOptions:{
							stopDown:false,
							stopUp: false
						}
					});
				break;
			case &quot;rectangle&quot;:
				drawControls.rectangle =  new OpenLayers.Control.DrawFeature(cosmeticLayer,
					OpenLayers.Handler.RegularPolygon, {
						featureAdded: function(feature){
							feature.overlaytype = &quot;rectangle&quot;;
							mygis.UI.increasePolygons(feature);
						},
						handlerOptions:{
							stopDown:false,
							stopUp: false
						}
					});
				break;
		}
		digimap.addControl(drawControls[toolname]);
		var prev=layerCurrentEditing;
		mygis.UI.activateOLControl(drawControls[toolname],object);	&#x2F;&#x2F;this resets any current layer editing, so..
		layerCurrentEditing=prev;	&#x2F;&#x2F;...restore it
		naviControls[&quot;navigation&quot;].activate();
		drawControls[toolname].deactivate();
		drawControls[toolname].activate();
		document.getElementById(&quot;mapContainer&quot;).ex_AddClassName(&quot;digitizeMode&quot;);
	},

    &#x2F;**
     Toggles the main toolbar
	 @method toggleToolbar
	 @deprecated
     *&#x2F;
    toggleToolbar: function(){
        if (!toolbarToggling)
        {
            toolbarToggling = true;
            if ($(&quot;#mapToolbar&quot;).is(&quot;:visible&quot;)){
                &#x2F;&#x2F;$(&quot;#mapToolbar&quot;).hide(&quot;slide&quot;, { direction: &quot;up&quot;}, 1000, function(){toolbarToggling=false;});
				$(&quot;#mapToolbar&quot;).hide();
				toolbarToggling=false;
                document.getElementById(&quot;mapAction_Tools&quot;).setAttribute(&quot;class&quot;, &quot;&quot;);
                document.getElementById(&quot;mapAction_Tools&quot;).setAttribute(&quot;className&quot;, &quot;&quot;);
				showCosmetic(false);&#x2F;&#x2F;toggleRadControl(&#x27;layers&#x27;, &#x27;layersButton&#x27;);
            }else{
                &#x2F;&#x2F;closeToolbars(&quot;mapToolbar&quot;);
				&#x2F;&#x2F;toggleRadControl(&#x27;layers&#x27;, &#x27;layersButton&#x27;);
				showCosmetic(true);
				&#x2F;&#x2F;$(&quot;#mapToolbar&quot;).show(&quot;slide&quot;, { direction: &quot;up&quot; }, 1000, function() { toolbarToggling = false; });
				$(&quot;#mapToolbar&quot;).show();
				toolbarToggling = false;
                document.getElementById(&quot;mapAction_Tools&quot;).setAttribute(&quot;class&quot;, &quot;pressed&quot;);
                document.getElementById(&quot;mapAction_Tools&quot;).setAttribute(&quot;className&quot;, &quot;pressed&quot;);

           }
       }

       return false;
    },

    &#x2F;**
     Toggles the search bar
	 @method toggleToolbar2
	 @deprecated
     *&#x2F;
    toggleToolbar2: function(){
        if (!toolbarToggling)
        {
            toolbarToggling = true;
            var sender = document.getElementById(&quot;toggleToolbar2&quot;);
            if ($(&quot;#searchbar&quot;).is(&quot;:visible&quot;)){
                $(&quot;#searchbar&quot;).hide(&quot;slide&quot;, { direction: &quot;left&quot;}, 1000, function(){toolbarToggling=false;});
                document.getElementById(&quot;toggleToolbar2&quot;).setAttribute(&quot;class&quot;,&quot;pressed&quot;);
                document.getElementById(&quot;toggleToolbar2&quot;).setAttribute(&quot;className&quot;,&quot;pressed&quot;);
            }else{
                &#x2F;&#x2F;closeToolbars(&quot;searchbar&quot;);
                $(&quot;#searchbar&quot;).show(&quot;slide&quot;, { direction: &quot;left&quot;}, 1000, function(){toolbarToggling=false;});
                document.getElementById(&quot;toggleToolbar2&quot;).setAttribute(&quot;class&quot;,&quot;&quot;);
                document.getElementById(&quot;toggleToolbar2&quot;).setAttribute(&quot;className&quot;,&quot;&quot;);

           }
       }
       return false;
    },

    &#x2F;**
     Toggles the misc bar
	 @method toggleToolbar3
	 @deprecated
     *&#x2F;
    toggleToolbar3: function(){
        if (!toolbarToggling)
        {
            toolbarToggling = true;
            var sender = document.getElementById(&quot;toggleToolbar3&quot;);
            if ($(&quot;#miscbar&quot;).is(&quot;:visible&quot;)){
                $(&quot;#miscbar&quot;).hide(&quot;slide&quot;, { direction: &quot;left&quot;}, 1000, function(){toolbarToggling=false;});
                document.getElementById(&quot;toggleToolbar3&quot;).setAttribute(&quot;class&quot;,&quot;pressed&quot;);
                document.getElementById(&quot;toggleToolbar3&quot;).setAttribute(&quot;className&quot;,&quot;pressed&quot;);
            }else{
                &#x2F;&#x2F;closeToolbars(&quot;searchbar&quot;);
                $(&quot;#miscbar&quot;).show(&quot;slide&quot;, { direction: &quot;left&quot;}, 1000, function(){toolbarToggling=false;});
                document.getElementById(&quot;toggleToolbar3&quot;).setAttribute(&quot;class&quot;,&quot;&quot;);
                document.getElementById(&quot;toggleToolbar3&quot;).setAttribute(&quot;className&quot;,&quot;&quot;);

           }
       }
       return false;
    },

    &#x2F;**
     Closes all toolbars
	 @method closeToolbars
     @param {String} exceptme Except this
     *&#x2F;
    closeToolbars: function(exceptme){
        for (var i=0;i&lt;2;i++)
        {
            var barname;
            var btnname = &quot;toggleToolbar&quot; + (i+1).toString();
            switch (i)
            {
                case 0:
                    barname = &quot;mapToolbar&quot;;
                    break;
                case 1:
                    barname = &quot;searchbar&quot;;
                    break;
            }
            if (barname!=exceptme)
            {
                if ($(&quot;#&quot;+barname).is(&quot;:visible&quot;)){
                    $(&quot;#&quot;+barname).hide();
                    document.getElementById(btnname).setAttribute(&quot;class&quot;,&quot;pressed&quot;);
                    document.getElementById(btnname).setAttribute(&quot;className&quot;,&quot;pressed&quot;);
                }
            }
        }
    },

     &#x2F;**
     Increases the marker counter
	 @method increaseMarkers
	 @param {Object} feature The feature to insert
     *&#x2F;
    increaseMarkers: function(feature){
        countMarkers ++;
		mygis.UI.cosmeticPush(feature);
    },

	&#x2F;**
	 *	Decreases the marker counter
	 *	@method decreaseMarkers
	 *	@param {Object} feature The feature to remove
	 *&#x2F;
	decreaseMarkers: function(feature){
		countMarkers --;
		mygis.UI.cosmeticPop(feature);
	},

    &#x2F;**
     Increases the polygon counter
	 @method increasePolygons
	 @param {Object} feature The feature to insert
     *&#x2F;
    increasePolygons: function(feature){
        countPolygons ++;
		mygis.UI.cosmeticPush(feature);

    },

	&#x2F;**
	 *	Decreases the polygon counter
	 *	@method decreasePolygons
	 *	@param {Object} feature The feature to remove
	 *&#x2F;
	decreasePolygons: function(feature){
		countPolygons --;
		mygis.UI.cosmeticPop(feature);
	},

    &#x2F;**
     Increases the polyline counter
	 @method increasePolylines
	 @param {Object} feature The feature to insert
     *&#x2F;
    increasePolylines: function(feature){
        countPolylines ++;
		mygis.UI.cosmeticPush(feature);

    },

	&#x2F;**
	 *	Decreases the polyline counter
	 *	@method decreasePolylines
	 *	@param {Object} feature The feature to remove
	 *&#x2F;
	decreasePolylines: function(feature){
		countPolylines --;
		mygis.UI.cosmeticPop(feature);
	},

	&#x2F;**
		Scales the map according to the scale select element value.

		@method scaleTo
		@param {String} scaleText The manual scaleText (Contains text in the form 1:XXXXX
	**&#x2F;
	scaleTo: function(scaleText){
		var element = document.getElementById(&quot;olScale_wrapper&quot;);
		var previousHandler = element.onchange;
		element.onchange = null;
		element.selectedIndex=0;
		element.onchange = previousHandler;
		var scalevalue = scaleText.substring(scaleText.indexOf(&quot;:&quot;)+1);
		scalevalue = scalevalue.replace(&#x2F;\.&#x2F;g,&#x27;&#x27;);
		digimap.zoomToScale(scalevalue);

	},

	&#x2F;**
	 * Adds stylesheets to the page
	 * @method initializeStyleSheets
	 *&#x2F;
	initializeStyleSheets: function(){
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;jqwidgets&#x2F;styles&#x2F;jqx.base.css&quot;});
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;jqwidgets&#x2F;styles&#x2F;jqx.classic.css&quot;});
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;jqwidgets&#x2F;styles&#x2F;jqx.energyblue.css&quot;});
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;jqwidgets&#x2F;styles&#x2F;jqx.pk_mg.css&quot;});
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;jqwidgets&#x2F;styles&#x2F;jqx.pk_mg_white.css&quot;});
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;jqwidgets&#x2F;styles&#x2F;jqx.pk_mg_jm.css&quot;});
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;css&#x2F;jqxcalendar-overrides.css&quot;});		&#x2F;&#x2F;JK CHANGE - ADD CSS
		&#x2F;&#x2F;mygis.Utilities.add_sheet({url:config.folderPath+&quot;Scripts&#x2F;linkSelect&#x2F;css&#x2F;jquery.linkselect.min.css&quot;});
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;GetAppStyle.ashx&quot;,title:&#x27;myappcust&#x27;});
		mygis.UI.createThemeChooser();
	},

	&#x2F;**
	 * Creates a list with the available published themes
	 * @method createThemeChooser
	 *&#x2F;
	createThemeChooser: function(){
		&#x2F;&#x2F;var customUrl = config.mgreq+&quot;?qtype=GetAvailableThemes&quot;;
		var customUrl = config.folderPath+&quot;mgreq.ashx?qtype=GetAvailableThemes&quot;;
		$.ajax({
					type:&quot;GET&quot;,
					url: customUrl,
					success: function(data){
						try{
							var results = data;
							if (results.length&gt;0){
								var sel = $(&quot;&lt;select &#x2F;&gt;&quot;);
								var dummyOption = $(&quot;&lt;option &#x2F;&gt;&quot;);
								&#x2F;&#x2F;sel.append(dummyOption);
								sel.attr(&quot;id&quot;,&quot;themeChooser&quot;);
								$(&quot;#bottomPane&quot;).append(sel);
								var el = sel[0];
								el.options[0] = new Option(strings.Coding.promptThemeChoose,&#x27;-1&#x27;);
								el.options[0].setAttribute(&quot;class&quot;,&quot;selectPrompt&quot;);
								$.each(results, function () {
									el.options[el.options.length] = new Option(this.name, this.value);
								});
								sel.bind(&quot;change&quot;,mygis.UI.handleThemeChoose);
							}
						}catch(err){}


					}
		});
	},

	&#x2F;**
	 * Switches to the selected theme
	 * @method handleThemeChoose
	 *&#x2F;
	handleThemeChoose: function(){
		var selIndex = parseInt($(&quot;#themeChooser&quot;).val());
		if (selIndex&gt;-1){
			mygis.Utilities.previewCustomization(selIndex);
		}else{
			mygis.Utilities.enableCustomization();
		}
	},

	&#x2F;**
		Creates a new &quot;map preview&quot; in the &quot;Build Search&quot; window

		@method createCriteriaMap
	**&#x2F;
	createCriteriaMap: function(){
		if (!criteriaMap){
			criteriaMap = new OpenLayers.Map(&quot;criteriaMap&quot;,{
				fractionalZoom: true,
				controls: [
					&#x2F;*
					new OpenLayers.Control.Attribution({
						template: &#x27;Copyright MyGIS 2012, ${layers}&#x27;
					}),*&#x2F;
					new OpenLayers.Control.Navigation({
						handleRightClicks: true,
						autoActive:true,
						dragPanOptions: {enableKinetic: false}
					})
				]
			});


			var selectElem = document.getElementById(&quot;criteriaMapBgSelect&quot;);
			var selectBackgrounds = [];
			var arrItem = new Object();
			arrItem[&quot;name&quot;]=strings.Coding.noBackground;
			arrItem[&quot;value&quot;]=&quot;&quot;;
			selectBackgrounds.push(arrItem);
			criteriaMap.countBackgrounds=0;
			for (var i=0;i&lt;digimap.layers.length;i++){
				var item = digimap.layers[i];

				if (item.isBaseLayer){
					var arrItem = new Object();
					arrItem[&quot;name&quot;]=strings.LayerControl.labelBackground+item.name;
					arrItem[&quot;value&quot;]=item.name;
					selectBackgrounds.push(arrItem);
					criteriaMap.addLayer(item.clone());
					criteriaMap.countBackgrounds+=1;
				}
			}
			mygis.Utilities.populateSelect(selectElem,selectBackgrounds,true);
			selectElem.selectedIndex = 1;
			selectElem.onchange = function(){
				var sel=document.getElementById(&quot;criteriaMapBgSelect&quot;);
				if (sel.selectedIndex&gt;0){
					criteriaMap.baseLayer.setVisibility(false);
				    criteriaMap.setBaseLayer(criteriaMap.layers[sel.selectedIndex-1]);
					criteriaMap.baseLayer.setVisibility(true);
				}else{
					criteriaMap.baseLayer.setVisibility(false);
				}
			}

			criteriaMap.setCenter(digimap.getCenter(), digimap.getZoom());
		}
	},

	&#x2F;**
		Updates the map preview in &quot;Build Search&quot; window to display the given layer

		@method updateCriteriaMap
		@param {Element} select The select element containing the layername
	**&#x2F;
	updateCriteriaMap: function(select,layername){
		var changeTo = select.selectedIndex;
		if (lastCritIndex!=changeTo){
			lastCritIndex=changeTo;
			var getTop = wmsHighlight?-2:-1;
			&#x2F;*
			if (criteriaMap.layers.length&gt;criteriaMap.countBackgrounds){

				criteriaMap.layers[criteriaMap.layers.length+getTop].destroy();
			}
			*&#x2F;
			if (changeTo&gt;0){
				var layername = select.options[changeTo].value;
				layername=mygis.Utilities.nameToUnderscore(layername);
				&#x2F;&#x2F;layername = currentAppName+&quot;_&quot;+layername;
				if ((getTop==-2 &amp;&amp; criteriaMap.layers.length&lt;criteriaMap.countBackgrounds+2)||criteriaMap.layers.length==criteriaMap.countBackgrounds){
					var layer = mygis.Map.getMapServerLayer(layername,&quot;&quot;,currentMapMaxExtent);
					criteriaMap.addLayer(layer);
				}else{
					criteriaMap.layers[criteriaMap.layers.length+getTop].mergeNewParams({
						layers:layername
					});
				}
				criteriaMap.layers[criteriaMap.layers.length+getTop].setVisibility(true);
			}else{
				criteriaMap.layers[criteriaMap.layers.length+getTop].setVisibility(false);
			}
		}
	},

	&#x2F;**
		Returns a comma-separated string of layer names contained the &quot;Build Search&quot; window.

		@method getCriteriaLayerString
		@return {String}
	**&#x2F;
	getCriteriaLayerString: function(){
		var fullLayerString=&quot;&quot;;
		var fullLayers=[];
		var layername;
		var searchContainer = $(&quot;#criteriaPanels&quot;);

		var selectArray = searchContainer.find(&quot;.dbTableName&quot;);
		$.each(selectArray,function(i,v){
			if (v.selectedIndex&gt;0){
				layername = v.options[v.selectedIndex].value;
				layername=mygis.Utilities.nameToUnderscore(layername);
				&#x2F;&#x2F;layername = currentAppName+&quot;_&quot;+layername;
				fullLayers.push(layername);
			}
		});
		fullLayerString = fullLayers.join(&quot;,&quot;);
		return fullLayerString;
	},

	&#x2F;**
		Populates a hidden &quot;distinct values&quot; list in the current row (&quot;Build Search&quot; window).

		@method dbPopulateDistinct
		@param {Element} element The calling element
	**&#x2F;
	dbPopulateDistinct: function(element){
		var thisRow = $(element).parent();
		var selectFrom = thisRow.find(&quot;.dbFieldName&quot;)[0];
		var fieldname = selectFrom.options[selectFrom.selectedIndex].value;
		var checkstring = fieldname;
		if (checkstring.substr(checkstring.length-2)==&quot;%s&quot;){
			checkstring = checkstring.split(&quot;%&quot;)[0];
		}

		var tableSelect = thisRow.parent().find(&quot;.dbTableName&quot;)[0];
		var layername = tableSelect.options[tableSelect.selectedIndex].value;
		var selectTo = thisRow.find(&quot;.dbValueDistinct&quot;)[0];
		if (layername &amp;&amp; fieldname){
			var customUrl = config.mgreq+&quot;?qtype=GetLayerDistinct&amp;qContents=&quot;+escape(layername.replace(&#x2F; &#x2F;g,&quot;_&quot;)+&quot;$&quot;+checkstring);
			$.ajax({
					type:&quot;GET&quot;,
					url: customUrl,
					success: function(data){
						var datacolumns = [];
						var row;
						try{
							var realResults = eval(data);
							$.each(realResults,function(index,value){
								row=new Object();
								row[&quot;name&quot;]=value;
								row[&quot;value&quot;]=value;
								datacolumns.push(row);
							});
							mygis.Utilities.populateSelect(selectTo,datacolumns);
							$(selectTo).css({&quot;display&quot;:&quot;inline&quot;});
							thisRow.find(&quot;.dbFieldValue&quot;)[0].value=&quot;&quot;;
						}catch(err){
							displayError(data);
						}
					}
			});
		}
	},

	&#x2F;**
		Fills in the current &quot;where&quot; clause in the &quot;Build Search&quot; window from the hidden &quot;distinct values&quot; list.
		@method dbGetFromDistinct
		@param {Element} element The calling element
	**&#x2F;
	dbGetFromDistinct: function(element){
		var thisRow = $(element).parent();
		thisRow.find(&quot;.dbFieldValue&quot;)[0].value=element.options[element.selectedIndex].value;
	},

	&#x2F;**
		Retrieves column data for the given row in &quot;Build Search&quot; window
		@method dbFieldPopulate
		@param {Element} element The calling element
	**&#x2F;
	dbFieldPopulate: function(element){
		var container = $(&quot;#databaseAnalysis&quot;);
		var tableRow = $(element).parent();
		var currentPanel = tableRow.parent();
		var secondRow = currentPanel.find(&quot;.criteriaSecondRow&quot;);
		var selectTo = secondRow.find(&quot;.dbFieldName&quot;);
		var critButton = tableRow.find(&#x27;.andButton&#x27;)[0];
		if (secondRow.length&gt;1){
			secondRow.slice(1).remove();	&#x2F;&#x2F;remove any additional &quot;where&quot;
		}
		secondRow.find(&quot;.dbValueDistinct&quot;).css({&quot;display&quot;:&quot;none&quot;});
		&#x2F;&#x2F;mygis.UI.updateCriteriaMap(element);
		if (element.selectedIndex&gt;0){
			critButton.ex_RemoveClassName(&#x27;disabled&#x27;);
			var layername = element.options[element.selectedIndex].value;
			&#x2F;&#x2F;mygis.UI.updateCriteriaMap(layername);

			var customUrl = config.mgreq+&quot;?qtype=GetLayerFields&amp;qContents=&quot;+escape(layername.replace(&#x2F; &#x2F;g,&quot;_&quot;));
			$.ajax({
					type:&quot;GET&quot;,
					url: customUrl,
					success: function(data){

						var datacolumns = mygis.Query.resultLayerDetails(data);	&#x2F;&#x2F;[];
						$.each(selectTo,function(i,v){
							mygis.Utilities.populateSelect(v,datacolumns);
						});
					}
			});
		}else{
			critButton.ex_AddClassName(&quot;disabled&quot;);
			secondRow.css({&quot;display&quot;:&quot;none&quot;});
			critButton.ex_RemoveClassName(&quot;pressed&quot;);
		}
	},
	
	dbQueryResults: function(data,queryname,dbQuery){
		mygis.Utilities.unblockUI();
		var response = eval(data);
		if (typeof response==&quot;object&quot;){
			&#x2F;&#x2F;$(&quot;#bottomTabContainer&quot;).jqxTabs(&#x27;select&#x27;,internalConfig.searchTabIndex);
			var qItem = new Object();
			qItem.text=queryname;
			displaySuccess(strings.QBuilder.feed_SearchSuccess+&#x27;&quot;&#x27;+qItem.text+&#x27;&quot;&#x27;);
			qItem.value=-1;
			qItem.isInitialized=true;
			qItem.linkedResults=response;
			qItem.isDBQuery=true;
			qItem.isMapSelect=false;
			querySource.push(qItem);
			mygis.UI.updateQueryList();

			try{$(&quot;#databaseAnalysis&quot;).dialog(&#x27;close&#x27;);}catch(err){}
			var leftList = $(&quot;#infoLeftList&quot;);
			var itemCount = leftList.jqxListBox(&#x27;getItems&#x27;).length;
			var lastSelection = leftList.jqxListBox(&#x27;getItemByValue&#x27;,-999);
			if (lastSelection&amp;&amp;!dbQuery){
				leftList.jqxListBox(&#x27;selectIndex&#x27;,lastSelection.index);
			}else{
				leftList.jqxListBox(&#x27;selectIndex&#x27;,itemCount-1);
			}
			
			mygis.UI.queryResultsRun();
		}else{
			alert(response);
		}
	},

	&#x2F;**
		Routing function that handles buttons in the &quot;Build Search&quot; window.

		@method dbCriteriaClick
	**&#x2F;
	dbCriteriaClick: function(element){
		var container = $(&quot;#criteriaPanels&quot;);
		var containerChildren = container.children();
		var innertext = element.className.split(&quot; &quot;)[0];

		switch (innertext){
			case &quot;bAnd&quot;:
			case &quot;bOr&quot;:
			case &quot;bXor&quot;:
			case &quot;bNot&quot;:
				var actionRow = $(element).parent();
				var prevPressed = actionRow.find(&quot;.pressed&quot;)[0];
				if (prevPressed!=element){
					prevPressed.ex_RemoveClassName(&quot;pressed&quot;);
				}
				element.ex_AddClassName(&quot;pressed&quot;);
				mygis.UI.dbCriteriaUpdateDescription();
				break;
			&#x2F;&#x2F;adds a new panel
			case &quot;addPanel&quot;:
				var actionRow = $(element).parent();
				var currentPanel = actionRow.parent();
				var getACopy = currentPanel.clone(true);
				getACopy.find(&quot;.closePanel&quot;).css({&quot;display&quot;:&quot;inline&quot;});
				&#x2F;&#x2F;remove any additional &quot;Where&quot; rows
				getACopy.find(&quot;.criteriaSecondRow&quot;).slice(1).remove();				
				&#x2F;&#x2F;JK CHANGES - give new id to new panel, its calendar and its button - change the calendar binding and hide the button
				if (window.lines_id.length &lt; 1) {
					window.lines_id=[[0,false,false,false]];
					id=0;}
				else if (window.lines_id!=[[0,false,false,false]]){			
					var id = window.lines_id[window.lines_id.length-1][0]+1;
					window.lines_id.push([id, window.lines_id[id-1][1], window.lines_id[id-1][2], window.lines_id[id-1][3]]);
				}
				getACopy.find(&quot;.criteriaSecondRow&quot;)[0].id = &#x27;second_row_&#x27;+id.toString();
				getACopy.find(&quot;.cal_button&quot;)[0].id = &#x27;cal_button_&#x27;+id.toString();							
				&#x2F;&#x2F;JK CHANGES - END
				&#x2F;&#x2F;reset to initial state
				getACopy.find(&quot;.dbFieldName&quot;)[0].selectedIndex=-1;
				getACopy.find(&quot;.dbFieldOperator&quot;)[0].selectedIndex=-1;
				getACopy.find(&quot;.dbFieldValue&quot;)[0].value=&quot;&quot;;
				getACopy.find(&quot;.dbValueDistinct&quot;).css({&quot;display&quot;:&quot;none&quot;});
				getACopy.find(&quot;.criteriaWrapperLegend&quot;).html(strings.QBuilder.panelTitle);
				container.append(getACopy);
				&#x2F;&#x2F;JK - CHANGES - hide the new calendar
				$(&#x27;#second_row_&#x27;+id.toString()+&#x27;&gt;.cal_button&#x27;).hide()
				&#x2F;&#x2F;JK CHANGES - END
				break;
			case &quot;andButton&quot;:
			&#x2F;&#x2F;duplicates second row
			case &quot;critDuplicate&quot;:
				var actionRow = $(element).parent();
				var currentPanel = actionRow.parent().parent();
				var criteriaRow = $(currentPanel.find(&quot;.criteriaSecondRow&quot;)[0]);				
				var currentIndex = containerChildren.index(currentPanel);
				if (innertext==&quot;andButton&quot; &amp;&amp; !element.ex_HasClassName(&quot;disabled&quot;)){
					if (element.ex_HasClassName(&quot;pressed&quot;)){	&#x2F;&#x2F;if a &quot;where&quot; row has already been added...
						var getACopy = criteriaRow.clone(true);
						&#x2F;&#x2F;JK CHANGES - give new id to new second row, calendar and button, initialize button if valid
						if (window.lines_id.length &lt; 1) {
							window.lines_id=[[0,false,false,false]];
							id=0;}
						else if (window.lines_id!=[[0,false,false,false]]){	
							var id = window.lines_id[window.lines_id.length-1][0]+1;
							window.lines_id.push([id, window.lines_id[id-1][1], window.lines_id[id-1][2], window.lines_id[id-1][3]]);
						}
						getACopy[0].id = &#x27;second_row_&#x27;+id.toString();						
						getACopy.find(&quot;.cal_button&quot;)[0].id = &#x27;cal_button_&#x27;+id.toString();
						&#x2F;&#x2F;JK CHANGES - END
						&#x2F;&#x2F;reset to initial state
						getACopy.find(&quot;.dbFieldName&quot;)[0].selectedIndex=-1;
						getACopy.find(&quot;.dbFieldOperator&quot;)[0].selectedIndex=-1;
						getACopy.find(&quot;.dbFieldValue&quot;)[0].value=&quot;&quot;;
						getACopy.find(&quot;.dbValueDistinct&quot;).css({&quot;display&quot;:&quot;none&quot;});
						getACopy.find(&quot;.criteriaMOD&quot;).css({&quot;display&quot;:&quot;block&quot;});
						getACopy.find(&quot;.critRemove&quot;).css({&quot;display&quot;:&quot;inline&quot;});
						currentPanel.append(getACopy);
						&#x2F;&#x2F;JK - CHANGES - hide the new calendar
						$(&#x27;#second_row_&#x27;+id.toString()+&#x27;&gt;.cal_button&#x27;).hide()						
						&#x2F;&#x2F;JK CHANGES - END
					}else{
						criteriaRow.css({&quot;display&quot;:&quot;block&quot;});
						element.ex_AddClassName(&quot;pressed&quot;);
					}

				}else{
					var thisRow = actionRow.parent();
					var getACopy = thisRow.clone(true);
					&#x2F;&#x2F;JK CHANGES - give new id to new second row, calendar and button
					if (window.lines_id.length &lt; 1) {
							window.lines_id=[[0,false,false,false]];
							id=0;}
					else if (window.lines_id!=[[0,false,false,false]]){
							var id = window.lines_id[window.lines_id.length-1][0]+1;
							window.lines_id.push([id, window.lines_id[id-1][1], window.lines_id[id-1][2], window.lines_id[id-1][3]]);
						}
					getACopy[0].id = &#x27;second_row_&#x27;+id.toString();					
					getACopy.find(&quot;.jqxdatetime&quot;)[0].id = &#x27;datetime_&#x27;+id.toString();
					getACopy.find(&quot;.cal_button&quot;)[0].id = &#x27;cal_button_&#x27;+id.toString();																	
					&#x2F;&#x2F;JK CHANGES - END
					&#x2F;&#x2F;clone doesn&#x27;t clone selectedIndex, so do it manually
					getACopy.find(&quot;.dbFieldName&quot;)[0].selectedIndex=thisRow.find(&quot;.dbFieldName&quot;)[0].selectedIndex;
					getACopy.find(&quot;.dbFieldOperator&quot;)[0].selectedIndex=thisRow.find(&quot;.dbFieldOperator&quot;)[0].selectedIndex;
					getACopy.find(&quot;.criteriaMOD&quot;).css({&quot;display&quot;:&quot;block&quot;});
					getACopy.find(&quot;.dbValueDistinct&quot;).css({&quot;display&quot;:&quot;none&quot;});
					getACopy.find(&quot;.critRemove&quot;).css({&quot;display&quot;:&quot;inline&quot;});					
					getACopy.insertAfter(thisRow);
					&#x2F;&#x2F;JK CHANGES -   re-initialize calendar
					mygis.Utilities.datetime_input_field(document.getElementById(&#x27;second_row_&#x27;+id.toString()));
					&#x2F;&#x2F;JK CHANGES - END
				}
				break;
				
			case &quot;search&quot;:
				var toSend=document.getElementById(&quot;criteriaURL&quot;).value;
				&#x2F;*
				&#x2F;&#x2F;JK CHANGES - fix the query input for dates				
				&#x2F;&#x2F;we will check the toSend string to see if there are matches with the datetime objects, and if so, we modify the string
				&#x2F;&#x2F;so that we will know to fix the query to sql as needed
				&#x2F;&#x2F;to do that, we split the string with the $,%b,# operators that separate input fields and after that we check for datetimes
				&#x2F;&#x2F;the new string is created during the checking process and the &amp;dt&amp; is added just before the date
				&#x2F;&#x2F;this will be interpreted later and passed correctly to the sql
				var newfield=&quot;&quot;;
				var field=toSend.split(&#x27;$&#x27;);				
				for (i=0;i&lt;field.length;i++){field[i] = field[i].split(&#x27;%b&#x27;)};
				for (i=0;i&lt;field.length;i++){for(j=0;j&lt;field[i].length;j++){field[i][j] = field[i][j].split(&#x27;#&#x27;)}};				
				for(i=0;i&lt;window.trigger_calendar.length;i++){
					for (j=0;j&lt;field.length;j++){
						for (k=0;k&lt;field[j].length;k++){
							for (l=0;l&lt;field[j][k].length;l++){
								if(window.trigger_calendar[i][1] == field[j][k][l]){field[j][k][l+2]=&#x27;&amp;dt&amp;&#x27;+field[j][k][l+2]}
								newfield+=field[j][k][l]+&#x27;#&#x27;
							};
							newfield = newfield.slice(0, -1);
							newfield+=&#x27;%b&#x27;;
						};
						newfield = newfield.slice(0, -2);
						newfield+=&#x27;$&#x27;;
					};
					newfield = newfield.slice(0, -1);
				};
				toSend = newfield;
				&#x2F;&#x2F;JK CHANGES - END
				*&#x2F;
				var queryname = document.getElementById(&quot;critFriendlyName&quot;).value;
				if (toSend){
					var myurl = config.mgreq+&quot;?qtype=DirectQuery&amp;qContents=&quot;+escape(toSend);
					mygis.Utilities.blockUI();
					$.ajax({
							type:&quot;GET&quot;,
							url: myurl,
							success: function(data){
								mygis.UI.dbQueryResults(data,queryname,true);
							}
					});
				}else{
					displayError(&quot;No query yet&quot;);
				}
				break;
			&#x2F;&#x2F;removes a panel
			case &quot;closePanel&quot;:
				var addPanel = $(element).parent().parent();				
				&#x2F;&#x2F;remove panel
				addPanel.remove();
				mygis.UI.dbCriteriaUpdateDescription();
				&#x2F;&#x2F;JK CHANGES - remove old id from our array
				var id_to_rm = parseInt(addPanel.find(&quot;.criteriaSecondRow&quot;)[0].id.replace(&quot;second_row_&quot;,&quot;&quot;));
				for (i = 0; i &lt; window.lines_id.length; i++){if(window.lines_id[i][0]==id_to_rm){index=i}}
				window.lines_id.splice(index, 1);
				&#x2F;&#x2F;fix crit-del-error - re-bind buttons and calendars if needed
				for (i=0; i&lt;window.lines_id.length; i++){
				test=[i,true,true,true,1];
				for(j= 0; j&lt;window.lines_id[i].length; j++){if (window.lines_id[i][j]!=test[j]){test[4]=0;}}
				if (test[4] == 1) {mygis.Utilities.datetime_input_field(document.getElementById(&#x27;second_row_&#x27;+i.toString()));}}
				&#x2F;&#x2F;JK CHANGES - END
				break;
			&#x2F;&#x2F;removes crit row
			case &quot;critRemove&quot;:
				var actionRow = $(element).parent().parent();				
				actionRow.remove();
				mygis.UI.dbCriteriaUpdateDescription();
				&#x2F;&#x2F;JK CHANGES - remove old id from our array
				var id_to_rm = parseInt(actionRow[0].id.replace(&quot;second_row_&quot;,&quot;&quot;));
				for (i = 0; i &lt; window.lines_id.length; i++){if (window.lines_id[i][0]==id_to_rm){index=i}}
				window.lines_id.splice(index, 1);
				&#x2F;&#x2F;fix crit-del-error - re-bind buttons and calendars if needed
				for (i=0; i&lt;window.lines_id.length; i++){
				test=[i,true,true,true,1];
				for(j= 0; j&lt;window.lines_id[i].length; j++){if (window.lines_id[i][j]!=test[j]){test[4]=0;}}
				if (test[4] == 1) {mygis.Utilities.datetime_input_field(document.getElementById(&#x27;second_row_&#x27;+i.toString()));}}			
				&#x2F;&#x2F;JK CHANGES - END
				break;
		}
	},

	&#x2F;**
		Resets the &quot;Build Search&quot; window to its initial state

		@method dbCriteriaReset
	**&#x2F;
	dbCriteriaReset: function(){
		var container = $(&quot;#criteriaPanels&quot;);
		var containerChildren = container.children();
		if (containerChildren.length&gt;1){$(&#x27;.cal_button&#x27;).hide();
			containerChildren.slice(1).remove();	&#x2F;&#x2F;remove any additional &quot;panels&quot;
		}
		var topPanel = $(containerChildren[0]);
		var getCriteria = topPanel.find(&quot;.criteriaSecondRow&quot;);
		if (getCriteria.length&gt;1){
			getCriteria.slice(1).remove();	&#x2F;&#x2F;remove any additional &quot;where&quot;
		}

		&#x2F;&#x2F;Reset the second row:
		var secondRow = topPanel.find(&quot;.criteriaSecondRow&quot;);

		&#x2F;&#x2F;do something with mod buttons
		var fieldName = secondRow.find(&quot;.dbFieldName&quot;)[0];
		var fieldOP = secondRow.find(&quot;.dbFieldOperator&quot;)[0];
		var fieldVal = secondRow.find(&quot;.dbFieldValue&quot;)[0];

		fieldVal.value=&quot;&quot;;
		fieldOP.selectedIndex = 0;
		fieldName.selectedIndex =0;
		&#x2F;&#x2F;Fire the &quot;disable&quot; triggers:
		mygis.UI.dbSelectChanged(fieldOP);
		mygis.UI.dbSelectChanged(fieldName);
		secondRow.css({&quot;display&quot;:&quot;none&quot;});

		&#x2F;&#x2F;Reset the first row:
		var firstRow = topPanel.find(&quot;.criteriaFirstRow&quot;);
		var tableSelect = firstRow.find(&quot;.dbTableName&quot;)[0];
		var addCritBtn = firstRow.find(&quot;.andButton&quot;)[0];

		addCritBtn.ex_RemoveClassName(&quot;pressed&quot;);
		tableSelect.selectedIndex = 0;
		mygis.UI.dbFieldPopulate(tableSelect);

		mygis.UI.dbCriteriaUpdateDescription();
		wmsHighlight = null;
		&#x2F;&#x2F;JK CHANGES - reset the flags and clear calendars
		window.trigger_calendar = []
		window.lines_id = [[0,false,false,false]]
		&#x2F;&#x2F;JK CHANGES - END
	},

	&#x2F;**
		Handler for selects change in &quot;Build search&quot; dialog.
		Visual changes only.

		@method dbSelectChanged
		@param {Element} element The calling element
	**&#x2F;
	dbSelectChanged: function(element){
		var secondRow = $(element).parent().parent();
		var innerText = element.className.split(&quot; &quot;)[0];
		var target=&quot;&quot;;
		id = parseInt(secondRow[0].id.replace(&quot;second_row_&quot;,&quot;&quot;));
		switch (innerText){
			case &quot;dbFieldName&quot;:
				target=&quot;.dbFieldOperator&quot;;
				secondRow.find(&quot;.dbValueDistinct&quot;).css({&quot;display&quot;:&quot;none&quot;});

				&#x2F;&#x2F;JK CHANGES - if its a datetime object, create a flag to check later
				for(i=0;i&lt;window.trigger_calendar.length ;i++){
					if(window.trigger_calendar[i][0] == element.selectedIndex){window.lines_id[id][1]=true;}
					else{window.lines_id[id][1]=false;}
				}
				&#x2F;&#x2F;JK CHANGES - END
				break;

			case &quot;dbFieldOperator&quot;:
				target=&quot;.dbFieldValue&quot;;
				&#x2F;&#x2F;JK CHANGES, add the datetime field if needed
				try{
				if(window.lines_id[id][1]==true)
				{
					&#x2F;&#x2F;add calendar later
					window.lines_id[id][2]=true;
				};}
				catch (err){}
				&#x2F;&#x2F;JK CHANGES - END
				break;
		}
		var targetElement = secondRow.find(target)[0];
		if (element.selectedIndex&gt;0){
			$(targetElement).removeAttr(&quot;disabled&quot;);
			&#x2F;&#x2F;JK CHANGES - flag change
			if (innerText == &#x27;dbFieldOperator&#x27;){window.lines_id[id][3]=true;}
			else {window.lines_id[id][2]=true;}
			&#x2F;&#x2F;JK CHANGES - END
		}else{
			$(targetElement).attr(&quot;disabled&quot;,&quot;disabled&quot;);
			&#x2F;&#x2F;JK CHANGES - flag change
			if (innerText == &#x27;dbFieldOperator&#x27;){window.lines_id[id][3]=false;}
			else {window.lines_id[id][2]=false}
			&#x2F;&#x2F;JK CHANGES - END
		}

		&#x2F;&#x2F;JK CHANGES - delete or create, hide and show the calendar and cal button
		try
		{
			&#x2F;&#x2F;if no datetime object was encountered, remove the calendar and its button
			if (window.lines_id[id][1]==false || window.lines_id[id][3] == false){mygis.Utilities.rm_datetime_input_field(secondRow[0]);}
			&#x2F;&#x2F;else, if both fields are ready, create the calendar and show button
			else if (window.lines_id[id][2] == true){mygis.Utilities.datetime_input_field(secondRow[0]);}
		}
		catch(err){}
		&#x2F;&#x2F;JK CHANGES - END

	},

	&#x2F;**
		Updates the &quot;Build Search&quot; description and modifies a hidden input to contain a crafted String.
		Expected value of qUrl at the end:
			TABLE_1
			--OR--
			TABLE_1 $ ... $ TABLE_N
			--OR--
			TABLE_1 # FIELD_1 # OP_1 # VALUE % Q_OP # FIELD_2 # OP_2 # VALUE_2
			--etc--

		@method dbCriteriaUpdateDescription
	**&#x2F;
	dbCriteriaUpdateDescription: function(){
		$(&quot;#critSearchDescription&quot;).empty();
		var resultText=&quot;&quot;;
		var qUrl=&quot;&quot;;
		var panels = $(&quot;#criteriaPanels&quot;).children();
		var queries = [];
		$.each(panels,function(i,singlePanel){
			var panelText = &quot;&quot;;
			var whereText = &quot;&quot;;

			var panelQ = &quot;&quot;;
			var panelQW = &quot;&quot;;

			var atLeastOneWhere = false;
			var selectedTable = $(singlePanel).find(&quot;.dbTableName&quot;)[0];
			if (selectedTable.selectedIndex&gt;0){
				panelText += &quot;&lt;span class=&#x27;sqlKeyword&#x27;&gt;&quot;;
				panelText += strings.QBuilder.keywordSELECT;	&#x2F;&#x2F; &quot;SHOW&quot;;
				panelText += &quot;&lt;&#x2F;span&gt;&quot;;
				panelText += mygis.Utilities.format(&quot; {0} &quot;,strings.QBuilder.keywordALL); &#x2F;&#x2F;&quot; ALL &quot;;
				panelText += &quot;&lt;span class=&#x27;sqlKeyword&#x27;&gt;&quot;;
				panelText += mygis.Utilities.format(&quot;{0} &quot;,strings.QBuilder.keywordFROM);	&#x2F;&#x2F;&quot;FROM &quot;;
				panelText += &quot;&lt;&#x2F;span&gt;&quot;;
				panelText += selectedTable.options[selectedTable.selectedIndex].text;
				&#x2F;&#x2F;panelQ += currentAppName+&quot;_&quot;+mygis.Utilities.nameToUnderscore(selectedTable.options[selectedTable.selectedIndex].value);	&#x2F;&#x2F;GET TABLE
				panelQ += mygis.Utilities.nameToUnderscore(selectedTable.options[selectedTable.selectedIndex].value);	&#x2F;&#x2F;GET TABLE

				var whereClauses = $(singlePanel).find(&quot;.criteriaSecondRow&quot;);
				$.each(whereClauses,function(j,singleWhere){

					var fieldName = $(singleWhere).find(&quot;.dbFieldName&quot;)[0];
					var fieldOp = $(singleWhere).find(&quot;.dbFieldOperator&quot;)[0];
					var fieldValue = $(singleWhere).find(&quot;.dbFieldValue&quot;)[0];
					if (fieldName.selectedIndex &gt; 0 &amp;&amp; fieldOp.selectedIndex &gt; 0 &amp;&amp; fieldValue.value != &quot;&quot;){
						if (j&gt;0 &amp;&amp; atLeastOneWhere){	&#x2F;&#x2F;we need to add MOD clause
							var fieldMOD = $(singleWhere).find(&quot;.criteriaMOD&quot;).find(&quot;.pressed&quot;)[0];
							var fieldMODtext = $(fieldMOD).html();
							var fieldMODvalue = fieldMOD.className.split(&quot; &quot;)[0];
							whereText += &quot;&lt;span class=&#x27;sqlKeyword&#x27;&gt;&quot;;
							whereText += fieldMODtext + &quot; &quot;;
							whereText +=&quot;&lt;&#x2F;span&gt;&quot;;
							panelQW += &quot;%&quot;+fieldMODvalue;	&#x2F;&#x2F;GET MOD
						}
						if (!atLeastOneWhere){
							whereText += &quot;&lt;span class=&#x27;sqlKeyword&#x27;&gt;&quot;;
							whereText += mygis.Utilities.format(&quot;{0} &quot;,strings.QBuilder.keywordWHERE); &#x2F;&#x2F;&quot;WHERE &quot;;
							whereText +=&quot;&lt;&#x2F;span&gt;&quot;;
							atLeastOneWhere = true;
						}
						whereText += fieldName.options[fieldName.selectedIndex].text;
						whereText += &quot; &quot;;
						whereText += &quot;&lt;span class=&#x27;sqlKeyword&#x27;&gt;&quot;;
						whereText += fieldOp.options[fieldOp.selectedIndex].text;
						whereText +=&quot;&lt;&#x2F;span&gt;&quot;;
						whereText += &quot; &quot;;
						whereText += &quot;&lt;span class=&#x27;sqlValue&#x27;&gt;&quot;;
						whereText += fieldValue.value;
						whereText +=&quot;&lt;&#x2F;span&gt;&quot;;
						whereText += &quot; &quot;;

						var formattedInput;
						var formattedField;
						var checkstring = fieldName.options[fieldName.selectedIndex].value;
						if (checkstring.substr(checkstring.length-2)==&quot;%s&quot; &amp;&amp; checkstring[0]!=&quot;\&quot;&quot; &amp;&amp; checkstring[checkstring.length-1]!=&quot;\&quot;&quot;){
							formattedInput = mygis.Utilities.format(&quot;\&quot;{0}\&quot;&quot;,fieldValue.value);
						}else{
							formattedInput=fieldValue.value;
						}
						if (checkstring.substr(checkstring.length-2)==&quot;%s&quot;){
							formattedField=checkstring.split(&quot;%&quot;)[0];
						}else{
							formattedField=checkstring;
						}

						panelQW += mygis.Utilities.format(&quot;#{0}#{1}#{2}&quot;,
								formattedField,
								fieldOp.options[fieldOp.selectedIndex].value,
								formattedInput
								);
					}
				});
				if (atLeastOneWhere){
					panelText += &quot; &quot;+whereText;

					panelQ += panelQW;
				}
			}
			if (panelText){
				if (resultText){
					resultText += &quot;&lt;br &#x2F;&gt;&quot;;
					resultText += &quot;&lt;span class=&#x27;sqlKeyword&#x27;&gt;&quot;;
					resultText += strings.QBuilder.keywordALSO;	&#x2F;&#x2F;&quot;ALSO&quot;;
					resultText += &quot;&lt;&#x2F;span&gt;&quot;;
					resultText += &quot;&lt;br &#x2F;&gt;&quot;;

					qUrl += &quot;$&quot;;
				}
				resultText += panelText;
				qUrl += panelQ;
				queries.push(panelQ);
			}
		});
		if (resultText){
			document.getElementById(&quot;criteriaURL&quot;).value=qUrl;
			$(&quot;#critSearchDescription&quot;).html(resultText);
			&#x2F;&#x2F;mygis.Query.highlightAll(queries);	&#x2F;&#x2F;BUG WITH STRING VALUES
		}
	},

	&#x2F;**
		Handler for the row selection in grids (#infoAnalysis)
		Used to only select a single row.

		@method dbResultsSelect
		@param {Element} The calling element
	**&#x2F;
	dbResultsSelect: function(element){
		var tab=$(element).parent().parent().parent();
		var grid=$(tab.find(&quot;.jqx-grid&quot;)[0]);
		var alreadySelected = grid.jqxGrid(&#x27;selectedrowindexes&#x27;);
		var gridLength = grid.jqxGrid(&#x27;source&#x27;).records.length;
		var on = alreadySelected.length&lt;gridLength;
		if (on){

			grid.unbind(&#x27;rowclick&#x27;);
			for (var i=0;i&lt;gridLength;i++){
				if (alreadySelected.indexOf(i)==-1)
					grid.jqxGrid(&#x27;selectrow&#x27;,i);
			}
			grid.bind(&#x27;rowclick&#x27;,infoGridRowClick);
			$(element).html(strings.Info.btnSelectNone);
		}else{
			grid.jqxGrid(&#x27;clearselection&#x27;);
			$(element).html(strings.Info.btnSelectAll);
		}
	},

	&#x2F;**
		Handler for the &quot;Results on Map&quot; button in #infoAnalysis.
		Highlights the grid&#x27;s selected features on the map

		@method dbResultsOnMap
		@param {Element} the calling element
	**&#x2F;
	dbResultsOnMap: function(element){
		var tab=$(element).parent().parent().parent();
		var grid=$(tab.find(&quot;.jqx-grid&quot;)[0]);
		var gridName = grid.data(&#x27;gridTableName&#x27;).trim();
		var alreadySelected = grid.jqxGrid(&#x27;selectedrowindexes&#x27;);
		var resultString=&quot;&quot;;
		gridName = mygis.Utilities.nameToUnderscore(gridName);
		&#x2F;&#x2F;gridName = currentAppName+&quot;_&quot;+gridName;
		var count=0;
		resultString = gridName+&quot;#&quot;;
		for (var i=0;i&lt;alreadySelected.length;i++){
			count +=1;
			if (count&gt;1){
				resultString +=&quot;%bOr#&quot;;
			}
			var item=grid.jqxGrid(&#x27;getrowdata&#x27;,alreadySelected[i]);
			resultString += mygis.Utilities.format(&quot;OID#EQ#{0}&quot;,item.OID);
		}
		if (resultString[resultString.length-1]!=&quot;#&quot;){
			mygis.Query.highlightSelection([resultString]);
			$(&quot;#infoAnalysis&quot;).dialog(&#x27;close&#x27;);
		}else{
			displayError(strings.Info.err_AtLeastOne);
		}
	},

	&#x2F;**
		Shows the &quot;exportMapAs&quot; dialog

		@method showExportMap
		@param {Element} elem
	**&#x2F;
	showExportMap: function(elem){
		$(&quot;#exportMapAs&quot;).dialog({width: 450,resizable: false});
	},


	&#x2F;**
		Checks the response after saving and either displays an error message or refresh the layer control.

		@method saveDigiResults
		@param {Object} The response received
	**&#x2F;
	saveDigiResults: function(response){
		var responseParts =response.split(&quot;$&quot;);
		var responseType = responseParts[0];
		var responseMessage = responseParts[1];
		switch (responseType)
		{
			case &quot;success&quot;:
				displaySuccess(responseMessage);
				mygis.UI.clearUnsavedLayer(layerCurrentEditing);
				digimap.layers[1].redraw(true);
				mygis.UI.activateControl(&#x27;drag&#x27;);
				mygis.Utilities.nudgeMap();
				if (Sys.Services.AuthenticationService.get_isLoggedIn()){
					mygis.User.Hooks.loadUserLayerRights();
				};
				break;
			case &quot;error&quot;:
				displayError(responseMessage);
				break;
		}

	},

	&#x2F;**
		Gets the current map&#x27;s scale and applies it to an input contained in the same &quot;parent&quot; as the calling element.

		@method getMgScale
		@param {Element} element The calling element
	**&#x2F;
	getMgScale: function(element){
		var currentScale = Math.round(digimap.getScale());
		var container=$(element).parent();
		container.find(&quot;input&quot;)[0].value=mygis.Utilities.addCommas(currentScale);
	},

	&#x2F;**
	 * Resets the loading feedback div
	 * @method resetLoadFeedback
	 *&#x2F;
	resetLoadFeedback: function(){
		$(&quot;#mygis_loadFeedback&quot;).empty();
	},

	&#x2F;**
	 * Appends text to the loading feedback div
	 * @method feedback
	 * @param {String} text The text to append
	 *&#x2F;
	feedback: function(text,error){
		var elem = $(mygis.Utilities.format(&quot;&lt;p&gt;{0}&lt;&#x2F;p&gt;&quot;,text));
		var feedCont = $(&quot;#mygis_loadFeedback&quot;);
		var feedChildren = feedCont.children();
		var completed = error?&quot;cross&quot;:&quot;checked&quot;;
		if (feedChildren.length&gt;0){
			$(feedChildren[feedChildren.length-1]).attr(&quot;class&quot;,completed);
		}
		feedCont.append(elem);
		feedCont.scrollTo(elem);


	},

	&#x2F;**
	 * Toggles the actively displayed list
	 * @method toggleActiveList
	 * @param {Integer} index The triggering tab index
	 *&#x2F;
	toggleActiveList: function(index){
		if (index!=0){
			$.each($(&quot;#sidePanel .subPanel&quot;),function(i,v){
				v.ex_RemoveClassName(&quot;active&quot;);
			});
		}
		switch (index){
			case internalConfig.mapTabIndex:
				$(&quot;#mapsAnalysis&quot;)[0].ex_AddClassName(&quot;active&quot;);
				$(&quot;#mapsList&quot;).jqxListBox(&#x27;width&#x27;,243);
				$(&quot;#mapsList&quot;).jqxListBox(&#x27;width&#x27;,244);
				break;
			case internalConfig.layerTabIndex:
				$(&quot;#layersAnalysis&quot;)[0].ex_AddClassName(&quot;active&quot;);
				break;
			case internalConfig.searchTabIndex:
				$(&quot;#objectsAnalysis&quot;)[0].ex_AddClassName(&quot;active&quot;);
				break;
		}
		fixLayerList();
	},

	&#x2F;**
	 * Toggles the available buttons for layer list, according to selection
	 * @method toggleLayerAvailableActions
	 *&#x2F;
	toggleLayerAvailableActions: function(){
		var layerlist=$(&#x27;#layersList&#x27;);
		var selection = layerlist.jqxGrid(&#x27;getselectedrowindexes&#x27;);
		mygis.UI.resetLayerAvailableActions();
		if (selection.length&gt;1){
			document.getElementById(&quot;btnLayer_Remove&quot;).ex_RemoveClassName(&quot;disabled&quot;);
		}else if(selection.length==1){
			document.getElementById(&quot;btnLayer_Remove&quot;).ex_RemoveClassName(&quot;disabled&quot;);
			document.getElementById(&quot;btnLayer_Up&quot;).ex_RemoveClassName(&quot;disabled&quot;);
			document.getElementById(&quot;btnLayer_Down&quot;).ex_RemoveClassName(&quot;disabled&quot;);
			document.getElementById(&quot;btnLayer_ZoomFull&quot;).ex_RemoveClassName(&quot;disabled&quot;);
			document.getElementById(&quot;btnLayer_ViewMetaData&quot;).ex_RemoveClassName(&quot;disabled&quot;);
			document.getElementById(&quot;btnLayer_EditStyle&quot;).ex_RemoveClassName(&quot;disabled&quot;);
		}
	},

	&#x2F;**
	 * Resets the layer available actions to their initial state
	 * @method resetLayerAvailableActions
	 *&#x2F;
	resetLayerAvailableActions: function(){
		var hasRemoved = layerRemovedSource.length&gt;0;
		if (!Sys.Services.AuthenticationService.get_isLoggedIn()){
			document.getElementById(&quot;btnLayer_New&quot;).ex_AddClassName(&quot;disabled&quot;);
		}else{
			document.getElementById(&quot;btnLayer_New&quot;).ex_RemoveClassName(&quot;disabled&quot;);
		}
		if (!hasRemoved){
			document.getElementById(&quot;btnLayer_Add&quot;).ex_AddClassName(&quot;disabled&quot;);
		}else{
			document.getElementById(&quot;btnLayer_Add&quot;).ex_RemoveClassName(&quot;disabled&quot;);
		}
		document.getElementById(&quot;btnLayer_Up&quot;).ex_AddClassName(&quot;disabled&quot;);
		document.getElementById(&quot;btnLayer_Down&quot;).ex_AddClassName(&quot;disabled&quot;);
		document.getElementById(&quot;btnLayer_Remove&quot;).ex_AddClassName(&quot;disabled&quot;);
		document.getElementById(&quot;btnLayer_ZoomFull&quot;).ex_AddClassName(&quot;disabled&quot;);
		document.getElementById(&quot;btnLayer_ViewMetaData&quot;).ex_AddClassName(&quot;disabled&quot;);
		document.getElementById(&quot;btnLayer_EditStyle&quot;).ex_AddClassName(&quot;disabled&quot;);
	},

	&#x2F;**
	 * Toggles the available buttons for search list, according to selection
	 * @method toggleSearchAvailableActions
	 *&#x2F;
	toggleSearchAvailableActions: function(){
		var searchList=$(&#x27;#infoLeftList&#x27;);
		mygis.UI.resetSearchAvailableActions();
		var item = searchList.jqxListBox(&#x27;getSelectedItem&#x27;);
		if (item){
			document.getElementById(&quot;btnPlaySearch&quot;).ex_RemoveClassName(&quot;disabled&quot;);
			document.getElementById(&quot;btnRemoveSearch&quot;).ex_RemoveClassName(&quot;disabled&quot;);
		}
	},

	&#x2F;**
	 * Resets the search available actions to their initial state
	 * @method resetSearchAvailableActions
	 *&#x2F;
	resetSearchAvailableActions: function(){
		document.getElementById(&quot;btnPlaySearch&quot;).ex_AddClassName(&quot;disabled&quot;);
		document.getElementById(&quot;btnRemoveSearch&quot;).ex_AddClassName(&quot;disabled&quot;);
	}
};


&#x2F;&#x2F; END of mygis.UI

&#x2F;**
	Contains methods to handle direct DB searches.

	@class mygis.Query
	@static
**&#x2F;
mygis.Query = {

	&#x2F;**
		Highlights the given layer based on the queryArray

		@method highlightSelection
		@param {Array} queryArray An array containing the encoded &quot;query&quot; for the features to search.
		@param {String} [manualSLD] If specified, applies that SLD instead of the query one.
	**&#x2F;
	highlightSelection: function(queryArray,manualSLD){
		var sld;
		if (manualSLD){
			&#x2F;&#x2F;sld = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#x27;+manualSLD.replace(&#x2F;#&#x2F;g,&quot;%23&quot;);
			sld = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#x27;+manualSLD;
		}else{
			sld = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#x27;+mygis.Query.getSLDBody(queryArray).replace(&#x2F;#&#x2F;g,&quot;%23&quot;);
		}
		sld= sld.replace(&#x2F;Wingdings%23&#x2F;g,&quot;Wingdings#&quot;);
		var wms_url=config.mapserver+&quot;wms&quot;;
		if (!selectionWMSLayer){
			selectionWMSLayer= new OpenLayers.Layer.WMS(
						&quot;HighlightWMS&quot;,
						wms_url,
						{
							&#x2F;&#x2F;map:currentMapPath,
							&#x27;format&#x27;:&#x27;png&#x27;,
							EXCEPTIONS:&#x27;BLANK&#x27;,
							&#x2F;&#x2F;CRS:&#x27;EPSG:4326&#x27;,&#x2F;&#x2F;CRS:&#x27;EPSG:4121&#x27;,
							FORMAT:&#x27;image&#x2F;png&#x27;,
							transparent: true,
							sld_body: sld
						},
						{
							&#x27;visibility&#x27;: true,
							&#x27;isBaseLayer&#x27;: false,
							&#x27;alpha&#x27;:true
							,singleTile:false,ratio: 1
						}
			);
			digimap.addLayer(selectionWMSLayer);
		}else{
			selectionWMSLayer.mergeNewParams({
				sld_body: sld
			});
		}
		if (!selectionFlasher.timer &amp;&amp; !manualSLD &amp;&amp;selectionWMSLayer){
			selectionFlasher.count=0;
			selectionFlasher.timer = setInterval(function(){
				selectionFlasher.count+=1;
				if (selectionFlasher.count&gt;10){
					clearInterval(selectionFlasher.timer);
					selectionFlasher.timer=null;
				}else{
					selectionWMSLayer.setVisibility(!selectionWMSLayer.getVisibility());
				}

			},500);
		}

	},
	
	queryWithinWindow: function(){
		$(&quot;#layerWithinSelectionListCont&quot;).toggle();
		try{
			$(&quot;#statsAnalysis&quot;).dialog(&#x27;close&#x27;);
		}catch(err){}
	},
	
	getLayersWithin: function(){
		var results=[];
		var items=$(&quot;#layerWithinSelectionList&quot;).jqxListBox(&#x27;getCheckedItems&#x27;);
		$.each(items,function(x,item){
			results.push(item.value);
		});
		return results;
	},
	
	getRowPK: function(row){
		var retvalue=null;
		$.each(row.Cells,function(x,cell){
			if (cell.ColumnName==&quot;OID&quot;){
				retvalue=cell.Value;
			}
		});
		return retvalue;
	},
	
	getLayersOutside: function(){
		var results=[];
		var dataSource=$(&quot;#queryExpanders&quot;).data(&quot;querySource&quot;).originalItem.linkedResults;
		var isMapQuery=dataSource.layers;
		if (isMapQuery){	&#x2F;&#x2F;it&#x27;s a map query
			$.each(dataSource.layers,function(x,lname){
				var ins={
					layer: lname,
					ids: []
				}
				$.each(dataSource.features,function(y,feat){
					var featLayer= feat.fid.split(&quot;.&quot;)[0];
					if (lname==featLayer){
						ins.ids.push(feat.data.OID);
					}
				});
				results.push(ins);
			});
		}else{
			var ins;
			for (var i = 0; i &lt; dataSource.length; i++) {
				var item = dataSource[i];
				ins={
					layer: item.TableName,
					ids: []
				}
				$.each(item.Rows,function(x, row){
					ins.ids.push(mygis.Query.getRowPK(row));
				});
				results.push(ins);
			}
		}
		return results;
	},
	
	queryWithinExecute: function(){
		
		var data = {
			layersFrom: mygis.Query.getLayersOutside(),
			layersSearch: mygis.Query.getLayersWithin()
		};
		var myurl = config.mgreq+&quot;?qtype=QueryWithin&amp;qContents=&quot;;
		var myDate = new Date().toString(&quot;hh:mm:ss&quot;);
		var friendlyName = strings.QBuilder.friendlyNameDef+myDate;
		$(&quot;#layerWithinSelectionListCont&quot;).hide();
		mygis.Utilities.blockUI();
		$.ajax({
			type:&quot;POST&quot;,
			url: myurl,
			data: JSON.stringify(data),
			success: function(data){
				mygis.UI.dbQueryResults(data,friendlyName,true);
			}
		});
	},
	
	queryStatsWindow: function(){
		if ($(&quot;#statsAnalysis&quot;).children().length==0){
			loadFragment(&quot;statsAnalysis&quot;,mygis.Query.queryStatsShow);
		}else{
			mygis.Query.queryStatsShow(true);
		}
		
	},
	
	queryStatsPrint: function(){
		var model = new mygis.Printing.models.printModel();
		$.each($(&quot;#statsResultCont .result&quot;),function(x,result){
			var tableCells =  $(result).find(&quot;table tr td&quot;);
			var newRow={
				header: $($(result).find(&quot;.fieldName&quot;)[0]).html(),
				subheader: $($(result).find(&quot;.fieldName.sub&quot;)[0]).html(),
				sumValue: $(tableCells[0]).html(),
				minValue: $(tableCells[1]).html(),
				maxValue: $(tableCells[2]).html(),
				avgValue: $(tableCells[3]).html()
			}
			model.results.push(newRow);
		});
		mygis.Printing.printWindow(&#x27;stats&#x27;,model);
	},
	
	queryStatsShow: function(secondRun){
		$(&quot;#layerWithinSelectionListCont&quot;).hide();
		var target = $(&quot;#panel3Out&quot;);
		$(&quot;#statsAnalysis&quot;).dialog({
			modal: false,
			resizable: false,
			width: 900,
			height: 510, 
			position: {
				my: &#x27;right top&#x27;,
				at: &#x27;left top&#x27;,
				of: target
			},
			dialogClass: &#x27;queryStatsWindowPopup&#x27;,
			title: strings.QBuilder.statsTitle,
			open: function(){
				$(&#x27;#statsCont&#x27;).layout({
					south__size: 430
					,south__resizable: false
					,south__closable:false
					,applyDefaultStyles: true
				});
				mygis.Query.statsActions=$(&#x27;#statsActions&#x27;).layout({
					east__size:      900
					,east__resizable: false
					,east__closable:false
					,east__initHidden: true
					,	spacing_open: 0
					,	spacing_closed: 0
				});
				$(&#x27;#statsCriteria&#x27;).layout({
					east__size:      430
					,east__resizable: false
					,east__closable:false
					,	spacing_open: 0
					,	spacing_closed: 0
				});
				mygis.Query.statsBackToSelection();
				try{
					$(&quot;#statsFieldList&quot;).jqxListBox(&#x27;clear&#x27;);
				}catch(err){}
				mygis.Query.buildStatSource();
			}
		});
	},
	
	buildStatSource: function(){
		var dataSource=$(&quot;#queryExpanders&quot;).data(&quot;querySource&quot;).originalItem.linkedResults;
		var source=new Array();
		var isMapQuery=dataSource.layers;
		if (isMapQuery){	&#x2F;&#x2F;it&#x27;s a map query
			for (var ind in dataSource.layers){
				try{
				var row = {};
				var layer = dataSource.layers[ind];
				row[&quot;name&quot;]=layer;
				row[&quot;value&quot;]=mygis.Utilities.getFriendlyName(layer);
				row[&quot;ids&quot;]=[];
				var count=0;
				var titles=&quot;&quot;;
				$.each(dataSource.features,function(y,feat){
					var featLayer= feat.fid.split(&quot;.&quot;)[0];
					if (layer==featLayer){
						var firstField=$.keys(feat.data)[0];
						if (titles){
							titles+=&quot;, &quot;;
						}
						titles+=feat.data[firstField];
						row.ids.push(layer+&quot;.&quot;+feat.data.OID);
						count++;
					}
				});
				&#x2F;&#x2F;row[&quot;flavorName&quot;]=mygis.Utilities.getFriendlyName(layer)+&quot; (&quot;+count+&quot;)&quot;;
				row[&quot;flavorName&quot;]=mygis.Utilities.getFriendlyName(layer)+&quot; (&quot;+titles+&quot;)&quot;;
				if (row.ids.length&gt;0){
					source.push(row);
				}
				}catch(err){}
			}
		}else{	&#x2F;&#x2F;it&#x27;s a db query
			for (var i = 0; i &lt; dataSource.length; i++) {
				try{
				var item = dataSource[i];
				if (item.Rows.length&gt;0){
					var row = {};
					row[&quot;name&quot;]=item.TableName;
					row[&quot;value&quot;]=mygis.Utilities.getFriendlyName(item.TableName);
					row[&quot;ids&quot;]=[];
					row[&quot;flavorName&quot;]=mygis.Utilities.getFriendlyName(item.TableName)+&quot; (&quot;+item.Rows.length+&quot;)&quot;;
					$.each(item.Rows,function(x, myrow){
						row.ids.push(item.TableName+&quot;.&quot;+mygis.Query.getRowPK(myrow));
					});
					source.push(row);
				}
				}catch(err){}
			}
		}
		var listbox=$(&quot;#statsLayerList&quot;);
		listbox.jqxListBox({
			width: &#x27;100%&#x27;, 
			source: source, 
			checkboxes: true, 
			height: &#x27;100%&#x27;
		});
		listbox.on(&#x27;checkChange&#x27;,function(event){
			var args=event.args;
			mygis.Query.statsClearFields();
			var fieldList={};
			var checkedItems = listbox.jqxListBox(&#x27;getCheckedItems&#x27;);
			var firstItem=true;
			var dataSource = $(&quot;#queryExpanders&quot;).data(&quot;querySource&quot;).originalItem.linkedResults;
			var isMapQuery=dataSource.layers;
			if (isMapQuery){
				var layers=&quot;&quot;;
				$.each(checkedItems,function(x,item){
					if (layers.length&gt;0){
						layers+=&quot;,&quot;
					}
					layers+=item.originalItem.name;
				});
				if (layers.length&gt;0){
					OpenLayers.Request.GET({
						url: config.mapserver+&quot;wfs?service=wfs&amp;version=1.1.0&amp;request=DescribeFeatureType&amp;typeName=&quot;+layers,
						success: function(data){
							var results = mygis.Query.getWFSAttributes(data);
							var firstItem=true;
							$.each(results,function(x,item){
								var newList=[];
								var result=this;
								$.each(item.fields,function(y,field){
									if (!mygis.Utilities.isUnwantedField(field.Name)){
										var compatibleType=&quot;&quot;;
										var wanted=false;
										switch (field.DataType){
											case &quot;int&quot;:
												compatibleType=&quot;System.Int32&quot;;
												wanted=true;
												break;
											case &quot;double&quot;:
												compatibleType=&quot;System.Double&quot;;
												wanted=true;
												break;
											case &quot;string&quot;:
												compatibleType=&quot;System.String&quot;;
												break;
										}
										if (firstItem &amp;&amp; wanted){
											if (fieldList[field.Name]){
												fieldList[field.Name].layerName+=&quot;#&quot;+result.layerName;
												console.log(field.Name+&#x27; relogged, layerName: &#x27;+fieldList[field.Name].layerName);
											}else{
												fieldList[field.Name]={
													&quot;name&quot;:field.Name,
													&quot;dataType&quot;: compatibleType,
													&quot;layerName&quot;: result.layerName
												}
												console.log(field.Name+&#x27; logged, layerName: &#x27;+fieldList[field.Name].layerName);
											}
											
										}
									}
									
								});
							});
							mygis.Query.createStatFieldList(fieldList);
						}
					});
				}
			}else{	&#x2F;&#x2F;it&#x27;s a DB query
				$.each(checkedItems,function(x,item){
					$.each(dataSource,function(y,sourceItem){
						if (sourceItem.TableName==item.originalItem.name){
							var newList=[];
							$.each(sourceItem.Fields,function(z,field){
							
								var wanted = false;
								switch(field.DataType){
									case &quot;System.Int32&quot;:
									case &quot;System.Double&quot;:
										wanted=true;
										break;
								}
								if (firstItem &amp;&amp; wanted){
									if (fieldList[field.Name]){
										fieldList[field.Name].layerName+=&quot;#&quot;+item.originalItem.name;
									}else{
										fieldList[field.Name]={
											&quot;name&quot;:field.Name,
											&quot;dataType&quot;: field.DataType,
											&quot;layerName&quot;: item.originalItem.name
										}
									}
								} 
							});
						}
					});
					&#x2F;&#x2F;firstItem=false;
				});
				mygis.Query.createStatFieldList(fieldList);
			}
		});
		
	},
	
	createStatFieldList: function(fieldList){
		var fieldArray=[];
		$.each(fieldList,function(x,field){
			if(!mygis.Utilities.isUnwantedField(field.name)){
				fieldArray.push({
					&quot;name&quot;:field.name,
					&quot;value&quot;:field.name,
					&quot;fieldType&quot;:field.dataType,
					&quot;layerName&quot;:field.layerName
				});
			}
		});
		var fieldBox=$(&quot;#statsFieldList&quot;);
		try{fieldBox.jqxListBox(&#x27;clear&#x27;);}catch(err){}
		fieldBox.jqxListBox({
			width: &#x27;100%&#x27;, 
			source: fieldArray, 
			checkboxes: true, 
			height: &#x27;100%&#x27;,
			renderer: function (index, label, value) {
				try{
				var mySource = this.source;
				var dataRecord = mySource[index];
				var humanType=&quot;&quot;;
				switch (dataRecord.fieldType){
					case &quot;System.String&quot;:
						humanType=strings.QBuilder.datatypeText;
						break;
					case &quot;System.Int32&quot;:
					case &quot;System.Double&quot;:
						humanType=strings.QBuilder.datatypeNumeric;
						break;
				}
				var output=&quot;&lt;div class=&#x27;fieldName&#x27;&gt;&quot;+value+&quot;&lt;&#x2F;div&gt;&quot;;
				&#x2F;&#x2F;output+=&quot;&lt;div class=&#x27;fieldType&#x27;&gt;&quot;+humanType+&quot; (&quot;+dataRecord.fieldType+&quot;)&quot;+&quot;&lt;&#x2F;div&gt;&quot;;
				return output;
				}catch(err){}
			}
		});
		fieldBox.on(&#x27;checkChange&#x27;,function(event){
			var checkedItems=$(&quot;#statsFieldList&quot;).jqxListBox(&#x27;getCheckedItems&#x27;);
			if (checkedItems.length&gt;0){
				$(&quot;#statsCalculate&quot;).removeClass(&quot;disabled&quot;);
			}else{
				$(&quot;#statsCalculate&quot;).addClass(&quot;disabled&quot;);
			}
		});
	},
	
	statsCalculate: function(){
		var data={
			layers: [],
			fields: [],
			ids: []
		};
		var checkedItems = $(&quot;#statsLayerList&quot;).jqxListBox(&#x27;getCheckedItems&#x27;);
		$.each(checkedItems,function(x,item){
			data.layers.push(item.originalItem.name);
			$.each(item.originalItem.ids,function(y,id){
				data.ids.push(id);
			});
			
		});
		var checkedFields = $(&quot;#statsFieldList&quot;).jqxListBox(&#x27;getCheckedItems&#x27;);
		$.each(checkedFields,function(x,item){
			data.fields.push({
				Name:item.originalItem.name,
				DataType:item.originalItem.fieldType,
				layerName: item.originalItem.layerName
			});
		});
		var customUrl = config.mgreq+&quot;?qtype=GetQueryStats&amp;qContents=&quot;;
		$(&quot;#statsResultCont&quot;).die().empty();
		$.ajax({
			type:&quot;POST&quot;,
			data: JSON.stringify(data),
			url: customUrl,
			success: function(data){
				var results=eval(data);
				$.each(results,function(x,result){
					var resultSet = $(&quot;&lt;div class=&#x27;result&#x27; &#x2F;&gt;&quot;);
					var cell = $(&quot;&lt;div class=&#x27;fieldName&#x27; &#x2F;&gt;&quot;);
					var fieldItem = $(&quot;#statsFieldList&quot;).jqxListBox(&#x27;getItemByValue&#x27;,result.fieldName);
					var flavorText=&quot;&quot;;
					$.each($(&quot;#statsLayerList&quot;).jqxListBox(&#x27;getItems&#x27;),function(z,item){
						if (fieldItem.originalItem.layerName.indexOf(item.originalItem.name)&gt;-1){
							if (flavorText){
								flavorText += &quot;, &quot;;
							}
							flavorText += item.originalItem.flavorName;
						}
					});
					var str=strings.QBuilder.statsFieldNameBefore+&quot; &#x27;&quot;+result.fieldName+&quot;&#x27; &quot;+strings.QBuilder.statsFieldNameAfter+&quot;:&quot;;
					cell.append(str);
					var cell2=$(&quot;&lt;div class=&#x27;fieldName sub&#x27; &#x2F;&gt;&quot;);
					&#x2F;&#x2F;cell2.append(strings.QBuilder.statResultIn+&quot; &quot;+flavorText);
					cell2.append(flavorText);
					resultSet.append(cell);
					resultSet.append(cell2);
					var table=$(&quot;&lt;table &#x2F;&gt;&quot;);
					var header= $(&quot;&lt;tr &#x2F;&gt;&quot;);
					table.append(header);
					&#x2F;&#x2F;header.append($(&quot;&lt;td class=&#x27;emptyColHeader&#x27; &#x2F;&gt;&quot;));
					$.each(result.stats,function(y,stat){
						var friendlyname=&quot;&quot;;
						switch (stat.statName){
							case &quot;fieldSum&quot;:
								friendlyname = strings.QBuilder.statSum;
								break;
							case &quot;fieldMin&quot;:
								friendlyname = strings.QBuilder.statMin;
								break;
							case &quot;fieldMax&quot;:
								friendlyname = strings.QBuilder.statMax;
								break;
							case &quot;fieldAvg&quot;:
								friendlyname = strings.QBuilder.statAvg;
								break;
							case &quot;fieldCount&quot;:
								friendlyname = strings.QBuilder.statCount;
								break;
						}
						&#x2F;&#x2F;var cell=$(&quot;&lt;td class=&#x27;colHeader&#x27;&gt;&quot;+friendlyname+&quot;&lt;&#x2F;td&gt;&quot;);
						var cell=$(&quot;&lt;td class=&#x27;&#x27;&gt;&lt;span class=&#x27;fieldLabel&#x27;&gt;&quot;+friendlyname+&quot;&lt;&#x2F;span&gt;&lt;span class=&#x27;fieldValue&#x27;&gt;&quot;+mygis.Utilities.addCommas(stat.statValue)+&quot;&lt;&#x2F;span&gt;&lt;&#x2F;td&gt;&quot;);
						header.append(cell);
					});
					&#x2F;*
					var row=$(&quot;&lt;tr &#x2F;&gt;&quot;);
					$.each(result.stats,function(y,stat){
						var cell = $(&quot;&lt;td &#x2F;&gt;&quot;);
						cell.append(stat.statValue);
						row.append(cell);
						
					});
					table.append(row);
					*&#x2F;
					resultSet.append(table);
					$(&quot;#statsResultCont&quot;).append(resultSet);
					
				});
				mygis.Query.statsDisplayResults();
			}
		});
	},
	
	statsClearFields: function(){
		&#x2F;&#x2F;$(&quot;#statsFieldList&quot;).die().empty();
		$(&quot;#statsResultCont&quot;).die().empty();
	},
	
	statsDisplayResults: function(){
		$(&quot;#statsPrint&quot;).show();
		$(&quot;#statsBack&quot;).show();
		$(&quot;#statsCalculate&quot;).hide();
		$(&quot;#statsCriteria&quot;).hide();
		mygis.Query.statsActions.show(&#x27;east&#x27;);
	},
	
	statsBackToSelection: function(){
		$(&quot;#statsCriteria&quot;).show();
		$(&quot;#statsPrint&quot;).hide();
		$(&quot;#statsBack&quot;).hide();
		$(&quot;#statsCalculate&quot;).show();
		mygis.Query.statsActions.hide(&#x27;east&#x27;);
		
	},
	
	
	&#x2F;**
	 * Retrieves fields from a WFS DescribeFeatureType request
	 * @method getWFSAttributes
	*&#x2F;
	getWFSAttributes: function(request){
		var format = new OpenLayers.Format.WFSDescribeFeatureType();
		var resp = format.read(request.responseText);
		var featureTypes = resp.featureTypes;
		var results=[];
		for (var i = 0; i &lt; featureTypes.length; i++) {
			var result={
				layerName: featureTypes[i].typeName,
				fields:[]
			};
			for (var j = 0; j &lt; featureTypes[i].properties.length; j++) {
				var field={
					Name: featureTypes[i].properties[j].name,
					DataType: featureTypes[i].properties[j].localType
				};
				result.fields.push(field);
			}
			results.push(result);
		}
		return results;
	},
	

	&#x2F;**
		Highlights the given layer based on the queryArray

		@method highlightAll
		@param {Array} queryArray An array containing the encoded &quot;query&quot; for the features to search.

	**&#x2F;
	highlightAll: function (queryArray){
		var sld = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#x27;+mygis.Query.getSLDBody(queryArray).replace(&#x2F;#&#x2F;g,&quot;%23&quot;);
		var wms_url=config.mapserver+&quot;wms&quot;;
		var addFlag = false;
		if (!wmsHighlight){
			addFlag=true;

			wmsHighlight= new OpenLayers.Layer.WMS(
						&quot;HighlightWMS&quot;,
						wms_url,
						{
							&#x2F;&#x2F;map:currentMapPath,
							&#x2F;&#x2F;&#x27;layers&#x27;: &#x27;chios_MUNICIPALITIES&#x27;,	&#x2F;&#x2F;mygis.Utilities.getVisibleLayerString(currentAppName),
							&#x27;format&#x27;:&#x27;png&#x27;,
							EXCEPTIONS:&#x27;BLANK&#x27;,
							&#x2F;&#x2F;CRS:&#x27;EPSG:4326&#x27;,&#x2F;&#x2F;CRS:&#x27;EPSG:4121&#x27;,
							FORMAT:&#x27;image&#x2F;png&#x27;,
							transparent: true,
							sld_body: sld
						},
						{
							&#x27;visibility&#x27;: true,
							&#x27;isBaseLayer&#x27;: false,
							&#x27;alpha&#x27;:true
							,singleTile:false,ratio: 1
						}
			);
			criteriaMap.addLayers([wmsHighlight]);
		}else{
			wmsHighlight.mergeNewParams({
				sld_body: sld
			});
		}
	},

	&#x2F;**
		Creates an sld string based on multiple query strings
		@method getSLDBody
		@param {Array} queryArray The array containing query strings
		@return {String} The sld for the query
	**&#x2F;
	getSLDBody: function(queryArray){
		var sld ={
			version: &quot;1.0.0&quot;,
			namedLayers: new Object()
		};
		for (var i=0;i&lt;queryArray.length;i++){
			var getSingleSld = mygis.Query.getTableFilter(queryArray[i]);
			sld.namedLayers[getSingleSld.name]=getSingleSld;

		}
		var frmt = new OpenLayers.Format.SLD();
		return frmt.write(sld);
	},


	&#x2F;**
		Combines an array of OpenLayers.Filter to a single filter

		@method getCombinedFilter
		@param {String} combination How to combine the filters.
				Valid values:
					-bAnd
					-bOr
					-bNot
		@param {Array} filters Array of OpenLayers.Filter
		@return {Object} The combined filter.
	**&#x2F;
	getCombinedFilter: function(combination,filters){
		var retvalue;
		var combType;
		switch (combination)
		{
			case &quot;bAnd&quot;:
				combType = OpenLayers.Filter.Logical.AND;
				break;
			case &quot;bOr&quot;:
				combType = OpenLayers.Filter.Logical.OR;
				break;
			case &quot;bNot&quot;:
				combType = OpenLayers.Filter.Logical.NOT;
				break;
		}
		retvalue = new OpenLayers.Filter.Logical({
			type: combType,
			filters: filters
		});
		return retvalue;
	},

	&#x2F;**
		Creates an SLD style to apply for the given layer

		@method getTableFilter
		@param {String} querystring Sample querystring: TABLE_1 # FIELD_1 # OP_1 # VALUE % Q_OP # FIELD_2 # OP_2 # VALUE_2
		@return {Object} An SLD style to apply for the given layer
	**&#x2F;
	getTableFilter: function(querystring){
		var retvalue;
		var tableName;
		var conditions = querystring.split(&quot;%&quot;);
		var filters_AND = [];
		var OR_FLAG=false;
		&#x2F;&#x2F;var filters_OR = [];
		var finalFilters = [];
		var singleFilter;
		var single;
		for (var i=0;i&lt;conditions.length;i++){
			var qParts=conditions[i].split(&quot;#&quot;);
			var mod_op;
			var prop,op,val;
			if (i==0){
				tableName=qParts[0];
			}else{
				mod_op = qParts[0];
			}

			prop = qParts[1];
			op = qParts[2];
			val = qParts[3];
			if (val){
				if (val.indexOf(&quot;\\&quot;)==0){
					val=val.substring(3,val.length-6);
				}
			}
			if (prop!=null&amp;&amp;op!=null&amp;&amp;val!=null){
				singleFilter = mygis.Drawing.Styling.getSLDFilter(op,prop,val);
			}else{
				singleFilter = null;
			}
			if (i==0){

				if (mygis.Query.peek(conditions,i+1)==&quot;bOr&quot;){
					finalFilters.push(singleFilter);
				}else{
					filters_AND.push(singleFilter);
				}
			}else{
				switch(mod_op){
					case &quot;bNot&quot;:
						var negFilter = mygis.Query.getCombinedFilter(mod_op,[singleFilter]);
						filters_AND.push(negFilter);
						break;
					case &quot;bAnd&quot;:
						filters_AND.push(singleFilter);
						break;
					case &quot;bOr&quot;:
						if (filters_AND.length&gt;0){
							finalFilters.push(mygis.Query.getCombinedFilter(&quot;bAnd&quot;,filters_AND));
						}
						if (i==conditions.length-1 || mygis.Query.peek(conditions,i+1)==&quot;bOr&quot;){
							finalFilters.push(singleFilter);
						}else{
							filters_AND=[];
							filters_AND.push(singleFilter);
						}
						OR_FLAG = true;
						break;

				}

			}

		}
		if (conditions.length==1){
			if (singleFilter){
				singleRule = new OpenLayers.Rule({
					symbolizer: mygis.Query.getSLDSymbolizer(),
					filter: singleFilter
				});
			}else{
				singleRule = new OpenLayers.Rule({
					symbolizer: mygis.Query.getSLDSymbolizer()
				});
			}
		}else{
			if (filters_AND.length&gt;0 &amp;&amp; OR_FLAG){
				finalFilters.push(mygis.Query.getCombinedFilter(&quot;bAnd&quot;,filters_AND));
			}
			var resultFilter = OR_FLAG?mygis.Query.getCombinedFilter(&quot;bOr&quot;,finalFilters):mygis.Query.getCombinedFilter(&quot;bAnd&quot;,filters_AND);
			singleRule = new OpenLayers.Rule({
				symbolizer: mygis.Query.getSLDSymbolizer(),
				filter: resultFilter
			});
		}
		var namedLayer = {
			name: tableName,
			userStyles: []
		};
		namedLayer.userStyles[0]={
			rules: []
		};
		namedLayer.userStyles[0].rules.push(singleRule);
		retvalue = namedLayer;
		return retvalue;
	},

	&#x2F;**
		Creates default sld-style properties for Point, Line, Polygon

		@method getSLDSymbolizer
		@return {Object} An object containing the styles.
	**&#x2F;
	getSLDSymbolizer: function(){
		var retvalue = new Object();
		&#x2F;&#x2F;retvalue[&quot;Point&quot;]=mygis.Drawing.Styling.getOLStyle(&#x27;selectPoint&#x27;);
		&#x2F;&#x2F;retvalue[&quot;Line&quot;]=mygis.Drawing.Styling.getOLStyle(&#x27;selectLine&#x27;);

		&#x2F;&#x2F;retvalue[&quot;Polygon&quot;]=mygis.Drawing.Styling.getOLStyle(&#x27;selectPolygon&#x27;);
		retvalue[&#x27;Polygon&#x27;]= {fillColor: &#x27;#FF0000&#x27;, stroke: false},
        retvalue[&#x27;Line&#x27;]= {strokeColor: &#x27;#FF0000&#x27;, strokeWidth: 2},
        retvalue[&#x27;Point&#x27;]= {graphicName: &#x27;square&#x27;, fillColor: &#x27;#FF0000&#x27;, pointRadius: 5}
		return retvalue;
	},

	&#x2F;**
		Used to check in an array of conditions (Containing #-separated strings) if the specified index exists.

		@method peek
		@param {Array} conditions The array to check
		@param {Integer} The index to check
		@return {String} Either the condition at the specified index, or null if none exist.
	**&#x2F;
	peek: function(conditions,index){
		try{
			var items = conditions[index].split(&quot;#&quot;);
			return items[0];
		}catch(err){return &quot;&quot;;}
	},

	&#x2F;**
		Gets the columns for a given layer.

		@method getLayerDetails
		@param {Integer} index The layer index to get
		@param {String} forID Currently only accepting &quot;editableInfo&quot;
	**&#x2F;
	getLayerDetails: function(index,forID){

		var layername = layerSource.records[index].layerTABLE;
		$.ajax({
			type: &quot;GET&quot;,
			url: config.mgreq+&quot;?qtype=GetLayerFields&amp;qContents=&quot;+escape(layername.replace(&#x2F; &#x2F;g,&quot;_&quot;)),
			success: function(data){
				var datacolumns = mygis.Query.resultLayerDetails(data);
				if (forID==&quot;editableInfo&quot;){
					var firstField=false;
					var fieldCount=0;
					var section1 = $(&quot;#editableInfo&quot;).find(&quot;.infoFields&quot;);
					var section2 = $(&quot;#editableInfo&quot;).find(&quot;.infoImages&quot;);
					var section3 = $(&quot;#editableInfo&quot;).find(&quot;.infoFiles &quot;);
					var section4 = $(&quot;#editableInfo&quot;).find(&quot;.infoLinks &quot;);
					var DBFields=$(&quot;&lt;div &#x2F;&gt;&quot;);
					var DBImages=$(&quot;&lt;div &#x2F;&gt;&quot;);
					var DBFiles=$(&quot;&lt;div &#x2F;&gt;&quot;);
					var DBLinks=$(&quot;&lt;div &#x2F;&gt;&quot;);

					var imageFields=0;
					var fileFields = 0;
					var linkFields = 0;

					section1.empty();
					section2.empty();
					section3.empty();
					section4.empty();
					$.each(datacolumns,function(i,v){
						var skipField=false;
						if (v.name.endsWith(&quot;__&quot;)){
							skipField=true;
							var nameParts = v.name.substring(2).split(&quot;_&quot;);
							var type=nameParts[0];
							switch (type){
								case &#x27;IMG&#x27;:
									imageFields +=1;
									break;
								case &#x27;LNK&#x27;:
									linkFields +=1;
									break;
								case &#x27;FILE&#x27;:
									fileFields +=1;
									break;
							}
						}
						if (v.name==&quot;Geometry&quot; || v.name==&quot;OID&quot; || v.name==&quot;Center_X&quot; || v.name==&quot;Center_Y&quot;)skipField=true;
						if (!skipField){

							var newLine = $(&quot;&lt;div &#x2F;&gt;&quot;);
							var newHead = $(&quot;&lt;span &#x2F;&gt;&quot;);
							var newValue = $(&quot;&lt;input type=&#x27;text&#x27; &#x2F;&gt;&quot;);
							newHead.html(v.name);
							newHead.addClass(&quot;featureHCell&quot;);
							newValue.addClass(&quot;featureVCell&quot;);
							newLine.append(newHead);
							newLine.append(newValue);
							DBFields.append(newLine);
							if (!firstField){
								firstField = true;
								&#x2F;&#x2F;newValue.attr(&quot;disabled&quot;,&quot;disabled&quot;);
							}else{

							}
							fieldCount+=1;
						}
					});
					section1.append(DBFields);
					var existingImgTitle = mygis.Utilities.format(&quot;{0} {1} {2}&quot;, &quot;Up to&quot;,imageFields,&quot;image fields have already been created&quot;);
					var existingLinkTitle = mygis.Utilities.format(&quot;{0} {1} {2}&quot;, &quot;Up to&quot;,linkFields,&quot;link fields have already been created&quot;);
					var existingFileTitle = mygis.Utilities.format(&quot;{0} {1} {2}&quot;, &quot;Up to&quot;,fileFields,&quot;file fields have already been created&quot;);

					var imagePrompt=$(&quot;&lt;div &#x2F;&gt;&quot;).append(existingImgTitle);
					var linkPrompt=$(&quot;&lt;div &#x2F;&gt;&quot;).append(existingLinkTitle);
					var filePrompt=$(&quot;&lt;div &#x2F;&gt;&quot;).append(existingFileTitle);

					DBImages.append(imagePrompt);
					DBFiles.append(filePrompt);
					DBLinks.append(linkPrompt);

					var actionbar=$(&quot;&lt;div class=&#x27;uploadActionBar&#x27; &#x2F;&gt;&quot;);
					var actionBtnAdd=$(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;addNew&#x27; onclick=&#x27;displayError(\&#x27;Not authorized\&#x27;);return false;&#x27; &#x2F;&gt;&quot;);
					actionBtnAdd.html(&quot;Add new&quot;);

					for (var i=0;i&lt;imageFields;i++){
						var newLine = $(&quot;&lt;div &#x2F;&gt;&quot;);
						var newHead = $(&quot;&lt;span &#x2F;&gt;&quot;);
						var newValue = $(&quot;&lt;input type=&#x27;file&#x27; accept=&#x27;image&#x2F;jpg,image&#x2F;gif&#x27; &#x2F;&gt;&quot;);
						newHead.html(&quot;Add image&quot;);
						newHead.addClass(&quot;featureHCell&quot;);
						newValue.addClass(&quot;featureVCell&quot;);
						newLine.append(newHead);
						newLine.append(newValue);
						&#x2F;&#x2F;DBImages.append(newLine);
					}
					for (var i=0;i&lt;linkFields;i++){
						var newLine = $(&quot;&lt;div &#x2F;&gt;&quot;);
						var newHead = $(&quot;&lt;span &#x2F;&gt;&quot;);
						var newValue = $(&quot;&lt;input type=&#x27;text&#x27; &#x2F;&gt;&quot;);
						newHead.html(&quot;Add link&quot;);
						newHead.addClass(&quot;featureHCell&quot;);
						newValue.addClass(&quot;featureVCell&quot;);
						newLine.append(newHead);
						newLine.append(newValue);
						DBLinks.append(newLine);
					}
					for (var i=0;i&lt;fileFields;i++){
						var newLine = $(&quot;&lt;div &#x2F;&gt;&quot;);
						var newHead = $(&quot;&lt;span &#x2F;&gt;&quot;);
						var newValue = $(&quot;&lt;input type=&#x27;file&#x27; accept=&#x27;image&#x2F;jpg,image&#x2F;gif&#x27; &#x2F;&gt;&quot;);
						newHead.html(&quot;Add image&quot;);
						newHead.addClass(&quot;featureHCell&quot;);
						newValue.addClass(&quot;featureVCell&quot;);
						newLine.append(newHead);
						newLine.append(newValue);
						&#x2F;&#x2F;DBFiles.append(newLine);
					}
					&#x2F;*
					var iframeUploader=$(&quot;&lt;iframe &#x2F;&gt;&quot;);
					iframeUploader.attr(&quot;src&quot;,&quot;&#x2F;customUpload.aspx&quot;);
					iframeUploader.attr(&quot;height&quot;,&quot;256px&quot;);
					iframeUploader.attr(&quot;width&quot;,&quot;280px&quot;);
					DBImages.append(iframeUploader);
					*&#x2F;
					section2.append(DBImages);
					section3.append(DBFiles);
					section4.append(DBLinks);
					section2.append(actionbar.clone());
					section3.append(actionbar.clone());
					section4.append(actionbar.clone());
				}
				if (forID==&quot;editDigitize&quot;){
					mygis.Drawing.Editing.fillDigiPopup(datacolumns,layername);
				}
			}
		});
	},

	&#x2F;**
		Returns an array of the layer&#x27;s columns

		@method resultLayerDetails
		@param {String} json data to parse
		@return {Array}
	**&#x2F;
	resultLayerDetails: function(data){
		var datacolumns = {};&#x2F;&#x2F;[];
		var row;
		var realResults = eval(data);
		$.each(realResults,function(index,value){
			row=new Object();
			row[&quot;name&quot;]=value.fieldNAME;
			row[&quot;originalType&quot;]=value.fieldTYPE;
			row[&quot;fieldLists&quot;]=value.fieldLISTS;
			if (
				value.fieldTYPE.indexOf(&quot;char&quot;)&gt;-1 ||
				value.fieldTYPE.indexOf(&quot;nchar&quot;)&gt;-1 ||
				value.fieldTYPE.indexOf(&quot;varchar&quot;)&gt;-1 ||
				value.fieldTYPE.indexOf(&quot;nvarchar&quot;)&gt;-1 ||
				value.fieldTYPE.indexOf(&quot;Text&quot;)&gt;-1)
			{
			row[&quot;value&quot;]=value.fieldNAME+&quot;%s&quot;;
			}
			else{
				row[&quot;value&quot;]=value.fieldNAME;
			}


			datacolumns[value.fieldNAME]=row;&#x2F;&#x2F;datacolumns.push(row);
		});
		return datacolumns;

	},
	
	getInfoStructure: function(id){
		var container = $([
		&quot;&lt;div id=&#x27;&quot;+id+&quot;&#x27; class=&#x27;infoCont&#x27;&gt;&quot;,
		&quot;	&lt;div class=&#x27;layoutContainer&#x27;&gt;&quot;, 
		&quot;		&lt;div class=&#x27;ui-layout-north&#x27;&gt;&quot;,
		&quot;			&lt;div class=&#x27;mainImageCont&#x27;&gt;&lt;&#x2F;div&gt;&quot;,
        &quot;			&lt;a href=&#x27;#&#x27; class=&#x27;showInfoImagesBtn&#x27;&gt;&lt;&#x2F;a&gt;&quot;,
		&quot;		&lt;&#x2F;div&gt;&quot;,
		&quot;		&lt;div class=&#x27;ui-layout-center&#x27;&gt;&quot;,
		&quot;			&lt;h3 class=&#x27;infoImagesLabel&#x27;&gt;&quot;+strings.Info.section2+&quot;&lt;&#x2F;h3&gt;&quot;,
		&quot;			&lt;div class=&#x27;popupimageContainer&#x27; style=&#x27;display:none&#x27;&gt;&lt;&#x2F;div&gt;&quot;,
		&quot;			&lt;h3 class=&#x27;infoFieldsLabel&#x27;&gt;&quot;+strings.Info.section1+&quot;&lt;&#x2F;h3&gt;&quot;,
		&quot;			&lt;div class=&#x27;popupFieldContainer&#x27;&gt;&lt;&#x2F;div&gt;&quot;,
		&quot;			&lt;h3 class=&#x27;infoFilesLabel&#x27;&gt;&quot;+strings.Info.section3+&quot;&lt;&#x2F;h3&gt;&quot;,
		&quot;			&lt;div class=&#x27;popupFileContainer&#x27; style=&#x27;display:none&#x27;&gt;&lt;&#x2F;div&gt;&quot;,
		&quot;		&lt;&#x2F;div&gt;&quot;,
		&quot;		&lt;div class=&#x27;ui-layout-east&#x27;&gt;&lt;&#x2F;div&gt;&quot;,
		&quot;	&lt;&#x2F;div&gt;&quot;,
		&quot;&lt;&#x2F;div&gt;&quot;
		].join(&quot;\n&quot;));
		return container;
	},
	
	&#x2F;**
	  *	Displays data in a &quot;popup info&quot; window
	  *	@method popupInfo
	  * @param results (Array)
	  * @param layername (String)
	  * @param newWindow (Boolean): whether this is an empty window (blank object)
	  **&#x2F;
	popupInfo: function(results,layername,newWindow){
		var that=results;
		&#x2F;&#x2F;loadFragment(&quot;infoDetachContWrapper2&quot;,function(){
			var oldResults;
			var id = results.OID;
			oldResults= jQuery.extend({}, that);
			if (newWindow){
				results={};
				$.each(oldResults,function(i,v){
					results[i]=&quot;&quot;;
				});
				results.OID=-1;
				id=results.OID;
			}else{
				var layerID=mygis.Utilities.mggetLayerID(layername);
				var datacolumns = mygis.Query.resultLayerDetails(internalMemory.layerFields[layerID]);
				oldResults = jQuery.extend(true,oldResults,datacolumns);
				var objectID=results.OID;
				if (mygis.Drawing.Exporting.checkRights(objectID,layerID)){
					var transformedResults=jQuery.extend({},oldResults);
					$.each(transformedResults,function(i,v){
						if (results[i]){
							transformedResults[i]=results[i];
						}
					});
					results=jQuery.extend({},transformedResults);
				}
			}
			
			if ($(&quot;#detached&quot;+layername+&quot;_&quot;+id).length&gt;0){
				$(&quot;#detached&quot;+layername+&quot;_&quot;+id).dialogExtend(&quot;restore&quot;);
			}else{
				var container = mygis.Query.getInfoStructure(&quot;detached&quot;+layername+&quot;_&quot;+id);	&#x2F;&#x2F;$(&quot;#infoDetachContWrapper2&quot;);
				var fieldsCont = container.find(&quot;.popupFieldContainer&quot;);
				var imagesCont = container.find(&quot;.popupimageContainer&quot;);
				var filesCont = container.find(&quot;.popupFileContainer&quot;);
				
				fieldsCont.empty();
				imagesCont.empty();
				filesCont.empty();
				&#x2F;&#x2F;$(&quot;.mainImageCont&quot;).attr(&quot;style&quot;,&quot;&quot;);
				fieldsCont.append(mygis.Query.buildInfoFields(results,layername));
				console.log(location.toString());
				fieldsCont.append($([
				&quot;&lt;div class=&#x27;addthis_toolbox addthis_default_style&#x27; data-url=&#x27;&quot;+location.toString()+&quot;&#x27;&gt;&quot;,
				&quot;	&lt;a class=&#x27;addthis_button_facebook_like&#x27;  fb:like:layout=&#x27;button_count&#x27;&gt;&lt;&#x2F;a&gt;&quot;,
				&quot;	&lt;a class=&#x27;addthis_button_twitter&#x27; style=&#x27;cursor:pointer&#x27;&gt;&lt;&#x2F;a&gt;&quot;,
				&quot;	&lt;a class=&#x27;addthis_button_email&#x27; style=&#x27;cursor:pointer&#x27;&gt;&lt;&#x2F;a&gt;&quot;,
				&quot;&lt;&#x2F;div&gt;&quot;
				].join(&quot;\n&quot;)));
				var fid = layername+&quot;.&quot;+id;
				var images=[];
				var files=[];
				if (!newWindow){
					images = mygis.UI.getObjectGridSource(&#x27;Images&#x27;,fid).records;&#x2F;&#x2F;mygis.UI.objectImageGrid(id,layername,&#x27;Images&#x27;);
					files = mygis.UI.getObjectGridSource(&#x27;Files&#x27;,fid).records; &#x2F;&#x2F;mygis.UI.objectImageGrid(id,layername,&#x27;Files&#x27;);
				}
				var windowTitle = results[$.keys(results)[0]];
				if (windowTitle==-1 || undefined==windowTitle || windowTitle==&quot;&quot;){
					windowTitle=strings.Editing.newObjTitle
				}
				var params={
					hasImages: images.length&gt;0,
					hasFiles: files.length&gt;0,
					title: windowTitle +&quot;&lt;div class=&#x27;dialogSub&#x27;&gt;&quot;+strings.Info.infoWindowSubPart1+mygis.Utilities.getFriendlyName(layername)+strings.Info.infoWindowSubPart2+&quot;&lt;&#x2F;div&gt;&quot;,
					layer: layername,
					oid: id,
					newWindow: newWindow,
					fieldInfo: oldResults
				};
				
				if (images.length&gt;0){
					var src=mygis.Utilities.format(
						&quot;url(&#x27;{0}GetImage.ashx?qType=userFile&amp;qContents={1}&amp;qSize=430&#x27;)&quot;,
						config.folderPath,
						images[0].imageID);
					container.find(&quot;.mainImageCont&quot;).css(&quot;background-image&quot;,src);
					container.find(&quot;.showInfoImagesBtn&quot;).html(strings.Info.infoImagesBtn +&quot;(&quot;+images.length+&quot;)&quot;);
					imagesCont.append(mygis.UI.getInfoImageGrid(images,fid));
					imagesCont.data(&quot;images&quot;,images);
				}
				if (files.length&gt;0){
					filesCont.append(mygis.UI.getInfoFileGrid(files,fid));
					filesCont.data(&quot;files&quot;,files);
				}
				
				
				mygis.Query.infoDetach(container,layername+&quot;_&quot;+id,params);
			}
			
		&#x2F;&#x2F;},&quot;#infoDetachContWrapper2&quot;);
	},
	
	&#x2F;**
	  *	Used to display a preview of an image file (inside info popup)
	  *	@method infoImgPreview
	  **&#x2F;
	infoImgPreview: function(params){
		var imageSource = params.src;
		var fullSource = imageSource.substring(0,imageSource.indexOf(&quot;&amp;qSize&quot;));
		var newImg = $(&quot;&lt;img &#x2F;&gt;&quot;);
		newImg.attr(&quot;src&quot;,fullSource);
		newImg.attr(&quot;class&quot;,&quot;imagePreviewer&quot;);
		var layout = $(params).closest(&quot;.layoutContainer&quot;);
		var container = layout.find(&quot;.ui-layout-east&quot;);
		var previewCont = $(&quot;&lt;div class=&#x27;imgPreview&#x27; &#x2F;&gt;&quot;);
		previewCont.append(newImg);
		container.html(previewCont);
		var layoutObj=layout.parent().data(&#x27;outerLayout&#x27;);
		var dialog=layout.closest(&quot;.ui-dialog-content&quot;);
		try{
			layoutObj.hide(&#x27;east&#x27;);
		}catch(err){}
		var prevWidth=dialog.width();
		$(&quot;#&quot;+dialog.attr(&quot;id&quot;)).dialog(&quot;option&quot;, &quot;width&quot;, 938);
		layoutObj.resizeAll();
		layoutObj.sizePane(&#x27;east&#x27;,prevWidth-20);
		layoutObj.show(&quot;east&quot;);
	},
	
	infoFilePreview: function(params){
		var fileSrc= mygis.Utilities.format(config.mgreq+&quot;?qtype=DownloadFile&amp;qContents={0}&quot;,params.id);
		var layout = $(params.elem).closest(&quot;.layoutContainer&quot;);
		var container = layout.find(&quot;.ui-layout-east&quot;);
		var previewCont = $(&quot;&lt;div class=&#x27;imgPreview&#x27; &#x2F;&gt;&quot;);
		&#x2F;&#x2F;previewCont.append(newImg);
		container.html(previewCont);
		var layoutObj=layout.parent().data(&#x27;outerLayout&#x27;);
		var dialog=layout.closest(&quot;.ui-dialog-content&quot;);
		var prevWidth=dialog.width();
		var prevHeight=dialog.height();
		PDFJS.workerSrc=config.folderPath+&quot;Scripts&#x2F;lib&#x2F;pdf.worker.js&quot;;
		PDFJS.getDocument(fileSrc).then(function(pdf){
			pdf.getPage(1).then(function(page) {
				var viewport = page.getViewport(0.5);
				var canvas = document.createElement(&#x27;canvas&#x27;);
				var ctx = canvas.getContext(&#x27;2d&#x27;);
				canvas.height = viewport.height;
				canvas.width = viewport.width;

				var renderContext = {
				  canvasContext: ctx,
				  viewport: viewport
				};

				page.render(renderContext).then(function(){
				&#x2F;&#x2F;set to draw behind current content
				ctx.globalCompositeOperation = &quot;destination-over&quot;;

				&#x2F;&#x2F;set background color
				ctx.fillStyle = &quot;#ffffff&quot;;

				&#x2F;&#x2F;draw background &#x2F; rect on entire canvas
				ctx.fillRect(0,0,canvas.width,canvas.height);
				var img = canvas.toDataURL();
				previewCont.html(&#x27;&lt;img class=&quot;imagePreviewer&quot; src=&quot;&#x27;+img+&#x27;&quot;&#x2F;&gt;&#x27;);
				$(&quot;#&quot;+dialog.attr(&quot;id&quot;)).dialog(&quot;option&quot;, &quot;width&quot;, 938);
				layoutObj.resizeAll();
				layoutObj.sizePane(&#x27;east&#x27;,prevWidth-20);
				layoutObj.show(&quot;east&quot;);
				});
			});
		});
	},
	
	&#x2F;**
	  * Returns only the map select data that match fid
	  * @method breakupMapData
	  * @remarks This is used because map select returns features, mixed up from all layers
	  **&#x2F;
	breakupMapData: function(results,lname,fid){
		var features = results.features;
		var data = {};
		for (var j=0;j&lt;features.length;j++){
			var f=features[j];
			if (f.fid==fid){
				data=f.data;
			}
		};
		return data;
	},
	
	&#x2F;**
	  * Homogenizes the structure of &quot;results&quot; to be the same as the one from map select.
	  * @method breakupQueryData
	  * @remarks 
	  * From:
		object:{
			[0]: {
				ColumnName: String,
				Value: Value
			},
			[1]: {....}
		}
		To:
		object: {
			String: value,
			String: value,
			...
		}
		**&#x2F;
	breakupQueryData: function(results){
		var data={};
		$.each(results,function(cellIndex,cellObject){
			data[cellObject.ColumnName]=cellObject.Value;
		});
		return data;
	},
	
	&#x2F;**
	  * Builds the info popup window&#x27;s structure (north&#x2F;south&#x2F;east layout)
	  * @method buildInfoStructure
	  **&#x2F;
	buildInfoStructure: function(element,hasImages,hasFiles,newWindow){
		var outerLayout=element.find(&quot;.layoutContainer&quot;).layout( {
			north__applyDefaultStyles:false,
			north__size: 150,
			north__closable: false,
			north__resizable: false,
			north__initClosed: !hasImages,
			north__initHidden: !hasImages,
			east__applyDefaultStyles: true,
			east__size: 300,
			east__initHidden: true,
			east__closable: true,
			east__resizable: true,
			onclose: function(pane,elem){
				if (pane==&quot;east&quot;){
					$(elem).closest(&quot;.ui-dialog-content&quot;).dialog(&quot;option&quot;, &quot;width&quot;, 469);
				}
			},
			spacing_closed: 0
		}); 
		var container = element.find(&quot;.layoutContainer&quot;);
		container.linkify();
		container.togglepanels();
		if (newWindow){
			container.find(&quot;.mainImageCont&quot;).addClass(&quot;editable&quot;)
					.bind(&quot;click&quot;,mygis.Drawing.Editing.handlerAttachImage);
		}
		if(!hasImages){
			container.find(&quot;.infoImagesLabel&quot;).hide();
		}
		if(!hasFiles){
			container.find(&quot;.infoFilesLabel&quot;).hide();
		}
		container.find(&quot;.infoFieldsLabel&quot;).trigger(&#x27;click&#x27;);
		element.data(&#x27;outerLayout&#x27;,outerLayout);
	},
	
	&#x2F;**
	  * Creates the HTML markup for the fields in the info popup window
	  * @method buildInfoFields
	  **&#x2F;
	buildInfoFields: function(data,layername){
		var container = $(&quot;&lt;div class=&#x27;infoFieldsCont&#x27; &#x2F;&gt;&quot;);
		var innerCont=   $(&quot;&lt;table class=&#x27;infoFieldsInnerCont&#x27; &#x2F;&gt;&quot;);&#x2F;&#x2F;$(&quot;&lt;div class=&#x27;infoFieldsInnerCont&#x27; &#x2F;&gt;&quot;);
		var layerID = mygis.Utilities.mggetLayerID(layername);
		$.each(data,function(i,v){
			if (mygis.Drawing.Editing.isValidOutputIntern(i)){
				var newLine = $(&quot;&lt;tr &#x2F;&gt;&quot;);&#x2F;&#x2F;$(&quot;&lt;div &#x2F;&gt;&quot;);
				var newHead = $(&quot;&lt;td &#x2F;&gt;&quot;);&#x2F;&#x2F;$(&quot;&lt;span &#x2F;&gt;&quot;);
				var newValue = $(&quot;&lt;td &#x2F;&gt;&quot;);&#x2F;&#x2F;$(&quot;&lt;span &#x2F;&gt;&quot;);
				var fieldInfo = internalMemory.layerFields[layerID][i];
				newHead.html(fieldInfo.friendlyName);	&#x2F;&#x2F;i
				newHead.attr(&quot;data-originalName&quot;,i);
				newHead.attr(&quot;data-description&quot;,fieldInfo.description);
				newValue.html(v);
				newHead.addClass(&quot;featureHCell&quot;);
				newValue.addClass(&quot;featureVCell edit_area&quot;);
				newLine.append(newHead);
				newLine.append(newValue);
				innerCont.append(newLine);
			}
			
		});
		container.append(innerCont);
		container.append(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;infoPopup_editBtn&#x27; style=&#x27;display:none;&#x27; &#x2F;&gt;&quot;);
		container.append(&quot;&lt;a href=&#x27;#&#x27; class=&#x27;infoPopup_deleteBtn&#x27; style=&#x27;display:none;&#x27; &#x2F;&gt;&quot;);
		return container;
	},
	
	&#x2F;**
	  * Clones the &quot;info window&quot; and displays it in a popup
	  * @method infoDetach
	  **&#x2F;
	infoDetach: function(jQueryElement,uniqueIndex,params){
		if ($(&quot;#detached&quot;+uniqueIndex).length&gt;0){
			$(&quot;#detached&quot;+uniqueIndex).dialogExtend(&quot;restore&quot;);
		}else{
			var clone = jQueryElement;	&#x2F;&#x2F;jQueryElement.clone(false);
			&#x2F;*
			var contDiv = $(&quot;&lt;div class=&#x27;infoCont&#x27; &#x2F;&gt;&quot;);
			contDiv.appendTo(&quot;body&quot;);
			contDiv.attr(&quot;id&quot;,&quot;detached&quot;+uniqueIndex);
			contDiv.append(clone.html());
			*&#x2F;
			clone.appendTo(&quot;body&quot;);
			contDiv=clone;
			if (params.fieldInfo){
				var cells=contDiv.find(&quot;.infoFieldsCont tr .featureVCell&quot;);
				var allData = params.fieldInfo;
				$.each(cells,function(i,cell){
					var fieldName = $(cell).prev().attr(&#x27;data-originalName&#x27;);
					var data = allData[fieldName];
					$(cell).data(&quot;fieldInfo&quot;,data);
				});
			}
			var minizable=true;
			if (params.newWindow){
				minizable=false;
			}else if (mygis.Drawing.Exporting.checkRights(params.oid,mygis.Utilities.mggetLayerID(params.layer))){
				minizable=false;
			}
			contDiv.dialog(
				{&#x2F;&#x2F;position: [135,123],
				width: 469,	&#x2F;&#x2F;(!(params.hasImages||params.hasFiles))?375:750,
				height: 650,
				resizable: true, 
				modal: params.newWindow,
				autoResize: true,
				title: params.title,
				close: function(){
					internalMemory.dialogLeft-=10;
					internalMemory.dialogTop-=10;
					$(this).remove();
				},
				position: { 
					my: (&quot;center+&quot;+ internalMemory.dialogLeft + &quot; center+&quot; + internalMemory.dialogTop), at: &quot;center center&quot; },
				open: function(){
					internalMemory.dialogLeft+=10;
					internalMemory.dialogTop+=10;
					
					var titleBar = $(&quot;#detached&quot;+uniqueIndex).parent().find(&quot;.ui-dialog-titlebar&quot;);
					var dialogWindow = titleBar.parent();
					var dialogContent=$(&quot;#detached&quot;+uniqueIndex);
					titleBar.css({
							&quot;background&quot;:&quot;#F6A828 no-repeat 12px 2px&quot;
							});
					&#x2F;&#x2F;titleBarSpan.attr(&quot;style&quot;,&quot;padding: 2px 0;font-size:11px !important&quot;);
					$(&#x27;.ui-widget-overlay&#x27;).bind(&#x27;click&#x27;, function () { $(this).siblings(&#x27;.ui-dialog&#x27;).find(&#x27;.ui-dialog-content&#x27;).dialog(&#x27;close&#x27;); });
					mygis.Query.buildInfoStructure($(&quot;#detached&quot;+uniqueIndex),params.hasImages||params.newWindow,params.hasFiles||params.newWindow,params.newWindow);
					if (Sys.Services.AuthenticationService.get_isLoggedIn()){
						mygis.Drawing.Editing.checkInfoPopupButtons(params.layer,params.oid,params.fieldInfo);
					}
					if(params.newWindow){
						mygis.Drawing.Editing.editInfoFields(params.fieldInfo);
					}
					mygis.UI.Hooks.infoWindowShown();
				},
				beforeClose: function(event){
					if (params.newWindow){
						mygis.Drawing.Exporting.checkDigitizing(event);
						return false;
					}
				}
			}).dialogExtend({
				minimizable: minizable,
				beforeMinimize: function(){
					$(&quot;#dialog-extend-fixed-container&quot;).show();
					$(&quot;#panel1 .ui-layout-center&quot;).animate({
						scrollTop: 0
					},0);
				},
				minimize : function(evt) {
					$(&quot;#dialog-extend-fixed-title&quot;).show();
				},
				restore: function(evt){
					if ($(&quot;#dialog-extend-fixed-container .ui-dialog&quot;).length==0){
						$(&quot;#dialog-extend-fixed-title&quot;).hide();
						$(&quot;#dialog-extend-fixed-container&quot;).hide();
					}
				}
			});
		}
		
	}
};

&#x2F;&#x2F; END of mygis.Query

&#x2F;**
	Utility functions.

	@class Utilities
	@static
**&#x2F;
mygis.Utilities = {

	&#x2F;**
	 * Updates a single property of a layer
	 * @method updateLayerSource
	 * @param {String} searchProperty Finds a record by this property
	 * @param {Mixed} searchValue The searchProperty must be equal to this value
	 * @param {String} replaceProperty Replaces this property...
	 * @param {Mixed} replaceValue ...with this value
	 *&#x2F;
	updateLayerSource: function(searchProperty,searchValue,replaceProperty,replaceValue){
		var counter =0;
		var found =false;
		while (!found &amp;&amp; counter&lt;layerSource.records.length){
			var item = layerSource.records[counter];
			if (item[searchProperty]==searchValue){
				found=true;
			}else{
				counter++;
			}
		}
		if (found){
		layerSource.records[counter][replaceProperty]=replaceValue;
		if (internalConfig.updateLayerSource){
			clearTimeout(internalConfig.updateLayerSource);
		}
		internalConfig.updateLayerSource = setTimeout(function(){
			mygis.UI.updateLayerGrid();
		},5000);
		}else{
			console.log(searchProperty+&quot; not found. Search value: &quot;+searchValue);
		}

	},


	isUnwantedField: function(name){
		var retvalue=false;
		switch (name){
			case &quot;OID&quot;:
			case &quot;Geometry&quot;:
			case &quot;GeometryText&quot;:
				retvalue=true;
				break;
		}
		if(name.endsWith(&quot;__&quot;)){
			retvalue=true;
		}
		return retvalue;
	},
	
	&#x2F;**
	 * Populates a given select element with the list of available backgrounds
	 * @method populateBGselect
	 * @param {jQuery Element} selectElement The select element to populate
	 * @param {String} initialSelect Select this background name if found
	 *&#x2F;
	populateBGselect: function(selectElement,initialSelect){
		selectElement.empty();
		for (var bg in backgrounds){
			if (backgrounds[bg].hasOwnProperty(&quot;name&quot;)){	&#x2F;&#x2F;1-level
				var opt = $(&quot;&lt;option &#x2F;&gt;&quot;);
				opt.attr(&quot;value&quot;,bg);
				opt.html(backgrounds[bg].name);
				if (bg.toString()==initialSelect){
					opt.attr(&quot;selected&quot;,&quot;selected&quot;);
				}
				selectElement.append(opt);
			}else{	&#x2F;&#x2F;2-level
				for (var sub in backgrounds[bg]){
					var opt = $(&quot;&lt;option &#x2F;&gt;&quot;);
					opt.attr(&quot;value&quot;,bg+&#x27;.&#x27;+sub);
					opt.html(backgrounds[bg][sub].name);
					if ((bg+&#x27;.&#x27;+sub)==initialSelect){
						opt.attr(&quot;selected&quot;,&quot;selected&quot;);
					}
					selectElement.append(opt);
				}
				
			}
		}
	},

	&#x2F;**
	 * Searches for the background identifier by (localized) name
	 * @method getBGIdentifier
	 * @param {String} name The background&#x27;s localized name
	 * @returns {String} The background identifier
	 *&#x2F;
	getBGIdentifier: function(name){
		var retvalue = &quot;&quot;;
		for (var bg in backgrounds){
			if (backgrounds[bg].hasOwnProperty(&quot;name&quot;)){ &#x2F;&#x2F;1-level
				if (backgrounds[bg].name==name){
					retvalue=bg.toString();
				}
			}else{
				for (var sub in backgrounds[bg]){
					if (backgrounds[bg][sub].name==name){
						retvalue=bg+&quot;.&quot;+sub;
					}
				}
			}
			
		}
		return retvalue;
	},

	&#x2F;**
	 * Enables app customization theme
	 * @method enableCustomization
	 *&#x2F;
	enableCustomization: function(){
		mygis.Utilities.disableCustomization();
		mygis.Utilities.add_sheet({url:config.folderPath+&quot;GetAppStyle.ashx?ut=&quot;+new Date().getTime(),title:&#x27;myappcust&#x27;});
	},

	&#x2F;**
	 * Disables app customization theme
	 * @method disableCustomization
	 *&#x2F;
	disableCustomization: function(){
		mygis.Utilities.remove_sheet(&quot;myappcust&quot;);
	},

	&#x2F;**
	 * Previews a specific app customization theme
	 * @method previewCustomization
	 *&#x2F;
	previewCustomization: function(styleID){
		mygis.Utilities.disableCustomization();
		mygis.Utilities.add_sheet({
			url:config.folderPath+&quot;GetAppStyle.ashx?st=&quot;+styleID+&quot;&amp;ut=&quot;+new Date().getTime(),
			title:&#x27;myappcust&#x27;});
	},

	&#x2F;**
	 * Adds a whole stylesheet or appends to an existing stylesheet.
	 * @method add_sheet
	 * @param {Object} options
	 * options.url - location of the stylesheet - when this is supplied _options.str_ and _options.title_ should not be set and a new LINK element is always created
	 * options.str - text content of the stylesheet - when this is supplied _options.url_ is not used. A STYLE element is used.
	 * options.title - the ID of the added stylesheet (if you pass &#x60;foo&#x60; the ID will be &#x60;foo-stylesheet&#x60;), when the stylesheet exists the content is appended and no new stylesheet is created.
	 * @returns a reference to the stylesheet
	 *&#x2F;
	add_sheet: function(opts) {
		var tmp = false, is_new = true;
		if(opts.str) {
			if(opts.title) { tmp = $(&quot;style[id=&#x27;&quot; + opts.title + &quot;-stylesheet&#x27;]&quot;)[0]; }
			if(tmp) { is_new = false; }
			else {
				tmp = document.createElement(&quot;style&quot;);
				tmp.setAttribute(&#x27;type&#x27;,&quot;text&#x2F;css&quot;);
				if(opts.title) { tmp.setAttribute(&quot;id&quot;, opts.title + &quot;-stylesheet&quot;); }
			}
			if(tmp.styleSheet) {
				if(is_new) {
					document.getElementsByTagName(&quot;head&quot;)[0].appendChild(tmp);
					tmp.styleSheet.cssText = opts.str;
				}
				else {
					tmp.styleSheet.cssText = tmp.styleSheet.cssText + &quot; &quot; + opts.str;
				}
			}
			else {
				tmp.appendChild(document.createTextNode(opts.str));
				document.getElementsByTagName(&quot;head&quot;)[0].appendChild(tmp);
			}
			return tmp.sheet || tmp.styleSheet;
		}
		if(opts.url) {
			tmp			= document.createElement(&#x27;link&#x27;);
			tmp.rel		= &#x27;stylesheet&#x27;;
			tmp.type	= &#x27;text&#x2F;css&#x27;;
			tmp.media	= &quot;all&quot;;
			tmp.href	= opts.url;
			if (opts.title){
				tmp.id		= opts.title;
			}

			document.getElementsByTagName(&quot;head&quot;)[0].appendChild(tmp);
			return tmp.styleSheet;

		}
		return null;
	},

	&#x2F;**
	 * Removes a css style sheet when it has the given id
	 * @method remove_sheet
	 * @param {String} id The style id
	 *&#x2F;
	remove_sheet: function(id){
		var elem = document.getElementById(id);
		if (elem){
			document.getElementsByTagName(&quot;head&quot;)[0].removeChild(elem);
		}
	},

	&#x2F;**
	 * Merges the properties of 2 objects
	 * @method mergeOptions
	 * @param {Object} src The source object
	 * @param {Object} target The target object
	 *&#x2F;
	mergeOptions: function (src,target){
		var obj3 = {};
		for (var attrname in src) { obj3[attrname] = src[attrname]; }
		for (var attrname in target) { obj3[attrname] = target[attrname]; }
		return obj3;
	},


	&#x2F;**
		Blocks UI interaction.

		@method blockUI
		@param {Boolean} blanket If true, blankets the whole page
	**&#x2F;
	blockUI: function(blanket){

		try{
		if (!internalConfig.uiBlocked){
			if (blanket){
				$(&#x27;#initialLoad&#x27;).find(&quot;.mygis_logo&quot;).show();
				$(&#x27;#initialLoad&#x27;).find(&quot;.mygis_loader&quot;).attr({&quot;style&quot;:&quot;display: none;margin-top:0px;&quot;});
				$.blockUI({
					message: $(&#x27;#initialLoad&#x27;)
				});
			}else{
				$(&#x27;#initialLoad&#x27;).find(&quot;.mygis_logo&quot;).hide();
				$(&#x27;#initialLoad&#x27;).find(&quot;.mygis_loader&quot;).attr({&quot;style&quot;:&quot;display: block;margin-top:140px;&quot;});
				$.blockUI({
					message: $(&#x27;#initialLoad&#x27;),
					css: {
						backgroundColor: &#x27;transparent&#x27;
					},
					overlayCSS: {
						opacity:0
					}
				});
			}
			internalConfig.uiBlocked=true;
		}
		}catch(err){

			console.log(err.message);

		}

	},

	&#x2F;**
		Unblocks the UI
		@method mygis.Utilities.unblockUI

	**&#x2F;
	unblockUI: function(){
		$.unblockUI();
		internalConfig.uiBlocked=false;
	},

	&#x2F;**
	 * Due to a bug in $.blockUI, this is used to reset the blocking div
	 * @method resetBlockUI
	 *&#x2F;
	resetBlockUI: function(){
		var parent = $(&quot;#VariousPopUps&quot;);
		var cont = $(&quot;&lt;div &#x2F;&gt;&quot;);
		cont.attr(&quot;id&quot;,&quot;initialLoad&quot;);
		cont.attr(&quot;style&quot;,&quot;display:none&quot;);
		var logo = $(&quot;&lt;div &#x2F;&gt;&quot;);
		logo.attr(&quot;class&quot;,&quot;mygis_logo&quot;);
		var logoImg = $(&quot;&lt;img &#x2F;&gt;&quot;);
		logoImg.attr(&quot;src&quot;,config.folderPath+&quot;GetImage.ashx?qType=GetAppLogo&quot;);
		var feedback = $(&quot;&lt;div &#x2F;&gt;&quot;);
		feedback.attr(&quot;id&quot;,&quot;mygis_loadFeedback&quot;);
		logo.append(logoImg);
		logo.append(feedback);
		var loader = $(&quot;&lt;div &#x2F;&gt;&quot;);
		var loaderImg = $(&quot;&lt;img &#x2F;&gt;&quot;);
		loader.attr(&quot;class&quot;,&quot;mygis_loader&quot;);
		loaderImg.attr(&quot;src&quot;,config.folderPath + &quot;Images&#x2F;mygis_loader.gif&quot;);
		loader.append(loaderImg);
		cont.append(logo);
		cont.append(loader);
		parent.append(cont);
	},

	&#x2F;**
		Categorizes an array of features based on feature.type

		@method categorizeFeatures
		@param {Array} features
		@return {Object} Hashtable with the features. Key is the layername.
	**&#x2F;
	categorizeFeatures: function(features){
		var retvalue = {};
		for (var i=0;i&lt;features.length;i++){
			var item = features[i];
			if (!retvalue[item.type]){
				retvalue[item.type]=[];
			}
			retvalue[item.type].push(item);

		}
		return retvalue;
	},

	&#x2F;**
		Searches for a given layerTable in the layerSource

		@method mggetLayerIndex
		@param {String} layertable The layerTable property to search for
		@return {Integer} If found, the item&#x27;s index, otherwise -1
	**&#x2F;
	mggetLayerIndex: function(layertable){
		var retvalue=-1;
		var i=0;
		var found=false;
		while (!found &amp;&amp; i&lt;layerSource.records.length)
		{
			var item = layerSource.records[i];
			if (item.layerTABLE==layertable){
				found=true;
				retvalue = i;
			}else{
				i++;
			}
		}
		return retvalue;
	},

	&#x2F;** Searches for a given layerTable in the layerSource
	 *  @method mggetLayerID
	 *  @param {String} layertable The layerTable property to search for
	 *  @return {Integer} If found, the layer ID, otherwise -1
	 *&#x2F;
	mggetLayerID: function(layertable){
		var retvalue = -1;
		var i=0;
		var found=false;
		while (!found &amp;&amp; i&lt;layerSource.records.length)
		{
			var item = layerSource.records[i];
			if (item.layerTABLE==layertable){
				found=true;
				retvalue = item.layerID;
			}else{
				i++;
			}
		}
		return retvalue;
	},

	&#x2F;**
		Searches the stored queries for the given value

		@method getQueryByValue
		@param value The value to search for
		@param {Boolean} [returnIndex] If true, only the index of the item will be returned, otherwise the item itself.
		@return {Mixed}
	**&#x2F;
	getQueryByValue: function(value,returnIndex){
		var i=0;
		var found=false;
		var retvalue;
		while (!found &amp;&amp; i&lt;querySource.length){
			var item;
			item = querySource[i];
			if (item.value==value){
				found=true;
				retvalue=item;
			}else{
				i++;
			}
		}
		if (returnIndex&amp;&amp;!found){
			return -1;
		}else if(returnIndex){
			return i;
		}else{
			return item;
		}
	},

	&#x2F;**
		Checks to see if the current user has authorization for the given operation, as a quick-check.
		Use this only for UI purposes.

		@method checkAuthorization
		@param {String} operation
		@param {String} params Any additional parameters to pass server-side
	**&#x2F;
	checkAuthorization: function(operation,params){
		var mycallback = function(closureData){
			return function(data){
				var realResults = eval(data);
				if (realResults.type==&quot;success&quot;){
					switch (realResults.operation){
						case &quot;digitize&quot;:
							mygis.Drawing.Exporting.saveDigitizing();
							break;
					}
				}else{
					displayError(realResults.message);
				}
			}
		};
		$.ajax({
			url:config.mgreq+&quot;?qtype=isAuthorized&amp;qContents=&quot;+operation+&quot;&amp;qParams=&quot;+params,
			type: &quot;GET&quot;,
			success: mycallback()
		});
	},

	&#x2F;**
		Checkes the layerSource for a given layerTable name, and returns the friendly name.

		@method getFriendlyName
		@param {String} layerTable the given layerTable to search
		@return {String} The friendly layerNAME if found, or layerTable if not found
	**&#x2F;
	getFriendlyName: function(layerTable){
		var i=0;
		var found=false;
		var retvalue = layerTable;
		while (!found &amp;&amp; i&lt;layerSource.records.length){
			var item = layerSource.records[i];
			if (item.layerTABLE==layerTable){
				found=true;
				retvalue = item.layerNAME;
			}else{
				i++;
			}
		}
		return retvalue;
	},

	&#x2F;**
		Returns a new array with only unique values

		@method arrayUnique
		@param {Array} The array to search
		@return {Array} The array with the unique items
	**&#x2F;
	arrayUnique: function(array) {
		var o = new Object(), i, l = array.length, r = [];
		for(i=0; i&lt;l;i+=1) o[array[i]] = array[i];
		for(i in o) r.push(o[i]);
		return r;
	},

	&#x2F;**
		Moves an item in an array

		@method arrayMove
		@param {Array} arrayObj The array to reorder
		@param {Integer} old_index The index to move from
		@param {Integer} new_index The index to move to
	**&#x2F;
	arrayMove: function(arrayObj,old_index,new_index){
		while (old_index &lt; 0) {
			old_index += arrayObj.length;
		}
		while (new_index &lt; 0) {
			new_index += arrayObj.length;
		}
		if (new_index &gt;= arrayObj.length) {
			var k = new_index - arrayObj.length;
			while ((k--) + 1) {
				arrayObj.push(undefined);
			}
		}
		arrayObj.splice(new_index, 0, arrayObj.splice(old_index, 1)[0]);
		return arrayObj; &#x2F;&#x2F; for testing purposes
	},

	&#x2F;**
		Checks if a string is a number

		@method isNumeric
		@param {String} input
		@return {Boolean}
	**&#x2F;
	isNumeric: function(input){
		var inp=input.toString();
		return (inp - 0) == inp &amp;&amp; inp.length &gt; 0;
	},

	&#x2F;**
		Checks if an object has any custom properties defined.
		@method isEmptyObject
		@param {Object} obj The object to check
		@return {Boolean} True if the Object does not have any properties of its own defined.
	**&#x2F;
	isEmptyObject: function(obj){
		for(var prop in obj) {
			if (Object.prototype.hasOwnProperty.call(obj, prop)) {
			  return false;
			}
		}
		return true;
	},

	&#x2F;**
		Populates select list from array of items given as objects

		@method populateSelect
		@param {Element} el The select element to populate
		@param {Array} items Objects of this form: { name: &#x27;text&#x27;, value: &#x27;value&#x27; }
		@param {Boolean} [noFirst] If not defined or false, a new blank Option will be inserted before the items.
	**&#x2F;
	populateSelect: function(el, items, noFirst) {
		el.options.length = 0;
		if (!$.isEmptyObject(items) &amp;&amp; (!noFirst)){
			el.options[0] = new Option(&#x27;&#x27;, &#x27;&#x27;);
		}

		var i=0 &#x2F;&#x2F;JK CHANGE - variable for counting
		$.each(items, function () {
			&#x2F;&#x2F;JK CHANGES - find the index numbers of datetime fields
			i++;
			try{
			if ((this.originalType == &quot;datetime&quot;) || (this.originalType == &quot;date&quot;)) {
				el.options[el.options.length] = new Option(this.name, this.value); &#x2F;&#x2F;JK - this was original code line
				if (window.trigger_calendar.length == 0){window.trigger_calendar.push ([i.toString(),this.name]);}
				else{
					for (i=0;i&lt;window.trigger_calendar.length;i++){
						if (window.trigger_calendar[i][1]!=this.name)
						{window.trigger_calendar.push ([i.toString(),this.name]);} &#x2F;&#x2F;the index number of those objects is added to the list	
					}
				}
			}
			else{
			&#x2F;&#x2F;JK CHANGES - END
			el.options[el.options.length] = new Option(this.name, this.value);
			&#x2F;&#x2F;JK CHANGES - the rest of the &#x27;try&#x27; loop
			}}
			catch(err)
			{
			el.options[el.options.length] = new Option(this.name, this.value);
			}
			&#x2F;&#x2F;JK CHANGES - END
		});

	},

	&#x2F;**
		Returns only the custom defined propertied in an Object

		@method array_keys
		@param {Object} input
		@param {String} [search_value] If defined, it will only return an array with this key if found
		@return {Object}
	**&#x2F;
	array_keys: function(input,search_value,argStrict){
		var search = typeof search_value !== &#x27;undefined&#x27;, tmp_arr = [], strict = !!argStrict, include = true, key = &#x27;&#x27;;
		if (input &amp;&amp; typeof input === &#x27;object&#x27; &amp;&amp; input.change_key_case) { &#x2F;&#x2F; Duck-type check for our own array()-created PHPJS_Array
			return input.keys(search_value, argStrict);
		}
		for (key in input)
		{
			if (input.hasOwnProperty(key))
			{
				include = true;
				if (search)
				{
					if (strict &amp;&amp; input[key] !== search_value){
						include = false;
					}
					else {
						if (input[key] != search_value){
							include = false;
						}
					}
				}
				if (include){
					tmp_arr[tmp_arr.length] = key;
				}
			}
		}
		return tmp_arr;
	},

	&#x2F;**
		Converts a given string to its boolean equivalent

		@method stringToBoolean
		@param (String) string
		@return {Boolean}
	**&#x2F;
	stringToBoolean: function(string){
			switch(string){
					case &quot;True&quot;: case &quot;true&quot;: case &quot;yes&quot;: case &quot;1&quot;: return true;
					case &quot;False&quot;: case &quot;false&quot;: case &quot;no&quot;: case &quot;0&quot;: case null: return false;
					default: return Boolean(string);
			}
	},

	&#x2F;**
		Formats an OpenLayers LonLat object to a comma separated string.
		@method formatLonlats
		@return {String} The formatted string
	**&#x2F;
	formatLonlats: function(lonLat){
		&#x2F;&#x2F;lonLat = lonLat.transform(new OpenLayers.Projection(mygis.Utilities.projections.google), new OpenLayers.Projection(mygis.Utilities.projections.wgs84));
		&#x2F;&#x2F;lonLat = lonLat.transform(new OpenLayers.Projection(&quot;EPSG:900913&quot;), new OpenLayers.Projection(&quot;EPSG:4326&quot;));
		&#x2F;&#x2F;var lat = lonLat.lon;	&#x2F;&#x2F;GOOGLE SWITCH
		&#x2F;&#x2F;var lon = lonLat.lat;	&#x2F;&#x2F;GOOGLE SWITCH
		var lat = lonLat.lon; &#x2F;&#x2F;GOOGLE SWITCH
		var lon = lonLat.lat; &#x2F;&#x2F;GOOGLE SWITCH
		var ns = OpenLayers.Util.getFormattedLonLat(lat);
		var ew = OpenLayers.Util.getFormattedLonLat(lon,&#x27;lon&#x27;);
		ns=ns.substring(0,ns.length-2);
		ew=ew.substring(0,ew.length-2);
		var outputx = mygis.Utilities.format(&quot;&lt;div class=&#x27;coord&#x27;&gt;X: {0} ({1}°)&lt;&#x2F;div&gt;&quot;,ns,(Math.round(lat * 10000) &#x2F; 10000));
		var outputy = mygis.Utilities.format(&quot;&lt;div class=&#x27;coord&#x27;&gt;Y: {0} ({1}°)&lt;&#x2F;div&gt;&quot;,ew,(Math.round(lon * 10000) &#x2F; 10000));
		&#x2F;&#x2F;var outputx = mygis.Utilities.format(&quot;&lt;div class=&#x27;coord&#x27;&gt;X: {0}&lt;&#x2F;div&gt;&quot;,ns);
		&#x2F;&#x2F;var outputy = mygis.Utilities.format(&quot;&lt;div class=&#x27;coord&#x27;&gt;Y: {0}&lt;&#x2F;div&gt;&quot;,ew);
		return outputx+outputy;
	},

	&#x2F;**
		Unbinds the global (window) mousedown handlers
		and saves them to window.globalHandlers
		@method unbindGlobalHandlers
	**&#x2F;
	unbindGlobalHandlers: function(){

		var myevents = $(document).data(&#x27;events&#x27;).mousedown;
		var handlers = [];
		$.each(myevents,function(i,v){
			handlers.push(v.handler);
		});
		window.globalHandlers = handlers;
		$(document).unbind(&#x27;mousedown&#x27;);

	},

	&#x2F;**
		Reattaches all handlers which were unbound by unbindGlobalHandlers
		@method rebindGlobalHandlers
	**&#x2F;
	rebindGlobalHandlers: function(){

		if (window.globalHandlers){
			if (window.globalHandlers.length&gt;0){
				$.each(window.globalHandlers,function(i,v){
					$(document).bind(&#x27;mousedown&#x27;,v);
				});
				window.globalHandlers = [];
			}
		}

	},

	&#x2F;**
		Formats a string containing a number into proper &quot;grouped&quot; format.
		@method addCommas
		@param {String} nStr
		@return {String} The formatted string
	**&#x2F;
	addCommas: function(nStr){
		nStr += &#x27;&#x27;;
		x = nStr.split(&#x27;.&#x27;);
		x1 = x[0];
		x2 = x.length &gt; 1 ? &#x27;.&#x27; + x[1] : &#x27;&#x27;;
		var rgx = &#x2F;(\d+)(\d{3})&#x2F;;
		while (rgx.test(x1)) {
			x1 = x1.replace(rgx, &#x27;$1&#x27; + &#x27;.&#x27; + &#x27;$2&#x27;);
		}
		return x1 + x2;
	},

	&#x2F;**
		Converts a parsed JSON object to html table

		@method ConvertJsonToTable
		@param {Object} parsedJson
		@param {String} [tableId] The ID for the generated table
		@param {String} [tableClassName] A class name for the generated table
		@param {String} [linkText] Text that should be linked.
		@return {String} String containing an html table.
	**&#x2F;
	ConvertJsonToTable: function (parsedJson, tableId, tableClassName, linkText){
		&#x2F;&#x2F;Patterns for links and NULL value
		var italic = &#x27;&lt;i&gt;{0}&lt;&#x2F;i&gt;&#x27;;
		var link = linkText ? &#x27;&lt;a href=&quot;{0}&quot;&gt;&#x27; + linkText + &#x27;&lt;&#x2F;a&gt;&#x27; :
							  &#x27;&lt;a href=&quot;{0}&quot;&gt;{0}&lt;&#x2F;a&gt;&#x27;;

		&#x2F;&#x2F;Pattern for table
		var idMarkup = tableId ? &#x27; id=&quot;&#x27; + tableId + &#x27;&quot;&#x27; :
								 &#x27;&#x27;;

		var classMarkup = tableClassName ? &#x27; class=&quot;&#x27; + tableClassName + &#x27;&quot;&#x27; :
										   &#x27;&#x27;;

		var tbl = &#x27;&lt;table border=&quot;1&quot; cellpadding=&quot;1&quot; cellspacing=&quot;1&quot;&#x27; + idMarkup + classMarkup + &#x27;&gt;{0}{1}&lt;&#x2F;table&gt;&#x27;;

		&#x2F;&#x2F;Patterns for table content
		var th = &#x27;&lt;thead&gt;{0}&lt;&#x2F;thead&gt;&#x27;;
		var tb = &#x27;&lt;tbody&gt;{0}&lt;&#x2F;tbody&gt;&#x27;;
		var tr = &#x27;&lt;tr&gt;{0}&lt;&#x2F;tr&gt;&#x27;;
		var thRow = &#x27;&lt;th&gt;{0}&lt;&#x2F;th&gt;&#x27;;
		var tdRow = &#x27;&lt;td&gt;{0}&lt;&#x2F;td&gt;&#x27;;
		var thCon = &#x27;&#x27;;
		var tbCon = &#x27;&#x27;;
		var trCon = &#x27;&#x27;;

		if (parsedJson)
		{
			var isStringArray = typeof(parsedJson[0]) == &#x27;string&#x27;;
			var headers;

			&#x2F;&#x2F; Create table headers from JSON data
			&#x2F;&#x2F; If JSON data is a simple string array we create a single table header
			if(isStringArray)
				thCon += thRow.format(&#x27;value&#x27;);
			else
			{
				&#x2F;&#x2F; If JSON data is an object array, headers are automatically computed
				if(typeof(parsedJson[0]) == &#x27;object&#x27;)
				{
					headers = mygis.Utilities.array_keys(parsedJson[0]);

					for (i = 0; i &lt; headers.length; i++)
						thCon += thRow.format(headers[i]);
				}
			}
			th = th.format(tr.format(thCon));

			&#x2F;&#x2F; Create table rows from Json data
			if(isStringArray)
			{
				for (i = 0; i &lt; parsedJson.length; i++)
				{
					tbCon += tdRow.format(parsedJson[i]);
					trCon += tr.format(tbCon);
					tbCon = &#x27;&#x27;;
				}
			}
			else
			{
				if(headers)
				{
					var urlRegExp = new RegExp(&#x2F;(\b(https?|ftp|file):\&#x2F;\&#x2F;[-A-Z0-9+&amp;@#\&#x2F;%?=~_|!:,.;]*[-A-Z0-9+&amp;@#\&#x2F;%=~_|])&#x2F;ig);
					var javascriptRegExp = new RegExp(&#x2F;(^javascript:[\s\S]*;$)&#x2F;ig);

					for (i = 0; i &lt; parsedJson.length; i++)
					{
						for (j = 0; j &lt; headers.length; j++)
						{
							var value = parsedJson[i][headers[j]];
							var isUrl = urlRegExp.test(value) || javascriptRegExp.test(value);

							if(isUrl) &#x2F;&#x2F; If value is URL we auto-create a link
								tbCon += tdRow.format(link.format(value));
							else
							{
								if(value)
									tbCon += tdRow.format(value);
								else &#x2F;&#x2F; If value == null we format it like PhpMyAdmin NULL values
									tbCon += tdRow.format(italic.format(value).toUpperCase());
							}
						}
						trCon += tr.format(tbCon);
						tbCon = &#x27;&#x27;;
					}
				}
			}
			tb = tb.format(trCon);
			tbl = tbl.format(th, tb);

			return tbl;
		}
		return null;
	},

	&#x2F;**
		Replaces spaces with underscores in a given string.
		@method nameToUnderscore
		@param {String} name The string to convert
		@return {String} The formatted string
	**&#x2F;
	nameToUnderscore: function(name){
		if (name.indexOf(&quot; &quot;)&gt;0){
			var nameparts = name.split(&quot; &quot;);
			name = nameparts.join(&quot;_&quot;);
		}
		return name;
	},

	&#x2F;**
		Returns a comma-separated string of visible layers

		@method getVisibleLayerString
		@param {String} appname The current applicatio nname
		@param {Boolean} legend If this will be used to ask for a geoserver getlegend request.
		@return {String} The comma-separated string of layers
	**&#x2F;
	getVisibleLayerString: function(appname,legend){
		var fullLayerString=&quot;&quot;;
		var recs = layerSource.records;
		var fullLayers=[];
		for (var i=recs.length-1;i&gt;=0;i--)
		{
			if (!(Boolean(recs[i].hidden)===true)){
				layername = recs[i].layerTABLE;
				layername=mygis.Utilities.nameToUnderscore(layername);
				&#x2F;&#x2F;layername = appname+&quot;_&quot;+layername;
				fullLayers.push(layername);
			}

		}
		var separator=legend?&quot;+&quot;:&quot;,&quot;;
		fullLayerString = fullLayers.join(separator);
		return fullLayerString;
	},


	&#x2F;**
		Acts like String.Format() in VB.NET

		@method format
	 	@param {String} str The format string
	*&#x2F;
	format: function(str){
		for(i = 1; i &lt; arguments.length; i++){
			var searchme = &#x27;\\{&#x27; + (i - 1) + &#x27;}&#x27;;
			str = str.replace(new RegExp(searchme, &#x27;g&#x27;), arguments[i]);
		}
		return str;
	},

    &#x2F;**
		Used to round coordinates up to 6 decimals
		@method roundVal
		@param {Number} val The coordinate to round
    *&#x2F;
    roundVal: function(val) {
        if (val.toString().length &lt; 9) {
            return val;
        } else {
            var dec = 6;
            var result = Math.round(val * Math.pow(10, dec)) &#x2F; Math.pow(10, dec);
            return result;
        }
    },

    &#x2F;**
		Checks if &quot;ENTER&quot; was pressed to perform search
		@method checkKeypress
		@param {Event} e
    *&#x2F;
    checkKeypress: function(e) {
        var keynum;
        if (window.event) &#x2F;&#x2F; IE
        {
            keynum = e.keyCode
        }
        else if (e.which) &#x2F;&#x2F; Netscape&#x2F;Firefox&#x2F;Opera
        {
            keynum = e.which
        }
        if (keynum == 13) {
            mygis.Map.showAddress(document.getElementById(&quot;searchBtn&quot;).value);
            return false;
        }
    },

    &#x2F;**
		A more consistent method of detecting MouseOut like IE does
		@method isMouseLeaveOrEnter
		@param {event} e
		@param {Function} handler
    *&#x2F;
    isMouseLeaveOrEnter: function(e, handler) {
        if (e.type != &#x27;mouseout&#x27; &amp;&amp; e.type != &#x27;mouseover&#x27;) return false;
        var reltg = e.relatedTarget ? e.relatedTarget : e.type == &#x27;mouseout&#x27; ? e.toElement : e.fromElement;
        while (reltg &amp;&amp; reltg != handler) reltg = reltg.parentNode;
        return (reltg != handler);
    },

    &#x2F;**
    * A function to convert a point on the map to relative pixel coordinates.
    * @param map The map object
    * @param latlng The point on the map
    * @param z The zoom level
    *&#x2F;
    latlngToPoint: function(map, latlng, z) {
        var normalizedPoint = map.getProjection().fromLatLngToPoint(latlng); &#x2F;&#x2F; returns x,y normalized to 0~255
        &#x2F;&#x2F;var scale = Math.pow(2, z);
        &#x2F;&#x2F;var pixelCoordinate = new google.maps.Point(normalizedPoint.x * scale, normalizedPoint.y * scale);
        var pixelCoordinate = normalizedPoint;
        return pixelCoordinate;
    },

    &#x2F;**
    * Converts the number in degrees to the radian equivalent
    * @param angle
    *&#x2F;
    deg2rad: function(angle) {
        return (angle &#x2F; 180) * Math.PI;
    },

	&#x2F;**
		Converts a circle to polygon (incomplete)
		@method circle2polygon
		@TODO TODO
	*&#x2F;
    circle2polygon: function(centerpoint, radius) {
        var lat1 = mygis.Utilities.deg2rad(centerpoint.lat());
        var long1 = mygis.Utilities.deg2rad(centerpoint.lng());
        var d_rad = radius &#x2F; 6378137;
        var radial;
        var lat_rad;
        var dlon_rad;
        var lon_rad;
        for (var i = 0; i &lt;= 360; i++) {
            radial = mygis.Utilities.deg2rad(i);
            lat_rad = Math.asin
        }
    },

	&#x2F;**
		Creates a random number from minVal to maxVal
		@method randomXToY
		@param {Number} minVal
		@param {Number} maxVal
		@param {Boolean} [floatVal] If defined, the returned number contains up to floatVal decimals.
		@return The created random number
	*&#x2F;
    randomXToY: function(minVal, maxVal, floatVal) {
        var randVal = minVal + (Math.random() * (maxVal - minVal));
        return typeof floatVal == &#x27;undefined&#x27; ? Math.round(randVal) : randVal.toFixed(floatVal);
    },

	&#x2F;**
		Converts a given opacity value to its hex equivalent.

		@method opacityToHex
		@param {Number} degOpacity The opacity (0-1)
		@return The hex equivalent
	**&#x2F;
	opacityToHex: function(degOpacity){
		&#x2F;*
		Opacity is a value between 0-1.
		In order to use it for kml, we need to convert it to 0-255.
		degOpacity : 1
		x              : 255
		*&#x2F;
		var retvalue;
		if (degOpacity&lt;=1 &amp;&amp; degOpacity&gt;=0){
			var preHex = Math.floor(degOpacity*255);
			retvalue = preHex.toString(16);
			if (retvalue.length==1){
				retvalue = &quot;0&quot;+retvalue;
			}
		}
		return retvalue;
	},

	&#x2F;**
		Cuts the &quot;#&quot; character from a CSS hex color
		@method cutHex
		@param {String} hexValue a hex CSS-color
		@return The cut string
	**&#x2F;
	cutHex: function(hexValue){
		return (hexValue.charAt(0)==&quot;#&quot;) ? hexValue.substring(1,7):hexValue;
	},

	&#x2F;**
		Converts a css color from hex to rgb
		@method hexToRGB
		@param {String} hexValue a hex CSS-color
		@return {Array} An array containing the rgb colors
	**&#x2F;
	hexToRGB: function(hexValue){
		var retArray = [];
		var r,g,b;
		var h = mygis.Utilities.cutHex(hexValue);
		r = parseInt(h.substring(0,2),16);
		g = parseInt(h.substring(2,4),16);
		b = parseInt(h.substring(4,6),16);
		retArray.push(r);
		retArray.push(g);
		retArray.push(b);
		return retArray;
	},

	&#x2F;**
	 * Converts an rgba value to hex color, stripping the opacity parameter
	 * @method rgbaToHex
	 * @param {String} rgbaValue A css rgba value. example: &#x27;rgba(100,230,100,0.4)&#x27;
	 *&#x2F;
	rgbaToHex : function(rgbaValue){
		var colorStart = rgbaValue.indexOf(&#x27;rgba(&#x27;)+5;
		var colorEnd = rgbaValue.indexOf(&#x27;)&#x27;);
		var colors = rgbaValue.substring(colorStart,colorEnd).split(&#x27;,&#x27;);
		var r = parseInt(colors[0]).toString(16);
		var g = parseInt(colors[1]).toString(16);
		var b = parseInt(colors[2]).toString(16);
		return &quot;#&quot;+r+g+b;
	},

	&#x2F;**
	 * Gets the opacity component of a css rgba value
	 * @method getOpacityRGBA
	 * @param {String} rgbaValue A css rgba value. example: &#x27;rgba(100,230,100,0.4)&#x27;
	 *&#x2F;
	getOpacityRGBA: function(rgbaValue){
		if (rgbaValue.indexOf(&quot;#&quot;)==0){
			return 1;
		}else{
			var colorStart = rgbaValue.indexOf(&#x27;rgba(&#x27;)+5;
			var colorEnd = rgbaValue.indexOf(&#x27;)&#x27;);
			var colors = rgbaValue.substring(colorStart,colorEnd).split(&#x27;,&#x27;);
			return colors[3];
		}
	},

	&#x2F;**
	 * Returns a jqx.dataAdapter object with the bound localdata
	 * Used in jqx widgets (grid,list) etc
	 * @method getLocalGridSource
	 * @param {Array} localdata array of objects
	 *&#x2F;
	getLocalGridSource: function(localdata){
		var source = {
			datatype: &quot;local&quot;,
			localdata: localdata
		};
		var gridSource = new $.jqx.dataAdapter(source,{
			async: false
		});
		gridSource.dataBind();
		return gridSource;
	},

	&#x2F;**
		Contains the used projections in MyGIS

		@class Utilities.projections
		@static
	**&#x2F;
	projections: {
		&#x2F;**
			The google projection
			@property google
			@type String
		**&#x2F;
		google: &quot;EPSG:900913&quot;,
		&#x2F;**
			The WGS84 projection
			@property WGS84
			@type String
		**&#x2F;
		wgs84: &quot;EPSG:4326&quot;
	},

	&#x2F;**
		Used to attach the Google Places Api to the proper input element

		@method googleAutoComplete
	**&#x2F;
	googleAutoComplete: function(){

		$(&quot;#autoComplete&quot;).attr(&quot;placeholder&quot;,strings.QuickJump.placeholder);
		var pac_input = document.getElementById(&#x27;autoComplete&#x27;);

		(function pacSelectFirst(input) {
			&#x2F;&#x2F; store the original event binding function
			var _addEventListener = (input.addEventListener) ? input.addEventListener : input.attachEvent;

			function addEventListenerWrapper(type, listener) {
				&#x2F;&#x2F; Simulate a &#x27;down arrow&#x27; keypress on hitting &#x27;return&#x27; when no pac suggestion is selected,
				&#x2F;&#x2F; and then trigger the original listener.
				if (type == &quot;keydown&quot;) {
					var orig_listener = listener;
					listener = function(event) {
						var suggestion_selected = $(&quot;.pac-item-selected&quot;).length &gt; 0;
						if (event.which == 13 &amp;&amp; !suggestion_selected) {
							var simulated_downarrow = $.Event(&quot;keydown&quot;, {
								keyCode: 40,
								which: 40
							});
							orig_listener.apply(input, [simulated_downarrow]);
						}

						orig_listener.apply(input, [event]);
					};
				}

				_addEventListener.apply(input, [type, listener]);
			}

			input.addEventListener = addEventListenerWrapper;
			input.attachEvent = addEventListenerWrapper;
		})(pac_input);
		var defaultBounds = new google.maps.LatLngBounds(
		  new google.maps.LatLng(-33.8902, 151.1759),
		  new google.maps.LatLng(-33.8474, 151.2631));

		var input = document.getElementById(&#x27;autoComplete&#x27;);
		var options = {
		  bounds: defaultBounds,
		  types: [&#x27;(regions)&#x27;,&#x27;address&#x27;]		  &#x2F;*,
		  &#x2F;&#x2F;types: [&#x27;street_address&#x27;],
		  componentRestrictions: {country: &#x27;gr&#x27;}
	*&#x2F;
		};

		autocomplete = new google.maps.places.SearchBox(input, options);
		google.maps.event.addListener(autocomplete, &#x27;places_changed&#x27;, function() {

		  var place = autocomplete.getPlaces()[0];
		  console.log(&quot;types: &quot;);
		  console.log(place.types);
		  &#x2F;&#x2F;alert(place.name);
		  var foundType=place.types[0];
		  var zoomLevel=digimap.getZoom();
		  switch (foundType){
			case &quot;country&quot;:
				zoomLevel=6;
				break;
			case &quot;administrative_area_level_1&quot;:
				zoomLevel=8;
				break;
			case &quot;administrative_area_level_2&quot;:
				zoomLevel=10;
				break;
			case &quot;administrative_area_level_3&quot;:
				zoomLevel=12;
				break;
			case &quot;administrative_area_level_4&quot;:
				zoomLevel=14;
				break;
			case &quot;administrative_area_level_5&quot;:
				zoomLevel=16;
				break;
			case &quot;street_address&quot;:
				zoomLevel=16;
				break;
			case &quot;route&quot;:
			case &quot;intersection&quot;:
				zoomLevel=12;
				break;
			case &quot;locality&quot;:
				zoomLevel=12;
				break;
			
			
		  }
		  if (place.geometry){
			var center = place.geometry.location;
			var point = new OpenLayers.LonLat(center.lng(),center.lat());
			&#x2F;&#x2F;point.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;));
			
			var pointer = {lon:point.lon ,lat: point.lat};
			point.transform(new OpenLayers.Projection(&quot;EPSG:4326&quot;),new OpenLayers.Projection(&quot;EPSG:900913&quot;));
			digimap.setCenter(point);
			mygis.Map.markSelectionPoint(pointer,true);
			digimap.zoomTo(zoomLevel);
		  &#x2F;&#x2F;place.geometry.location?
		  }else{
			feedbackLayer.removeAllFeatures();
		  }
		});
	},

	&#x2F;**
		Moves the map just a tiny bit to the right to force a refresh of tiles.

		@method nudgeMap
	**&#x2F;
	nudgeMap: function(){

		var center = digimap.getCenter();
		digimap.panTo(new OpenLayers.LonLat(center.lon+0.0000000001,center.lat));
	},

	testReverseGeo: function(lon,lat){
		var map = new google.maps.Map(document.getElementById(&quot;dummyGoogle&quot;),{
			mapTypeId: google.maps.MapTypeId.ROADMAP,
			center: new google.maps.LatLng(34,23),
			zoom: 15
		  });
		var service = new google.maps.places.PlacesService(map);
		var request = {
			location: new google.maps.LatLng(lat,lon),
			bounds : new google.maps.LatLngBounds(
				google.maps.LatLng(-89.999999,-179.999999),
				google.maps.LatLng(89.999999,179.999999)
			),
			types: [&#x27;country&#x27;]
		};
		var cb = function(results,status){
			if (status == google.maps.places.PlacesServiceStatus.OK) {
				var xxx = results[0];
				alert(xxx.name);
			}
		};
		service.search(request,cb);
	},

	&#x2F;&#x2F;JK CHANGES - NEW FUNCTIONS

	&#x2F;**
		Creates the calendar field (hidden), shows button to trigger it, hides the &#x27;star&#x27; button and does the event bind

		@method datetime_input_field
	**&#x2F;
	datetime_input_field: function(secondRow){
		try{
			&#x2F;&#x2F;show the calendar	button
			$(&#x27;#&#x27;+secondRow.id.replace(&quot;second_row_&quot;,&quot;cal_button_&quot;)).show()
			&#x2F;&#x2F;set the button
			but_idname = secondRow.id.replace(&quot;second_row_&quot;,&quot;cal_button_&quot;);			
			$(&#x27;#&#x27;+secondRow.id+&#x27;&gt;.cal_button&#x27;).id = but_idname;
			mygis.Utilities.button_set(document.getElementById(but_idname));
			&#x2F;&#x2F;hide the &#x27;distinct&#x27; star when showing button
			$(&#x27;#&#x27;+secondRow.id+&#x27; &gt; .dbFieldGetList&#x27;).hide();			
			&#x2F;&#x2F;initialize the calendar
			if (!$(&quot;#datetime&quot;).length==0)
			{
				$(&quot;#datetime&quot;).jqxCalendar({width: 380, height: 274});				
				&#x2F;&#x2F;initially populate the field
				if (secondRow.getElementsByClassName(&quot;dbFieldValue&quot;)[0].value==&quot;&quot;)
				{
					new_date = $(&#x27;#datetime&#x27;).jqxCalendar(&#x27;getDate&#x27;);
					str_new_date= new_date.getDate().toString()+&#x27;&#x2F;&#x27;+(new_date.getMonth()+1).toString()+&#x27;&#x2F;&#x27;+new_date.getFullYear().toString();
					secondRow.getElementsByClassName(&quot;dbFieldValue&quot;)[0].value = str_new_date;
					secondRow.getElementsByClassName(&quot;dbFieldValue&quot;)[0].onchange();
				};
			};
			&#x2F;&#x2F;hide the calendar initially
			$(&quot;#datetime&quot;).hide();				
			&#x2F;&#x2F;bind the calendar for event reporting
			$(&#x27;#datetime&#x27;).bind(&#x27;cellSelected&#x27;, function (event) {
				if (window.current_row[0] != &quot;&quot;){
				var new_date = event.args.date;
				window.current_row[1]=new_date.getDate().toString()+&#x27;&#x2F;&#x27;+(new_date.getMonth()+1).toString()+&#x27;&#x2F;&#x27;+new_date.getFullYear().toString();			
				$(&#x27;.jqxdatetime&#x27;).hide();
				if (window.current_row[0] != &quot;&quot;)
					{
						&#x2F;&#x2F;populate the proper fields if possible
						if (window.current_row[1] == &quot;&quot;)	{
							new_date = $(&#x27;#datetime&#x27;).jqxCalendar(&#x27;getDate&#x27;);
							window.current_row[1]=new_date.getDate().toString()+&#x27;&#x2F;&#x27;+(new_date.getMonth()+1).toString()+&#x27;&#x2F;&#x27;+new_date.getFullYear().toString();
							};
						window.current_row[0].getElementsByClassName(&quot;dbFieldValue&quot;)[0].value = window.current_row[1];
						window.current_row[0].getElementsByClassName(&quot;dbFieldValue&quot;)[0].onchange();
						&#x2F;&#x2F;forget the place to populate
						window.current_row = [&quot;&quot;,&quot;&quot;];
					};
				};
			})
		}
		catch(err) {console.log(&#x27;calendar error :&#x27;+err);}

	},

	&#x2F;**
		hides the datetime input field, shows the &#x27;star&#x27; button again

		@method rm_datetime_input_field
	**&#x2F;
	rm_datetime_input_field: function(secondRow){
		try{
		&#x2F;&#x2F;show the &#x27;distinct&#x27; star when hiding calendar, and hide the calendar button
		$(&#x27;#&#x27;+secondRow.id+&#x27; &gt; .cal_button&#x27;).hide();
		$(&#x27;#&#x27;+secondRow.id+&#x27; &gt; .dbFieldGetList&#x27;).show();}
		catch (err){}	
		try{
			if(typeof(secondRow)===&quot;number&quot;)	&#x2F;&#x2F;this is a call to remove all instances
			{
				elements = document.getElementsByClassName(&quot;criteriaSecondRow&quot;);
				for ( var i = 0; i &lt; elements.length; i++ ){
				$(&#x27;#&#x27;+document.getElementById(elements.id.replace(&quot;second_row_&quot;,&quot;cal_button_&quot;))).hide();
				}
			}
			else{					&#x2F;&#x2F;or just hide the calendar div
			document.getElementById(secondRow.id.replace(&quot;second_row_&quot;,&quot;cal_button_&quot;)).style.display = &#x27;none&#x27;;
			}
		}
		&#x2F;&#x2F;if not possible, do tell
		catch(err){
			console.log(&#x27;error at calendar remove: &#x27;+err);
		}
	},
	
	&#x2F;**
		sets the proper reactions to the calendar button

		@method button_set
	**&#x2F;
	button_set: function(button){
		cal_idname = button.id.replace(&quot;cal_button_&quot;,&quot;datetime_&quot;);	
		button.onclick = function()
		{
			&#x2F;&#x2F;if no calendars are shown, show the correct calendar --test this if we can check for class, when an instance has smth
			try{
				if ($(&quot;#datetime&quot;)[0].style.display == &quot;none&quot;) {
					$(&quot;#datetime&quot;).show();
					&#x2F;&#x2F;remeber the row to populate later
					window.current_row[0] = document.getElementById(button.id.replace(&quot;cal_button_&quot;,&quot;second_row_&quot;));				
					}
				else {
					&#x2F;&#x2F;else hide all calendars
					$(&#x27;.jqxdatetime&#x27;).hide();
					if (window.current_row[0] != &quot;&quot;)
						{						
							&#x2F;&#x2F;populate the proper fields if possible
							if (window.current_row[1] == &quot;&quot;)	{
								new_date = $(&#x27;#datetime&#x27;).jqxCalendar(&#x27;getDate&#x27;);
								window.current_row[1]=new_date.getDate().toString()+&#x27;&#x2F;&#x27;+(new_date.getMonth()+1).toString()+&#x27;&#x2F;&#x27;+new_date.getFullYear().toString();
								};
							window.current_row[0].getElementsByClassName(&quot;dbFieldValue&quot;)[0].value = window.current_row[1];
							window.current_row[0].getElementsByClassName(&quot;dbFieldValue&quot;)[0].onchange();
							&#x2F;&#x2F;forget the place to populate
							window.current_row = [&quot;&quot;,&quot;&quot;];
						}
					};
			}
			catch (err){}
		}
	}
	&#x2F;&#x2F;JK CHANGES END - NEW FUNCTIONS
};

&#x2F;&#x2F;END of mygis.Utilities


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
